<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Reactå®˜æ–¹æ–‡æ¡£çŸ¥è¯†ç‚¹-Contextå’ŒHook</title>
    <link href="/2020/05/28/React%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%9F%A5%E8%AF%86%E7%82%B9-Context%E5%92%8CHook/"/>
    <url>/2020/05/28/React%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%9F%A5%E8%AF%86%E7%82%B9-Context%E5%92%8CHook/</url>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰çš„è¿›é˜¶ä¸­å…¶å®æœ‰Contextçš„å†…å®¹ï¼Œä¸è¿‡é‚£é‡Œè·³è¿‡äº†ï¼Œä½†Hookçš„ä¸€äº›APIæ¶‰åŠåˆ°Contextçš„æ“ä½œã€‚æ‰€ä»¥å…ˆç†Ÿæ‚‰ä¸€ä¸‹Contextçš„å†…å®¹ã€‚<br>Hookç®—æ˜¯Reactä¸­æ¯”è¾ƒæ–°çš„ä¸€ä¸ªç‰¹æ€§ï¼Œé…åˆContextï¼Œè¿™è®©æˆ‘ä»¬åœ¨ç®¡ç†çŠ¶æ€çš„æ—¶å€™æ›´åŠ çš„æ–¹ä¾¿ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¦‚æœä½ çš„åº”ç”¨ä¸æ˜¯é‚£ä¹ˆå¤æ‚ï¼Œä½ ç”šè‡³å¯ä»¥æ”¾ä¸‹reduxã€‚å½“ç„¶è¿™ä¸€ç‚¹æ¯”è¾ƒè§ä»è§æ™ºã€‚</p><h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><pre><code class="hljs plain">&#x2F;&#x2F; Context å¯ä»¥è®©æˆ‘ä»¬æ— é¡»æ˜ç¡®åœ°ä¼ éæ¯ä¸€ä¸ªç»„ä»¶ï¼Œå°±èƒ½å°†å€¼æ·±å…¥ä¼ é€’è¿›ç»„ä»¶æ ‘ã€‚&#x2F;&#x2F; ä¸ºå½“å‰çš„ theme åˆ›å»ºä¸€ä¸ª contextï¼ˆâ€œlightâ€ä¸ºé»˜è®¤å€¼ï¼‰ã€‚const ThemeContext &#x3D; React.createContext(&#39;light&#39;);class App extends React.Component &#123;  render() &#123;    &#x2F;&#x2F; ä½¿ç”¨ä¸€ä¸ª Provider æ¥å°†å½“å‰çš„ theme ä¼ é€’ç»™ä»¥ä¸‹çš„ç»„ä»¶æ ‘ã€‚    &#x2F;&#x2F; æ— è®ºå¤šæ·±ï¼Œä»»ä½•ç»„ä»¶éƒ½èƒ½è¯»å–è¿™ä¸ªå€¼ã€‚    &#x2F;&#x2F; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† â€œdarkâ€ ä½œä¸ºå½“å‰çš„å€¼ä¼ é€’ä¸‹å»ã€‚    return (      &lt;ThemeContext.Provider value&#x3D;&quot;dark&quot;&gt;        &lt;Toolbar &#x2F;&gt;      &lt;&#x2F;ThemeContext.Provider&gt;    );  &#125;&#125;&#x2F;&#x2F; ä¸­é—´çš„ç»„ä»¶å†ä¹Ÿä¸å¿…æŒ‡æ˜å¾€ä¸‹ä¼ é€’ theme äº†ã€‚function Toolbar() &#123;  return (    &lt;div&gt;      &lt;ThemedButton &#x2F;&gt;    &lt;&#x2F;div&gt;  );&#125;class ThemedButton extends React.Component &#123;  &#x2F;&#x2F; æŒ‡å®š contextType è¯»å–å½“å‰çš„ theme contextã€‚  &#x2F;&#x2F; React ä¼šå¾€ä¸Šæ‰¾åˆ°æœ€è¿‘çš„ theme Providerï¼Œç„¶åä½¿ç”¨å®ƒçš„å€¼ã€‚  &#x2F;&#x2F; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“å‰çš„ theme å€¼ä¸º â€œdarkâ€ã€‚  static contextType &#x3D; ThemeContext;  render() &#123;    return &lt;Button theme&#x3D;&#123;this.context&#125; &#x2F;&gt;;  &#125;&#125;</code></pre><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="React-createContext"><a href="#React-createContext" class="headerlink" title="React.createContext"></a>React.createContext</h3><pre><code class="hljs plain">const MyContext &#x3D; React.createContext(defaultValue);</code></pre><p>åˆ›å»ºä¸€ä¸ª Context å¯¹è±¡ã€‚å½“ React æ¸²æŸ“ä¸€ä¸ªè®¢é˜…äº†è¿™ä¸ª Context å¯¹è±¡çš„ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶ä¼šä»ç»„ä»¶æ ‘ä¸­ç¦»è‡ªèº«æœ€è¿‘çš„é‚£ä¸ªåŒ¹é…çš„ Provider ä¸­è¯»å–åˆ°å½“å‰çš„ context å€¼ã€‚</p><p>åªæœ‰å½“ç»„ä»¶æ‰€å¤„çš„æ ‘ä¸­æ²¡æœ‰åŒ¹é…åˆ° Provider æ—¶ï¼Œå…¶ defaultValue å‚æ•°æ‰ä¼šç”Ÿæ•ˆã€‚</p><h3 id="Context-Provider"><a href="#Context-Provider" class="headerlink" title="Context.Provider"></a>Context.Provider</h3><pre><code class="hljs plain">&lt;MyContext.Provider value&#x3D;&#123;&#x2F;* æŸä¸ªå€¼ *&#x2F;&#125;&gt;</code></pre><p>æ¯ä¸ª Context å¯¹è±¡éƒ½ä¼šè¿”å›ä¸€ä¸ª Provider React ç»„ä»¶ï¼Œå®ƒå…è®¸æ¶ˆè´¹ç»„ä»¶è®¢é˜… context çš„å˜åŒ–ã€‚</p><p>Provider æ¥æ”¶ä¸€ä¸ª value å±æ€§ï¼Œä¼ é€’ç»™æ¶ˆè´¹ç»„ä»¶ã€‚ä¸€ä¸ª Provider å¯ä»¥å’Œå¤šä¸ªæ¶ˆè´¹ç»„ä»¶æœ‰å¯¹åº”å…³ç³»ã€‚å¤šä¸ª Provider ä¹Ÿå¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œé‡Œå±‚çš„ä¼šè¦†ç›–å¤–å±‚çš„æ•°æ®ã€‚</p><p>å½“ Provider çš„ value å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå†…éƒ¨çš„æ‰€æœ‰æ¶ˆè´¹ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚Provider åŠå…¶å†…éƒ¨ consumer ç»„ä»¶éƒ½ä¸å—åˆ¶äº shouldComponentUpdate å‡½æ•°ï¼Œå› æ­¤å½“ consumer ç»„ä»¶åœ¨å…¶ç¥–å…ˆç»„ä»¶é€€å‡ºæ›´æ–°çš„æƒ…å†µä¸‹ä¹Ÿèƒ½æ›´æ–°ã€‚</p><p>é€šè¿‡æ–°æ—§å€¼æ£€æµ‹æ¥ç¡®å®šå˜åŒ–ï¼Œä½¿ç”¨äº†ä¸ Object.is ç›¸åŒçš„ç®—æ³•ã€‚</p><h3 id="Class-contextType"><a href="#Class-contextType" class="headerlink" title="Class.contextType"></a>Class.contextType</h3><pre><code class="hljs plain">class MyClass extends React.Component &#123;  componentDidMount() &#123;    let value &#x3D; this.context;    &#x2F;* åœ¨ç»„ä»¶æŒ‚è½½å®Œæˆåï¼Œä½¿ç”¨ MyContext ç»„ä»¶çš„å€¼æ¥æ‰§è¡Œä¸€äº›æœ‰å‰¯ä½œç”¨çš„æ“ä½œ *&#x2F;  &#125;  componentDidUpdate() &#123;    let value &#x3D; this.context;    &#x2F;* ... *&#x2F;  &#125;  componentWillUnmount() &#123;    let value &#x3D; this.context;    &#x2F;* ... *&#x2F;  &#125;  render() &#123;    let value &#x3D; this.context;    &#x2F;* åŸºäº MyContext ç»„ä»¶çš„å€¼è¿›è¡Œæ¸²æŸ“ *&#x2F;  &#125;&#125;MyClass.contextType &#x3D; MyContext;</code></pre><p>æŒ‚è½½åœ¨ class ä¸Šçš„ contextType å±æ€§ä¼šè¢«é‡èµ‹å€¼ä¸ºä¸€ä¸ªç”± React.createContext() åˆ›å»ºçš„ Context å¯¹è±¡ã€‚è¿™èƒ½è®©ä½ ä½¿ç”¨ this.context æ¥æ¶ˆè´¹æœ€è¿‘ Context ä¸Šçš„é‚£ä¸ªå€¼ã€‚ä½ å¯ä»¥åœ¨ä»»ä½•ç”Ÿå‘½å‘¨æœŸä¸­è®¿é—®åˆ°å®ƒï¼ŒåŒ…æ‹¬ render å‡½æ•°ä¸­ã€‚</p><p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨å®éªŒæ€§çš„ public class fields è¯­æ³•ï¼Œä½ å¯ä»¥ä½¿ç”¨ static è¿™ä¸ªç±»å±æ€§æ¥åˆå§‹åŒ–ä½ çš„ contextTypeã€‚</p><pre><code class="hljs plain">class MyClass extends React.Component &#123;  static contextType &#x3D; MyContext;  render() &#123;    let value &#x3D; this.context;    &#x2F;* åŸºäºè¿™ä¸ªå€¼è¿›è¡Œæ¸²æŸ“å·¥ä½œ *&#x2F;  &#125;&#125;</code></pre><p>å¦‚æœæ˜¯å‡½æ•°å¼ç»„ä»¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ï¼š</p><pre><code class="hljs plain">&lt;MyContext.Consumer&gt;  &#123;value &#x3D;&gt; &#x2F;* åŸºäº context å€¼è¿›è¡Œæ¸²æŸ“*&#x2F;&#125;&lt;&#x2F;MyContext.Consumer&gt;</code></pre><h2 id="æ›´å¤æ‚çš„æƒ…å½¢"><a href="#æ›´å¤æ‚çš„æƒ…å½¢" class="headerlink" title="æ›´å¤æ‚çš„æƒ…å½¢"></a>æ›´å¤æ‚çš„æƒ…å½¢</h2><h3 id="åŠ¨æ€Context"><a href="#åŠ¨æ€Context" class="headerlink" title="åŠ¨æ€Context"></a>åŠ¨æ€Context</h3><p>å¯¹äºä¸Šé¢çš„ theme ä¾‹å­ï¼Œä½¿ç”¨åŠ¨æ€å€¼ï¼ˆdynamic valuesï¼‰åæ›´å¤æ‚çš„ç”¨æ³•ï¼š<br><strong>theme-context.js</strong></p><pre><code class="hljs plain">import React from &#39;react&#39;;export const themes &#x3D; &#123;    light: &#123;      foreground: &#39;#000000&#39;,      background: &#39;#eeeeee&#39;,    &#125;,    dark: &#123;      foreground: &#39;#ffffff&#39;,      background: &#39;#222222&#39;,    &#125;,  &#125;;    export const ThemeContext &#x3D; React.createContext(    themes.dark &#x2F;&#x2F; é»˜è®¤å€¼  );</code></pre><p><strong>themedButton.js</strong></p><pre><code class="hljs plain">import React,&#123;Component&#125; from &#39;react&#39;import &#123;ThemeContext&#125; from &#39;.&#x2F;theme-context&#39;;class ThemedButton extends React.Component &#123;  render() &#123;    let props &#x3D; this.props;    let theme &#x3D; this.context;    return (      &lt;button        &#123;...props&#125;        style&#x3D;&#123;&#123;backgroundColor: theme.background&#125;&#125;      &#x2F;&gt;    );  &#125;&#125;ThemedButton.contextType &#x3D; ThemeContext;export default ThemedButton;</code></pre><p><strong>App.js</strong></p><pre><code class="hljs plain">&#x2F;&#x2F; ä¸€ä¸ªä½¿ç”¨ ThemedButton çš„ä¸­é—´ç»„ä»¶function Toolbar(props) &#123;  return (    &lt;ThemedButton onClick&#x3D;&#123;props.changeTheme&#125;&gt;      Change Theme    &lt;&#x2F;ThemedButton&gt;  );&#125;export default class App extends React.Component &#123;  constructor(props) &#123;    super(props);    this.state &#x3D; &#123;      theme: themes.light,    &#125;;    this.toggleTheme &#x3D; () &#x3D;&gt; &#123;      this.setState(state &#x3D;&gt; (&#123;        theme:          state.theme &#x3D;&#x3D;&#x3D; themes.dark            ? themes.light            : themes.dark,      &#125;));    &#125;;  &#125;  render() &#123;    &#x2F;&#x2F; åœ¨ ThemeProvider å†…éƒ¨çš„ ThemedButton æŒ‰é’®ç»„ä»¶ä½¿ç”¨ state ä¸­çš„ theme å€¼ï¼Œ    &#x2F;&#x2F; è€Œå¤–éƒ¨çš„ç»„ä»¶ä½¿ç”¨é»˜è®¤çš„ theme å€¼    return (      &lt;&gt;        &lt;ThemeContext.Provider value&#x3D;&#123;this.state.theme&#125;&gt;          &lt;Toolbar changeTheme&#x3D;&#123;this.toggleTheme&#125; &#x2F;&gt;        &lt;&#x2F;ThemeContext.Provider&gt;        &lt;div&gt;          &lt;ThemedButton &#x2F;&gt;        &lt;&#x2F;div&gt;      &lt;&#x2F;&gt;    );  &#125;&#125;</code></pre><h3 id="åœ¨åµŒå¥—ç»„ä»¶ä¸­æ›´æ–°Context"><a href="#åœ¨åµŒå¥—ç»„ä»¶ä¸­æ›´æ–°Context" class="headerlink" title="åœ¨åµŒå¥—ç»„ä»¶ä¸­æ›´æ–°Context"></a>åœ¨åµŒå¥—ç»„ä»¶ä¸­æ›´æ–°Context</h3><p>ä»ä¸€ä¸ªåœ¨ç»„ä»¶æ ‘ä¸­åµŒå¥—å¾ˆæ·±çš„ç»„ä»¶ä¸­æ›´æ–° context æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡ context ä¼ é€’ä¸€ä¸ªå‡½æ•°ï¼Œä½¿å¾— consumers ç»„ä»¶æ›´æ–° contextã€‚å®é™…å°±æ˜¯å°†æŸä¸ªé«˜å±‚ç»„ä»¶çš„æŸä¸ªæ·±å±‚ç»„ä»¶è¦ç”¨åˆ°çš„stateå’Œæ§åˆ¶stateå˜åŒ–çš„å‡½æ•°ä½œä¸ºcontextï¼Œç„¶åä¸éœ€è¦ä¸€å±‚ä¸€å±‚ä¼ é€’ï¼Œåº•å±‚ç»„ä»¶é€šè¿‡Consumeræ¥è·å–</p><p><strong>theme-context.js</strong></p><pre><code class="hljs plain">&#x2F;&#x2F; ç¡®ä¿ä¼ é€’ç»™ createContext çš„é»˜è®¤å€¼æ•°æ®ç»“æ„æ˜¯è°ƒç”¨çš„ç»„ä»¶ï¼ˆconsumersï¼‰æ‰€èƒ½åŒ¹é…çš„ï¼export const ThemeContext &#x3D; React.createContext(&#123;  theme: themes.dark,  toggleTheme: () &#x3D;&gt; &#123;&#125;,&#125;);</code></pre><p><strong>theme-toggler-button.js</strong></p><pre><code class="hljs plain">import &#123;ThemeContext&#125; from &#39;.&#x2F;theme-context&#39;;function ThemeTogglerButton() &#123;  &#x2F;&#x2F; Theme Toggler æŒ‰é’®ä¸ä»…ä»…åªè·å– theme å€¼ï¼Œå®ƒä¹Ÿä» context ä¸­è·å–åˆ°ä¸€ä¸ª toggleTheme å‡½æ•°  return (    &lt;ThemeContext.Consumer&gt;      &#123;(&#123;theme, toggleTheme&#125;) &#x3D;&gt; (        &lt;button          onClick&#x3D;&#123;toggleTheme&#125;          style&#x3D;&#123;&#123;backgroundColor: theme.background&#125;&#125;&gt;          Toggle Theme        &lt;&#x2F;button&gt;      )&#125;    &lt;&#x2F;ThemeContext.Consumer&gt;  );&#125;export default ThemeTogglerButton;</code></pre><p><strong>app.js</strong></p><pre><code class="hljs plain">import &#123;ThemeContext, themes&#125; from &#39;.&#x2F;theme-context&#39;;import ThemeTogglerButton from &#39;.&#x2F;theme-toggler-button&#39;;class App extends React.Component &#123;  constructor(props) &#123;    super(props);    this.toggleTheme &#x3D; () &#x3D;&gt; &#123;      this.setState(state &#x3D;&gt; (&#123;        theme:          state.theme &#x3D;&#x3D;&#x3D; themes.dark            ? themes.light            : themes.dark,      &#125;));    &#125;;    &#x2F;&#x2F; State ä¹ŸåŒ…å«äº†æ›´æ–°å‡½æ•°ï¼Œå› æ­¤å®ƒä¼šè¢«ä¼ é€’è¿› context providerã€‚    this.state &#x3D; &#123;      theme: themes.light,      toggleTheme: this.toggleTheme,    &#125;;  &#125;  render() &#123;    &#x2F;&#x2F; æ•´ä¸ª state éƒ½è¢«ä¼ é€’è¿› provider    return (      &lt;ThemeContext.Provider value&#x3D;&#123;this.state&#125;&gt;        &lt;Content &#x2F;&gt;      &lt;&#x2F;ThemeContext.Provider&gt;    );  &#125;&#125;function Content() &#123;  return (    &lt;div&gt;      &lt;ThemeTogglerButton &#x2F;&gt;    &lt;&#x2F;div&gt;  );&#125;ReactDOM.render(&lt;App &#x2F;&gt;, document.root);</code></pre><h3 id="æ¶ˆè´¹å¤šä¸ªContext"><a href="#æ¶ˆè´¹å¤šä¸ªContext" class="headerlink" title="æ¶ˆè´¹å¤šä¸ªContext"></a>æ¶ˆè´¹å¤šä¸ªContext</h3><p>ä¸ºäº†ç¡®ä¿ context å¿«é€Ÿè¿›è¡Œé‡æ¸²æŸ“ï¼ŒReact éœ€è¦ä½¿æ¯ä¸€ä¸ª consumers ç»„ä»¶çš„ context åœ¨ç»„ä»¶æ ‘ä¸­æˆä¸ºä¸€ä¸ªå•ç‹¬çš„èŠ‚ç‚¹ã€‚</p><pre><code class="hljs plain">&#x2F;&#x2F; Theme contextï¼Œé»˜è®¤çš„ theme æ˜¯ â€œlightâ€ å€¼const ThemeContext &#x3D; React.createContext(&#39;light&#39;);&#x2F;&#x2F; ç”¨æˆ·ç™»å½• contextconst UserContext &#x3D; React.createContext(&#123;  name: &#39;Guest&#39;,&#125;);class App extends React.Component &#123;  render() &#123;    const &#123;signedInUser, theme&#125; &#x3D; this.props;    &#x2F;&#x2F; æä¾›åˆå§‹ context å€¼çš„ App ç»„ä»¶    return (      &lt;ThemeContext.Provider value&#x3D;&#123;theme&#125;&gt;        &lt;UserContext.Provider value&#x3D;&#123;signedInUser&#125;&gt;          &lt;Layout &#x2F;&gt;        &lt;&#x2F;UserContext.Provider&gt;      &lt;&#x2F;ThemeContext.Provider&gt;    );  &#125;&#125;function Layout() &#123;  return (    &lt;div&gt;      &lt;Sidebar &#x2F;&gt;      &lt;Content &#x2F;&gt;    &lt;&#x2F;div&gt;  );&#125;&#x2F;&#x2F; ä¸€ä¸ªç»„ä»¶å¯èƒ½ä¼šæ¶ˆè´¹å¤šä¸ª contextfunction Content() &#123;  return (    &lt;ThemeContext.Consumer&gt;      &#123;theme &#x3D;&gt; (        &lt;UserContext.Consumer&gt;          &#123;user &#x3D;&gt; (            &lt;ProfilePage user&#x3D;&#123;user&#125; theme&#x3D;&#123;theme&#125; &#x2F;&gt;          )&#125;        &lt;&#x2F;UserContext.Consumer&gt;      )&#125;    &lt;&#x2F;ThemeContext.Consumer&gt;  );&#125;</code></pre><p>å¦‚æœä¸¤ä¸ªæˆ–è€…æ›´å¤šçš„ context å€¼ç»å¸¸è¢«ä¸€èµ·ä½¿ç”¨ï¼Œé‚£ä½ å¯èƒ½è¦è€ƒè™‘ä¸€ä¸‹å¦å¤–åˆ›å»ºä½ è‡ªå·±çš„æ¸²æŸ“ç»„ä»¶ï¼Œä»¥æä¾›è¿™äº›å€¼ã€‚</p><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><p>ä¸Šé¢ä¹‹æ‰€ä»¥è¦å°†å€¼æ”¾åˆ°é«˜å±‚ç»„ä»¶çš„stateä¸­ï¼Œæ˜¯å› ä¸º context ä¼šä½¿ç”¨å‚è€ƒæ ‡è¯†ï¼ˆreference identityï¼‰æ¥å†³å®šä½•æ—¶è¿›è¡Œæ¸²æŸ“ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€äº›é™·é˜±ï¼Œå½“ provider çš„çˆ¶ç»„ä»¶è¿›è¡Œé‡æ¸²æŸ“æ—¶ï¼Œå¯èƒ½ä¼šåœ¨ consumers ç»„ä»¶ä¸­è§¦å‘æ„å¤–çš„æ¸²æŸ“ã€‚</p><h1 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h1><p>Hook æ˜¯ React 16.8 çš„æ–°å¢ç‰¹æ€§ã€‚å®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™ class çš„æƒ…å†µä¸‹ä½¿ç”¨ state ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§ã€‚</p><p>Hook æ˜¯ React 16.8 çš„æ–°å¢ç‰¹æ€§ã€‚å®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™ class çš„æƒ…å†µä¸‹ä½¿ç”¨ state ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§ã€‚</p><h2 id="è¯ç”ŸåŸå› "><a href="#è¯ç”ŸåŸå› " class="headerlink" title="è¯ç”ŸåŸå› "></a>è¯ç”ŸåŸå› </h2><ul><li>åœ¨ç»„ä»¶ä¹‹é—´å¤ç”¨çŠ¶æ€é€»è¾‘å¾ˆéš¾</li><li>å¤æ‚ç»„ä»¶å˜å¾—éš¾ä»¥ç†è§£<br>æˆ‘ä»¬ç»å¸¸ç»´æŠ¤ä¸€äº›ç»„ä»¶ï¼Œç»„ä»¶èµ·åˆå¾ˆç®€å•ï¼Œä½†æ˜¯é€æ¸ä¼šè¢«çŠ¶æ€é€»è¾‘å’Œå‰¯ä½œç”¨å……æ–¥ã€‚æ¯ä¸ªç”Ÿå‘½å‘¨æœŸå¸¸å¸¸åŒ…å«ä¸€äº›ä¸ç›¸å…³çš„é€»è¾‘ã€‚åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸å¯èƒ½å°†ç»„ä»¶æ‹†åˆ†ä¸ºæ›´å°çš„ç²’åº¦ï¼Œå› ä¸ºçŠ¶æ€é€»è¾‘æ— å¤„ä¸åœ¨ã€‚è¿™ä¹Ÿç»™æµ‹è¯•å¸¦æ¥äº†ä¸€å®šæŒ‘æˆ˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHook å°†ç»„ä»¶ä¸­ç›¸äº’å…³è”çš„éƒ¨åˆ†æ‹†åˆ†æˆæ›´å°çš„å‡½æ•°ï¼ˆæ¯”å¦‚è®¾ç½®è®¢é˜…æˆ–è¯·æ±‚æ•°æ®ï¼‰ï¼Œè€Œå¹¶éå¼ºåˆ¶æŒ‰ç…§ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ reducer æ¥ç®¡ç†ç»„ä»¶çš„å†…éƒ¨çŠ¶æ€ï¼Œä½¿å…¶æ›´åŠ å¯é¢„æµ‹ã€‚</li><li>éš¾ä»¥ç†è§£çš„ class<br>Hook ä½¿ä½ åœ¨é class çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨æ›´å¤šçš„ React ç‰¹æ€§ã€‚ ä»æ¦‚å¿µä¸Šè®²ï¼ŒReact ç»„ä»¶ä¸€ç›´æ›´åƒæ˜¯å‡½æ•°ã€‚è€Œ Hook åˆ™æ‹¥æŠ±äº†å‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿæ²¡æœ‰ç‰ºç‰² React çš„ç²¾ç¥åŸåˆ™ã€‚Hook æä¾›äº†é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œæ— éœ€å­¦ä¹ å¤æ‚çš„å‡½æ•°å¼æˆ–å“åº”å¼ç¼–ç¨‹æŠ€æœ¯ã€‚</li></ul><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>å…ˆçœ‹ä¸ªä¾‹å­</p><pre><code class="hljs plain">import React, &#123; useState &#125; from &#39;react&#39;;function Example() &#123;  &#x2F;&#x2F; å£°æ˜ä¸€ä¸ªå« â€œcountâ€ çš„ state å˜é‡ã€‚  const [count, setCount] &#x3D; useState(0);  return (    &lt;div&gt;      &lt;p&gt;You clicked &#123;count&#125; times&lt;&#x2F;p&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; setCount(count + 1)&#125;&gt;        Click me      &lt;&#x2F;button&gt;    &lt;&#x2F;div&gt;  );&#125;</code></pre><p>useState å°±æ˜¯ä¸€ä¸ª Hook ï¼ˆç­‰ä¸‹æˆ‘ä»¬ä¼šè®²åˆ°è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼‰ã€‚é€šè¿‡åœ¨å‡½æ•°ç»„ä»¶é‡Œè°ƒç”¨å®ƒæ¥ç»™ç»„ä»¶æ·»åŠ ä¸€äº›å†…éƒ¨ stateã€‚React ä¼šåœ¨é‡å¤æ¸²æŸ“æ—¶ä¿ç•™è¿™ä¸ª stateã€‚useState ä¼šè¿”å›ä¸€å¯¹å€¼ï¼šå½“å‰çŠ¶æ€å’Œä¸€ä¸ªè®©ä½ æ›´æ–°å®ƒçš„å‡½æ•°ï¼Œä½ å¯ä»¥åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æˆ–å…¶ä»–ä¸€äº›åœ°æ–¹è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚å®ƒç±»ä¼¼ class ç»„ä»¶çš„ this.setStateï¼Œä½†æ˜¯å®ƒä¸ä¼šæŠŠæ–°çš„ state å’Œæ—§çš„ state è¿›è¡Œåˆå¹¶ã€‚<br>useState å”¯ä¸€çš„å‚æ•°å°±æ˜¯åˆå§‹ stateã€‚ä¸åŒäº this.stateï¼Œè¿™é‡Œçš„ state ä¸ä¸€å®šè¦æ˜¯ä¸€ä¸ªå¯¹è±¡.</p><p><strong>å£°æ˜å¤šä¸ªstateå˜é‡</strong></p><pre><code class="hljs plain">function ExampleWithManyStates() &#123;  &#x2F;&#x2F; å£°æ˜å¤šä¸ª state å˜é‡ï¼  const [age, setAge] &#x3D; useState(42);  const [fruit, setFruit] &#x3D; useState(&#39;banana&#39;);  const [todos, setTodos] &#x3D; useState([&#123; text: &#39;Learn Hooks&#39; &#125;]);  &#x2F;&#x2F; ...&#125;</code></pre><p><strong>ä»€ä¹ˆæ˜¯Hook</strong><br>Hook æ˜¯ä¸€äº›å¯ä»¥è®©ä½ åœ¨å‡½æ•°ç»„ä»¶é‡Œâ€œé’©å…¥â€ React state åŠç”Ÿå‘½å‘¨æœŸç­‰ç‰¹æ€§çš„å‡½æ•°ã€‚Hook ä¸èƒ½åœ¨ class ç»„ä»¶ä¸­ä½¿ç”¨ â€”â€” è¿™ä½¿å¾—ä½ ä¸ä½¿ç”¨ class ä¹Ÿèƒ½ä½¿ç”¨ Reactã€‚ï¼ˆæˆ‘ä»¬ä¸æ¨èæŠŠä½ å·²æœ‰çš„ç»„ä»¶å…¨éƒ¨é‡å†™ï¼Œä½†æ˜¯ä½ å¯ä»¥åœ¨æ–°ç»„ä»¶é‡Œå¼€å§‹ä½¿ç”¨ Hookã€‚ï¼‰</p><p>React å†…ç½®äº†ä¸€äº›åƒ useState è¿™æ ·çš„ Hookã€‚ä½ ä¹Ÿå¯ä»¥åˆ›å»ºä½ è‡ªå·±çš„ Hook æ¥å¤ç”¨ä¸åŒç»„ä»¶ä¹‹é—´çš„çŠ¶æ€é€»è¾‘ã€‚æˆ‘ä»¬å…ˆä»‹ç»è¿™äº›å†…ç½®çš„ Hookã€‚</p><h2 id="Effect-Hook"><a href="#Effect-Hook" class="headerlink" title="Effect Hook"></a>Effect Hook</h2><p>ä½ ä¹‹å‰å¯èƒ½å·²ç»åœ¨ React ç»„ä»¶ä¸­æ‰§è¡Œè¿‡æ•°æ®è·å–ã€è®¢é˜…æˆ–è€…æ‰‹åŠ¨ä¿®æ”¹è¿‡ DOMã€‚æˆ‘ä»¬ç»Ÿä¸€æŠŠè¿™äº›æ“ä½œç§°ä¸ºâ€œå‰¯ä½œç”¨â€ï¼Œæˆ–è€…ç®€ç§°ä¸ºâ€œä½œç”¨â€ã€‚</p><p>useEffect å°±æ˜¯ä¸€ä¸ª Effect Hookï¼Œç»™å‡½æ•°ç»„ä»¶å¢åŠ äº†æ“ä½œå‰¯ä½œç”¨çš„èƒ½åŠ›ã€‚å®ƒè·Ÿ class ç»„ä»¶ä¸­çš„ componentDidMountã€componentDidUpdate å’Œ componentWillUnmount å…·æœ‰ç›¸åŒçš„ç”¨é€”ï¼Œåªä¸è¿‡è¢«åˆå¹¶æˆäº†ä¸€ä¸ª APIã€‚</p><pre><code class="hljs plain">import React, &#123; useState, useEffect &#125; from &#39;react&#39;;function Example() &#123;  const [count, setCount] &#x3D; useState(0);  &#x2F;&#x2F; ç›¸å½“äº componentDidMount å’Œ componentDidUpdate:  useEffect(() &#x3D;&gt; &#123;    &#x2F;&#x2F; ä½¿ç”¨æµè§ˆå™¨çš„ API æ›´æ–°é¡µé¢æ ‡é¢˜    document.title &#x3D; &#96;You clicked $&#123;count&#125; times&#96;;  &#125;);  return (    &lt;div&gt;      &lt;p&gt;You clicked &#123;count&#125; times&lt;&#x2F;p&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; setCount(count + 1)&#125;&gt;        Click me      &lt;&#x2F;button&gt;    &lt;&#x2F;div&gt;  );&#125;</code></pre><p>å½“ä½ è°ƒç”¨ useEffect æ—¶ï¼Œå°±æ˜¯åœ¨å‘Šè¯‰ React åœ¨å®Œæˆå¯¹ DOM çš„æ›´æ”¹åè¿è¡Œä½ çš„â€œå‰¯ä½œç”¨â€å‡½æ•°ã€‚ç”±äºå‰¯ä½œç”¨å‡½æ•°æ˜¯åœ¨ç»„ä»¶å†…å£°æ˜çš„ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥è®¿é—®åˆ°ç»„ä»¶çš„ props å’Œ stateã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒReact ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åè°ƒç”¨å‰¯ä½œç”¨å‡½æ•° â€”â€” åŒ…æ‹¬ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™ã€‚</p><p>å‰¯ä½œç”¨å‡½æ•°è¿˜å¯ä»¥é€šè¿‡è¿”å›ä¸€ä¸ªå‡½æ•°æ¥æŒ‡å®šå¦‚ä½•â€œæ¸…é™¤â€å‰¯ä½œç”¨ã€‚</p><pre><code class="hljs plain">import React, &#123; useState, useEffect &#125; from &#39;react&#39;;function FriendStatus(props) &#123;  const [isOnline, setIsOnline] &#x3D; useState(null);  function handleStatusChange(status) &#123;    setIsOnline(status.isOnline);  &#125;  useEffect(() &#x3D;&gt; &#123;    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);    return () &#x3D;&gt; &#123;      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);    &#125;;  &#125;);  if (isOnline &#x3D;&#x3D;&#x3D; null) &#123;    return &#39;Loading...&#39;;  &#125;  return isOnline ? &#39;Online&#39; : &#39;Offline&#39;;&#125;</code></pre><p>è·Ÿ useState ä¸€æ ·ï¼Œä½ å¯ä»¥åœ¨ç»„ä»¶ä¸­å¤šæ¬¡ä½¿ç”¨ useEffectã€‚<br>é€šè¿‡ä½¿ç”¨ Hookï¼Œä½ å¯ä»¥æŠŠç»„ä»¶å†…ç›¸å…³çš„å‰¯ä½œç”¨ç»„ç»‡åœ¨ä¸€èµ·ï¼ˆä¾‹å¦‚åˆ›å»ºè®¢é˜…åŠå–æ¶ˆè®¢é˜…ï¼‰ï¼Œè€Œä¸è¦æŠŠå®ƒä»¬æ‹†åˆ†åˆ°ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°é‡Œã€‚</p><h2 id="hookä½¿ç”¨è§„åˆ™"><a href="#hookä½¿ç”¨è§„åˆ™" class="headerlink" title="hookä½¿ç”¨è§„åˆ™"></a>hookä½¿ç”¨è§„åˆ™</h2><p>Hook å°±æ˜¯ JavaScript å‡½æ•°ï¼Œä½†æ˜¯ä½¿ç”¨å®ƒä»¬ä¼šæœ‰ä¸¤ä¸ªé¢å¤–çš„è§„åˆ™ï¼š</p><ul><li>åªèƒ½åœ¨å‡½æ•°æœ€å¤–å±‚è°ƒç”¨ Hookã€‚ä¸è¦åœ¨å¾ªç¯ã€æ¡ä»¶åˆ¤æ–­æˆ–è€…å­å‡½æ•°ä¸­è°ƒç”¨ã€‚</li><li>åªèƒ½åœ¨ React çš„å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨ Hookã€‚ä¸è¦åœ¨å…¶ä»– JavaScript å‡½æ•°ä¸­è°ƒç”¨ã€‚ï¼ˆè¿˜æœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥è°ƒç”¨ Hook â€”â€” å°±æ˜¯è‡ªå®šä¹‰çš„ Hook ä¸­ï¼Œæˆ‘ä»¬ç¨åä¼šå­¦ä¹ åˆ°ã€‚ï¼‰</li></ul><h2 id="è‡ªå®šä¹‰Hook"><a href="#è‡ªå®šä¹‰Hook" class="headerlink" title="è‡ªå®šä¹‰Hook"></a>è‡ªå®šä¹‰Hook</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæƒ³è¦åœ¨ç»„ä»¶ä¹‹é—´é‡ç”¨ä¸€äº›çŠ¶æ€é€»è¾‘ã€‚ç›®å‰ä¸ºæ­¢ï¼Œæœ‰ä¸¤ç§ä¸»æµæ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šé«˜é˜¶ç»„ä»¶å’Œ render propsã€‚è‡ªå®šä¹‰ Hook å¯ä»¥è®©ä½ åœ¨ä¸å¢åŠ ç»„ä»¶çš„æƒ…å†µä¸‹è¾¾åˆ°åŒæ ·çš„ç›®çš„ã€‚</p><pre><code class="hljs plain">import React, &#123; useState, useEffect &#125; from &#39;react&#39;;function useFriendStatus(friendID) &#123;  const [isOnline, setIsOnline] &#x3D; useState(null);  function handleStatusChange(status) &#123;    setIsOnline(status.isOnline);  &#125;  useEffect(() &#x3D;&gt; &#123;    ChatAPI.subscribeToFriendStatus(friendID, handleStatusChange);    return () &#x3D;&gt; &#123;      ChatAPI.unsubscribeFromFriendStatus(friendID, handleStatusChange);    &#125;;  &#125;);  return isOnline;&#125;</code></pre><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ä¸¤ä¸ªç»„ä»¶ä¸­ä½¿ç”¨å®ƒï¼š</p><pre><code class="hljs plain">function FriendStatus(props) &#123;  const isOnline &#x3D; useFriendStatus(props.friend.id);  if (isOnline &#x3D;&#x3D;&#x3D; null) &#123;    return &#39;Loading...&#39;;  &#125;  return isOnline ? &#39;Online&#39; : &#39;Offline&#39;;&#125;</code></pre><pre><code class="hljs plain">function FriendListItem(props) &#123;  const isOnline &#x3D; useFriendStatus(props.friend.id);  return (    &lt;li style&#x3D;&#123;&#123; color: isOnline ? &#39;green&#39; : &#39;black&#39; &#125;&#125;&gt;      &#123;props.friend.name&#125;    &lt;&#x2F;li&gt;  );&#125;</code></pre><p>è¿™ä¸¤ä¸ªç»„ä»¶çš„ state æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚Hook æ˜¯ä¸€ç§å¤ç”¨çŠ¶æ€é€»è¾‘çš„æ–¹å¼ï¼Œå®ƒä¸å¤ç”¨ state æœ¬èº«ã€‚äº‹å®ä¸Š Hook çš„æ¯æ¬¡è°ƒç”¨éƒ½æœ‰ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ state â€”â€” å› æ­¤ä½ å¯ä»¥åœ¨å•ä¸ªç»„ä»¶ä¸­å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªè‡ªå®šä¹‰ Hookã€‚</p><p>è‡ªå®šä¹‰ Hook æ›´åƒæ˜¯ä¸€ç§çº¦å®šè€Œä¸æ˜¯åŠŸèƒ½ã€‚å¦‚æœå‡½æ•°çš„åå­—ä»¥ â€œuseâ€ å¼€å¤´å¹¶è°ƒç”¨å…¶ä»– Hookï¼Œæˆ‘ä»¬å°±è¯´è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ Hookã€‚ useSomething çš„å‘½åçº¦å®šå¯ä»¥è®©æˆ‘ä»¬çš„ linter æ’ä»¶åœ¨ä½¿ç”¨ Hook çš„ä»£ç ä¸­æ‰¾åˆ° bugã€‚</p><p>ä½ å¯ä»¥åˆ›å»ºæ¶µç›–å„ç§åœºæ™¯çš„è‡ªå®šä¹‰ Hookï¼Œå¦‚è¡¨å•å¤„ç†ã€åŠ¨ç”»ã€è®¢é˜…å£°æ˜ã€è®¡æ—¶å™¨ï¼Œç”šè‡³å¯èƒ½è¿˜æœ‰æ›´å¤šæˆ‘ä»¬æ²¡æƒ³åˆ°çš„åœºæ™¯ã€‚æˆ‘ä»¬å¾ˆæœŸå¾…çœ‹åˆ° React ç¤¾åŒºä¼šå‡ºç°ä»€ä¹ˆæ ·çš„è‡ªå®šä¹‰ Hookã€‚</p><h2 id="å…¶å®ƒhook"><a href="#å…¶å®ƒhook" class="headerlink" title="å…¶å®ƒhook"></a>å…¶å®ƒhook</h2><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä½¿ç”¨é¢‘ç‡è¾ƒä½çš„ä½†æ˜¯å¾ˆæœ‰ç”¨çš„ Hookã€‚æ¯”å¦‚ï¼ŒuseContext è®©ä½ ä¸ä½¿ç”¨ç»„ä»¶åµŒå¥—å°±å¯ä»¥è®¢é˜… React çš„ Contextã€‚</p><pre><code class="hljs plain">function Example() &#123;  const locale &#x3D; useContext(LocaleContext);  const theme &#x3D; useContext(ThemeContext);  &#x2F;&#x2F; ...&#125;</code></pre><p>å¦å¤– useReducer å¯ä»¥è®©ä½ é€šè¿‡ reducer æ¥ç®¡ç†ç»„ä»¶æœ¬åœ°çš„å¤æ‚ stateã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›ä¸€æ­¥çš„æ¥çœ‹è¿™äº›APIåˆ°åº•åšäº†ä»€ä¹ˆã€‚</p><h2 id="useStateæ–¹æ³•è¯´æ˜"><a href="#useStateæ–¹æ³•è¯´æ˜" class="headerlink" title="useStateæ–¹æ³•è¯´æ˜"></a>useStateæ–¹æ³•è¯´æ˜</h2><p>è°ƒç”¨ useState æ–¹æ³•çš„æ—¶å€™åšäº†ä»€ä¹ˆ? å®ƒå®šä¹‰ä¸€ä¸ª â€œstate å˜é‡â€ã€‚æˆ‘ä»¬çš„å˜é‡å« countï¼Œ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å«ä»–ä»»ä½•åå­—ï¼Œæ¯”å¦‚ bananaã€‚è¿™æ˜¯ä¸€ç§åœ¨å‡½æ•°è°ƒç”¨æ—¶ä¿å­˜å˜é‡çš„æ–¹å¼ â€”â€” useState æ˜¯ä¸€ç§æ–°æ–¹æ³•ï¼Œå®ƒä¸ class é‡Œé¢çš„ this.state æä¾›çš„åŠŸèƒ½å®Œå…¨ç›¸åŒã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨å‡½æ•°é€€å‡ºåå˜é‡å°±ä¼šâ€æ¶ˆå¤±â€ï¼Œè€Œ state ä¸­çš„å˜é‡ä¼šè¢« React ä¿ç•™ã€‚</p><p>useState éœ€è¦å“ªäº›å‚æ•°ï¼Ÿ useState() æ–¹æ³•é‡Œé¢å”¯ä¸€çš„å‚æ•°å°±æ˜¯åˆå§‹ stateã€‚ä¸åŒäº class çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§éœ€è¦ä½¿ç”¨æ•°å­—æˆ–å­—ç¬¦ä¸²å¯¹å…¶è¿›è¡Œèµ‹å€¼ï¼Œè€Œä¸ä¸€å®šæ˜¯å¯¹è±¡ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œåªéœ€ä½¿ç”¨æ•°å­—æ¥è®°å½•ç”¨æˆ·ç‚¹å‡»æ¬¡æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ äº† 0 ä½œä¸ºå˜é‡çš„åˆå§‹ stateã€‚ï¼ˆå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨ state ä¸­å­˜å‚¨ä¸¤ä¸ªä¸åŒçš„å˜é‡ï¼Œåªéœ€è°ƒç”¨ useState() ä¸¤æ¬¡å³å¯ã€‚ï¼‰</p><p>useState æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä»€ä¹ˆï¼Ÿ è¿”å›å€¼ä¸ºï¼šå½“å‰ state ä»¥åŠæ›´æ–° state çš„å‡½æ•°ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å†™ const [count, setCount] = useState() çš„åŸå› ã€‚è¿™ä¸ class é‡Œé¢ this.state.count å’Œ this.setState ç±»ä¼¼ï¼Œå”¯ä¸€åŒºåˆ«å°±æ˜¯ä½ éœ€è¦æˆå¯¹çš„è·å–å®ƒä»¬ã€‚</p><p>ä½ ä¸å¿…ä½¿ç”¨å¤šä¸ª state å˜é‡ã€‚State å˜é‡å¯ä»¥å¾ˆå¥½åœ°å­˜å‚¨å¯¹è±¡å’Œæ•°ç»„ï¼Œå› æ­¤ï¼Œä½ ä»ç„¶å¯ä»¥å°†ç›¸å…³æ•°æ®åˆ†ä¸ºä¸€ç»„ã€‚ç„¶è€Œï¼Œä¸åƒ class ä¸­çš„ this.setStateï¼Œæ›´æ–° state å˜é‡æ€»æ˜¯æ›¿æ¢å®ƒè€Œä¸æ˜¯åˆå¹¶å®ƒã€‚</p><h2 id="ä½¿ç”¨Effect-Hook"><a href="#ä½¿ç”¨Effect-Hook" class="headerlink" title="ä½¿ç”¨Effect Hook"></a>ä½¿ç”¨Effect Hook</h2><p>åœ¨ React ç»„ä»¶ä¸­æœ‰ä¸¤ç§å¸¸è§å‰¯ä½œç”¨æ“ä½œï¼šéœ€è¦æ¸…é™¤çš„å’Œä¸éœ€è¦æ¸…é™¤çš„ã€‚æˆ‘ä»¬æ¥æ›´ä»”ç»†åœ°çœ‹ä¸€ä¸‹ä»–ä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚</p><h3 id="æ— éœ€æ¸…é™¤çš„effect"><a href="#æ— éœ€æ¸…é™¤çš„effect" class="headerlink" title="æ— éœ€æ¸…é™¤çš„effect"></a>æ— éœ€æ¸…é™¤çš„effect</h3><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åªæƒ³åœ¨ React æ›´æ–° DOM ä¹‹åè¿è¡Œä¸€äº›é¢å¤–çš„ä»£ç ã€‚æ¯”å¦‚<strong>å‘é€ç½‘ç»œè¯·æ±‚ï¼Œæ‰‹åŠ¨å˜æ›´ DOMï¼Œè®°å½•æ—¥å¿—</strong>ï¼Œè¿™äº›éƒ½æ˜¯å¸¸è§çš„æ— éœ€æ¸…é™¤çš„æ“ä½œã€‚å› ä¸ºæˆ‘ä»¬åœ¨æ‰§è¡Œå®Œè¿™äº›æ“ä½œä¹‹åï¼Œå°±å¯ä»¥å¿½ç•¥ä»–ä»¬äº†ã€‚è®©æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨ class å’Œ Hook éƒ½æ˜¯æ€ä¹ˆå®ç°è¿™äº›å‰¯ä½œç”¨çš„ã€‚</p><p><strong>class</strong>:</p><pre><code class="hljs plain">class Example extends React.Component &#123;  constructor(props) &#123;    super(props);    this.state &#x3D; &#123;      count: 0    &#125;;  &#125;  componentDidMount() &#123;    document.title &#x3D; &#96;You clicked $&#123;this.state.count&#125; times&#96;;  &#125;  componentDidUpdate() &#123;    document.title &#x3D; &#96;You clicked $&#123;this.state.count&#125; times&#96;;  &#125;  render() &#123;    return (      &lt;div&gt;        &lt;p&gt;You clicked &#123;this.state.count&#125; times&lt;&#x2F;p&gt;        &lt;button onClick&#x3D;&#123;() &#x3D;&gt; this.setState(&#123; count: this.state.count + 1 &#125;)&#125;&gt;          Click me        &lt;&#x2F;button&gt;      &lt;&#x2F;div&gt;    );  &#125;&#125;</code></pre><p><strong>ä½¿ç”¨Hook</strong>ï¼š</p><pre><code class="hljs plain">import React, &#123; useState, useEffect &#125; from &#39;react&#39;;function Example() &#123;  const [count, setCount] &#x3D; useState(0);  useEffect(() &#x3D;&gt; &#123;    document.title &#x3D; &#96;You clicked $&#123;count&#125; times&#96;;  &#125;);  return (    &lt;div&gt;      &lt;p&gt;You clicked &#123;count&#125; times&lt;&#x2F;p&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; setCount(count + 1)&#125;&gt;        Click me      &lt;&#x2F;button&gt;    &lt;&#x2F;div&gt;  );&#125;</code></pre><p>useEffect åšäº†ä»€ä¹ˆï¼Ÿ é€šè¿‡ä½¿ç”¨è¿™ä¸ª Hookï¼Œä½ å¯ä»¥å‘Šè¯‰ React ç»„ä»¶éœ€è¦åœ¨æ¸²æŸ“åæ‰§è¡ŒæŸäº›æ“ä½œã€‚</p><p>useEffect ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œå—ï¼Ÿ æ˜¯çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹åå’Œæ¯æ¬¡æ›´æ–°ä¹‹åéƒ½ä¼šæ‰§è¡Œã€‚ï¼ˆæˆ‘ä»¬ç¨åä¼šè°ˆåˆ°å¦‚ä½•æ§åˆ¶å®ƒã€‚ï¼‰ä½ å¯èƒ½ä¼šæ›´å®¹æ˜“æ¥å— effect å‘ç”Ÿåœ¨â€œæ¸²æŸ“ä¹‹åâ€è¿™ç§æ¦‚å¿µï¼Œä¸ç”¨å†å»è€ƒè™‘â€œæŒ‚è½½â€è¿˜æ˜¯â€œæ›´æ–°â€ã€‚React ä¿è¯äº†æ¯æ¬¡è¿è¡Œ effect çš„åŒæ—¶ï¼ŒDOM éƒ½å·²ç»æ›´æ–°å®Œæ¯•ã€‚</p><p>ä¸ componentDidMount æˆ– componentDidUpdate ä¸åŒï¼Œä½¿ç”¨ useEffect è°ƒåº¦çš„ effect ä¸ä¼šé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•ï¼Œè¿™è®©ä½ çš„åº”ç”¨çœ‹èµ·æ¥å“åº”æ›´å¿«ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œeffect ä¸éœ€è¦åŒæ­¥åœ°æ‰§è¡Œã€‚åœ¨ä¸ªåˆ«æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚æµ‹é‡å¸ƒå±€ï¼‰ï¼Œæœ‰å•ç‹¬çš„ useLayoutEffect Hook ä¾›ä½ ä½¿ç”¨ï¼Œå…¶ API ä¸ useEffect ç›¸åŒã€‚</p><h3 id="éœ€è¦æ¸…é™¤çš„effect"><a href="#éœ€è¦æ¸…é™¤çš„effect" class="headerlink" title="éœ€è¦æ¸…é™¤çš„effect"></a>éœ€è¦æ¸…é™¤çš„effect</h3><p>ä¹‹å‰ï¼Œæˆ‘ä»¬ç ”ç©¶äº†å¦‚ä½•ä½¿ç”¨ä¸éœ€è¦æ¸…é™¤çš„å‰¯ä½œç”¨ï¼Œè¿˜æœ‰ä¸€äº›å‰¯ä½œç”¨æ˜¯éœ€è¦æ¸…é™¤çš„ã€‚ä¾‹å¦‚è®¢é˜…å¤–éƒ¨æ•°æ®æºã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ¸…é™¤å·¥ä½œæ˜¯éå¸¸é‡è¦çš„ï¼Œå¯ä»¥é˜²æ­¢å¼•èµ·å†…å­˜æ³„éœ²ï¼ç°åœ¨è®©æˆ‘ä»¬æ¥æ¯”è¾ƒä¸€ä¸‹å¦‚ä½•ç”¨ Class å’Œ Hook æ¥å®ç°ã€‚</p><p>åœ¨ React class ä¸­ï¼Œä½ é€šå¸¸ä¼šåœ¨ componentDidMount ä¸­è®¾ç½®è®¢é˜…ï¼Œå¹¶åœ¨ componentWillUnmount ä¸­æ¸…é™¤å®ƒã€‚</p><p>ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª ChatAPI æ¨¡å—ï¼Œå®ƒå…è®¸æˆ‘ä»¬è®¢é˜…å¥½å‹çš„åœ¨çº¿çŠ¶æ€ã€‚<br><strong>ä½¿ç”¨class</strong><br>ç•¥</p><p><strong>ä½¿ç”¨Hook</strong><br>ä½ å¯èƒ½è®¤ä¸ºéœ€è¦å•ç‹¬çš„ effect æ¥æ‰§è¡Œæ¸…é™¤æ“ä½œã€‚ä½†ç”±äºæ·»åŠ å’Œåˆ é™¤è®¢é˜…çš„ä»£ç çš„ç´§å¯†æ€§ï¼Œæ‰€ä»¥ useEffect çš„è®¾è®¡æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹æ‰§è¡Œã€‚<strong>å¦‚æœä½ çš„ effect è¿”å›ä¸€ä¸ªå‡½æ•°ï¼ŒReact å°†ä¼šåœ¨æ‰§è¡Œæ¸…é™¤æ“ä½œæ—¶è°ƒç”¨å®ƒ</strong>ï¼š</p><pre><code class="hljs plain">import React, &#123; useState, useEffect &#125; from &#39;react&#39;;function FriendStatus(props) &#123;  const [isOnline, setIsOnline] &#x3D; useState(null);  useEffect(() &#x3D;&gt; &#123;    function handleStatusChange(status) &#123;      setIsOnline(status.isOnline);    &#125;    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);    &#x2F;&#x2F; Specify how to clean up after this effect:  å®é™…ä¸Šå‡½æ•°åä¸é‡è¦ï¼Œç®­å¤´å‡½æ•°ä¹Ÿè¡Œï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†ä½“ç°å…¶ä½œç”¨    return function cleanup() &#123;      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);    &#125;;  &#125;);  if (isOnline &#x3D;&#x3D;&#x3D; null) &#123;    return &#39;Loading...&#39;;  &#125;  return isOnline ? &#39;Online&#39; : &#39;Offline&#39;;&#125;</code></pre><p>ä¸ºä»€ä¹ˆè¦åœ¨ effect ä¸­è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Ÿ è¿™æ˜¯ effect å¯é€‰çš„æ¸…é™¤æœºåˆ¶ã€‚æ¯ä¸ª effect éƒ½å¯ä»¥è¿”å›ä¸€ä¸ªæ¸…é™¤å‡½æ•°ã€‚å¦‚æ­¤å¯ä»¥å°†æ·»åŠ å’Œç§»é™¤è®¢é˜…çš„é€»è¾‘æ”¾åœ¨ä¸€èµ·ã€‚å®ƒä»¬éƒ½å±äº effect çš„ä¸€éƒ¨åˆ†ã€‚</p><p>React ä½•æ—¶æ¸…é™¤ effectï¼Ÿ React ä¼šåœ¨ç»„ä»¶å¸è½½çš„æ—¶å€™æ‰§è¡Œæ¸…é™¤æ“ä½œã€‚æ­£å¦‚ä¹‹å‰å­¦åˆ°çš„ï¼Œeffect åœ¨æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ React ä¼šåœ¨æ‰§è¡Œå½“å‰ effect ä¹‹å‰å¯¹ä¸Šä¸€ä¸ª effect è¿›è¡Œæ¸…é™¤ã€‚æˆ‘ä»¬ç¨åå°†è®¨è®º<a href="https://zh-hans.reactjs.org/docs/hooks-effect.html#explanation-why-effects-run-on-each-update" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆè¿™å°†åŠ©äºé¿å… bug</a>ä»¥åŠ<a href="https://zh-hans.reactjs.org/docs/hooks-effect.html#tip-optimizing-performance-by-skipping-effects" target="_blank" rel="noopener">å¦‚ä½•åœ¨é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶è·³è¿‡æ­¤è¡Œä¸º</a>ã€‚</p><h3 id="ä½¿ç”¨å¤šä¸ªeffectå®ç°å…³æ³¨ç‚¹åˆ†ç¦»"><a href="#ä½¿ç”¨å¤šä¸ªeffectå®ç°å…³æ³¨ç‚¹åˆ†ç¦»" class="headerlink" title="ä½¿ç”¨å¤šä¸ªeffectå®ç°å…³æ³¨ç‚¹åˆ†ç¦»"></a>ä½¿ç”¨å¤šä¸ªeffectå®ç°å…³æ³¨ç‚¹åˆ†ç¦»</h3><p>æˆ‘ä»¬çš„classä¸­çš„å£°æ˜å‘¨æœŸå‡½æ•°å†…ç»å¸¸éœ€è¦åŒ…å«å¦‚ä¸Šä¾‹å­è¿™æ ·çš„ä¸ç›¸å…³é€»è¾‘ï¼Œè€Œclasså†™æ³•é‡Œè¿™äº›é€»è¾‘æ— ç–‘ä¼šè¢«åˆ†å‰²åˆ°ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæ¯”å¦‚componentWillMountä¸­è®¢é˜…ï¼ŒcompnentWillUnmountä¸­å–æ¶ˆè®¢é˜…ç­‰ã€‚è€Œå¦‚æœè¿™æ ·çš„ä»£ç è¾ƒå¤šï¼Œæˆ‘ä»¬è¿˜è¦åœ¨åŒä¸ªç”Ÿå‘½å‘¨æœŸä¸­åšä¸åŒçš„äº‹æƒ…ï¼Œè®©ä»£ç å˜å¾—æ›´åŠ éš¾ä»¥ç†è§£ã€‚<br>Hookçš„å¦ä¸€ä¸ªä½œç”¨ï¼Œ<strong>å°±æ˜¯å…è®¸æˆ‘ä»¬æŒ‰ç…§ä»£ç çš„ç”¨é€”æ¥åˆ†ç¦»ä»–ä»¬</strong>ã€‚</p><pre><code class="hljs plain">function FriendStatusWithCounter(props) &#123;  const [count, setCount] &#x3D; useState(0);  useEffect(() &#x3D;&gt; &#123;    document.title &#x3D; &#96;You clicked $&#123;count&#125; times&#96;;  &#125;);  const [isOnline, setIsOnline] &#x3D; useState(null);  useEffect(() &#x3D;&gt; &#123;    function handleStatusChange(status) &#123;      setIsOnline(status.isOnline);    &#125;    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);    return () &#x3D;&gt; &#123;      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);    &#125;;  &#125;);  &#x2F;&#x2F; ...&#125;</code></pre><h3 id="ä¸ºä»€ä¹ˆæ¯æ¬¡æ›´æ–°çš„æ—¶å€™éƒ½éœ€è¦è¿è¡Œeffect"><a href="#ä¸ºä»€ä¹ˆæ¯æ¬¡æ›´æ–°çš„æ—¶å€™éƒ½éœ€è¦è¿è¡Œeffect" class="headerlink" title="ä¸ºä»€ä¹ˆæ¯æ¬¡æ›´æ–°çš„æ—¶å€™éƒ½éœ€è¦è¿è¡Œeffect"></a>ä¸ºä»€ä¹ˆæ¯æ¬¡æ›´æ–°çš„æ—¶å€™éƒ½éœ€è¦è¿è¡Œeffect</h3><p>å¦‚æœä½ å·²ç»ä¹ æƒ¯äº†ä½¿ç”¨ classï¼Œé‚£ä¹ˆä½ æˆ–è®¸ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆ effect çš„æ¸…é™¤é˜¶æ®µåœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶éƒ½ä¼šæ‰§è¡Œï¼Œè€Œä¸æ˜¯åªåœ¨å¸è½½ç»„ä»¶çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œçœ‹çœ‹ä¸ºä»€ä¹ˆè¿™ä¸ªè®¾è®¡å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ›å»º bug æ›´å°‘çš„ç»„ä»¶ã€‚</p><pre><code class="hljs plain">componentDidMount() &#123;    ChatAPI.subscribeToFriendStatus(      this.props.friend.id,      this.handleStatusChange    );  &#125;  componentWillUnmount() &#123;    ChatAPI.unsubscribeFromFriendStatus(      this.props.friend.id,      this.handleStatusChange    );  &#125;</code></pre><p>å¦‚ä¸Šï¼Œè€ƒè™‘åŸæ¥çš„ä»£ç ï¼Œ<strong>å½“ç»„ä»¶å·²ç»æ˜¾ç¤ºåœ¨å±å¹•ä¸Šæ—¶ï¼Œfriend prop å‘ç”Ÿå˜åŒ–æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ</strong>ï¼Ÿ æˆ‘ä»¬çš„ç»„ä»¶å°†ç»§ç»­å±•ç¤ºåŸæ¥çš„å¥½å‹çŠ¶æ€ã€‚è¿™æ˜¯ä¸€ä¸ª bugã€‚è€Œä¸”æˆ‘ä»¬è¿˜ä¼šå› ä¸ºå–æ¶ˆè®¢é˜…æ—¶ä½¿ç”¨é”™è¯¯çš„å¥½å‹ ID å¯¼è‡´å†…å­˜æ³„éœ²æˆ–å´©æºƒçš„é—®é¢˜ã€‚</p><p>åœ¨ class ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  componentDidUpdate æ¥è§£å†³è¿™ä¸ªé—®é¢˜:</p><pre><code class="hljs plain">componentDidUpdate(prevProps) &#123;    &#x2F;&#x2F; å–æ¶ˆè®¢é˜…ä¹‹å‰çš„ friend.id    ChatAPI.unsubscribeFromFriendStatus(      prevProps.friend.id,      this.handleStatusChange    );    &#x2F;&#x2F; è®¢é˜…æ–°çš„ friend.id    ChatAPI.subscribeToFriendStatus(      this.props.friend.id,      this.handleStatusChange    );  &#125;</code></pre><p>è€Œhookå°±å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸€é—®é¢˜ã€‚</p><h3 id="è·³è¿‡effectè¿›è¡Œæ€§èƒ½ä¼˜åŒ–"><a href="#è·³è¿‡effectè¿›è¡Œæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="è·³è¿‡effectè¿›è¡Œæ€§èƒ½ä¼˜åŒ–"></a>è·³è¿‡effectè¿›è¡Œæ€§èƒ½ä¼˜åŒ–</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œæ¸…ç†æˆ–è€…æ‰§è¡Œ effect å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚åœ¨ class ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ componentDidUpdate ä¸­æ·»åŠ å¯¹ prevProps æˆ– prevState çš„æ¯”è¾ƒé€»è¾‘è§£å†³ï¼š</p><pre><code class="hljs plain">componentDidUpdate(prevProps, prevState) &#123;  if (prevState.count !&#x3D;&#x3D; this.state.count) &#123;    document.title &#x3D; &#96;You clicked $&#123;this.state.count&#125; times&#96;;  &#125;&#125;</code></pre><p>è¿™æ˜¯å¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œæ‰€ä»¥å®ƒè¢«å†…ç½®åˆ°äº† useEffect çš„ Hook API ä¸­ã€‚å¦‚æœæŸäº›ç‰¹å®šå€¼åœ¨ä¸¤æ¬¡é‡æ¸²æŸ“ä¹‹é—´æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½ å¯ä»¥é€šçŸ¥ React è·³è¿‡å¯¹ effect çš„è°ƒç”¨ï¼Œåªè¦ä¼ é€’æ•°ç»„ä½œä¸º useEffect çš„ç¬¬äºŒä¸ªå¯é€‰å‚æ•°å³å¯ï¼š</p><pre><code class="hljs plain">useEffect(() &#x3D;&gt; &#123;  document.title &#x3D; &#96;You clicked $&#123;count&#125; times&#96;;&#125;, [count]); &#x2F;&#x2F; ä»…åœ¨ count æ›´æ”¹æ—¶æ›´æ–°</code></pre><p>ç›¸å½“äºæŠŠå½“å‰çš„countä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ï¼Œé‡æ¸²æŸ“è°ƒç”¨effectçš„æ—¶å€™reactä¼šæ¯”è¾ƒå½¼æ—¶çš„countå’Œæˆ‘ä»¬ä¼ å…¥çš„countï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™reactä¼šè·³è¿‡è¿™ä¸ªeffectã€‚<br><strong>æƒ³åˆ¤æ–­å“ªä¸ªå‚æ•°ï¼Œå°±ä¼ å…¥å“ªä¸ªå‚æ•°ã€‚</strong>å¯¹äºæœ‰æ¸…é™¤æ“ä½œçš„effectåŒæ ·é€‚ç”¨ã€‚</p><pre><code class="hljs plain">useEffect(() &#x3D;&gt; &#123;  function handleStatusChange(status) &#123;    setIsOnline(status.isOnline);  &#125;  ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);  return () &#x3D;&gt; &#123;    ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);  &#125;;&#125;, [props.friend.id]); &#x2F;&#x2F; ä»…åœ¨ props.friend.id å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡æ–°è®¢é˜…</code></pre><p>æœªæ¥ç‰ˆæœ¬ï¼Œå¯èƒ½ä¼šåœ¨æ„å»ºæ—¶è‡ªåŠ¨æ·»åŠ ç¬¬äºŒä¸ªå‚æ•°ã€‚</p><p><strong>æ³¨æ„</strong>ï¼š<br>å¦‚æœä½ è¦ä½¿ç”¨æ­¤ä¼˜åŒ–æ–¹å¼ï¼Œè¯·ç¡®ä¿æ•°ç»„ä¸­åŒ…å«äº†<strong>æ‰€æœ‰å¤–éƒ¨ä½œç”¨åŸŸä¸­ä¼šéšæ—¶é—´å˜åŒ–å¹¶ä¸”åœ¨effectä¸­ä½¿ç”¨çš„å˜é‡</strong>ï¼Œå¦åˆ™ä½ çš„ä»£ç ä¼šå¼•ç”¨åˆ°å…ˆå‰æ¸²æŸ“ä¸­çš„æ—§å˜é‡ã€‚å‚é˜…æ–‡æ¡£ï¼Œäº†è§£æ›´å¤šå…³äº<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies" target="_blank" rel="noopener">å¦‚ä½•å¤„ç†å‡½æ•°</a>ä»¥åŠ<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often" target="_blank" rel="noopener">æ•°ç»„é¢‘ç¹å˜åŒ–æ—¶çš„æªæ–½</a>å†…å®¹ã€‚</p><p><strong>å¦‚æœæƒ³æ‰§è¡Œåªè¿è¡Œä¸€æ¬¡çš„ effectï¼ˆä»…åœ¨ç»„ä»¶æŒ‚è½½å’Œå¸è½½æ—¶æ‰§è¡Œï¼‰</strong>ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªç©ºæ•°ç»„ï¼ˆ[]ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚è¿™å°±å‘Šè¯‰ React ä½ çš„ effect ä¸ä¾èµ–äº props æˆ– state ä¸­çš„ä»»ä½•å€¼ï¼Œæ‰€ä»¥å®ƒæ°¸è¿œéƒ½ä¸éœ€è¦é‡å¤æ‰§è¡Œã€‚è¿™å¹¶ä¸å±äºç‰¹æ®Šæƒ…å†µ â€”â€” å®ƒä¾ç„¶éµå¾ªä¾èµ–æ•°ç»„çš„å·¥ä½œæ–¹å¼ã€‚ </p><p>å¦‚æœä½ ä¼ å…¥äº†ä¸€ä¸ªç©ºæ•°ç»„ï¼ˆ[]ï¼‰ï¼Œeffect å†…éƒ¨çš„ props å’Œ state å°±ä¼šä¸€ç›´æ‹¥æœ‰å…¶åˆå§‹å€¼ã€‚å°½ç®¡ä¼ å…¥ [] ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°æ›´æ¥è¿‘å¤§å®¶æ›´ç†Ÿæ‚‰çš„ componentDidMount å’Œ componentWillUnmount æ€ç»´æ¨¡å¼ï¼Œä½†æˆ‘ä»¬æœ‰<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies" target="_blank" rel="noopener">æ›´å¥½çš„æ–¹å¼</a>æ¥é¿å…è¿‡äºé¢‘ç¹çš„é‡å¤è°ƒç”¨ effectã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯·è®°å¾— React ä¼šç­‰å¾…æµè§ˆå™¨å®Œæˆç”»é¢æ¸²æŸ“ä¹‹åæ‰ä¼šå»¶è¿Ÿè°ƒç”¨ useEffectï¼Œå› æ­¤ä¼šä½¿å¾—é¢å¤–æ“ä½œå¾ˆæ–¹ä¾¿ã€‚</p><p>æˆ‘ä»¬æ¨èå¯ç”¨ <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks#installation" target="_blank" rel="noopener">eslint-plugin-react-hooks</a> ä¸­çš„ <a href="https://github.com/facebook/react/issues/14920" target="_blank" rel="noopener">exhaustive-deps</a> è§„åˆ™ã€‚æ­¤è§„åˆ™ä¼šåœ¨æ·»åŠ é”™è¯¯ä¾èµ–æ—¶å‘å‡ºè­¦å‘Šå¹¶ç»™å‡ºä¿®å¤å»ºè®®ã€‚</p><p>æ­¤æ—¶ä½ å¯èƒ½ä¼šå¥½å¥‡ Hook æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚åœ¨ä¸¤æ¬¡æ¸²æŸ“é—´ï¼ŒReactå¦‚ä½•çŸ¥é“å“ªä¸ª useState è°ƒç”¨å¯¹åº”äºå“ªä¸ª state å˜é‡ï¼ŸReact åˆæ˜¯å¦‚ä½•åŒ¹é…å‰åä¸¤æ¬¡æ¸²æŸ“ä¸­çš„æ¯ä¸€ä¸ª effect çš„ï¼Ÿæ¥ç€æ¥çœ‹ã€‚</p><h2 id="hookè§„åˆ™"><a href="#hookè§„åˆ™" class="headerlink" title="hookè§„åˆ™"></a>hookè§„åˆ™</h2><p>Hook æœ¬è´¨å°±æ˜¯ JavaScript å‡½æ•°ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨å®ƒæ—¶éœ€è¦éµå¾ªä¸¤æ¡è§„åˆ™ã€‚æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">linter æ’ä»¶</a>æ¥å¼ºåˆ¶æ‰§è¡Œè¿™äº›è§„åˆ™ï¼š</p><ol><li>åªåœ¨æœ€é¡¶å±‚ä½¿ç”¨ Hook<br>ä¸è¦åœ¨å¾ªç¯ï¼Œæ¡ä»¶æˆ–åµŒå¥—å‡½æ•°ä¸­è°ƒç”¨ Hookï¼Œ ç¡®ä¿æ€»æ˜¯åœ¨ä½ çš„ React å‡½æ•°çš„æœ€é¡¶å±‚è°ƒç”¨ä»–ä»¬ã€‚éµå®ˆè¿™æ¡è§„åˆ™ï¼Œä½ å°±èƒ½ç¡®ä¿ Hook åœ¨æ¯ä¸€æ¬¡æ¸²æŸ“ä¸­éƒ½æŒ‰ç…§åŒæ ·çš„é¡ºåºè¢«è°ƒç”¨ã€‚è¿™è®© React èƒ½å¤Ÿåœ¨å¤šæ¬¡çš„ useState å’Œ useEffect è°ƒç”¨ä¹‹é—´ä¿æŒ hook çŠ¶æ€çš„æ­£ç¡®ã€‚</li><li>åªåœ¨ React å‡½æ•°ä¸­è°ƒç”¨ Hook<br>ä¸è¦åœ¨æ™®é€šçš„ JavaScript å‡½æ•°ä¸­è°ƒç”¨ Hookã€‚ä½ å¯ä»¥ï¼š<br>âœ… åœ¨ React çš„å‡½æ•°ç»„ä»¶ä¸­è°ƒç”¨ Hook<br>âœ… åœ¨è‡ªå®šä¹‰ Hook ä¸­è°ƒç”¨å…¶ä»– Hook</li></ol><h3 id="eslintæ’ä»¶"><a href="#eslintæ’ä»¶" class="headerlink" title="eslintæ’ä»¶"></a>eslintæ’ä»¶</h3><p>æˆ‘ä»¬å‘å¸ƒäº†ä¸€ä¸ªåä¸º eslint-plugin-react-hooks çš„ ESLint æ’ä»¶æ¥å¼ºåˆ¶æ‰§è¡Œè¿™ä¸¤æ¡è§„åˆ™ã€‚</p><pre><code class="hljs plain">npm install eslint-plugin-react-hooks --save-dev</code></pre><pre><code class="hljs plain">&#x2F;&#x2F; ä½ çš„ ESLint é…ç½®&#123;  &quot;plugins&quot;: [    &#x2F;&#x2F; ...    &quot;react-hooks&quot;  ],  &quot;rules&quot;: &#123;    &#x2F;&#x2F; ...    &quot;react-hooks&#x2F;rules-of-hooks&quot;: &quot;error&quot;, &#x2F;&#x2F; æ£€æŸ¥ Hook çš„è§„åˆ™    &quot;react-hooks&#x2F;exhaustive-deps&quot;: &quot;warn&quot; &#x2F;&#x2F; æ£€æŸ¥ effect çš„ä¾èµ–  &#125;&#125;</code></pre><p>å›ç­”ä¸Šé¢çš„é—®é¢˜ï¼ŒReact æ€ä¹ˆçŸ¥é“å“ªä¸ª state å¯¹åº”å“ªä¸ª useStateï¼Ÿç­”æ¡ˆæ˜¯ React é çš„æ˜¯ Hook è°ƒç”¨çš„é¡ºåºã€‚<br>åªè¦ Hook çš„è°ƒç”¨é¡ºåºåœ¨å¤šæ¬¡æ¸²æŸ“ä¹‹é—´ä¿æŒä¸€è‡´ï¼ŒReact å°±èƒ½æ­£ç¡®åœ°å°†å†…éƒ¨ state å’Œå¯¹åº”çš„ Hook è¿›è¡Œå…³è”ã€‚ä½†å¦‚æœæˆ‘ä»¬å°†ä¸€ä¸ª Hook (ä¾‹å¦‚ persistForm effect) è°ƒç”¨æ”¾åˆ°ä¸€ä¸ªæ¡ä»¶è¯­å¥ä¸­ï¼ŒHookçš„è°ƒç”¨é¡ºåºå¯èƒ½å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä»è€Œå¯¼è‡´bugã€‚</p><pre><code class="hljs plain">&#x2F;&#x2F; ğŸ”´ åœ¨æ¡ä»¶è¯­å¥ä¸­ä½¿ç”¨ Hook è¿åç¬¬ä¸€æ¡è§„åˆ™  if (name !&#x3D;&#x3D; &#39;&#39;) &#123;    useEffect(function persistForm() &#123;      localStorage.setItem(&#39;formData&#39;, name);    &#125;);  &#125;</code></pre><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Hook éœ€è¦åœ¨æˆ‘ä»¬ç»„ä»¶çš„æœ€é¡¶å±‚è°ƒç”¨ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦æœ‰æ¡ä»¶åœ°æ‰§è¡Œä¸€ä¸ª effectï¼Œå¯ä»¥å°†åˆ¤æ–­æ”¾åˆ° Hook çš„å†…éƒ¨ï¼š</p><pre><code class="hljs plain">useEffect(function persistForm() &#123;   &#x2F;&#x2F; ğŸ‘ å°†æ¡ä»¶åˆ¤æ–­æ”¾ç½®åœ¨ effect ä¸­   if (name !&#x3D;&#x3D; &#39;&#39;) &#123;     localStorage.setItem(&#39;formData&#39;, name);   &#125; &#125;);</code></pre><p><strong>æ³¨æ„ï¼šå¦‚æœä½¿ç”¨äº†æä¾›çš„ lint æ’ä»¶ï¼Œå°±æ— éœ€æ‹…å¿ƒæ­¤é—®é¢˜ã€‚</strong></p><h2 id="è‡ªå®šä¹‰Hook-1"><a href="#è‡ªå®šä¹‰Hook-1" class="headerlink" title="è‡ªå®šä¹‰Hook"></a>è‡ªå®šä¹‰Hook</h2><p>é€šè¿‡è‡ªå®šä¹‰ Hookï¼Œå¯ä»¥å°†ç»„ä»¶é€»è¾‘æå–åˆ°å¯é‡ç”¨çš„å‡½æ•°ä¸­ã€‚</p><p>åœ¨æˆ‘ä»¬å­¦ä¹ ä½¿ç”¨ Effect Hook æ—¶ï¼Œæˆ‘ä»¬å·²ç»è§è¿‡è¿™ä¸ªèŠå¤©ç¨‹åºä¸­çš„ç»„ä»¶ï¼Œè¯¥ç»„ä»¶ç”¨äºæ˜¾ç¤ºå¥½å‹çš„åœ¨çº¿çŠ¶æ€</p><pre><code class="hljs plain">import React, &#123; useState, useEffect &#125; from &#39;react&#39;;function FriendStatus(props) &#123;  const [isOnline, setIsOnline] &#x3D; useState(null);  useEffect(() &#x3D;&gt; &#123;    function handleStatusChange(status) &#123;      setIsOnline(status.isOnline);    &#125;    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);    return () &#x3D;&gt; &#123;      ChatAPI.unsubscribeFromFriendStatus(props.friend.id, handleStatusChange);    &#125;;  &#125;);  if (isOnline &#x3D;&#x3D;&#x3D; null) &#123;    return &#39;Loading...&#39;;  &#125;  return isOnline ? &#39;Online&#39; : &#39;Offline&#39;;&#125;</code></pre><p>ç°åœ¨æˆ‘ä»¬å‡è®¾èŠå¤©åº”ç”¨ä¸­æœ‰ä¸€ä¸ªè”ç³»äººåˆ—è¡¨ï¼Œå½“ç”¨æˆ·åœ¨çº¿æ—¶éœ€è¦æŠŠåå­—è®¾ç½®ä¸ºç»¿è‰²ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢ç±»ä¼¼çš„é€»è¾‘å¤åˆ¶å¹¶ç²˜è´´åˆ° FriendListItem ç»„ä»¶ä¸­æ¥ï¼Œä½†è¿™å¹¶ä¸æ˜¯ç†æƒ³çš„è§£å†³æ–¹æ¡ˆã€‚<br>ç›¸åï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ FriendStatus å’Œ FriendListItem ä¹‹é—´å…±äº«é€»è¾‘ã€‚<br>ç›®å‰ä¸ºæ­¢ï¼Œåœ¨ React ä¸­æœ‰ä¸¤ç§æµè¡Œçš„æ–¹å¼æ¥å…±äº«ç»„ä»¶ä¹‹é—´çš„çŠ¶æ€é€»è¾‘: render props å’Œé«˜é˜¶ç»„ä»¶ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Hook æ˜¯å¦‚ä½•åœ¨è®©ä½ ä¸å¢åŠ ç»„ä»¶çš„æƒ…å†µä¸‹è§£å†³ç›¸åŒé—®é¢˜çš„ã€‚</p><h3 id="æå–è‡ªå®šä¹‰-Hook"><a href="#æå–è‡ªå®šä¹‰-Hook" class="headerlink" title="æå–è‡ªå®šä¹‰ Hook"></a>æå–è‡ªå®šä¹‰ Hook</h3><p>å½“æˆ‘ä»¬æƒ³åœ¨ä¸¤ä¸ªå‡½æ•°ä¹‹é—´å…±äº«é€»è¾‘æ—¶ï¼Œæˆ‘ä»¬ä¼šæŠŠå®ƒæå–åˆ°ç¬¬ä¸‰ä¸ªå‡½æ•°ä¸­ã€‚è€Œç»„ä»¶å’Œ Hook éƒ½æ˜¯å‡½æ•°ï¼Œæ‰€ä»¥ä¹ŸåŒæ ·é€‚ç”¨è¿™ç§æ–¹å¼ã€‚</p><p><strong>è‡ªå®šä¹‰ Hook æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶åç§°ä»¥ â€œuseâ€ å¼€å¤´ï¼Œå‡½æ•°å†…éƒ¨å¯ä»¥è°ƒç”¨å…¶ä»–çš„ Hookã€‚</strong></p><pre><code class="hljs plain">import &#123; useState, useEffect &#125; from &#39;react&#39;;function useFriendStatus(friendID) &#123;  const [isOnline, setIsOnline] &#x3D; useState(null);  useEffect(() &#x3D;&gt; &#123;    function handleStatusChange(status) &#123;      setIsOnline(status.isOnline);    &#125;    ChatAPI.subscribeToFriendStatus(friendID, handleStatusChange);    return () &#x3D;&gt; &#123;      ChatAPI.unsubscribeFromFriendStatus(friendID, handleStatusChange);    &#125;;  &#125;);  return isOnline;&#125;</code></pre><p>ä¸ç»„ä»¶ä¸­ä¸€è‡´ï¼Œè¯·ç¡®ä¿åªåœ¨è‡ªå®šä¹‰ Hook çš„é¡¶å±‚æ— æ¡ä»¶åœ°è°ƒç”¨å…¶ä»– Hookã€‚</p><p>ä¸ React ç»„ä»¶ä¸åŒçš„æ˜¯ï¼Œè‡ªå®šä¹‰ Hook ä¸éœ€è¦å…·æœ‰ç‰¹æ®Šçš„æ ‡è¯†ã€‚æˆ‘ä»¬å¯ä»¥è‡ªç”±çš„å†³å®šå®ƒçš„å‚æ•°æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå®ƒåº”è¯¥è¿”å›ä»€ä¹ˆï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚</p><h3 id="ä½¿ç”¨è‡ªå®šä¹‰Hook"><a href="#ä½¿ç”¨è‡ªå®šä¹‰Hook" class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰Hook"></a>ä½¿ç”¨è‡ªå®šä¹‰Hook</h3><pre><code class="hljs plain">unction FriendStatus(props) &#123;  const isOnline &#x3D; useFriendStatus(props.friend.id);  if (isOnline &#x3D;&#x3D;&#x3D; null) &#123;    return &#39;Loading...&#39;;  &#125;  return isOnline ? &#39;Online&#39; : &#39;Offline&#39;;&#125;</code></pre><pre><code class="hljs plain">function FriendListItem(props) &#123;  const isOnline &#x3D; useFriendStatus(props.friend.id);  return (    &lt;li style&#x3D;&#123;&#123; color: isOnline ? &#39;green&#39; : &#39;black&#39; &#125;&#125;&gt;      &#123;props.friend.name&#125;    &lt;&#x2F;li&gt;  );&#125;</code></pre><p>è¿™æ®µä»£ç ç­‰ä»·äºåŸæ¥çš„ç¤ºä¾‹ä»£ç å—ï¼Ÿç­‰ä»·ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼å®Œå…¨ä¸€æ ·ã€‚å¦‚æœä½ ä»”ç»†è§‚å¯Ÿï¼Œä½ ä¼šå‘ç°æˆ‘ä»¬æ²¡æœ‰å¯¹å…¶è¡Œä¸ºåšä»»ä½•çš„æ”¹å˜ï¼Œæˆ‘ä»¬åªæ˜¯å°†ä¸¤ä¸ªå‡½æ•°ä¹‹é—´ä¸€äº›å…±åŒçš„ä»£ç æå–åˆ°å•ç‹¬çš„å‡½æ•°ä¸­ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>è‡ªå®šä¹‰ Hook æ˜¯ä¸€ç§è‡ªç„¶éµå¾ª Hook è®¾è®¡çš„çº¦å®šï¼Œè€Œå¹¶ä¸æ˜¯ React çš„ç‰¹æ€§ã€‚</strong></p><p>å‡ ä¸ªç‚¹ï¼š</p><ul><li><strong>è‡ªå®šä¹‰ Hook å¿…é¡»ä»¥ â€œuseâ€ å¼€å¤´ã€‚</strong>  ä¸éµå¾ªçš„è¯ï¼Œç”±äºæ— æ³•åˆ¤æ–­æŸä¸ªå‡½æ•°æ˜¯å¦åŒ…å«å¯¹å…¶å†…éƒ¨ Hook çš„è°ƒç”¨ï¼ŒReact å°†æ— æ³•è‡ªåŠ¨æ£€æŸ¥ä½ çš„ Hook æ˜¯å¦è¿åäº† Hook çš„è§„åˆ™ã€‚</li><li><strong>åœ¨ä¸¤ä¸ªç»„ä»¶ä¸­ä½¿ç”¨ç›¸åŒçš„ Hook ä¸ä¼šå…±äº« stateã€‚</strong>  è‡ªå®šä¹‰ Hook æ˜¯ä¸€ç§é‡ç”¨çŠ¶æ€é€»è¾‘çš„æœºåˆ¶(ä¾‹å¦‚è®¾ç½®ä¸ºè®¢é˜…å¹¶å­˜å‚¨å½“å‰å€¼)ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨è‡ªå®šä¹‰ Hook æ—¶ï¼Œå…¶ä¸­çš„æ‰€æœ‰ state å’Œå‰¯ä½œç”¨éƒ½æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚</li><li><strong>è‡ªå®šä¹‰ Hook å¦‚ä½•è·å–ç‹¬ç«‹çš„ state?</strong> æ¯æ¬¡è°ƒç”¨ Hookï¼Œå®ƒéƒ½ä¼šè·å–ç‹¬ç«‹çš„ stateã€‚ç”±äºæˆ‘ä»¬ç›´æ¥è°ƒç”¨äº† useFriendStatusï¼Œä» React çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬çš„ç»„ä»¶åªæ˜¯è°ƒç”¨äº† useState å’Œ useEffectã€‚ æ­£å¦‚æˆ‘ä»¬åœ¨ä¹‹å‰ç« èŠ‚ä¸­äº†è§£åˆ°çš„ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªç»„ä»¶ä¸­å¤šæ¬¡è°ƒç”¨ useState å’Œ useEffectï¼Œå®ƒä»¬æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚</li></ul><h3 id="åœ¨å¤šä¸ª-Hook-ä¹‹é—´ä¼ é€’ä¿¡æ¯"><a href="#åœ¨å¤šä¸ª-Hook-ä¹‹é—´ä¼ é€’ä¿¡æ¯" class="headerlink" title="åœ¨å¤šä¸ª Hook ä¹‹é—´ä¼ é€’ä¿¡æ¯"></a>åœ¨å¤šä¸ª Hook ä¹‹é—´ä¼ é€’ä¿¡æ¯</h3><p>ç”±äº Hook æœ¬èº«å°±æ˜¯å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€’ä¿¡æ¯ã€‚</p><pre><code class="hljs plain">const friendList &#x3D; [  &#123; id: 1, name: &#39;Phoebe&#39; &#125;,  &#123; id: 2, name: &#39;Rachel&#39; &#125;,  &#123; id: 3, name: &#39;Ross&#39; &#125;,];function ChatRecipientPicker() &#123;  const [recipientID, setRecipientID] &#x3D; useState(1);  const isRecipientOnline &#x3D; useFriendStatus(recipientID);  return (    &lt;&gt;      &lt;Circle color&#x3D;&#123;isRecipientOnline ? &#39;green&#39; : &#39;red&#39;&#125; &#x2F;&gt;      &lt;select        value&#x3D;&#123;recipientID&#125;        onChange&#x3D;&#123;e &#x3D;&gt; setRecipientID(Number(e.target.value))&#125;      &gt;        &#123;friendList.map(friend &#x3D;&gt; (          &lt;option key&#x3D;&#123;friend.id&#125; value&#x3D;&#123;friend.id&#125;&gt;            &#123;friend.name&#125;          &lt;&#x2F;option&gt;        ))&#125;      &lt;&#x2F;select&gt;    &lt;&#x2F;&gt;  );&#125;</code></pre><p>æˆ‘ä»¬å°†å½“å‰é€‰æ‹©çš„å¥½å‹ ID ä¿å­˜åœ¨ recipientID çŠ¶æ€å˜é‡ä¸­ï¼Œå¹¶åœ¨ç”¨æˆ·ä» <code>&lt;select&gt;</code> ä¸­é€‰æ‹©å…¶ä»–å¥½å‹æ—¶æ›´æ–°è¿™ä¸ª stateã€‚</p><p>ç”±äº useState ä¸ºæˆ‘ä»¬æä¾›äº† recipientID çŠ¶æ€å˜é‡çš„æœ€æ–°å€¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å®ƒä½œä¸ºå‚æ•°ä¼ é€’ç»™è‡ªå®šä¹‰çš„ useFriendStatus Hookã€‚<br>å¦‚æ­¤å¯ä»¥è®©æˆ‘ä»¬çŸ¥é“å½“å‰é€‰ä¸­çš„å¥½å‹æ˜¯å¦åœ¨çº¿ã€‚å½“æˆ‘ä»¬é€‰æ‹©ä¸åŒçš„å¥½å‹å¹¶æ›´æ–° recipientID çŠ¶æ€å˜é‡æ—¶ï¼ŒuseFriendStatus Hook å°†ä¼šå–æ¶ˆè®¢é˜…ä¹‹å‰é€‰ä¸­çš„å¥½å‹ï¼Œå¹¶è®¢é˜…æ–°é€‰ä¸­çš„å¥½å‹çŠ¶æ€ã€‚</p><p>æ—¢ç„¶å‡½æ•°ç»„ä»¶èƒ½å¤Ÿåšçš„æ›´å¤šï¼Œé‚£ä¹ˆä»£ç åº“ä¸­å‡½æ•°ç»„ä»¶çš„ä»£ç è¡Œæ•°å¯èƒ½ä¼šå‰§å¢ã€‚è¿™å±äºæ­£å¸¸ç°è±¡ â€”â€” ä¸å¿…ç«‹å³å°†å®ƒä»¬æ‹†åˆ†ä¸º Hookã€‚ä½†æˆ‘ä»¬ä»é¼“åŠ±ä½ èƒ½é€šè¿‡è‡ªå®šä¹‰ Hook å¯»æ‰¾å¯èƒ½ï¼Œä»¥è¾¾åˆ°ç®€åŒ–ä»£ç é€»è¾‘ï¼Œè§£å†³ç»„ä»¶æ‚ä¹±æ— ç« çš„ç›®çš„ã€‚</p><h3 id="å‘æŒ¥æƒ³è±¡"><a href="#å‘æŒ¥æƒ³è±¡" class="headerlink" title="å‘æŒ¥æƒ³è±¡"></a>å‘æŒ¥æƒ³è±¡</h3><p>æœ‰ä¸ªå¤æ‚çš„ç»„ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†å¤§é‡ä»¥ç‰¹æ®Šçš„æ–¹å¼æ¥ç®¡ç†çš„å†…éƒ¨çŠ¶æ€ã€‚useState å¹¶ä¸ä¼šä½¿å¾—é›†ä¸­æ›´æ–°é€»è¾‘å˜å¾—å®¹æ˜“ï¼Œå› æ­¤ä½ å¯èƒ½æ›´æ„¿æ„ä½¿ç”¨ redux ä¸­çš„ reducer æ¥ç¼–å†™ã€‚</p><pre><code class="hljs plain">function todosReducer(state, action) &#123;  switch (action.type) &#123;    case &#39;add&#39;:      return [...state, &#123;        text: action.text,        completed: false      &#125;];    &#x2F;&#x2F; ... other actions ...    default:      return state;  &#125;&#125;</code></pre><p>Reducers éå¸¸ä¾¿äºå•ç‹¬æµ‹è¯•ï¼Œä¸”æ˜“äºæ‰©å±•ï¼Œä»¥è¡¨è¾¾å¤æ‚çš„æ›´æ–°é€»è¾‘ã€‚å¦‚æœ‰å¿…è¦ï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬åˆ†æˆæ›´å°çš„ reducerã€‚ä½†æ˜¯ï¼Œä½ å¯èƒ½è¿˜äº«å—ç€ React å†…éƒ¨ state å¸¦æ¥çš„å¥½å¤„ï¼Œæˆ–è€…å¯èƒ½æ ¹æœ¬ä¸æƒ³å®‰è£…å…¶ä»–åº“ã€‚</p><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç¼–å†™ä¸€ä¸ª useReducer çš„ Hookï¼Œä½¿ç”¨ reducer çš„æ–¹å¼æ¥ç®¡ç†ç»„ä»¶çš„å†…éƒ¨ state å‘¢ï¼Ÿå…¶ç®€åŒ–ç‰ˆæœ¬å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="hljs plain">function useReducer(reducer, initialState) &#123;  const [state, setState] &#x3D; useState(initialState);  function dispatch(action) &#123;    const nextState &#x3D; reducer(state, action);    setState(nextState);  &#125;  return [state, dispatch];&#125;</code></pre><p>åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å®ƒï¼Œè®© reducer é©±åŠ¨å®ƒç®¡ç† stateï¼š</p><pre><code class="hljs plain">function Todos() &#123;  const [todos, dispatch] &#x3D; useReducer(todosReducer, []);  function handleAddClick(text) &#123;    dispatch(&#123; type: &#39;add&#39;, text &#125;);  &#125;  &#x2F;&#x2F; ...&#125;</code></pre><p>åœ¨å¤æ‚ç»„ä»¶ä¸­ä½¿ç”¨ reducer ç®¡ç†å†…éƒ¨ state çš„éœ€æ±‚å¾ˆå¸¸è§ï¼Œæˆ‘ä»¬å·²ç»å°† useReducer çš„ Hook å†…ç½®åˆ° React ä¸­ã€‚ä½ å¯ä»¥åœ¨ <a href="https://zh-hans.reactjs.org/docs/hooks-reference.html" target="_blank" rel="noopener">Hook API ç´¢å¼•</a>ä¸­æ‰¾åˆ°å®ƒä½¿ç”¨ï¼Œæ­é…å…¶ä»–å†…ç½®çš„ Hook ä¸€èµ·ä½¿ç”¨ã€‚</p><h1 id="Hookçš„API"><a href="#Hookçš„API" class="headerlink" title="Hookçš„API"></a>Hookçš„API</h1><p>Hookçš„APIå¤§è‡´åˆ†ä¸ºä¸¤ç±»ã€‚</p><p>åŸºç¡€ Hook</p><ul><li>useState</li><li>useEffect</li><li>useContext</li></ul><p>é¢å¤–çš„ Hook</p><ul><li>useReducer</li><li>useCallback</li><li>useMemo</li><li>useRef</li><li>useImperativeHandle</li><li>useLayoutEffect</li><li>useDebugValue</li></ul><h2 id="åŸºç¡€Hook"><a href="#åŸºç¡€Hook" class="headerlink" title="åŸºç¡€Hook"></a>åŸºç¡€Hook</h2><h3 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h3><pre><code class="hljs plain">const [state, setState] &#x3D; useState(initialState);</code></pre><p>é™¤äº†ä¹‹å‰ä»‹ç»çš„ç”¨æ³•ã€‚</p><p>è¿˜å¯ä»¥è¿›è¡Œ<br><strong>å‡½æ•°å¼æ›´æ–°</strong><br>å¦‚æœæ–°çš„ state éœ€è¦é€šè¿‡ä½¿ç”¨å…ˆå‰çš„ state è®¡ç®—å¾—å‡ºï¼Œé‚£ä¹ˆå¯ä»¥å°†å‡½æ•°ä¼ é€’ç»™ setStateã€‚è¯¥å‡½æ•°å°†æ¥æ”¶å…ˆå‰çš„ stateï¼Œå¹¶è¿”å›ä¸€ä¸ªæ›´æ–°åçš„å€¼ã€‚ä¸‹é¢çš„è®¡æ•°å™¨ç»„ä»¶ç¤ºä¾‹å±•ç¤ºäº† setState çš„ä¸¤ç§ç”¨æ³•ï¼š</p><pre><code class="hljs plain">function Counter(&#123;initialCount&#125;) &#123;  const [count, setCount] &#x3D; useState(initialCount);  return (    &lt;&gt;      Count: &#123;count&#125;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; setCount(initialCount)&#125;&gt;Reset&lt;&#x2F;button&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; setCount(prevCount &#x3D;&gt; prevCount - 1)&#125;&gt;-&lt;&#x2F;button&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; setCount(prevCount &#x3D;&gt; prevCount + 1)&#125;&gt;+&lt;&#x2F;button&gt;    &lt;&#x2F;&gt;  );&#125;</code></pre><p>å¦‚æœä½ çš„æ›´æ–°å‡½æ•°è¿”å›å€¼ä¸å½“å‰ state å®Œå…¨ç›¸åŒï¼Œåˆ™éšåçš„é‡æ¸²æŸ“ä¼šè¢«å®Œå…¨è·³è¿‡ã€‚</p><p>æ³¨æ„ï¼šä¸ class ç»„ä»¶ä¸­çš„ setState æ–¹æ³•ä¸åŒï¼ŒuseState ä¸ä¼šè‡ªåŠ¨åˆå¹¶æ›´æ–°å¯¹è±¡ã€‚ä½ å¯ä»¥ç”¨å‡½æ•°å¼çš„ setState ç»“åˆå±•å¼€è¿ç®—ç¬¦æ¥è¾¾åˆ°åˆå¹¶æ›´æ–°å¯¹è±¡çš„æ•ˆæœã€‚<br>useReducer æ˜¯å¦ä¸€ç§å¯é€‰æ–¹æ¡ˆï¼Œå®ƒæ›´é€‚åˆç”¨äºç®¡ç†åŒ…å«å¤šä¸ªå­å€¼çš„ state å¯¹è±¡ã€‚</p><p><strong>æƒ°æ€§åˆå§‹state</strong><br>initialState å‚æ•°åªä¼šåœ¨ç»„ä»¶çš„åˆå§‹æ¸²æŸ“ä¸­èµ·ä½œç”¨ï¼Œåç»­æ¸²æŸ“æ—¶ä¼šè¢«å¿½ç•¥ã€‚å¦‚æœåˆå§‹ state éœ€è¦é€šè¿‡å¤æ‚è®¡ç®—è·å¾—ï¼Œåˆ™å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å‡½æ•°ä¸­è®¡ç®—å¹¶è¿”å›åˆå§‹çš„ stateï¼Œæ­¤å‡½æ•°åªåœ¨åˆå§‹æ¸²æŸ“æ—¶è¢«è°ƒç”¨ï¼š</p><pre><code class="hljs plain">const [state, setState] &#x3D; useState(() &#x3D;&gt; &#123;  const initialState &#x3D; someExpensiveComputation(props);  return initialState;&#125;);</code></pre><p><strong>è·³è¿‡stateæ›´æ–°</strong><br>è°ƒç”¨ State Hook çš„æ›´æ–°å‡½æ•°å¹¶ä¼ å…¥å½“å‰çš„ state æ—¶ï¼ŒReact å°†è·³è¿‡å­ç»„ä»¶çš„æ¸²æŸ“åŠ effect çš„æ‰§è¡Œã€‚ï¼ˆReact ä½¿ç”¨ Object.is æ¯”è¾ƒç®—æ³• æ¥æ¯”è¾ƒ stateã€‚ï¼‰</p><h3 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h3><pre><code class="hljs plain">useEffect(didUpdate);</code></pre><p>ä½¿ç”¨ useEffect å®Œæˆå‰¯ä½œç”¨æ“ä½œã€‚èµ‹å€¼ç»™ useEffect çš„å‡½æ•°ä¼šåœ¨ç»„ä»¶æ¸²æŸ“åˆ°å±å¹•ä¹‹åæ‰§è¡Œã€‚ä½ å¯ä»¥æŠŠ effect çœ‹ä½œä» React çš„çº¯å‡½æ•°å¼ä¸–ç•Œé€šå¾€å‘½ä»¤å¼ä¸–ç•Œçš„é€ƒç”Ÿé€šé“ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œeffect å°†åœ¨æ¯è½®æ¸²æŸ“ç»“æŸåæ‰§è¡Œã€‚å‰é¢è¯´åˆ°è¿‡ï¼Œä½†ä½ å¯ä»¥é€‰æ‹©è®©å®ƒ åœ¨åªæœ‰æŸäº›å€¼æ”¹å˜çš„æ—¶å€™ æ‰æ‰§è¡Œã€‚</p><p>ä¸ componentDidMountã€componentDidUpdate ä¸åŒçš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶ä¹‹åï¼Œä¼ ç»™ useEffect çš„å‡½æ•°ä¼šå»¶è¿Ÿè°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®è®¢é˜…å’Œäº‹ä»¶å¤„ç†ç­‰æƒ…å†µï¼Œå› æ­¤ä¸åº”åœ¨å‡½æ•°ä¸­æ‰§è¡Œé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•çš„æ“ä½œã€‚</p><p>ç„¶è€Œï¼Œå¹¶éæ‰€æœ‰ effect éƒ½å¯ä»¥è¢«å»¶è¿Ÿæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œåœ¨æµè§ˆå™¨æ‰§è¡Œä¸‹ä¸€æ¬¡ç»˜åˆ¶å‰ï¼Œç”¨æˆ·å¯è§çš„ DOM å˜æ›´å°±å¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œè¿™æ ·ç”¨æˆ·æ‰ä¸ä¼šæ„Ÿè§‰åˆ°è§†è§‰ä¸Šçš„ä¸ä¸€è‡´ã€‚ï¼ˆæ¦‚å¿µä¸Šç±»ä¼¼äºè¢«åŠ¨ç›‘å¬äº‹ä»¶å’Œä¸»åŠ¨ç›‘å¬äº‹ä»¶çš„åŒºåˆ«ã€‚ï¼‰React ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªé¢å¤–çš„ <strong>useLayoutEffect Hook</strong> æ¥å¤„ç†è¿™ç±» effectã€‚å®ƒå’Œ useEffect çš„ç»“æ„ç›¸åŒï¼ŒåŒºåˆ«åªæ˜¯è°ƒç”¨æ—¶æœºä¸åŒã€‚</p><p>è™½ç„¶ useEffect ä¼šåœ¨æµè§ˆå™¨ç»˜åˆ¶åå»¶è¿Ÿæ‰§è¡Œï¼Œä½†ä¼šä¿è¯åœ¨ä»»ä½•æ–°çš„æ¸²æŸ“å‰æ‰§è¡Œã€‚React å°†åœ¨ç»„ä»¶æ›´æ–°å‰åˆ·æ–°ä¸Šä¸€è½®æ¸²æŸ“çš„ effectã€‚</p><p><strong>effect çš„æ¡ä»¶æ‰§è¡Œ</strong><br>å³å‰é¢è¯´åˆ°çš„ç¬¬äºŒä¸ªå‚æ•°,å®ƒæ˜¯ effect æ‰€ä¾èµ–çš„å€¼æ•°ç»„ã€‚æ›´æ–°åçš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre><code class="hljs plain">useEffect(  () &#x3D;&gt; &#123;    const subscription &#x3D; props.source.subscribe();    return () &#x3D;&gt; &#123;      subscription.unsubscribe();    &#125;;  &#125;,  [props.source],);</code></pre><p>æ­¤æ—¶ï¼Œåªæœ‰å½“ props.source æ”¹å˜åæ‰ä¼šé‡æ–°åˆ›å»ºè®¢é˜…ã€‚</p><p>å†æ¬¡å¼ºè°ƒï¼Œ<strong>è¯·ç¡®ä¿æ•°ç»„ä¸­åŒ…å«äº†æ‰€æœ‰å¤–éƒ¨ä½œç”¨åŸŸä¸­ä¼šå‘ç”Ÿå˜åŒ–ä¸”åœ¨ effect ä¸­ä½¿ç”¨çš„å˜é‡</strong>ã€‚ è§<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies" target="_blank" rel="noopener">å¦‚ä½•å¤„ç†å‡½æ•°</a>å’Œ<a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often" target="_blank" rel="noopener">æ•°ç»„é¢‘ç¹å˜åŒ–æ—¶çš„æªæ–½</a></p><p>è¿™é‡Œç¡®å®æœ‰ä¸€ç‚¹éº»çƒ¦ï¼Œéœ€è¦è‡ªå·±ä¼ å…¥å¯¹åº”çš„propï¼Œstateæˆ–äºŒè€…çš„è¡ç”Ÿå€¼æ‰èƒ½å®Œæˆä¼˜åŒ–ã€‚æœªæ¥ç¼–è¯‘å™¨ä¼šæ›´åŠ æ™ºèƒ½ï¼Œå±Šæ—¶è‡ªåŠ¨åˆ›å»ºæ•°ç»„å°†æˆä¸ºå¯èƒ½ã€‚</p><p>å¦‚æœæƒ³æ‰§è¡Œåªè¿è¡Œä¸€æ¬¡çš„ effectï¼ˆä»…åœ¨ç»„ä»¶æŒ‚è½½å’Œå¸è½½æ—¶æ‰§è¡Œï¼‰ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªç©ºæ•°ç»„ï¼ˆ[]ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚ä½†è¿™éœ€è¦ä½ çš„effectå‡½æ•°ç¡®å®æ²¡æœ‰å¼•ç”¨ propsã€state ä»¥åŠç”±å®ƒä»¬è¡ç”Ÿè€Œæ¥çš„å€¼ã€‚</p><h3 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h3><pre><code class="hljs plain">const value &#x3D; useContext(MyContext);</code></pre><p>æ¥æ”¶ä¸€ä¸ª context å¯¹è±¡ï¼ˆReact.createContext çš„è¿”å›å€¼ï¼‰å¹¶è¿”å›è¯¥ context çš„å½“å‰å€¼ã€‚å½“å‰çš„ context å€¼ç”±ä¸Šå±‚ç»„ä»¶ä¸­è·ç¦»å½“å‰ç»„ä»¶æœ€è¿‘çš„ <code>&lt;MyContext.Provider&gt;</code> çš„ value prop å†³å®šã€‚<br>å½“ç»„ä»¶ä¸Šå±‚æœ€è¿‘çš„ <code>&lt;MyContext.Provider&gt;</code>æ›´æ–°æ—¶ï¼Œè¯¥ Hook ä¼šè§¦å‘é‡æ¸²æŸ“.å³ä½¿ç¥–å…ˆä½¿ç”¨ React.memo æˆ– shouldComponentUpdateï¼Œä¹Ÿä¼šåœ¨ç»„ä»¶æœ¬èº«ä½¿ç”¨ useContext æ—¶é‡æ–°æ¸²æŸ“ã€‚</p><p>åˆ«å¿˜è®° useContext çš„å‚æ•°å¿…é¡»æ˜¯ context å¯¹è±¡æœ¬èº«ï¼š</p><ul><li>æ­£ç¡®ï¼š useContext(MyContext)</li><li>é”™è¯¯ï¼š useContext(MyContext.Consumer)</li><li>é”™è¯¯ï¼š useContext(MyContext.Provider)</li></ul><p>è°ƒç”¨äº† useContext çš„ç»„ä»¶æ€»ä¼šåœ¨ context å€¼å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ã€‚å¦‚æœé‡æ¸²æŸ“ç»„ä»¶çš„å¼€é”€è¾ƒå¤§ï¼Œä½ å¯ä»¥ <a href="https://github.com/facebook/react/issues/15156#issuecomment-474590693" target="_blank" rel="noopener">é€šè¿‡ä½¿ç”¨ memoization æ¥ä¼˜åŒ–</a>ã€‚</p><p>æ³¨æ„ï¼š<br>useContext(MyContext) ç›¸å½“äº class ç»„ä»¶ä¸­çš„ static contextType = MyContext æˆ–è€… <code>&lt;MyContext.Consumer&gt;</code>ã€‚<br>useContext(MyContext) åªæ˜¯è®©ä½ èƒ½å¤Ÿè¯»å– context çš„å€¼ä»¥åŠè®¢é˜… context çš„å˜åŒ–ã€‚ä½ ä»ç„¶éœ€è¦åœ¨ä¸Šå±‚ç»„ä»¶æ ‘ä¸­ä½¿ç”¨ <code>&lt;MyContext.Provider&gt;</code> æ¥ä¸ºä¸‹å±‚ç»„ä»¶æä¾› contextã€‚</p><h2 id="é¢å¤–çš„Hook"><a href="#é¢å¤–çš„Hook" class="headerlink" title="é¢å¤–çš„Hook"></a>é¢å¤–çš„Hook</h2><p>ä»¥ä¸‹ä»‹ç»çš„ Hookï¼Œæœ‰äº›æ˜¯ä¸Šä¸€èŠ‚ä¸­åŸºç¡€ Hook çš„å˜ä½“ï¼Œæœ‰äº›åˆ™ä»…åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä¼šç”¨åˆ°ã€‚</p><h3 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h3><pre><code class="hljs plain">const [state, dispatch] &#x3D; useReducer(reducer, initialArg, init);</code></pre><p>useState çš„æ›¿ä»£æ–¹æ¡ˆã€‚å®ƒæ¥æ”¶ä¸€ä¸ªå½¢å¦‚ (state, action) =&gt; newState çš„ reducerï¼Œå¹¶è¿”å›å½“å‰çš„ state ä»¥åŠä¸å…¶é…å¥—çš„ dispatch æ–¹æ³•ã€‚ï¼ˆå¦‚æœä½ ç†Ÿæ‚‰ Redux çš„è¯ï¼Œå°±å·²ç»çŸ¥é“å®ƒå¦‚ä½•å·¥ä½œäº†ã€‚ï¼‰<br>åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ŒuseReducer ä¼šæ¯” useState æ›´é€‚ç”¨ï¼Œä¾‹å¦‚ state é€»è¾‘è¾ƒå¤æ‚ä¸”åŒ…å«å¤šä¸ªå­å€¼ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ª state ä¾èµ–äºä¹‹å‰çš„ state ç­‰ã€‚å¹¶ä¸”ï¼Œä½¿ç”¨ useReducer è¿˜èƒ½ç»™é‚£äº›ä¼šè§¦å‘æ·±æ›´æ–°çš„ç»„ä»¶åšæ€§èƒ½ä¼˜åŒ–ï¼Œå› ä¸ºä½ å¯ä»¥å‘å­ç»„ä»¶ä¼ é€’ dispatch è€Œä¸æ˜¯å›è°ƒå‡½æ•° ã€‚</p><pre><code class="hljs plain">const initialState &#x3D; &#123;count: 0&#125;;&#x2F;&#x2F;reducerä¸ºå•ç‹¬å®šä¹‰çš„å‡½æ•°function reducer(state, action) &#123;  switch (action.type) &#123;    case &#39;increment&#39;:      &#x2F;&#x2F;æ³¨æ„è¿™é‡Œï¼Œä¸ç”¨è¿”å›dispathï¼Œreactä¼šå¸®æˆ‘ä»¬å®ç°ï¼Œè·ŸreduxåŸºæœ¬ä¸€è‡´      return &#123;count: state.count + 1&#125;;    case &#39;decrement&#39;:      return &#123;count: state.count - 1&#125;;    default:      throw new Error();  &#125;&#125;function Counter() &#123;  const [state, dispatch] &#x3D; useReducer(reducer, initialState);  return (    &lt;&gt;      Count: &#123;state.count&#125;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; dispatch(&#123;type: &#39;decrement&#39;&#125;)&#125;&gt;-&lt;&#x2F;button&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; dispatch(&#123;type: &#39;increment&#39;&#125;)&#125;&gt;+&lt;&#x2F;button&gt;    &lt;&#x2F;&gt;  );&#125;</code></pre><p>React ä¼šç¡®ä¿ dispatch å‡½æ•°çš„æ ‡è¯†æ˜¯ç¨³å®šçš„ï¼Œå¹¶ä¸”ä¸ä¼šåœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶æ”¹å˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥å®‰å…¨åœ°ä» useEffect æˆ– useCallback çš„ä¾èµ–åˆ—è¡¨ä¸­çœç•¥ dispatchã€‚</p><p><strong>æƒ°æ€§åˆå§‹åŒ–</strong><br>æ³¨æ„åˆ°useReducerçš„ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚ç”¨äºè®©æˆ‘ä»¬å¯ä»¥é€‰æ‹© æƒ°æ€§åœ°åˆ›å»ºåˆå§‹ stateã€‚ä¸ºæ­¤ï¼Œéœ€è¦å°† init å‡½æ•°ä½œä¸º useReducer çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥ï¼Œè¿™æ ·åˆå§‹ state å°†è¢«è®¾ç½®ä¸º init(initialArg)ã€‚<br>è¿™ä¹ˆåšå¯ä»¥å°†ç”¨äºè®¡ç®— state çš„é€»è¾‘æå–åˆ° reducer å¤–éƒ¨ï¼Œè¿™ä¹Ÿä¸ºå°†æ¥å¯¹é‡ç½® state çš„ action åšå¤„ç†æä¾›äº†ä¾¿åˆ©ï¼š</p><pre><code class="hljs plain">function init(initialCount) &#123;  return &#123;count: initialCount&#125;;&#125;function reducer(state, action) &#123;  switch (action.type) &#123;    case &#39;increment&#39;:      return &#123;count: state.count + 1&#125;;    case &#39;decrement&#39;:      return &#123;count: state.count - 1&#125;;    case &#39;reset&#39;:      return init(action.payload);    default:      throw new Error();  &#125;&#125;function Counter(&#123;initialCount&#125;) &#123;  const [state, dispatch] &#x3D; useReducer(reducer, initialCount, init);  return (    &lt;&gt;      Count: &#123;state.count&#125;      &lt;button        onClick&#x3D;&#123;() &#x3D;&gt; dispatch(&#123;type: &#39;reset&#39;, payload: initialCount&#125;)&#125;&gt;        Reset      &lt;&#x2F;button&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; dispatch(&#123;type: &#39;decrement&#39;&#125;)&#125;&gt;-&lt;&#x2F;button&gt;      &lt;button onClick&#x3D;&#123;() &#x3D;&gt; dispatch(&#123;type: &#39;increment&#39;&#125;)&#125;&gt;+&lt;&#x2F;button&gt;    &lt;&#x2F;&gt;  );&#125;</code></pre><p>å¦‚æœ Reducer Hook çš„è¿”å›å€¼ä¸å½“å‰ state ç›¸åŒï¼ŒReact å°†è·³è¿‡å­ç»„ä»¶çš„æ¸²æŸ“åŠå‰¯ä½œç”¨çš„æ‰§è¡Œã€‚ï¼ˆReact ä½¿ç”¨ Object.is æ¯”è¾ƒç®—æ³• æ¥æ¯”è¾ƒ stateã€‚ï¼‰</p><h3 id="useCallback"><a href="#useCallback" class="headerlink" title="useCallback"></a>useCallback</h3><pre><code class="hljs plain">const memoizedCallback &#x3D; useCallback(  () &#x3D;&gt; &#123;    doSomething(a, b);  &#125;,  [a, b],);</code></pre><p>è¿”å›ä¸€ä¸ª memoized å›è°ƒå‡½æ•°ã€‚<br>æŠŠå†…è”å›è°ƒå‡½æ•°åŠä¾èµ–é¡¹æ•°ç»„ä½œä¸ºå‚æ•°ä¼ å…¥ useCallbackï¼Œå®ƒå°†è¿”å›è¯¥å›è°ƒå‡½æ•°çš„ memoized ç‰ˆæœ¬ï¼Œè¯¥å›è°ƒå‡½æ•°ä»…åœ¨æŸä¸ªä¾èµ–é¡¹æ”¹å˜æ—¶æ‰ä¼šæ›´æ–°ã€‚å½“ä½ æŠŠå›è°ƒå‡½æ•°ä¼ é€’ç»™ç»è¿‡ä¼˜åŒ–çš„å¹¶ä½¿ç”¨å¼•ç”¨ç›¸ç­‰æ€§å»é¿å…éå¿…è¦æ¸²æŸ“ï¼ˆä¾‹å¦‚ shouldComponentUpdateï¼‰çš„å­ç»„ä»¶æ—¶ï¼Œå®ƒå°†éå¸¸æœ‰ç”¨ã€‚<br>useCallback(fn, deps) ç›¸å½“äº useMemo(() =&gt; fn, deps)ã€‚</p><h3 id="useMemo"><a href="#useMemo" class="headerlink" title="useMemo"></a>useMemo</h3><pre><code class="hljs plain">const memoizedValue &#x3D; useMemo(() &#x3D;&gt; computeExpensiveValue(a, b), [a, b]);</code></pre><p>è¿”å›ä¸€ä¸ª memoized å€¼ã€‚</p><p>æŠŠâ€œåˆ›å»ºâ€å‡½æ•°å’Œä¾èµ–é¡¹æ•°ç»„ä½œä¸ºå‚æ•°ä¼ å…¥ useMemoï¼Œå®ƒä»…ä¼šåœ¨æŸä¸ªä¾èµ–é¡¹æ”¹å˜æ—¶æ‰é‡æ–°è®¡ç®— memoized å€¼ã€‚è¿™ç§ä¼˜åŒ–æœ‰åŠ©äºé¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½è¿›è¡Œé«˜å¼€é”€çš„è®¡ç®—ã€‚</p><p>è®°ä½ï¼Œä¼ å…¥ useMemo çš„å‡½æ•°ä¼šåœ¨æ¸²æŸ“æœŸé—´æ‰§è¡Œã€‚è¯·ä¸è¦åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨æ‰§è¡Œä¸æ¸²æŸ“æ— å…³çš„æ“ä½œï¼Œè¯¸å¦‚å‰¯ä½œç”¨è¿™ç±»çš„æ“ä½œå±äº useEffect çš„é€‚ç”¨èŒƒç•´ï¼Œè€Œä¸æ˜¯ useMemoã€‚</p><p>å¦‚æœæ²¡æœ‰æä¾›ä¾èµ–é¡¹æ•°ç»„ï¼ŒuseMemo åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šè®¡ç®—æ–°çš„å€¼ã€‚</p><p>ä½ å¯ä»¥æŠŠ useMemo ä½œä¸ºæ€§èƒ½ä¼˜åŒ–çš„æ‰‹æ®µï¼Œä½†ä¸è¦æŠŠå®ƒå½“æˆè¯­ä¹‰ä¸Šçš„ä¿è¯ã€‚</p><h3 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h3><pre><code class="hljs plain">const refContainer &#x3D; useRef(initialValue);</code></pre><h3 id="useImperativeHandle"><a href="#useImperativeHandle" class="headerlink" title="useImperativeHandle"></a>useImperativeHandle</h3><h3 id="useLayoutEffect"><a href="#useLayoutEffect" class="headerlink" title="useLayoutEffect"></a>useLayoutEffect</h3><p>å…¶å‡½æ•°ç­¾åä¸ useEffect ç›¸åŒï¼Œä½†å®ƒä¼šåœ¨æ‰€æœ‰çš„ DOM å˜æ›´ä¹‹ååŒæ­¥è°ƒç”¨ effectã€‚å¯ä»¥ä½¿ç”¨å®ƒæ¥è¯»å– DOM å¸ƒå±€å¹¶åŒæ­¥è§¦å‘é‡æ¸²æŸ“ã€‚åœ¨æµè§ˆå™¨æ‰§è¡Œç»˜åˆ¶ä¹‹å‰ï¼ŒuseLayoutEffect å†…éƒ¨çš„æ›´æ–°è®¡åˆ’å°†è¢«åŒæ­¥åˆ·æ–°ã€‚</p><p>å°½å¯èƒ½ä½¿ç”¨æ ‡å‡†çš„ useEffect ä»¥é¿å…é˜»å¡è§†è§‰æ›´æ–°ã€‚</p><p>æˆ‘ä»¬æ¨èä½ ä¸€å¼€å§‹å…ˆç”¨ useEffectï¼Œåªæœ‰å½“å®ƒå‡ºé—®é¢˜çš„æ—¶å€™å†å°è¯•ä½¿ç”¨ useLayoutEffectã€‚</p><p>å¦‚æœä½ ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œè¯·è®°ä½ï¼Œæ— è®º useLayoutEffect è¿˜æ˜¯ useEffect éƒ½æ— æ³•åœ¨ Javascript ä»£ç åŠ è½½å®Œæˆä¹‹å‰æ‰§è¡Œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æœåŠ¡ç«¯æ¸²æŸ“ç»„ä»¶ä¸­å¼•å…¥ useLayoutEffect ä»£ç æ—¶ä¼šè§¦å‘ React å‘Šè­¦ã€‚è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å°†ä»£ç é€»è¾‘ç§»è‡³ useEffect ä¸­ï¼ˆå¦‚æœé¦–æ¬¡æ¸²æŸ“ä¸éœ€è¦è¿™æ®µé€»è¾‘çš„æƒ…å†µä¸‹ï¼‰ï¼Œæˆ–æ˜¯å°†è¯¥ç»„ä»¶å»¶è¿Ÿåˆ°å®¢æˆ·ç«¯æ¸²æŸ“å®Œæˆåå†æ˜¾ç¤ºï¼ˆå¦‚æœç›´åˆ° useLayoutEffect æ‰§è¡Œä¹‹å‰ HTML éƒ½æ˜¾ç¤ºé”™ä¹±çš„æƒ…å†µä¸‹ï¼‰ã€‚</p><p>è‹¥è¦ä»æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML ä¸­æ’é™¤ä¾èµ–å¸ƒå±€ effect çš„ç»„ä»¶ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ showChild &amp;&amp; <code>&lt;Child /&gt;</code> è¿›è¡Œæ¡ä»¶æ¸²æŸ“ï¼Œå¹¶ä½¿ç”¨ useEffect(() =&gt; { setShowChild(true); }, []) å»¶è¿Ÿå±•ç¤ºç»„ä»¶ã€‚è¿™æ ·ï¼Œåœ¨å®¢æˆ·ç«¯æ¸²æŸ“å®Œæˆä¹‹å‰ï¼ŒUI å°±ä¸ä¼šåƒä¹‹å‰é‚£æ ·æ˜¾ç¤ºé”™ä¹±äº†ã€‚</p><h3 id="useDebugValue"><a href="#useDebugValue" class="headerlink" title="useDebugValue"></a>useDebugValue</h3>]]></content>
    
    
    <categories>
      
      <category>webå‰ç«¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åŸºç¡€</tag>
      
      <tag>React</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Reactå®˜æ–¹æ–‡æ¡£çŸ¥è¯†ç‚¹-è¿›é˜¶</title>
    <link href="/2020/05/28/React%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%9F%A5%E8%AF%86%E7%82%B9-%E8%BF%9B%E9%98%B6/"/>
    <url>/2020/05/28/React%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%9F%A5%E8%AF%86%E7%82%B9-%E8%BF%9B%E9%98%B6/</url>
    
    <content type="html"><![CDATA[<p>æ‰¿æ¥ä¸Šä¸€ç¯‡æ–‡ç« ã€‚</p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h3 id="1-æ— éšœç¢è¾…åŠ©åŠŸèƒ½"><a href="#1-æ— éšœç¢è¾…åŠ©åŠŸèƒ½" class="headerlink" title="1.æ— éšœç¢è¾…åŠ©åŠŸèƒ½"></a>1.æ— éšœç¢è¾…åŠ©åŠŸèƒ½</h3><p>æ— éšœç¢è¾…åŠ©åŠŸèƒ½æ˜¯è®©æ‰€æœ‰äººéƒ½èƒ½å¤Ÿè·å¾—æœåŠ¡çš„ä¸€ç§è®¾è®¡ã€‚<br>å…³äºReactä¸­å¯¹æ­¤åŠŸèƒ½çš„å…¨é¢è¦ç‚¹ï¼š<a href="https://zh-hans.reactjs.org/docs/accessibility.html" target="_blank" rel="noopener">ç‚¹å‡»è¿™é‡Œ</a></p><h3 id="2-ä»£ç åˆ†å‰²"><a href="#2-ä»£ç åˆ†å‰²" class="headerlink" title="2.ä»£ç åˆ†å‰²"></a>2.ä»£ç åˆ†å‰²</h3><p>å¤§å¤šæ•° React åº”ç”¨éƒ½ä¼šä½¿ç”¨ Webpackï¼ŒRollup æˆ– Browserify è¿™ç±»çš„æ„å»ºå·¥å…·æ¥æ‰“åŒ…æ–‡ä»¶ã€‚ æ‰“åŒ…æ˜¯ä¸€ä¸ªå°†æ–‡ä»¶å¼•å…¥å¹¶åˆå¹¶åˆ°ä¸€ä¸ªå•ç‹¬æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ª â€œbundleâ€ã€‚ æ¥ç€åœ¨é¡µé¢ä¸Šå¼•å…¥è¯¥ bundleï¼Œæ•´ä¸ªåº”ç”¨å³å¯ä¸€æ¬¡æ€§åŠ è½½ã€‚</p><p>è€Œç°åœ¨çš„å‰ç«¯åº”ç”¨å¤§å¤šéƒ½ä¼šæ•´åˆéå¸¸å¤šç¬¬ä¸‰æ–¹åº“ï¼Œä¸ºäº†é¿å…æ‰“åŒ…å‡ºçš„ä»£ç åŒ…è¿‡å¤§å¯¼è‡´åŠ è½½æ—¶é—´è¾¹é•¿ã€‚æˆ‘ä»¬åº”è¯¥å°½æ—©æ€è€ƒå¯¹ä»£ç è¿›è¡Œä»£ç åˆ†å‰²ã€‚ä»£ç åˆ†å‰²æ˜¯ä¸Šè¯‰æ‰“åŒ…å·¥å…·æ”¯æŒçš„ä¸€é¡¹æŠ€æœ¯ï¼Œèƒ½å¤Ÿåˆ›å»ºå¤šä¸ªåŒ…å¹¶åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ã€‚<br>å®ƒå¯ä»¥è®©ä½ â€œæ‡’åŠ è½½â€ç”¨æˆ·æ‰€éœ€è¦çš„å†…å®¹ï¼Œé¿å…åŠ è½½æ°¸è¿œä¸éœ€è¦çš„ä»£ç ï¼Œå¹¶åœ¨åˆå§‹åŠ è½½æ—¶å‡å°‘æ‰€éœ€åŠ è½½çš„ä»£ç é‡ï¼Œä»è€Œæ˜¾è‘—æé«˜åº”ç”¨æ€§èƒ½ã€‚</p><p>æ¯”å¦‚ä½ çš„ç½‘ç«™æœ‰20ä¸ªç½‘é¡µï¼Œè€ŒæŸä¸ªç”¨æˆ·å¯èƒ½åªä½¿ç”¨å…¶ä¸­2ä¸ªç½‘é¡µï¼Œå¦å¤–18ä¸ªç½‘é¡µçš„å†…å®¹ï¼Œç”¨æˆ·æ˜¯ä¸éœ€è¦åŠ è½½çš„ã€‚</p><p>ä½¿ç”¨æ–¹æ³•ï¼š</p><ul><li><p>import</p><pre><code class="hljs plain">&#x2F;&#x2F;ä½¿ç”¨å‰import &#123; add &#125; from &#39;.&#x2F;math&#39;;console.log(add(16, 26));&#x2F;&#x2F;ä½¿ç”¨åimport(&quot;.&#x2F;math&quot;).then(math &#x3D;&gt; &#123;  console.log(math.add(16, 26));&#125;);</code></pre><p>å¦‚æœä½ è‡ªå·±é…ç½® Webpackï¼Œä½ å¯èƒ½è¦é˜…è¯»ä¸‹ Webpack å…³äº<a href="https://webpack.docschina.org/guides/code-splitting/" target="_blank" rel="noopener">ä»£ç åˆ†å‰²</a>çš„æŒ‡å—ã€‚ä½ çš„ Webpack é…ç½®åº”è¯¥<a href="https://gist.github.com/gaearon/ca6e803f5c604d37468b0091d9959269" target="_blank" rel="noopener">ç±»ä¼¼äºæ­¤</a>ã€‚</p></li><li><p>React.lazy<br>React.lazy å‡½æ•°èƒ½è®©ä½ åƒæ¸²æŸ“å¸¸è§„ç»„ä»¶ä¸€æ ·å¤„ç†åŠ¨æ€å¼•å…¥ï¼ˆçš„ç»„ä»¶ï¼‰ã€‚</p><pre><code class="hljs plain">&#x2F;&#x2F;ä½¿ç”¨å‰import OtherComponent from &#39;.&#x2F;OtherComponent&#39;;&#x2F;&#x2F;ä½¿ç”¨åconst OtherComponent &#x3D; React.lazy(() &#x3D;&gt; import(&#39;.&#x2F;OtherComponent&#39;));</code></pre><p>æ­¤ä»£ç å°†ä¼šåœ¨ç»„ä»¶é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œè‡ªåŠ¨å¯¼å…¥åŒ…å« OtherComponent ç»„ä»¶çš„åŒ…ã€‚<br>React.lazy æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦åŠ¨æ€è°ƒç”¨ import()ã€‚å®ƒå¿…é¡»è¿”å›ä¸€ä¸ª Promiseï¼Œè¯¥ Promise éœ€è¦ resolve ä¸€ä¸ª default export çš„ React ç»„ä»¶ã€‚<br>ç„¶åä½ åº”åœ¨ <strong>Suspense</strong> ç»„ä»¶ä¸­æ¸²æŸ“ lazy ç»„ä»¶ï¼Œå¦‚æ­¤ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨ç­‰å¾…åŠ è½½ lazy ç»„ä»¶æ—¶åšä¼˜é›…é™çº§ï¼ˆå¦‚ loading æŒ‡ç¤ºå™¨ç­‰ï¼‰ã€‚</p><pre><code class="hljs plain">import React, &#123; Suspense &#125; from &#39;react&#39;;const OtherComponent &#x3D; React.lazy(() &#x3D;&gt; import(&#39;.&#x2F;OtherComponent&#39;));function MyComponent() &#123;  return (    &lt;div&gt;      &lt;Suspense fallback&#x3D;&#123;&lt;div&gt;Loading...&lt;&#x2F;div&gt;&#125;&gt;        &lt;OtherComponent &#x2F;&gt;      &lt;&#x2F;Suspense&gt;    &lt;&#x2F;div&gt;  );&#125;</code></pre><p>fallback å±æ€§æ¥å—ä»»ä½•åœ¨ç»„ä»¶åŠ è½½è¿‡ç¨‹ä¸­ä½ æƒ³å±•ç¤ºçš„ React å…ƒç´ ã€‚ä½ å¯ä»¥å°† Suspense ç»„ä»¶ç½®äºæ‡’åŠ è½½ç»„ä»¶ä¹‹ä¸Šçš„ä»»ä½•ä½ç½®ã€‚ä½ ç”šè‡³å¯ä»¥ç”¨ä¸€ä¸ª Suspense ç»„ä»¶åŒ…è£¹å¤šä¸ªæ‡’åŠ è½½ç»„ä»¶ã€‚</p></li></ul><p>PSï¼šReact.lazy ç›®å‰åªæ”¯æŒé»˜è®¤å¯¼å‡ºï¼ˆdefault exportsï¼‰</p><ul><li><p>å¼‚å¸¸æ•è·è¾¹ç•Œ(Error boundaries)<br>å¦‚æœæ¨¡å—åŠ è½½å¤±è´¥ï¼ˆå¦‚ç½‘ç»œé—®é¢˜ï¼‰ï¼Œå®ƒä¼šè§¦å‘ä¸€ä¸ªé”™è¯¯ã€‚ä½ å¯ä»¥é€šè¿‡<a href="https://zh-hans.reactjs.org/docs/error-boundaries.html" target="_blank" rel="noopener">å¼‚å¸¸æ•è·è¾¹ç•Œï¼ˆError boundariesï¼‰</a>æŠ€æœ¯æ¥å¤„ç†è¿™äº›æƒ…å†µï¼Œä»¥æ˜¾ç¤ºè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå¹¶ç®¡ç†æ¢å¤äº‹å®œã€‚</p></li><li><p>åŸºäºè·¯ç”±çš„ä»£ç åˆ†å‰²<br>å¦ä¸€ä¸ªå¾ˆç®€å•çš„ä»£ç åˆ†å‰²æ–¹å¼å°±æ˜¯åŸºäºè·¯ç”±ã€‚<br>ä½¿ç”¨React.lazy å’Œ <a href="https://react-router.docschina.org/" target="_blank" rel="noopener">React Router</a> è¿™ç±»çš„ç¬¬ä¸‰æ–¹åº“ï¼Œæ¥é…ç½®åŸºäºè·¯ç”±çš„ä»£ç åˆ†å‰²ã€‚</p></li></ul><h3 id="3-Context"><a href="#3-Context" class="headerlink" title="3.Context"></a>3.Context</h3><p>Context æä¾›äº†ä¸€ä¸ªæ— éœ€ä¸ºæ¯å±‚ç»„ä»¶æ‰‹åŠ¨æ·»åŠ  propsï¼Œå°±èƒ½åœ¨ç»„ä»¶æ ‘é—´è¿›è¡Œæ•°æ®ä¼ é€’çš„æ–¹æ³•ã€‚<br>ä½¿ç”¨æ–¹å¼</p><pre><code class="hljs plain">&#x2F;&#x2F; Context å¯ä»¥è®©æˆ‘ä»¬æ— é¡»æ˜ç¡®åœ°ä¼ éæ¯ä¸€ä¸ªç»„ä»¶ï¼Œå°±èƒ½å°†å€¼æ·±å…¥ä¼ é€’è¿›ç»„ä»¶æ ‘ã€‚&#x2F;&#x2F; ä¸ºå½“å‰çš„ theme åˆ›å»ºä¸€ä¸ª contextï¼ˆâ€œlightâ€ä¸ºé»˜è®¤å€¼ï¼‰ã€‚const ThemeContext &#x3D; React.createContext(&#39;light&#39;);class App extends React.Component &#123;  render() &#123;    &#x2F;&#x2F; ä½¿ç”¨ä¸€ä¸ª Provider æ¥å°†å½“å‰çš„ theme ä¼ é€’ç»™ä»¥ä¸‹çš„ç»„ä»¶æ ‘ã€‚    &#x2F;&#x2F; æ— è®ºå¤šæ·±ï¼Œä»»ä½•ç»„ä»¶éƒ½èƒ½è¯»å–è¿™ä¸ªå€¼ã€‚    &#x2F;&#x2F; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† â€œdarkâ€ ä½œä¸ºå½“å‰çš„å€¼ä¼ é€’ä¸‹å»ã€‚    return (      &lt;ThemeContext.Provider value&#x3D;&quot;dark&quot;&gt;        &lt;Toolbar &#x2F;&gt;      &lt;&#x2F;ThemeContext.Provider&gt;    );  &#125;&#125;&#x2F;&#x2F; ä¸­é—´çš„ç»„ä»¶å†ä¹Ÿä¸å¿…æŒ‡æ˜å¾€ä¸‹ä¼ é€’ theme äº†ã€‚function Toolbar() &#123;  return (    &lt;div&gt;      &lt;ThemedButton &#x2F;&gt;    &lt;&#x2F;div&gt;  );&#125;class ThemedButton extends React.Component &#123;  &#x2F;&#x2F; æŒ‡å®š contextType è¯»å–å½“å‰çš„ theme contextã€‚  &#x2F;&#x2F; React ä¼šå¾€ä¸Šæ‰¾åˆ°æœ€è¿‘çš„ theme Providerï¼Œç„¶åä½¿ç”¨å®ƒçš„å€¼ã€‚  &#x2F;&#x2F; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“å‰çš„ theme å€¼ä¸º â€œdarkâ€ã€‚  static contextType &#x3D; ThemeContext;  render() &#123;    return &lt;Button theme&#x3D;&#123;this.context&#125; &#x2F;&gt;;  &#125;&#125;</code></pre><p>è¯·è°¨æ…ä½¿ç”¨contextï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—ç»„ä»¶çš„å¤ç”¨æ€§å˜å·®ã€‚</p><p>å¦‚æœä½ åªæ˜¯æƒ³é¿å…å±‚å±‚ä¼ é€’ä¸€äº›å±æ€§ï¼Œç»„ä»¶ç»„åˆï¼ˆcomponent compositionï¼‰æœ‰æ—¶å€™æ˜¯ä¸€ä¸ªæ¯” context æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>æ¯”å¦‚åœ¨ä¸€ä¸ªPageç»„ä»¶å†…ï¼Œå®ƒå±‚å±‚å‘ä¸‹ä¼ é€’userå’ŒavatarSizeå±æ€§ï¼Œä»è€Œè¾ƒæ·±çš„Avatarç»„ä»¶å¯ä»¥è¯»å–åˆ°è¿™äº›å±æ€§ã€‚å¦‚æœæœ€ååªæœ‰Avataréœ€è¦è¿™ä¸ªå˜é‡ï¼Œå±‚å±‚ä¼ é€’å°±æ˜¾å¾—æ¯”è¾ƒè ¢ï¼Œæ­¤æ—¶é™¤äº†ä½¿ç”¨contextï¼Œè¿˜å¯ä»¥çš„ä¸€ç§æ–¹æ³•æ˜¯ç›´æ¥åœ¨pageä¸­æ„é€ å¥½avatarç»„ä»¶ï¼Œç„¶åä¼ é€’ä¸‹å»ã€‚</p><p>è¿™ç§å¯¹ç»„ä»¶çš„æ§åˆ¶åè½¬å‡å°‘äº†åœ¨ä½ çš„åº”ç”¨ä¸­è¦ä¼ é€’çš„ props æ•°é‡ï¼Œè¿™åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ä¼šä½¿å¾—ä½ çš„ä»£ç æ›´åŠ å¹²å‡€ï¼Œä½¿ä½ å¯¹æ ¹ç»„ä»¶æœ‰æ›´å¤šçš„æŠŠæ§ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶ä¸é€‚ç”¨äºæ¯ä¸€ä¸ªåœºæ™¯ï¼šè¿™ç§å°†é€»è¾‘æå‡åˆ°ç»„ä»¶æ ‘çš„æ›´é«˜å±‚æ¬¡æ¥å¤„ç†ï¼Œä¼šä½¿å¾—è¿™äº›é«˜å±‚ç»„ä»¶å˜å¾—æ›´å¤æ‚ï¼Œå¹¶ä¸”ä¼šå¼ºè¡Œå°†ä½å±‚ç»„ä»¶é€‚åº”è¿™æ ·çš„å½¢å¼ï¼Œè¿™å¯èƒ½ä¸ä¼šæ˜¯ä½ æƒ³è¦çš„ã€‚</p><p><a href="https://zh-hans.reactjs.org/docs/context.html" target="_blank" rel="noopener">contextçš„ä½¿ç”¨æ–¹æ³•</a></p><h3 id="4-é”™è¯¯è¾¹ç•Œ"><a href="#4-é”™è¯¯è¾¹ç•Œ" class="headerlink" title="4.é”™è¯¯è¾¹ç•Œ"></a>4.é”™è¯¯è¾¹ç•Œ</h3><p>éƒ¨åˆ† UI çš„ JavaScript é”™è¯¯ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ªåº”ç”¨å´©æºƒï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒReact 16 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µ â€”â€” é”™è¯¯è¾¹ç•Œã€‚</p><p>é”™è¯¯è¾¹ç•Œæ˜¯ä¸€ç§ React ç»„ä»¶ï¼Œè¿™ç§ç»„ä»¶å¯ä»¥æ•è·å¹¶æ‰“å°å‘ç”Ÿåœ¨å…¶å­ç»„ä»¶æ ‘ä»»ä½•ä½ç½®çš„ JavaScript é”™è¯¯ï¼Œå¹¶ä¸”ï¼Œå®ƒä¼šæ¸²æŸ“å‡ºå¤‡ç”¨ UIã€‚é”™è¯¯è¾¹ç•Œåœ¨æ¸²æŸ“æœŸé—´ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å’Œæ•´ä¸ªç»„ä»¶æ ‘çš„æ„é€ å‡½æ•°ä¸­æ•è·é”™è¯¯ã€‚</p><p>é”™è¯¯è¾¹ç•Œæ— æ³•æ•è·ä»¥ä¸‹åœºæ™¯ä¸­äº§ç”Ÿçš„é”™è¯¯ï¼š</p><ul><li>äº‹ä»¶å¤„ç†,å› ä¸ºäº‹ä»¶å¤„ç†å™¨ä¸ä¼šå†æ¸²æŸ“æœŸé—´è§¦å‘ï¼Œsoä½¿ç”¨try/catchæ¥æ•è·ã€‚</li><li>å¼‚æ­¥ä»£ç ï¼ˆä¾‹å¦‚ setTimeout æˆ– requestAnimationFrame å›è°ƒå‡½æ•°ï¼‰</li><li>æœåŠ¡ç«¯æ¸²æŸ“</li><li>å®ƒè‡ªèº«æŠ›å‡ºæ¥çš„é”™è¯¯ï¼ˆå¹¶éå®ƒçš„å­ç»„ä»¶ï¼‰</li></ul><p>å¦‚æœä¸€ä¸ª class ç»„ä»¶ä¸­å®šä¹‰äº† static <strong>getDerivedStateFromError()</strong> æˆ– <strong>componentDidCatch()</strong> è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­çš„ä»»æ„ä¸€ä¸ªï¼ˆæˆ–ä¸¤ä¸ªï¼‰æ—¶ï¼Œé‚£ä¹ˆå®ƒå°±å˜æˆä¸€ä¸ªé”™è¯¯è¾¹ç•Œã€‚<br>å½“æŠ›å‡ºé”™è¯¯åï¼Œè¯·ä½¿ç”¨ static getDerivedStateFromError() æ¸²æŸ“å¤‡ç”¨ UI ï¼Œä½¿ç”¨ componentDidCatch() æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚</p><pre><code class="hljs plain">class ErrorBoundary extends React.Component &#123;  constructor(props) &#123;    super(props);    this.state &#x3D; &#123; hasError: false &#125;;  &#125;  static getDerivedStateFromError(error) &#123;    &#x2F;&#x2F; æ›´æ–° state ä½¿ä¸‹ä¸€æ¬¡æ¸²æŸ“èƒ½å¤Ÿæ˜¾ç¤ºé™çº§åçš„ UI    return &#123; hasError: true &#125;;  &#125;  componentDidCatch(error, errorInfo) &#123;    &#x2F;&#x2F; ä½ åŒæ ·å¯ä»¥å°†é”™è¯¯æ—¥å¿—ä¸ŠæŠ¥ç»™æœåŠ¡å™¨    logErrorToMyService(error, errorInfo);  &#125;  render() &#123;    if (this.state.hasError) &#123;      &#x2F;&#x2F; ä½ å¯ä»¥è‡ªå®šä¹‰é™çº§åçš„ UI å¹¶æ¸²æŸ“      return &lt;h1&gt;Something went wrong.&lt;&#x2F;h1&gt;;    &#125;    return this.props.children;   &#125;&#125;</code></pre><p>æ³¨æ„é”™è¯¯è¾¹ç•Œä»…å¯ä»¥æ•è·å…¶å­ç»„ä»¶çš„é”™è¯¯ï¼Œå®ƒæ— æ³•æ•è·å…¶è‡ªèº«çš„é”™è¯¯ã€‚å¦‚æœä¸€ä¸ªé”™è¯¯è¾¹ç•Œæ— æ³•æ¸²æŸ“é”™è¯¯ä¿¡æ¯ï¼Œåˆ™é”™è¯¯ä¼šå†’æ³¡è‡³æœ€è¿‘çš„ä¸Šå±‚é”™è¯¯è¾¹ç•Œï¼Œè¿™ä¹Ÿç±»ä¼¼äº JavaScript ä¸­ catch {} çš„å·¥ä½œæœºåˆ¶ã€‚</p><p>é”™è¯¯è¾¹ç•Œçš„ç²’åº¦ç”±ä½ æ¥å†³å®šï¼Œå¯ä»¥å°†å…¶åŒ…è£…åœ¨æœ€é¡¶å±‚çš„è·¯ç”±ç»„ä»¶å¹¶ä¸ºç”¨æˆ·å±•ç¤ºä¸€ä¸ª â€œSomething went wrongâ€ çš„é”™è¯¯ä¿¡æ¯ï¼Œå°±åƒæœåŠ¡ç«¯æ¡†æ¶ç»å¸¸å¤„ç†å´©æºƒä¸€æ ·ã€‚ä½ ä¹Ÿå¯ä»¥å°†å•ç‹¬çš„éƒ¨ä»¶åŒ…è£…åœ¨é”™è¯¯è¾¹ç•Œä»¥ä¿æŠ¤åº”ç”¨å…¶ä»–éƒ¨åˆ†ä¸å´©æºƒã€‚</p><p>PS:è‡ª React 16 èµ·ï¼Œä»»ä½•æœªè¢«é”™è¯¯è¾¹ç•Œæ•è·çš„é”™è¯¯å°†ä¼šå¯¼è‡´æ•´ä¸ª React ç»„ä»¶æ ‘è¢«å¸è½½ã€‚</p><h3 id="5-Refs-å’Œ-DOM"><a href="#5-Refs-å’Œ-DOM" class="headerlink" title="5.Refs å’Œ DOM"></a>5.Refs å’Œ DOM</h3><p>Refs æä¾›äº†ä¸€ç§æ–¹å¼ï¼Œå…è®¸æˆ‘ä»¬è®¿é—® DOM èŠ‚ç‚¹æˆ–åœ¨ render æ–¹æ³•ä¸­åˆ›å»ºçš„ React å…ƒç´ ã€‚<br>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ éœ€è¦åœ¨å…¸å‹æ•°æ®æµä¹‹å¤–å¼ºåˆ¶ä¿®æ”¹å­ç»„ä»¶ã€‚è¢«ä¿®æ”¹çš„å­ç»„ä»¶å¯èƒ½æ˜¯ä¸€ä¸ª React ç»„ä»¶çš„å®ä¾‹ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ª DOM å…ƒç´ ã€‚  </p><p>ä¸‹é¢æ˜¯å‡ ä¸ªé€‚åˆä½¿ç”¨ refs çš„æƒ…å†µï¼š</p><ul><li>ç®¡ç†ç„¦ç‚¹ï¼Œæ–‡æœ¬é€‰æ‹©æˆ–åª’ä½“æ’­æ”¾ã€‚</li><li>è§¦å‘å¼ºåˆ¶åŠ¨ç”»ã€‚</li><li>é›†æˆç¬¬ä¸‰æ–¹ DOM åº“ã€‚</li></ul><p>é¿å…ä½¿ç”¨ refs æ¥åšä»»ä½•å¯ä»¥é€šè¿‡å£°æ˜å¼å®ç°æ¥å®Œæˆçš„äº‹æƒ…ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œé¿å…åœ¨ Dialog ç»„ä»¶é‡Œæš´éœ² open() å’Œ close() æ–¹æ³•ï¼Œæœ€å¥½ä¼ é€’ isOpen å±æ€§ã€‚</p><p>ä¸¤ç§ä½¿ç”¨refsçš„æ–¹å¼ï¼š<br>1.React.createRef()</p><pre><code class="hljs plain">class CustomTextInput extends React.Component &#123;  constructor(props) &#123;    super(props);    &#x2F;&#x2F; åˆ›å»ºä¸€ä¸ª ref æ¥å­˜å‚¨ textInput çš„ DOM å…ƒç´     this.textInput &#x3D; React.createRef();    this.focusTextInput &#x3D; this.focusTextInput.bind(this);  &#125;  focusTextInput() &#123;    &#x2F;&#x2F; ç›´æ¥ä½¿ç”¨åŸç”Ÿ API ä½¿ text è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹    &#x2F;&#x2F; æ³¨æ„ï¼šæˆ‘ä»¬é€šè¿‡ &quot;current&quot; æ¥è®¿é—® DOM èŠ‚ç‚¹    this.textInput.current.focus();  &#125;  render() &#123;    &#x2F;&#x2F; å‘Šè¯‰ React æˆ‘ä»¬æƒ³æŠŠ &lt;input&gt; ref å…³è”åˆ°    &#x2F;&#x2F; æ„é€ å™¨é‡Œåˆ›å»ºçš„ &#96;textInput&#96; ä¸Š    return (      &lt;div&gt;        &lt;input          type&#x3D;&quot;text&quot;          ref&#x3D;&#123;this.textInput&#125; &#x2F;&gt;        &lt;input          type&#x3D;&quot;button&quot;          value&#x3D;&quot;Focus the text input&quot;          onClick&#x3D;&#123;this.focusTextInput&#125;        &#x2F;&gt;      &lt;&#x2F;div&gt;    );  &#125;&#125;</code></pre><p>React ä¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶ç»™ current å±æ€§ä¼ å…¥ DOM å…ƒç´ ï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½æ—¶ä¼ å…¥ null å€¼ã€‚ref ä¼šåœ¨ componentDidMount æˆ– componentDidUpdate ç”Ÿå‘½å‘¨æœŸé’©å­è§¦å‘å‰æ›´æ–°ã€‚</p><ul><li>å½“ ref å±æ€§ç”¨äº HTML å…ƒç´ æ—¶ï¼Œæ„é€ å‡½æ•°ä¸­ä½¿ç”¨ React.createRef() åˆ›å»ºçš„ ref æ¥æ”¶åº•å±‚ DOM å…ƒç´ ä½œä¸ºå…¶ current å±æ€§ã€‚</li><li>å½“ ref å±æ€§ç”¨äºè‡ªå®šä¹‰ class ç»„ä»¶æ—¶ï¼Œref å¯¹è±¡æ¥æ”¶ç»„ä»¶çš„æŒ‚è½½å®ä¾‹ä½œä¸ºå…¶ current å±æ€§ã€‚</li></ul><p>2.å›è°ƒref</p><pre><code class="hljs plain">class CustomTextInput extends React.Component &#123;  constructor(props) &#123;    super(props);    this.textInput &#x3D; null;    this.setTextInputRef &#x3D; element &#x3D;&gt; &#123;      this.textInput &#x3D; element;    &#125;;    this.focusTextInput &#x3D; () &#x3D;&gt; &#123;      &#x2F;&#x2F; ä½¿ç”¨åŸç”Ÿ DOM API ä½¿ text è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹      if (this.textInput) this.textInput.focus();    &#125;;  &#125;  componentDidMount() &#123;    &#x2F;&#x2F; ç»„ä»¶æŒ‚è½½åï¼Œè®©æ–‡æœ¬æ¡†è‡ªåŠ¨è·å¾—ç„¦ç‚¹    this.focusTextInput();  &#125;  render() &#123;    &#x2F;&#x2F; ä½¿ç”¨ &#96;ref&#96; çš„å›è°ƒå‡½æ•°å°† text è¾“å…¥æ¡† DOM èŠ‚ç‚¹çš„å¼•ç”¨å­˜å‚¨åˆ° React    &#x2F;&#x2F; å®ä¾‹ä¸Šï¼ˆæ¯”å¦‚ this.textInputï¼‰    return (      &lt;div&gt;        &lt;input          type&#x3D;&quot;text&quot;          ref&#x3D;&#123;this.setTextInputRef&#125;        &#x2F;&gt;        &lt;input          type&#x3D;&quot;button&quot;          value&#x3D;&quot;Focus the text input&quot;          onClick&#x3D;&#123;this.focusTextInput&#125;        &#x2F;&gt;      &lt;&#x2F;div&gt;    );  &#125;&#125;</code></pre><p>å¦‚æœ ref å›è°ƒå‡½æ•°æ˜¯ä»¥å†…è”å‡½æ•°çš„æ–¹å¼å®šä¹‰çš„ï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­å®ƒä¼šè¢«æ‰§è¡Œä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ä¼ å…¥å‚æ•° nullï¼Œç„¶åç¬¬äºŒæ¬¡ä¼šä¼ å…¥å‚æ•° DOM å…ƒç´ ã€‚è¿™æ˜¯å› ä¸ºåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å®ä¾‹ï¼Œæ‰€ä»¥ React æ¸…ç©ºæ—§çš„ ref å¹¶ä¸”è®¾ç½®æ–°çš„ã€‚é€šè¿‡å°† ref çš„å›è°ƒå‡½æ•°å®šä¹‰æˆ class çš„ç»‘å®šå‡½æ•°çš„æ–¹å¼å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹å®ƒæ˜¯æ— å…³ç´§è¦çš„ã€‚</p><p>æ³¨ï¼švar func_name = function(){}è¿™ç§å½¢å¼å®šä¹‰çš„å‡½æ•°ä¸ºå†…è”å‡½æ•°ã€‚</p><p>åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›åœ¨çˆ¶ç»„ä»¶ä¸­å¼•ç”¨å­èŠ‚ç‚¹çš„ DOM èŠ‚ç‚¹ã€‚é€šå¸¸ä¸å»ºè®®è¿™æ ·åšï¼Œå› ä¸ºå®ƒä¼šæ‰“ç ´ç»„ä»¶çš„å°è£…ï¼Œä½†å®ƒå¶å°”å¯ç”¨äºè§¦å‘ç„¦ç‚¹æˆ–æµ‹é‡å­ DOM èŠ‚ç‚¹çš„å¤§å°æˆ–ä½ç½®ã€‚<br>è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬æ¨èä½¿ç”¨ <a href="https://zh-hans.reactjs.org/docs/forwarding-refs.html" target="_blank" rel="noopener">ref è½¬å‘</a>ã€‚Ref è½¬å‘ä½¿ç»„ä»¶å¯ä»¥åƒæš´éœ²è‡ªå·±çš„ ref ä¸€æ ·æš´éœ²å­ç»„ä»¶çš„ refã€‚å…³äºæ€æ ·å¯¹çˆ¶ç»„ä»¶æš´éœ²å­ç»„ä»¶çš„ DOM èŠ‚ç‚¹ï¼Œåœ¨ ref è½¬å‘æ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªè¯¦ç»†çš„ä¾‹å­ã€‚</p><h3 id="6-Fragments"><a href="#6-Fragments" class="headerlink" title="6.Fragments"></a>6.Fragments</h3><p>React ä¸­çš„ä¸€ä¸ªå¸¸è§æ¨¡å¼æ˜¯ä¸€ä¸ªç»„ä»¶è¿”å›å¤šä¸ªå…ƒç´ ã€‚Fragments å…è®¸ä½ å°†å­åˆ—è¡¨åˆ†ç»„ï¼Œè€Œæ— éœ€å‘ DOM æ·»åŠ é¢å¤–èŠ‚ç‚¹ã€‚</p><pre><code class="hljs plain">render() &#123;  return (    &lt;React.Fragment&gt;      &lt;ChildA &#x2F;&gt;      &lt;ChildB &#x2F;&gt;      &lt;ChildC &#x2F;&gt;    &lt;&#x2F;React.Fragment&gt;  );&#125;</code></pre><p>è¿˜æœ‰ä¸€ç§æ®µè¯­æ³•,çœ‹èµ·æ¥æœ‰ç‚¹è¯¡å¼‚ï¼Œå³ç©ºæ ‡ç­¾ï¼š</p><pre><code class="hljs plain">class Columns extends React.Component &#123;  render() &#123;    return (      &lt;&gt;        &lt;td&gt;Hello&lt;&#x2F;td&gt;        &lt;td&gt;World&lt;&#x2F;td&gt;      &lt;&#x2F;&gt;    );  &#125;&#125;</code></pre><p>ä½¿ç”¨æ˜¾å¼ &lt;React.Fragment&gt; è¯­æ³•å£°æ˜çš„ç‰‡æ®µå¯èƒ½å…·æœ‰ keyã€‚ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯å°†ä¸€ä¸ªé›†åˆæ˜ å°„åˆ°ä¸€ä¸ª Fragments æ•°ç»„ã€‚</p><pre><code class="hljs plain">function Glossary(props) &#123;  return (    &lt;dl&gt;      &#123;props.items.map(item &#x3D;&gt; (        &#x2F;&#x2F; æ²¡æœ‰&#96;key&#96;ï¼ŒReact ä¼šå‘å‡ºä¸€ä¸ªå…³é”®è­¦å‘Š        &lt;React.Fragment key&#x3D;&#123;item.id&#125;&gt;          &lt;dt&gt;&#123;item.term&#125;&lt;&#x2F;dt&gt;          &lt;dd&gt;&#123;item.description&#125;&lt;&#x2F;dd&gt;        &lt;&#x2F;React.Fragment&gt;      ))&#125;    &lt;&#x2F;dl&gt;  );&#125;</code></pre><p>key æ˜¯ç›®å‰å”¯ä¸€å¯ä»¥ä¼ é€’ç»™ Fragment çš„å±æ€§ã€‚</p><h3 id="7-é«˜é˜¶ç»„ä»¶"><a href="#7-é«˜é˜¶ç»„ä»¶" class="headerlink" title="7.é«˜é˜¶ç»„ä»¶"></a>7.é«˜é˜¶ç»„ä»¶</h3><p>é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ˜¯ React ä¸­ç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘çš„ä¸€ç§é«˜çº§æŠ€å·§ã€‚HOC è‡ªèº«ä¸æ˜¯ React API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäº React çš„ç»„åˆç‰¹æ€§è€Œå½¢æˆçš„è®¾è®¡æ¨¡å¼ã€‚</p><p>å¯ä»¥å¯¹åº”é«˜é˜¶å‡½æ•°æ¥ç†è§£ï¼Œé«˜é˜¶å‡½æ•°ä¸ºå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå‡½æ•°ä½œä¸ºè¿”å›å€¼ã€‚<br>è€Œé«˜é˜¶ç»„ä»¶åˆ™æ˜¯å‚æ•°ä¸ºç»„ä»¶ï¼Œè¿”å›å€¼ä¸ºæ–°ç»„ä»¶çš„å‡½æ•°ã€‚</p><pre><code class="hljs plain">const EnhancedComponent &#x3D; higherOrderComponent(WrappedComponent);</code></pre><p>HOC åœ¨ React çš„ç¬¬ä¸‰æ–¹åº“ä¸­å¾ˆå¸¸è§ï¼Œä¾‹å¦‚ Redux çš„ connect å’Œ Relay çš„ createFragmentContainerã€‚</p><p>ä¸€å¤§ä½œç”¨å°±æ˜¯å°†ç»„ä»¶é—´ç›¸åŒçš„ä¸šåŠ¡é€»è¾‘è¿›è¡ŒæŠ½è±¡ï¼Œæ¯”å¦‚2ä¸ªç»„ä»¶éƒ½ä¾èµ–äºæŸä¸ªå¤–éƒ¨æ•°æ®è¿›è¡Œæ¸²æŸ“ï¼Œé‚£ä¹ˆè·å–è¿™ä¸ªå¤–éƒ¨æ•°æ®å’Œç›‘å¬å…¶æ”¹å˜çš„æ–¹å¼å°±å¯ä»¥æ”¾åˆ°é«˜é˜¶ç»„ä»¶ä¸­è¿›è¡Œï¼š</p><pre><code class="hljs plain">&#x2F;&#x2F; æ­¤å‡½æ•°æ¥æ”¶ä¸€ä¸ªç»„ä»¶...function withSubscription(WrappedComponent, selectData) &#123;  &#x2F;&#x2F; ...å¹¶è¿”å›å¦ä¸€ä¸ªç»„ä»¶...  return class extends React.Component &#123;    constructor(props) &#123;      super(props);      this.handleChange &#x3D; this.handleChange.bind(this);      this.state &#x3D; &#123;        data: selectData(DataSource, props)      &#125;;    &#125;    componentDidMount() &#123;      &#x2F;&#x2F; ...è´Ÿè´£è®¢é˜…ç›¸å…³çš„æ“ä½œ...      DataSource.addChangeListener(this.handleChange);    &#125;    componentWillUnmount() &#123;      DataSource.removeChangeListener(this.handleChange);    &#125;    handleChange() &#123;      this.setState(&#123;        data: selectData(DataSource, this.props)      &#125;);    &#125;    render() &#123;      &#x2F;&#x2F; ... å¹¶ä½¿ç”¨æ–°æ•°æ®æ¸²æŸ“è¢«åŒ…è£…çš„ç»„ä»¶!      &#x2F;&#x2F; è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜ä¼šä¼ é€’å…¶ä»–å±æ€§      return &lt;WrappedComponent data&#x3D;&#123;this.state.data&#125; &#123;...this.props&#125; &#x2F;&gt;;    &#125;  &#125;;&#125;</code></pre><p>HOC ä¸ä¼šä¿®æ”¹ä¼ å…¥çš„ç»„ä»¶ï¼Œä¹Ÿä¸ä¼šä½¿ç”¨ç»§æ‰¿æ¥å¤åˆ¶å…¶è¡Œä¸ºã€‚ç›¸åï¼ŒHOC é€šè¿‡å°†ç»„ä»¶åŒ…è£…åœ¨å®¹å™¨ç»„ä»¶ä¸­æ¥ç»„æˆæ–°ç»„ä»¶ã€‚HOC æ˜¯çº¯å‡½æ•°ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ã€‚HOC ä¸éœ€è¦å…³å¿ƒæ•°æ®çš„ä½¿ç”¨æ–¹å¼æˆ–åŸå› ï¼Œè€Œè¢«åŒ…è£…ç»„ä»¶ä¹Ÿä¸éœ€è¦å…³å¿ƒæ•°æ®æ˜¯æ€ä¹ˆæ¥çš„ã€‚</p><p>ä¸è¦è¯•å›¾åœ¨ HOC ä¸­ä¿®æ”¹ç»„ä»¶åŸå‹ï¼ˆæˆ–ä»¥å…¶ä»–æ–¹å¼æ”¹å˜å®ƒï¼‰ã€‚å› ä¸ºè¿™ç§ä¿®æ”¹ä¼šå¯¼è‡´ç»„ä»¶è¡Œä¸ºæ°¸è¿œå‘ç”Ÿå˜åŒ–ã€‚</p><p>HOC ä¸åº”è¯¥ä¿®æ”¹ä¼ å…¥ç»„ä»¶ï¼Œè€Œåº”è¯¥ä½¿ç”¨ç»„åˆçš„æ–¹å¼ï¼Œé€šè¿‡å°†ç»„ä»¶åŒ…è£…åœ¨å®¹å™¨ç»„ä»¶ä¸­å®ç°åŠŸèƒ½ï¼š</p><pre><code class="hljs plain">function logProps(WrappedComponent) &#123;  return class extends React.Component &#123;    componentDidUpdate(prevProps) &#123;      console.log(&#39;Current props: &#39;, this.props);      console.log(&#39;Previous props: &#39;, prevProps);    &#125;    render() &#123;      &#x2F;&#x2F; å°† input ç»„ä»¶åŒ…è£…åœ¨å®¹å™¨ä¸­ï¼Œè€Œä¸å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚Good!      return &lt;WrappedComponent &#123;...this.props&#125; &#x2F;&gt;;    &#125;  &#125;&#125;</code></pre><p>æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ° HOC ä¸å®¹å™¨ç»„ä»¶æ¨¡å¼ä¹‹é—´æœ‰ç›¸ä¼¼ä¹‹å¤„ã€‚å®¹å™¨ç»„ä»¶æ‹…ä»»åˆ†ç¦»å°†é«˜å±‚å’Œä½å±‚å…³æ³¨çš„è´£ä»»ï¼Œç”±å®¹å™¨ç®¡ç†è®¢é˜…å’ŒçŠ¶æ€ï¼Œå¹¶å°† prop ä¼ é€’ç»™å¤„ç†æ¸²æŸ“ UIã€‚HOC ä½¿ç”¨å®¹å™¨ä½œä¸ºå…¶å®ç°çš„ä¸€éƒ¨åˆ†ï¼Œä½ å¯ä»¥å°† HOC è§†ä¸ºå‚æ•°åŒ–å®¹å™¨ç»„ä»¶ã€‚</p><p>æ¥çœ‹çœ‹reduxçš„connect</p><pre><code class="hljs plain">&#x2F;&#x2F; React Redux çš„ &#96;connect&#96; å‡½æ•°const ConnectedComment &#x3D; connect(commentSelector, commentActions)(CommentList);</code></pre><p>å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼å¦‚æœä½ æŠŠå®ƒåˆ†å¼€ï¼Œå°±ä¼šæ›´å®¹æ˜“çœ‹å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚</p><pre><code class="hljs plain">&#x2F;&#x2F; connect æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„è¿”å›å€¼ä¸ºå¦å¤–ä¸€ä¸ªå‡½æ•°ã€‚const enhance &#x3D; connect(commentListSelector, commentListActions);&#x2F;&#x2F; è¿”å›å€¼ä¸º HOCï¼Œå®ƒä¼šè¿”å›å·²ç»è¿æ¥ Redux store çš„ç»„ä»¶const ConnectedComment &#x3D; enhance(CommentList);</code></pre><p>æ¢å¥è¯è¯´ï¼Œconnect æ˜¯ä¸€ä¸ªè¿”å›é«˜é˜¶ç»„ä»¶çš„é«˜é˜¶å‡½æ•°ï¼</p><p>è¿™ç§å½¢å¼å¯èƒ½çœ‹èµ·æ¥ä»¤äººå›°æƒ‘æˆ–ä¸å¿…è¦ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªæœ‰ç”¨çš„å±æ€§, å……å½“è£…é¥°å™¨ï¼Œå¤šä¸ªè£…é¥°å™¨å¯ä»¥ä¸€èµ·ä½¿ç”¨ã€‚</p><pre><code class="hljs plain">&#x2F;&#x2F; è€Œä¸æ˜¯è¿™æ ·...const EnhancedComponent &#x3D; withRouter(connect(commentSelector)(WrappedComponent))&#x2F;&#x2F; ... ä½ å¯ä»¥ç¼–å†™ç»„åˆå·¥å…·å‡½æ•°&#x2F;&#x2F; compose(f, g, h) ç­‰åŒäº (...args) &#x3D;&gt; f(g(h(...args)))const enhance &#x3D; compose(  &#x2F;&#x2F; è¿™äº›éƒ½æ˜¯å•å‚æ•°çš„ HOC  withRouter,  connect(commentSelector))const EnhancedComponent &#x3D; enhance(WrappedComponent)</code></pre><p>è®¸å¤šç¬¬ä¸‰æ–¹åº“éƒ½æä¾›äº† compose å·¥å…·å‡½æ•°ï¼ŒåŒ…æ‹¬ lodash ï¼ˆæ¯”å¦‚ lodash.flowRightï¼‰ï¼Œ Redux å’Œ Ramdaã€‚</p><p>æ³¨æ„ç‚¹ï¼š</p><ul><li>ä¸è¦åœ¨ render æ–¹æ³•ä¸­ä½¿ç”¨ HOC</li><li>åŠ¡å¿…å¤åˆ¶é™æ€æ–¹æ³•</li><li>Refs ä¸ä¼šè¢«ä¼ é€’</li></ul><h3 id="8-ä¸å…¶å®ƒè§†å›¾åº“é›†æˆ"><a href="#8-ä¸å…¶å®ƒè§†å›¾åº“é›†æˆ" class="headerlink" title="8.ä¸å…¶å®ƒè§†å›¾åº“é›†æˆ"></a>8.ä¸å…¶å®ƒè§†å›¾åº“é›†æˆ</h3><p>å¾—ç›Šäº ReactDOM.render() çš„çµæ´»æ€§ React å¯ä»¥è¢«åµŒå…¥åˆ°å…¶ä»–çš„åº”ç”¨ä¸­ã€‚</p><p>è™½ç„¶ React é€šå¸¸è¢«ç”¨æ¥åœ¨å¯åŠ¨çš„æ—¶å€™åŠ è½½ä¸€ä¸ªå•ç‹¬çš„æ ¹ React ç»„ä»¶åˆ° DOM ä¸Šï¼ŒReactDOM.render() åŒæ ·å¯ä»¥åœ¨ UI çš„ç‹¬ç«‹éƒ¨åˆ†ä¸Šå¤šæ¬¡è°ƒç”¨ï¼Œè¿™äº›éƒ¨åˆ†å¯ä»¥å°åˆ°ä¸€ä¸ªæŒ‰é’®ï¼Œä¹Ÿå¯ä»¥å¤§åˆ°ä¸€ä¸ªåº”ç”¨ã€‚<br>å¦‚ï¼š</p><pre><code class="hljs plain">$(&#39;#container&#39;).html(&#39;&lt;button id&#x3D;&quot;btn&quot;&gt;Say Hello&lt;&#x2F;button&gt;&#39;);$(&#39;#btn&#39;).click(function() &#123;  alert(&#39;Hello!&#39;);&#125;);</code></pre><p>æ”¹é€ æˆï¼š</p><pre><code class="hljs plain">function Button(props) &#123;  return &lt;button onClick&#x3D;&#123;props.onClick&#125;&gt;Say Hello&lt;&#x2F;button&gt;;&#125;function HelloButton() &#123;  function handleClick() &#123;    alert(&#39;Hello!&#39;);  &#125;  return &lt;Button onClick&#x3D;&#123;handleClick&#125; &#x2F;&gt;;&#125;ReactDOM.render(  &lt;HelloButton &#x2F;&gt;,  document.getElementById(&#39;container&#39;));</code></pre><h3 id="9-æ·±å…¥JSX"><a href="#9-æ·±å…¥JSX" class="headerlink" title="9.æ·±å…¥JSX"></a>9.æ·±å…¥JSX</h3><p>å®é™…ä¸Šï¼ŒJSX ä»…ä»…åªæ˜¯ React.createElement(component, props, â€¦children) å‡½æ•°çš„è¯­æ³•ç³–ã€‚<br>å€¼å¾—è¯´çš„ç‚¹ï¼š</p><ul><li><p>Props é»˜è®¤å€¼ä¸º â€œTrueâ€ï¼Œå¦‚æœä½ æ²¡ç»™ prop èµ‹å€¼ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯ trueã€‚ä»¥ä¸‹ä¸¤ä¸ª JSX è¡¨è¾¾å¼æ˜¯ç­‰ä»·çš„ï¼š</p><pre><code class="hljs plain">&lt;MyTextBox autocomplete &#x2F;&gt;&lt;MyTextBox autocomplete&#x3D;&#123;true&#125; &#x2F;&gt;</code></pre></li><li><p>å±æ€§å±•å¼€ï¼šå¦‚æœä½ å·²ç»æœ‰äº†ä¸€ä¸ª props å¯¹è±¡ï¼Œä½ å¯ä»¥ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦ â€¦ æ¥åœ¨ JSX ä¸­ä¼ é€’æ•´ä¸ª props å¯¹è±¡ã€‚è¿˜å¯ä»¥é€‰æ‹©åªä¿ç•™å½“å‰ç»„ä»¶éœ€è¦æ¥æ”¶çš„ propsï¼Œå¹¶ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦å°†å…¶ä»– props ä¼ é€’ä¸‹å»ã€‚</p><pre><code class="hljs plain">const Button &#x3D; props &#x3D;&gt; &#123;  const &#123; kind, ...other &#125; &#x3D; props;  const className &#x3D; kind &#x3D;&#x3D;&#x3D; &quot;primary&quot; ? &quot;PrimaryButton&quot; : &quot;SecondaryButton&quot;;  return &lt;button className&#x3D;&#123;className&#125; &#123;...other&#125; &#x2F;&gt;;&#125;;</code></pre></li><li><p>å‡½æ•°ä½œä¸ºå­å…ƒç´ ã€‚ ä½ å¯ä»¥å°†ä»»ä½•ä¸œè¥¿ä½œä¸ºå­å…ƒç´ ä¼ é€’ç»™è‡ªå®šä¹‰ç»„ä»¶ï¼Œåªè¦ç¡®ä¿åœ¨è¯¥ç»„ä»¶æ¸²æŸ“ä¹‹å‰èƒ½å¤Ÿè¢«è½¬æ¢æˆ React ç†è§£çš„å¯¹è±¡ã€‚è¿™ç§ç”¨æ³•å¹¶ä¸å¸¸è§ï¼Œä½†å¯ä»¥ç”¨äºæ‰©å±• JSXã€‚</p></li><li><p>false, null, undefined, and true æ˜¯åˆæ³•çš„å­å…ƒç´ ã€‚ä½†å®ƒä»¬å¹¶ä¸ä¼šè¢«æ¸²æŸ“ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯æœ‰ä¸€äº› â€œfalsyâ€ å€¼ï¼Œå¦‚æ•°å­— 0ï¼Œä»ç„¶ä¼šè¢« React æ¸²æŸ“ã€‚ æ‰€ä»¥ä¸è¦ç”¨ aa.length &amp;&amp; Component è¿™ç§å½¢å¼ã€‚æ”¹æˆaa.length&gt;0å³å¯ã€‚</p></li></ul><h3 id="10-æ€§èƒ½ä¼˜åŒ–"><a href="#10-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="10.æ€§èƒ½ä¼˜åŒ–"></a>10.æ€§èƒ½ä¼˜åŒ–</h3><p>UI æ›´æ–°éœ€è¦æ˜‚è´µçš„ DOM æ“ä½œï¼Œè€Œ React å†…éƒ¨ä½¿ç”¨å‡ ç§å·§å¦™çš„æŠ€æœ¯ä»¥ä¾¿æœ€å°åŒ– DOM æ“ä½œæ¬¡æ•°ã€‚</p><p><strong>é¦–å…ˆï¼Œä½¿ç”¨ç”Ÿäº§ç‰ˆæœ¬ã€‚</strong><br>React é»˜è®¤åŒ…å«äº†è®¸å¤šæœ‰ç”¨çš„è­¦å‘Šä¿¡æ¯ã€‚è¿™äº›è­¦å‘Šä¿¡æ¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­éå¸¸æœ‰å¸®åŠ©ã€‚ç„¶è€Œè¿™ä½¿å¾— React å˜å¾—æ›´å¤§ä¸”æ›´æ…¢ï¼Œæ‰€ä»¥ä½ éœ€è¦ç¡®ä¿éƒ¨ç½²æ—¶ä½¿ç”¨äº†ç”Ÿäº§ç‰ˆæœ¬ã€‚å¯é€šè¿‡chromeçš„<a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi" target="_blank" rel="noopener">Reactå¼€å‘è€…å·¥å…·æ¥æ£€æŸ¥</a>ã€‚å›¾æ ‡ä¸ºè“è‰²è¡¨ç¤ºç”Ÿäº§ç‰ˆæœ¬ï¼Œå›¾ç‰‡çº¢è‰²è¡¨ç¤ºå¼€å‘æ¨¡å¼ã€‚<br><a href="https://zh-hans.reactjs.org/docs/optimizing-performance.html" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰webpack,Brunch,Browserify,Rollupæ¥è¿›è¡Œç”Ÿäº§æ„å»ºçš„æ–¹æ³•ã€‚</p><p><strong>ä½¿ç”¨chrome performanceæ ‡ç­¾åˆ†æç»„ä»¶</strong><br>åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡æ”¯æŒçš„æµè§ˆå™¨å¯è§†åŒ–åœ°äº†è§£ç»„ä»¶æ˜¯å¦‚ä½• æŒ‚è½½ã€æ›´æ–°ä»¥åŠå¸è½½çš„ã€‚<br>åœ¨ Chrome ä¸­è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><ol><li>ä¸´æ—¶ç¦ç”¨æ‰€æœ‰çš„ Chrome æ‰©å±•ï¼Œå°¤å…¶æ˜¯ React å¼€å‘è€…å·¥å…·ã€‚ä»–ä»¬ä¼šä¸¥é‡å¹²æ‰°åº¦é‡ç»“æœï¼</li><li>ç¡®ä¿ä½ æ˜¯åœ¨ React çš„å¼€å‘æ¨¡å¼ä¸‹è¿è¡Œåº”ç”¨ã€‚</li><li>æ‰“å¼€ Chrome å¼€å‘è€…å·¥å…·çš„ Performance æ ‡ç­¾å¹¶æŒ‰ä¸‹ Recordã€‚</li><li>å¯¹ä½ æƒ³åˆ†æçš„è¡Œä¸ºè¿›è¡Œå¤ç°ã€‚å°½é‡åœ¨ 20 ç§’å†…å®Œæˆä»¥é¿å… Chrome å¡ä½ã€‚</li><li>åœæ­¢è®°å½•ã€‚</li><li>åœ¨ User Timing æ ‡ç­¾ä¸‹ä¼šæ˜¾ç¤º React å½’ç±»å¥½çš„äº‹ä»¶ã€‚<br>è¿™èƒ½å¸®åŠ©ä½ æŸ¥çœ‹æ˜¯å¦æœ‰ä¸ç›¸å…³çš„ç»„ä»¶è¢«é”™è¯¯åœ°æ›´æ–°ï¼Œä»¥åŠ UI æ›´æ–°çš„æ·±åº¦å’Œé¢‘ç‡ã€‚</li></ol><p><strong>ä½¿ç”¨å¼€å‘è€…å·¥å…·ä¸­çš„åˆ†æå™¨å¯¹ç»„ä»¶è¿›è¡Œåˆ†æ</strong><br>åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒReact å¼€å‘è€…å·¥å…·ä¼šå‡ºç°åˆ†æå™¨æ ‡ç­¾ã€‚ ä½ å¯ä»¥åœ¨<a href="https://zh-hans.reactjs.org/blog/2018/09/10/introducing-the-react-profiler.html" target="_blank" rel="noopener">ã€Šä»‹ç» React åˆ†æå™¨ã€‹</a>è¿™ç¯‡åšå®¢ä¸­äº†è§£æ¦‚è¿°ã€‚ ä½ ä¹Ÿå¯ä»¥åœ¨ <a href="https://www.youtube.com/watch?v=nySib7ipZdk" target="_blank" rel="noopener">YouTube</a> ä¸Šè§‚çœ‹åˆ†æå™¨çš„è§†é¢‘æŒ‡å¯¼ã€‚</p><p><strong>è™šæ‹ŸåŒ–é•¿åˆ—è¡¨</strong><br>å¦‚æœä½ çš„åº”ç”¨æ¸²æŸ“äº†é•¿åˆ—è¡¨ï¼ˆä¸Šç™¾ç”šè‡³ä¸Šåƒçš„æ•°æ®ï¼‰ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨â€œè™šæ‹Ÿæ»šåŠ¨â€æŠ€æœ¯ã€‚è¿™é¡¹æŠ€æœ¯ä¼šåœ¨æœ‰é™çš„æ—¶é—´å†…ä»…æ¸²æŸ“æœ‰é™çš„å†…å®¹ï¼Œå¹¶å¥‡è¿¹èˆ¬åœ°é™ä½é‡æ–°æ¸²æŸ“ç»„ä»¶æ¶ˆè€—çš„æ—¶é—´ï¼Œä»¥åŠåˆ›å»º DOM èŠ‚ç‚¹çš„æ•°é‡ã€‚</p><p><a href="https://react-window.now.sh/" target="_blank" rel="noopener">react-window</a> å’Œ <a href="https://bvaughn.github.io/react-virtualized/" target="_blank" rel="noopener">react-virtualized</a> æ˜¯çƒ­é—¨çš„è™šæ‹Ÿæ»šåŠ¨åº“ã€‚ å®ƒä»¬æä¾›äº†å¤šç§å¯å¤ç”¨çš„ç»„ä»¶ï¼Œç”¨äºå±•ç¤ºåˆ—è¡¨ã€ç½‘æ ¼å’Œè¡¨æ ¼æ•°æ®ã€‚ å¦‚æœä½ æƒ³è¦ä¸€äº›é’ˆå¯¹ä½ çš„åº”ç”¨åšå®šåˆ¶ä¼˜åŒ–ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»ºä½ è‡ªå·±çš„è™šæ‹Ÿæ»šåŠ¨ç»„ä»¶ï¼Œå°±åƒ Twitter æ‰€åšçš„ã€‚</p><p><strong>é¿å…è°ƒåœ</strong><br>React æ„å»ºå¹¶ç»´æŠ¤äº†ä¸€å¥—å†…éƒ¨çš„ UI æ¸²æŸ“æè¿°ã€‚å®ƒåŒ…å«äº†æ¥è‡ªä½ çš„ç»„ä»¶è¿”å›çš„ React å…ƒç´ ã€‚å³è™šæ‹ŸDOMï¼Œä½¿å¾— React é¿å…åˆ›å»º DOM èŠ‚ç‚¹ä»¥åŠæ²¡æœ‰å¿…è¦çš„èŠ‚ç‚¹è®¿é—®ï¼Œå› ä¸º DOM æ“ä½œç›¸å¯¹äº JavaScript å¯¹è±¡æ“ä½œæ›´æ…¢ã€‚</p><p>å½“ä¸€ä¸ªç»„ä»¶çš„ props æˆ– state å˜æ›´ï¼ŒReact ä¼šå°†æœ€æ–°è¿”å›çš„å…ƒç´ ä¸ä¹‹å‰æ¸²æŸ“çš„å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œä»¥æ­¤å†³å®šæ˜¯å¦æœ‰å¿…è¦æ›´æ–°çœŸå®çš„ DOMã€‚å½“å®ƒä»¬ä¸ç›¸åŒæ—¶ï¼ŒReact ä¼šæ›´æ–°è¯¥ DOMã€‚<br>å³ä½¿ React åªæ›´æ–°æ”¹å˜äº†çš„ DOM èŠ‚ç‚¹ï¼Œé‡æ–°æ¸²æŸ“ä»ç„¶èŠ±è´¹äº†ä¸€äº›æ—¶é—´ã€‚åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹å®ƒå¹¶ä¸æ˜¯é—®é¢˜ï¼Œä¸è¿‡å¦‚æœå®ƒå·²ç»æ…¢åˆ°è®©äººæ³¨æ„äº†ï¼Œä½ å¯ä»¥é€šè¿‡è¦†ç›–ç”Ÿå‘½å‘¨æœŸæ–¹æ³• shouldComponentUpdate æ¥è¿›è¡Œæé€Ÿã€‚è¯¥æ–¹æ³•ä¼šåœ¨é‡æ–°æ¸²æŸ“å‰è¢«è§¦å‘ã€‚å…¶é»˜è®¤å®ç°æ€»æ˜¯è¿”å› trueï¼Œè®© React æ‰§è¡Œæ›´æ–°ã€‚<br>å¦‚æœä½ çŸ¥é“åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½ çš„ç»„ä»¶ä¸éœ€è¦æ›´æ–°ï¼Œä½ å¯ä»¥åœ¨ shouldComponentUpdate ä¸­è¿”å› false æ¥è·³è¿‡æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹ã€‚å…¶åŒ…æ‹¬è¯¥ç»„ä»¶çš„ render è°ƒç”¨ä»¥åŠä¹‹åçš„æ“ä½œã€‚<br>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç»§æ‰¿ React.PureComponent ä»¥ä»£æ›¿æ‰‹å†™ shouldComponentUpdate()ã€‚å®ƒç”¨å½“å‰ä¸ä¹‹å‰ props å’Œ state çš„æµ…æ¯”è¾ƒè¦†å†™äº† shouldComponentUpdate() çš„å®ç°ã€‚</p><p><strong>ä¸å¯å˜æ•°æ®çš„åŠ›é‡</strong><br>è¿™ç‚¹ä¹‹å‰å·²ç»è¯´è¿‡ï¼Œæ¯”å¦‚å¯¹äºæ•°ç»„ï¼Œç”¨concaté¿å…ç›´æ¥åœ¨åŸæ¥çš„æ•°ç»„ä¸Špushã€‚ å¯¹äºå¯¹è±¡ï¼Œç”¨Object.assigné¿å…ç›´æ¥ä¿®æ”¹å¯¹è±¡ä¸­çš„å€¼ã€‚</p><p>å½“å¤„ç†æ·±å±‚åµŒå¥—å¯¹è±¡æ—¶ï¼Œä»¥ immutable ï¼ˆä¸å¯å˜ï¼‰çš„æ–¹å¼æ›´æ–°å®ƒä»¬ä»¤äººè´¹è§£ã€‚å¦‚é‡åˆ°æ­¤ç±»é—®é¢˜ï¼Œè¯·å‚é˜… <a href="https://github.com/mweststrate/immer" target="_blank" rel="noopener">Immer</a> æˆ– <a href="https://github.com/kolodny/immutability-helper" target="_blank" rel="noopener">immutability-helper</a>ã€‚è¿™äº›åº“ä¼šå¸®åŠ©ä½ ç¼–å†™é«˜å¯è¯»æ€§çš„ä»£ç ï¼Œä¸”ä¸ä¼šå¤±å» immutability ï¼ˆä¸å¯å˜æ€§ï¼‰å¸¦æ¥çš„å¥½å¤„ã€‚</p><h3 id="11-Portals"><a href="#11-Portals" class="headerlink" title="11.Portals"></a>11.Portals</h3><p>Portal æä¾›äº†ä¸€ç§å°†å­èŠ‚ç‚¹æ¸²æŸ“åˆ°å­˜åœ¨äºçˆ¶ç»„ä»¶ä»¥å¤–çš„ DOM èŠ‚ç‚¹çš„ä¼˜ç§€çš„æ–¹æ¡ˆã€‚</p><p>é€šå¸¸æ¥è®²ï¼Œå½“ä½ ä»ç»„ä»¶çš„ render æ–¹æ³•è¿”å›ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œè¯¥å…ƒç´ å°†è¢«æŒ‚è½½åˆ° DOM èŠ‚ç‚¹ä¸­ç¦»å…¶æœ€è¿‘çš„çˆ¶èŠ‚ç‚¹ã€‚ç„¶è€Œï¼Œæœ‰æ—¶å€™å°†å­å…ƒç´ æ’å…¥åˆ° DOM èŠ‚ç‚¹ä¸­çš„ä¸åŒä½ç½®ä¹Ÿæ˜¯æœ‰å¥½å¤„çš„ã€‚<br>ä¸€ä¸ª portal çš„å…¸å‹ç”¨ä¾‹æ˜¯å½“çˆ¶ç»„ä»¶æœ‰ overflow: hidden æˆ– z-index æ ·å¼æ—¶ï¼Œä½†ä½ éœ€è¦å­ç»„ä»¶èƒ½å¤Ÿåœ¨è§†è§‰ä¸Šâ€œè·³å‡ºâ€å…¶å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œå¯¹è¯æ¡†ã€æ‚¬æµ®å¡ä»¥åŠæç¤ºæ¡†ã€‚</p><pre><code class="hljs plain">render() &#123;  &#x2F;&#x2F; React å¹¶*æ²¡æœ‰*åˆ›å»ºä¸€ä¸ªæ–°çš„ divã€‚å®ƒåªæ˜¯æŠŠå­å…ƒç´ æ¸²æŸ“åˆ° &#96;domNode&#96; ä¸­ã€‚  &#x2F;&#x2F; &#96;domNode&#96; æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ä»»ä½•ä½ç½®çš„æœ‰æ•ˆ DOM èŠ‚ç‚¹ã€‚  return ReactDOM.createPortal(    this.props.children,    domNode  );&#125;</code></pre><p>PS:å½“åœ¨ä½¿ç”¨ portal æ—¶, è®°ä½<a href="https://zh-hans.reactjs.org/docs/accessibility.html#programmatically-managing-focus" target="_blank" rel="noopener">ç®¡ç†é”®ç›˜ç„¦ç‚¹</a>å°±å˜å¾—å°¤ä¸ºé‡è¦ã€‚</p><p>å¯¹äºæ¨¡æ€å¯¹è¯æ¡†ï¼Œé€šè¿‡éµå¾ª <a href="https://www.w3.org/TR/wai-aria-practices-1.1/#dialog_modal" target="_blank" rel="noopener">WAI-ARIA æ¨¡æ€å¼€å‘å®è·µ</a>ï¼Œæ¥ç¡®ä¿æ¯ä¸ªäººéƒ½èƒ½å¤Ÿè¿ç”¨å®ƒã€‚</p><p><a href="https://codepen.io/gaearon/pen/yzMaBd" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰ä¸€ä¸ªå…³äºç”¨portalåˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†çš„ç¤ºä¾‹ã€‚</p><p>ä¸€ä¸ªä» portal å†…éƒ¨è§¦å‘çš„äº‹ä»¶ä¼šä¸€ç›´å†’æ³¡è‡³åŒ…å« React æ ‘çš„ç¥–å…ˆï¼Œå³ä¾¿è¿™äº›å…ƒç´ å¹¶ä¸æ˜¯ DOM æ ‘ ä¸­çš„ç¥–å…ˆã€‚å‡è®¾å­˜åœ¨å¦‚ä¸‹</p><pre><code class="hljs plain">&lt;html&gt;  &lt;body&gt;    &lt;div id&#x3D;&quot;app-root&quot;&gt;&lt;&#x2F;div&gt;    &lt;div id&#x3D;&quot;modal-root&quot;&gt;&lt;&#x2F;div&gt;  &lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</code></pre><p>åœ¨ #app-root é‡Œçš„ Parent ç»„ä»¶èƒ½å¤Ÿæ•è·åˆ°æœªè¢«æ•è·çš„ä»å…„å¼ŸèŠ‚ç‚¹ #modal-root å†’æ³¡ä¸Šæ¥çš„äº‹ä»¶ã€‚<br><a href="https://codepen.io/gaearon/pen/jGBWpE" target="_blank" rel="noopener">codepenå®ä¾‹</a><br>åœ¨çˆ¶ç»„ä»¶é‡Œæ•è·ä¸€ä¸ªæ¥è‡ª portal å†’æ³¡ä¸Šæ¥çš„äº‹ä»¶ï¼Œä½¿ä¹‹èƒ½å¤Ÿåœ¨å¼€å‘æ—¶å…·æœ‰ä¸å®Œå…¨ä¾èµ–äº portal çš„æ›´ä¸ºçµæ´»çš„æŠ½è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨æ¸²æŸ“ä¸€ä¸ª <Modal /> ç»„ä»¶ï¼Œæ— è®ºå…¶æ˜¯å¦é‡‡ç”¨ portal å®ç°ï¼Œçˆ¶ç»„ä»¶éƒ½èƒ½å¤Ÿæ•è·å…¶äº‹ä»¶ã€‚</p><h3 id="12-Profiler-API"><a href="#12-Profiler-API" class="headerlink" title="12.Profiler API"></a>12.Profiler API</h3><p>Profiler æµ‹é‡æ¸²æŸ“ä¸€ä¸ª React åº”ç”¨å¤šä¹…æ¸²æŸ“ä¸€æ¬¡ä»¥åŠæ¸²æŸ“ä¸€æ¬¡çš„â€œä»£ä»·â€ã€‚ å®ƒçš„ç›®çš„æ˜¯è¯†åˆ«å‡ºåº”ç”¨ä¸­æ¸²æŸ“è¾ƒæ…¢çš„éƒ¨åˆ†ï¼Œæˆ–æ˜¯å¯ä»¥ä½¿ç”¨ç±»ä¼¼ <a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#how-to-memoize-calculations" target="_blank" rel="noopener">memoization ä¼˜åŒ–</a>çš„éƒ¨åˆ†ï¼Œå¹¶ä»ç›¸å…³ä¼˜åŒ–ä¸­è·ç›Šã€‚<br><a href="https://zh-hans.reactjs.org/docs/profiler.html" target="_blank" rel="noopener">è¿™é‡Œ</a>äº†è§£è¯¦æƒ…ã€‚</p><h3 id="13-React-Diffingçš„åŸç†-åè°ƒç®—æ³•"><a href="#13-React-Diffingçš„åŸç†-åè°ƒç®—æ³•" class="headerlink" title="13.React Diffingçš„åŸç† åè°ƒç®—æ³•"></a>13.React Diffingçš„åŸç† åè°ƒç®—æ³•</h3><p>åœ¨æŸä¸€æ—¶é—´èŠ‚ç‚¹è°ƒç”¨ React çš„ render() æ–¹æ³•ï¼Œä¼šåˆ›å»ºä¸€æ£µç”± React å…ƒç´ ç»„æˆçš„æ ‘ã€‚åœ¨ä¸‹ä¸€æ¬¡ state æˆ– props æ›´æ–°æ—¶ï¼Œç›¸åŒçš„ render() æ–¹æ³•ä¼šè¿”å›ä¸€æ£µä¸åŒçš„æ ‘ã€‚React éœ€è¦åŸºäºè¿™ä¸¤æ£µæ ‘ä¹‹é—´çš„å·®åˆ«æ¥åˆ¤æ–­å¦‚ä½•æœ‰æ•ˆç‡çš„æ›´æ–° UI ä»¥ä¿è¯å½“å‰ UI ä¸æœ€æ–°çš„æ ‘ä¿æŒåŒæ­¥ã€‚<br>è¿™ä¸ªç®—æ³•é—®é¢˜æœ‰ä¸€äº›é€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå³ç”Ÿæˆå°†ä¸€æ£µæ ‘è½¬æ¢æˆå¦ä¸€æ£µæ ‘çš„æœ€å°æ“ä½œæ•°ã€‚ ç„¶è€Œï¼Œå³ä½¿åœ¨æœ€å‰æ²¿çš„ç®—æ³•ä¸­ï¼Œè¯¥ç®—æ³•çš„å¤æ‚ç¨‹åº¦ä¸º O(n 3 )ï¼Œå…¶ä¸­ n æ˜¯æ ‘ä¸­å…ƒç´ çš„æ•°é‡ã€‚<br>è¿™æ— ç–‘æœ‰äº›éš¾ä»¥æ¥å—ï¼ŒReactåŸºäºçœŸå®ä½¿ç”¨ç¯å¢ƒåšå‡º2ä¸ªå‡è®¾ï¼Œåœ¨å…¶åŸºç¡€ä¸Šæå‡ºäº†ä¸€å¥—O(n)çš„ç®—æ³•ï¼š</p><ol><li>ä¸¤ä¸ªä¸åŒç±»å‹çš„å…ƒç´ ä¼šäº§ç”Ÿå‡ºä¸åŒçš„æ ‘ï¼›</li><li>å¼€å‘è€…å¯ä»¥é€šè¿‡ key prop æ¥æš—ç¤ºå“ªäº›å­å…ƒç´ åœ¨ä¸åŒçš„æ¸²æŸ“ä¸‹èƒ½ä¿æŒç¨³å®šï¼›</li></ol><p><strong>Diffingç®—æ³•</strong><br>å½“å¯¹æ¯”ä¸¤é¢—æ ‘æ—¶ï¼ŒReact é¦–å…ˆæ¯”è¾ƒä¸¤æ£µæ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ä¸åŒç±»å‹çš„æ ¹èŠ‚ç‚¹å…ƒç´ ä¼šæœ‰ä¸åŒçš„å½¢æ€ã€‚</p><ol><li>æ¯”å¯¹ä¸åŒç±»å‹çš„å…ƒç´ <br>å½“æ ¹èŠ‚ç‚¹ä¸ºä¸åŒç±»å‹çš„å…ƒç´ æ—¶ï¼ŒReact ä¼šæ‹†å¸åŸæœ‰çš„æ ‘å¹¶ä¸”å»ºç«‹èµ·æ–°çš„æ ‘ã€‚<br>å½“æ‹†å¸ä¸€æ£µæ ‘æ—¶ï¼Œå¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹Ÿä¼šè¢«é”€æ¯ã€‚åœ¨æ ¹èŠ‚ç‚¹ä»¥ä¸‹çš„ç»„ä»¶ä¹Ÿä¼šè¢«å¸è½½ï¼Œå®ƒä»¬çš„çŠ¶æ€ä¼šè¢«é”€æ¯ã€‚</li><li>æ¯”å¯¹åŒä¸€ç±»å‹çš„å…ƒç´ <br>å½“æ¯”å¯¹ä¸¤ä¸ªç›¸åŒç±»å‹çš„ React å…ƒç´ æ—¶ï¼ŒReact ä¼šä¿ç•™ DOM èŠ‚ç‚¹ï¼Œä»…æ¯”å¯¹åŠæ›´æ–°æœ‰æ”¹å˜çš„å±æ€§ã€‚æ¯”å¦‚classNameå˜äº†å°±åªæ›´æ–°classNameå±æ€§ï¼Œå½“styleå±æ€§æ›´æ–°æ˜¯ï¼Œä¹Ÿä»…æ›´æ–°æœ‰æ‰€æ”¹å˜çš„å±æ€§ï¼Œæ¯”å¦‚colorç­‰ã€‚<br>å¤„ç†å®Œå½“å‰èŠ‚ç‚¹ä¹‹åï¼ŒReact ç»§ç»­å¯¹å­èŠ‚ç‚¹è¿›è¡Œé€’å½’ã€‚</li><li>æ¯”å¯¹åŒç±»å‹çš„ç»„ä»¶å…ƒç´ <br>å½“ä¸€ä¸ªç»„ä»¶æ›´æ–°æ—¶ï¼Œç»„ä»¶å®ä¾‹ä¿æŒä¸å˜ï¼Œè¿™æ · state åœ¨è·¨è¶Šä¸åŒçš„æ¸²æŸ“æ—¶ä¿æŒä¸€è‡´ã€‚React å°†æ›´æ–°è¯¥ç»„ä»¶å®ä¾‹çš„ props ä»¥è·Ÿæœ€æ–°çš„å…ƒç´ ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”è°ƒç”¨è¯¥å®ä¾‹çš„ componentWillReceiveProps() å’Œ componentWillUpdate() æ–¹æ³•ã€‚<br>ä¸‹ä¸€æ­¥ï¼Œè°ƒç”¨ render() æ–¹æ³•ï¼Œdiff ç®—æ³•å°†åœ¨ä¹‹å‰çš„ç»“æœä»¥åŠæ–°çš„ç»“æœä¸­è¿›è¡Œé€’å½’ã€‚</li><li>å¯¹å­èŠ‚ç‚¹è¿›è¡Œé€’å½’<br>åœ¨é»˜è®¤æ¡ä»¶ä¸‹ï¼Œå½“é€’å½’ DOM èŠ‚ç‚¹çš„å­å…ƒç´ æ—¶ï¼ŒReact ä¼šåŒæ—¶éå†ä¸¤ä¸ªå­å…ƒç´ çš„åˆ—è¡¨ï¼›å½“äº§ç”Ÿå·®å¼‚æ—¶ï¼Œç”Ÿæˆä¸€ä¸ª mutationã€‚<br>åœ¨å­å…ƒç´ åˆ—è¡¨æœ«å°¾æ–°å¢å…ƒç´ æ—¶ï¼Œæ›´å˜å¼€é”€æ¯”è¾ƒå°ã€‚React ä¼šé’ˆå¯¹æ¯ä¸ªå­å…ƒç´  mutate è€Œä¸æ˜¯ä¿æŒç›¸åŒçš„ <code>&lt;li&gt;Duke&lt;/li&gt;</code> å’Œ <code>&lt;li&gt;Villanova&lt;/li&gt;</code> å­æ ‘å®Œæˆã€‚è¿™ç§æƒ…å†µä¸‹çš„ä½æ•ˆå¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚<br>æ‰€ä»¥å¼•è¿›äº†keyå±æ€§ã€‚</li></ol><p><strong>æ€»ä¹‹</strong><br>React å¯ä»¥åœ¨æ¯ä¸ª action ä¹‹åå¯¹æ•´ä¸ªåº”ç”¨è¿›è¡Œé‡æ–°æ¸²æŸ“ï¼Œå¾—åˆ°çš„æœ€ç»ˆç»“æœä¹Ÿä¼šæ˜¯ä¸€æ ·çš„ã€‚åœ¨æ­¤æƒ…å¢ƒä¸‹ï¼Œé‡æ–°æ¸²æŸ“è¡¨ç¤ºåœ¨æ‰€æœ‰ç»„ä»¶å†…è°ƒç”¨ render æ–¹æ³•ï¼Œè¿™ä¸ä»£è¡¨ React ä¼šå¸è½½æˆ–è£…è½½å®ƒä»¬ã€‚React åªä¼šåŸºäºä»¥ä¸Šæåˆ°çš„è§„åˆ™æ¥å†³å®šå¦‚ä½•è¿›è¡Œå·®å¼‚çš„åˆå¹¶ã€‚<br>ç”±äº React ä¾èµ–æ¢ç´¢çš„ç®—æ³•ï¼Œå› æ­¤å½“ä»¥ä¸‹å‡è®¾æ²¡æœ‰å¾—åˆ°æ»¡è¶³ï¼Œæ€§èƒ½ä¼šæœ‰æ‰€æŸè€—ã€‚</p><ol><li>è¯¥ç®—æ³•ä¸ä¼šå°è¯•åŒ¹é…ä¸åŒç»„ä»¶ç±»å‹çš„å­æ ‘ã€‚å¦‚æœä½ å‘ç°ä½ åœ¨ä¸¤ç§ä¸åŒç±»å‹çš„ç»„ä»¶ä¸­åˆ‡æ¢ï¼Œä½†è¾“å‡ºéå¸¸ç›¸ä¼¼çš„å†…å®¹ï¼Œå»ºè®®æŠŠå®ƒä»¬æ”¹æˆåŒä¸€ç±»å‹ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰é‡åˆ°è¿™ç±»é—®é¢˜ã€‚</li><li>Key åº”è¯¥å…·æœ‰ç¨³å®šï¼Œå¯é¢„æµ‹ï¼Œä»¥åŠåˆ—è¡¨å†…å”¯ä¸€çš„ç‰¹è´¨ã€‚ä¸ç¨³å®šçš„ keyï¼ˆæ¯”å¦‚é€šè¿‡ Math.random() ç”Ÿæˆçš„ï¼‰ä¼šå¯¼è‡´è®¸å¤šç»„ä»¶å®ä¾‹å’Œ DOM èŠ‚ç‚¹è¢«ä¸å¿…è¦åœ°é‡æ–°åˆ›å»ºï¼Œè¿™å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™å’Œå­ç»„ä»¶ä¸­çš„çŠ¶æ€ä¸¢å¤±ã€‚</li></ol><h3 id="14-render-props"><a href="#14-render-props" class="headerlink" title="14.render props"></a>14.render props</h3><p>æœ¯è¯­ â€œrender propâ€ æ˜¯æŒ‡ä¸€ç§åœ¨ React ç»„ä»¶ä¹‹é—´ä½¿ç”¨ä¸€ä¸ªå€¼ä¸ºå‡½æ•°çš„ prop å…±äº«ä»£ç çš„ç®€å•æŠ€æœ¯</p><p>å…·æœ‰ render prop çš„ç»„ä»¶æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ª React å…ƒç´ å¹¶è°ƒç”¨å®ƒè€Œä¸æ˜¯å®ç°è‡ªå·±çš„æ¸²æŸ“é€»è¾‘ã€‚</p><pre><code class="hljs plain">&lt;DataProvider render&#x3D;&#123;data &#x3D;&gt; (  &lt;h1&gt;Hello &#123;data.target&#125;&lt;&#x2F;h1&gt;)&#125;&#x2F;&gt;</code></pre><p>ä½¿ç”¨ render prop çš„åº“æœ‰ React Routerã€Downshift ä»¥åŠ Formikã€‚<br>æ›´å…·ä½“åœ°è¯´ï¼Œrender prop æ˜¯ä¸€ä¸ªç”¨äºå‘ŠçŸ¥ç»„ä»¶éœ€è¦æ¸²æŸ“ä»€ä¹ˆå†…å®¹çš„å‡½æ•° propã€‚</p><pre><code class="hljs plain">class Cat extends React.Component &#123;  render() &#123;    const mouse &#x3D; this.props.mouse;    return (      &lt;img src&#x3D;&quot;&#x2F;cat.jpg&quot; style&#x3D;&#123;&#123; position: &#39;absolute&#39;, left: mouse.x, top: mouse.y &#125;&#125; &#x2F;&gt;    );  &#125;&#125;class Mouse extends React.Component &#123;  constructor(props) &#123;    super(props);    this.handleMouseMove &#x3D; this.handleMouseMove.bind(this);    this.state &#x3D; &#123; x: 0, y: 0 &#125;;  &#125;  handleMouseMove(event) &#123;    this.setState(&#123;      x: event.clientX,      y: event.clientY    &#125;);  &#125;  render() &#123;    return (      &lt;div style&#x3D;&#123;&#123; height: &#39;100vh&#39; &#125;&#125; onMouseMove&#x3D;&#123;this.handleMouseMove&#125;&gt;        &#123;&#x2F;*          Instead of providing a static representation of what &lt;Mouse&gt; renders,          use the &#96;render&#96; prop to dynamically determine what to render.        *&#x2F;&#125;        &#123;this.props.render(this.state)&#125;      &lt;&#x2F;div&gt;    );  &#125;&#125;class MouseTracker extends React.Component &#123;  render() &#123;    return (      &lt;div&gt;        &lt;h1&gt;ç§»åŠ¨é¼ æ ‡!&lt;&#x2F;h1&gt;        &lt;Mouse render&#x3D;&#123;mouse &#x3D;&gt; (          &lt;Cat mouse&#x3D;&#123;mouse&#125; &#x2F;&gt;        )&#125;&#x2F;&gt;      &lt;&#x2F;div&gt;    );  &#125;&#125;</code></pre><p>è¿™é¡¹æŠ€æœ¯ä½¿æˆ‘ä»¬å…±äº«è¡Œä¸ºéå¸¸å®¹æ˜“ã€‚è¦è·å¾—è¿™ä¸ªè¡Œä¸ºï¼Œåªè¦æ¸²æŸ“ä¸€ä¸ªå¸¦æœ‰ render prop çš„ <Mouse> ç»„ä»¶å°±èƒ½å¤Ÿå‘Šè¯‰å®ƒå½“å‰é¼ æ ‡åæ ‡ (x, y) è¦æ¸²æŸ“ä»€ä¹ˆã€‚</p><p>å…³äº render prop ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…æ˜¯ä½ å¯ä»¥ä½¿ç”¨å¸¦æœ‰ render prop çš„å¸¸è§„ç»„ä»¶æ¥å®ç°å¤§å¤šæ•°é«˜é˜¶ç»„ä»¶ (HOC)ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä½ æ›´å–œæ¬¢ä½¿ç”¨ withMouse HOCè€Œä¸æ˜¯ <Mouse> ç»„ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å¸¦æœ‰ render prop çš„å¸¸è§„ <Mouse> è½»æ¾åˆ›å»ºä¸€ä¸ª</p><pre><code class="hljs plain">&#x2F;&#x2F; å¦‚æœä½ å‡ºäºæŸç§åŸå› çœŸçš„æƒ³è¦ HOCï¼Œé‚£ä¹ˆä½ å¯ä»¥è½»æ¾å®ç°&#x2F;&#x2F; ä½¿ç”¨å…·æœ‰ render prop çš„æ™®é€šç»„ä»¶åˆ›å»ºä¸€ä¸ªï¼function withMouse(Component) &#123;  return class extends React.Component &#123;    render() &#123;      return (        &lt;Mouse render&#x3D;&#123;mouse &#x3D;&gt; (          &lt;Component &#123;...this.props&#125; mouse&#x3D;&#123;mouse&#125; &#x2F;&gt;        )&#125;&#x2F;&gt;      );    &#125;  &#125;&#125;</code></pre><p>é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œrender prop æ˜¯å› ä¸ºæ¨¡å¼æ‰è¢«ç§°ä¸º render prop ï¼Œä½ ä¸ä¸€å®šè¦ç”¨åä¸º render çš„ prop æ¥ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚äº‹å®ä¸Šï¼Œ <strong>ä»»ä½•è¢«ç”¨äºå‘ŠçŸ¥ç»„ä»¶éœ€è¦æ¸²æŸ“ä»€ä¹ˆå†…å®¹çš„å‡½æ•° prop åœ¨æŠ€æœ¯ä¸Šéƒ½å¯ä»¥è¢«ç§°ä¸º â€œrender propâ€.</strong></p><h3 id="15-é™æ€ç±»å‹æ£€æŸ¥"><a href="#15-é™æ€ç±»å‹æ£€æŸ¥" class="headerlink" title="15.é™æ€ç±»å‹æ£€æŸ¥"></a>15.é™æ€ç±»å‹æ£€æŸ¥</h3><p>åƒ Flow å’Œ TypeScript ç­‰è¿™äº›é™æ€ç±»å‹æ£€æŸ¥å™¨ï¼Œå¯ä»¥åœ¨è¿è¡Œå‰è¯†åˆ«æŸäº›ç±»å‹çš„é—®é¢˜ã€‚ä»–ä»¬è¿˜å¯ä»¥é€šè¿‡å¢åŠ è‡ªåŠ¨è¡¥å…¨ç­‰åŠŸèƒ½æ¥æ”¹å–„å¼€å‘è€…çš„å·¥ä½œæµç¨‹ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬å»ºè®®åœ¨å¤§å‹ä»£ç åº“ä¸­ä½¿ç”¨ Flow æˆ– TypeScript æ¥ä»£æ›¿ PropTypesã€‚</p><p>Flowä»‹ç»åœ¨<a href="https://zh-hans.reactjs.org/docs/static-type-checking.html" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p><strong>typescript</strong><br>TypeScript æ˜¯ä¸€ç§ç”±å¾®è½¯å¼€å‘çš„ç¼–ç¨‹è¯­è¨€ã€‚å®ƒæ˜¯ JavaScript çš„ä¸€ä¸ªç±»å‹è¶…é›†ï¼ŒåŒ…å«ç‹¬ç«‹çš„ç¼–è¯‘å™¨ã€‚ä½œä¸ºä¸€ç§ç±»å‹è¯­è¨€ï¼ŒTypeScript å¯ä»¥åœ¨æ„å»ºæ—¶å‘ç° bug å’Œé”™è¯¯ï¼Œè¿™æ ·ç¨‹åºè¿è¡Œæ—¶å°±å¯ä»¥é¿å…æ­¤ç±»é”™è¯¯ã€‚æ‚¨å¯ä»¥é€šè¿‡<a href="https://github.com/Microsoft/TypeScript-React-Starter#typescript-react-starter" target="_blank" rel="noopener">æ­¤æ–‡æ¡£</a> äº†è§£æ›´å¤šæœ‰å…³åœ¨ React ä¸­ä½¿ç”¨ TypeScript çš„çŸ¥è¯†ã€‚</p><p>å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼Œä¾¿å¯å¼€å§‹ä½¿ç”¨ TypeScriptï¼š</p><ul><li>å°† TypeScript æ·»åŠ åˆ°ä½ çš„é¡¹ç›®ä¾èµ–ä¸­ã€‚</li><li>é…ç½® TypeScript ç¼–è¯‘é€‰é¡¹</li><li>ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶æ‰©å±•å</li><li>ä¸ºä½ ä½¿ç”¨çš„åº“æ·»åŠ å®šä¹‰</li></ul><p>å¦‚æœä½ ä½¿ç”¨create-react-app,é‚£ä¹ˆä½¿ç”¨<code>npx create-react-app my-app --template typescript</code>å³å¯åˆ›å»ºä¸€ä¸ªä½¿ç”¨TypeScriptçš„æ–°é¡¹ç›®ã€‚</p><p>å…³äºæ€ä¹ˆåœ¨ç°æœ‰é¡¹ç›®ä¸­å¼•å…¥TSï¼Œè§<a href="https://zh-hans.reactjs.org/docs/static-type-checking.html" target="_blank" rel="noopener">è¿™é‡Œ</a></p><p><strong>Kotlin</strong><br>Kotlin æ˜¯ç”± JetBrains å¼€å‘çš„ä¸€é—¨é™æ€ç±»å‹è¯­è¨€ã€‚å…¶ç›®æ ‡å¹³å°åŒ…æ‹¬ JVMã€Androidã€LLVM å’Œ JavaScriptã€‚</p><p>JetBrains ä¸“é—¨ä¸º React ç¤¾åŒºå¼€å‘å’Œç»´æŠ¤äº†å‡ ä¸ªå·¥å…·ï¼šReact bindings ä»¥åŠ Create React Kotlin Appã€‚åè€…å¯ä»¥é€šè¿‡ Kotlin å¿«é€Ÿç¼–å†™ React åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”ä¸éœ€è¦æ„å»ºé…ç½®ã€‚</p><h3 id="16-ä¸¥æ ¼æ¨¡å¼"><a href="#16-ä¸¥æ ¼æ¨¡å¼" class="headerlink" title="16.ä¸¥æ ¼æ¨¡å¼"></a>16.ä¸¥æ ¼æ¨¡å¼</h3><p>StrictMode æ˜¯ä¸€ä¸ªç”¨æ¥çªå‡ºæ˜¾ç¤ºåº”ç”¨ç¨‹åºä¸­æ½œåœ¨é—®é¢˜çš„å·¥å…·ã€‚ä¸ Fragment ä¸€æ ·ï¼ŒStrictMode ä¸ä¼šæ¸²æŸ“ä»»ä½•å¯è§çš„ UIã€‚å®ƒä¸ºå…¶åä»£å…ƒç´ è§¦å‘é¢å¤–çš„æ£€æŸ¥å’Œè­¦å‘Šã€‚</p><pre><code class="hljs plain">import React from &#39;react&#39;;function ExampleApplication() &#123;  return (    &lt;div&gt;      &lt;Header &#x2F;&gt;      &lt;React.StrictMode&gt;        &lt;div&gt;          &lt;ComponentOne &#x2F;&gt;          &lt;ComponentTwo &#x2F;&gt;        &lt;&#x2F;div&gt;      &lt;&#x2F;React.StrictMode&gt;      &lt;Footer &#x2F;&gt;    &lt;&#x2F;div&gt;  );&#125;</code></pre><p>StrictMode ç›®å‰æœ‰åŠ©äºï¼š</p><ul><li>è¯†åˆ«ä¸å®‰å…¨çš„ç”Ÿå‘½å‘¨æœŸ</li><li>å…³äºä½¿ç”¨è¿‡æ—¶å­—ç¬¦ä¸² ref API çš„è­¦å‘Š</li><li>å…³äºä½¿ç”¨åºŸå¼ƒçš„ findDOMNode æ–¹æ³•çš„è­¦å‘Š</li><li>æ£€æµ‹æ„å¤–çš„å‰¯ä½œç”¨</li><li>æ£€æµ‹è¿‡æ—¶çš„ context API<br>è¯¦æƒ…è§<a href="https://zh-hans.reactjs.org/docs/strict-mode.html" target="_blank" rel="noopener">è¿™é‡Œ</a></li></ul><h3 id="17-PropTypes-ç±»å‹æ£€æŸ¥"><a href="#17-PropTypes-ç±»å‹æ£€æŸ¥" class="headerlink" title="17.PropTypes ç±»å‹æ£€æŸ¥"></a>17.PropTypes ç±»å‹æ£€æŸ¥</h3><p>ç¬¬15ç‚¹ä¸­è¯´è¿‡ï¼ŒFlowå’ŒTypeScriptå¯ä»¥å¯¹æ•´ä¸ªåº”ç”¨ç¨‹åºè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä½†å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨è¿™äº›æ‰©å±•ã€‚ä½ å¯ä»¥ä½¿ç”¨å†…ç½®çš„PropTypesæ¥è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚</p><pre><code class="hljs plain">import PropTypes from &#39;prop-types&#39;;class Greeting extends React.Component &#123;  render() &#123;    return (      &lt;h1&gt;Hello, &#123;this.props.name&#125;&lt;&#x2F;h1&gt;    );  &#125;&#125;Greeting.propTypes &#x3D; &#123;  name: PropTypes.string&#125;;</code></pre><p>å½“ä¼ å…¥çš„ prop å€¼ç±»å‹ä¸æ­£ç¡®æ—¶ï¼ŒJavaScript æ§åˆ¶å°å°†ä¼šæ˜¾ç¤ºè­¦å‘Šã€‚å‡ºäºæ€§èƒ½æ–¹é¢çš„è€ƒè™‘ï¼ŒpropTypes ä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹è¿›è¡Œæ£€æŸ¥ã€‚</p><p>ç±»å‹å¾ˆå¤šï¼Œå¦‚ä¸‹ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰ï¼š</p><pre><code class="hljs plain">import PropTypes from &#39;prop-types&#39;;MyComponent.propTypes &#x3D; &#123;  &#x2F;&#x2F; ä½ å¯ä»¥å°†å±æ€§å£°æ˜ä¸º JS åŸç”Ÿç±»å‹ï¼Œé»˜è®¤æƒ…å†µä¸‹  &#x2F;&#x2F; è¿™äº›å±æ€§éƒ½æ˜¯å¯é€‰çš„ã€‚  optionalArray: PropTypes.array,  optionalBool: PropTypes.bool,  optionalFunc: PropTypes.func,  optionalNumber: PropTypes.number,  optionalObject: PropTypes.object,  optionalString: PropTypes.string,  optionalSymbol: PropTypes.symbol,  &#x2F;&#x2F; ä»»ä½•å¯è¢«æ¸²æŸ“çš„å…ƒç´ ï¼ˆåŒ…æ‹¬æ•°å­—ã€å­—ç¬¦ä¸²ã€å…ƒç´ æˆ–æ•°ç»„ï¼‰  &#x2F;&#x2F; (æˆ– Fragment) ä¹ŸåŒ…å«è¿™äº›ç±»å‹ã€‚  optionalNode: PropTypes.node,  &#x2F;&#x2F; ä¸€ä¸ª React å…ƒç´ ã€‚  optionalElement: PropTypes.element,  &#x2F;&#x2F; ä¸€ä¸ª React å…ƒç´ ç±»å‹ï¼ˆå³ï¼ŒMyComponentï¼‰ã€‚  optionalElementType: PropTypes.elementType,  &#x2F;&#x2F; ä½ ä¹Ÿå¯ä»¥å£°æ˜ prop ä¸ºç±»çš„å®ä¾‹ï¼Œè¿™é‡Œä½¿ç”¨  &#x2F;&#x2F; JS çš„ instanceof æ“ä½œç¬¦ã€‚  optionalMessage: PropTypes.instanceOf(Message),  &#x2F;&#x2F; ä½ å¯ä»¥è®©ä½ çš„ prop åªèƒ½æ˜¯ç‰¹å®šçš„å€¼ï¼ŒæŒ‡å®šå®ƒä¸º  &#x2F;&#x2F; æšä¸¾ç±»å‹ã€‚  optionalEnum: PropTypes.oneOf([&#39;News&#39;, &#39;Photos&#39;]),  &#x2F;&#x2F; ä¸€ä¸ªå¯¹è±¡å¯ä»¥æ˜¯å‡ ç§ç±»å‹ä¸­çš„ä»»æ„ä¸€ä¸ªç±»å‹  optionalUnion: PropTypes.oneOfType([    PropTypes.string,    PropTypes.number,    PropTypes.instanceOf(Message)  ]),  &#x2F;&#x2F; å¯ä»¥æŒ‡å®šä¸€ä¸ªæ•°ç»„ç”±æŸä¸€ç±»å‹çš„å…ƒç´ ç»„æˆ  optionalArrayOf: PropTypes.arrayOf(PropTypes.number),  &#x2F;&#x2F; å¯ä»¥æŒ‡å®šä¸€ä¸ªå¯¹è±¡ç”±æŸä¸€ç±»å‹çš„å€¼ç»„æˆ  optionalObjectOf: PropTypes.objectOf(PropTypes.number),  &#x2F;&#x2F; å¯ä»¥æŒ‡å®šä¸€ä¸ªå¯¹è±¡ç”±ç‰¹å®šçš„ç±»å‹å€¼ç»„æˆ  optionalObjectWithShape: PropTypes.shape(&#123;    color: PropTypes.string,    fontSize: PropTypes.number  &#125;),    &#x2F;&#x2F; An object with warnings on extra properties  optionalObjectWithStrictShape: PropTypes.exact(&#123;    name: PropTypes.string,    quantity: PropTypes.number  &#125;),     &#x2F;&#x2F; ä½ å¯ä»¥åœ¨ä»»ä½• PropTypes å±æ€§åé¢åŠ ä¸Š &#96;isRequired&#96; ï¼Œç¡®ä¿  &#x2F;&#x2F; è¿™ä¸ª prop æ²¡æœ‰è¢«æä¾›æ—¶ï¼Œä¼šæ‰“å°è­¦å‘Šä¿¡æ¯ã€‚  requiredFunc: PropTypes.func.isRequired,  &#x2F;&#x2F; ä»»æ„ç±»å‹çš„æ•°æ®  requiredAny: PropTypes.any.isRequired,  &#x2F;&#x2F; ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰éªŒè¯å™¨ã€‚å®ƒåœ¨éªŒè¯å¤±è´¥æ—¶åº”è¿”å›ä¸€ä¸ª Error å¯¹è±¡ã€‚  &#x2F;&#x2F; è¯·ä¸è¦ä½¿ç”¨ &#96;console.warn&#96; æˆ–æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºè¿™åœ¨ &#96;onOfType&#96; ä¸­ä¸ä¼šèµ·ä½œç”¨ã€‚  customProp: function(props, propName, componentName) &#123;    if (!&#x2F;matchme&#x2F;.test(props[propName])) &#123;      return new Error(        &#39;Invalid prop &#96;&#39; + propName + &#39;&#96; supplied to&#39; +        &#39; &#96;&#39; + componentName + &#39;&#96;. Validation failed.&#39;      );    &#125;  &#125;,  &#x2F;&#x2F; ä½ ä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„ &#96;arrayOf&#96; æˆ– &#96;objectOf&#96; éªŒè¯å™¨ã€‚  &#x2F;&#x2F; å®ƒåº”è¯¥åœ¨éªŒè¯å¤±è´¥æ—¶è¿”å›ä¸€ä¸ª Error å¯¹è±¡ã€‚  &#x2F;&#x2F; éªŒè¯å™¨å°†éªŒè¯æ•°ç»„æˆ–å¯¹è±¡ä¸­çš„æ¯ä¸ªå€¼ã€‚éªŒè¯å™¨çš„å‰ä¸¤ä¸ªå‚æ•°  &#x2F;&#x2F; ç¬¬ä¸€ä¸ªæ˜¯æ•°ç»„æˆ–å¯¹è±¡æœ¬èº«  &#x2F;&#x2F; ç¬¬äºŒä¸ªæ˜¯ä»–ä»¬å½“å‰çš„é”®ã€‚  customArrayProp: PropTypes.arrayOf(function(propValue, key, componentName, location, propFullName) &#123;    if (!&#x2F;matchme&#x2F;.test(propValue[key])) &#123;      return new Error(        &#39;Invalid prop &#96;&#39; + propFullName + &#39;&#96; supplied to&#39; +        &#39; &#96;&#39; + componentName + &#39;&#96;. Validation failed.&#39;      );    &#125;  &#125;)&#125;;</code></pre><p><strong>é™åˆ¶å•ä¸ªå…ƒç´ </strong><br>ä½ å¯ä»¥é€šè¿‡ PropTypes.element æ¥ç¡®ä¿ä¼ é€’ç»™ç»„ä»¶çš„ children ä¸­åªåŒ…å«ä¸€ä¸ªå…ƒç´ ã€‚</p><pre><code class="hljs plain">&#x2F;&#x2F; childrenå¿…é¡»åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå¦åˆ™æ§åˆ¶å°ä¼šæ‰“å°è­¦å‘Šã€‚MyComponent.propTypes &#x3D; &#123;  children: PropTypes.element.isRequired&#125;;</code></pre><p><strong>é»˜è®¤Propå€¼</strong><br>æ‚¨å¯ä»¥é€šè¿‡é…ç½®ç‰¹å®šçš„ defaultProps å±æ€§æ¥å®šä¹‰ props çš„é»˜è®¤å€¼ï¼š</p><pre><code class="hljs plain">class Greeting extends React.Component &#123;  render() &#123;    return (      &lt;h1&gt;Hello, &#123;this.props.name&#125;&lt;&#x2F;h1&gt;    );  &#125;&#125;&#x2F;&#x2F; æŒ‡å®š props çš„é»˜è®¤å€¼ï¼šGreeting.defaultProps &#x3D; &#123;  name: &#39;Stranger&#39;&#125;;&#x2F;&#x2F; ä¸ä¼ é€’nameå°†æ¸²æŸ“å‡º &quot;Hello, Stranger&quot;ï¼š</code></pre><h3 id="18-éå—æ§ç»„ä»¶"><a href="#18-éå—æ§ç»„ä»¶" class="headerlink" title="18.éå—æ§ç»„ä»¶"></a>18.éå—æ§ç»„ä»¶</h3><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ å—æ§ç»„ä»¶ æ¥å¤„ç†è¡¨å•æ•°æ®ã€‚åœ¨ä¸€ä¸ªå—æ§ç»„ä»¶ä¸­ï¼Œè¡¨å•æ•°æ®æ˜¯ç”± React ç»„ä»¶æ¥ç®¡ç†çš„ã€‚å¦ä¸€ç§æ›¿ä»£æ–¹æ¡ˆæ˜¯ä½¿ç”¨éå—æ§ç»„ä»¶ï¼Œè¿™æ—¶è¡¨å•æ•°æ®å°†äº¤ç”± DOM èŠ‚ç‚¹æ¥å¤„ç†ã€‚å³ä½¿ç”¨ç±»ä¼¼refç­‰åŠŸèƒ½æ¥ä»DOMèŠ‚ç‚¹è·å–è¡¨å•æ•°æ®ã€‚</p><p><strong>é»˜è®¤å€¼</strong><br>åœ¨ React æ¸²æŸ“ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œè¡¨å•å…ƒç´ ä¸Šçš„ value å°†ä¼šè¦†ç›– DOM èŠ‚ç‚¹ä¸­çš„å€¼ï¼Œåœ¨éå—æ§ç»„ä»¶ä¸­ï¼Œä½ ç»å¸¸å¸Œæœ› React èƒ½èµ‹äºˆç»„ä»¶ä¸€ä¸ªåˆå§‹å€¼ï¼Œä½†æ˜¯ä¸å»æ§åˆ¶åç»­çš„æ›´æ–°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹, ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ª defaultValue å±æ€§ï¼Œè€Œä¸æ˜¯ valueã€‚</p><p><strong>æ–‡ä»¶è¾“å…¥</strong></p><pre><code class="hljs <input">ä½¿ç”¨ File API ä¸æ–‡ä»¶è¿›è¡Œäº¤äº’ã€‚</code></pre><p>class FileInput extends React.Component {<br>  constructor(props) {<br>    super(props);<br>    this.handleSubmit = this.handleSubmit.bind(this);<br>    this.fileInput = React.createRef();<br>  }<br>  handleSubmit(event) {<br>    event.preventDefault();<br>    alert(<br>      <code>Selected file - ${this.fileInput.current.files[0].name}</code><br>    );<br>  }</p><p>  render() {<br>    return (<br>      <form onSubmit={this.handleSubmit}><br>        <label><br>          Upload file:<br>          <input type="file" ref={this.fileInput} /><br>        </label><br>        <br /><br>        <button type="submit">Submit</button><br>      </form><br>    );<br>  }<br>}</p><p>ReactDOM.render(<br>  <FileInput />,<br>  document.getElementById(â€˜rootâ€™)<br>);</p><pre><code class="hljs plain">### 19. Web ComponentsReact å’Œ Web Components ä¸ºäº†è§£å†³ä¸åŒçš„é—®é¢˜è€Œç”Ÿã€‚Web Components ä¸ºå¯å¤ç”¨ç»„ä»¶æä¾›äº†å¼ºå¤§çš„å°è£…ï¼Œè€Œ React åˆ™æä¾›äº†å£°æ˜å¼çš„è§£å†³æ–¹æ¡ˆï¼Œä½¿ DOM ä¸æ•°æ®ä¿æŒåŒæ­¥ã€‚ä¸¤è€…æ—¨åœ¨äº’è¡¥ã€‚ä½œä¸ºå¼€å‘äººå‘˜ï¼Œå¯ä»¥è‡ªç”±é€‰æ‹©åœ¨ Web Components ä¸­ä½¿ç”¨ Reactï¼Œæˆ–è€…åœ¨ React ä¸­ä½¿ç”¨ Web Componentsï¼Œæˆ–è€…ä¸¤è€…å…±å­˜ã€‚å¤§å¤šæ•°å¼€å‘è€…åœ¨ä½¿ç”¨ React æ—¶ï¼Œä¸ä½¿ç”¨ Web Componentsï¼Œä½†å¯èƒ½ä½ ä¼šéœ€è¦ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨ Web Components ç¼–å†™çš„ç¬¬ä¸‰æ–¹ UI ç»„ä»¶æ—¶ã€‚</code></pre><p>class HelloMessage extends React.Component {<br>  render() {<br>    return <div>Hello <x-search>{this.props.name}</x-search>!</div>;<br>  }<br>}</p><pre><code class="hljs plain">Web Components é€šå¸¸æš´éœ²çš„æ˜¯å‘½ä»¤å¼ APIã€‚ä¾‹å¦‚ï¼ŒWeb Components çš„ç»„ä»¶ video å¯èƒ½ä¼šå…¬å¼€ play() å’Œ pause() æ–¹æ³•ã€‚è¦è®¿é—® Web Components çš„å‘½ä»¤å¼ APIï¼Œä½ éœ€è¦ä½¿ç”¨ ref ç›´æ¥ä¸ DOM èŠ‚ç‚¹è¿›è¡Œäº¤äº’ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹ Web Componentsï¼Œé‚£ä¹ˆæœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ç¼–å†™ React ç»„ä»¶åŒ…è£…è¯¥ Web Componentsã€‚Web Components è§¦å‘çš„äº‹ä»¶å¯èƒ½æ— æ³•é€šè¿‡ React æ¸²æŸ“æ ‘æ­£ç¡®çš„ä¼ é€’ã€‚ ä½ éœ€è¦åœ¨ React ç»„ä»¶ä¸­æ‰‹åŠ¨æ·»åŠ äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚å¸¸è§çš„è¯¯åŒºæ˜¯è¦æ³¨æ„åœ¨ Web Components ä¸­åº”è¯¥ä½¿ç”¨ class è€Œé classNameã€‚**åœ¨ Web Components ä¸­ä½¿ç”¨ React**</code></pre><p>class XSearch extends HTMLElement {<br>  connectedCallback() {<br>    const mountPoint = document.createElement(â€˜spanâ€™);<br>    this.attachShadow({ mode: â€˜openâ€™ }).appendChild(mountPoint);</p><pre><code>const name = this.getAttribute(&apos;name&apos;);const url = &apos;https://www.google.com/search?q=&apos; + encodeURIComponent(name);ReactDOM.render(&lt;a href={url}&gt;{name}&lt;/a&gt;, mountPoint);</code></pre><p>  }<br>}<br>customElements.define(â€˜x-searchâ€™, XSearch);</p><p>```<br>æ³¨æ„ï¼š<br>å¦‚æœä½¿ç”¨ Babel æ¥è½¬æ¢ classï¼Œæ­¤ä»£ç å°†ä¸ä¼šèµ·ä½œç”¨ã€‚è¯·æŸ¥é˜…è¯¥ <a href="https://github.com/w3c/webcomponents/issues/587" target="_blank" rel="noopener">issue</a> äº†è§£ç›¸å…³è®¨è®ºã€‚ åœ¨åŠ è½½ Web Components å‰è¯·å¼•å…¥ <a href="https://github.com/webcomponents/polyfills/tree/master/packages/webcomponentsjs#custom-elements-es5-adapterjs" target="_blank" rel="noopener">custom-elements-es5-adapter</a> æ¥è§£å†³è¯¥ issueã€‚</p>]]></content>
    
    
    <categories>
      
      <category>webå‰ç«¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åŸºç¡€</tag>
      
      <tag>React</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Reactå®˜æ–¹æ–‡æ¡£çŸ¥è¯†ç‚¹-åŸºæœ¬</title>
    <link href="/2020/05/28/React%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%9F%A5%E8%AF%86%E7%82%B9-%E5%9F%BA%E6%9C%AC/"/>
    <url>/2020/05/28/React%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%9F%A5%E8%AF%86%E7%82%B9-%E5%9F%BA%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‡†å¤‡é¢è¯•å‰ç«¯å·¥ä½œï¼Œå¾ˆå¤šå¾ˆä¹…æ²¡ä½¿ç”¨çš„ä¸œè¥¿æ˜¯åº”è¯¥å¤ä¹ ä¸€ä¸‹äº†ã€‚é¦–å½“å…¶å†²å°±æ˜¯å‰ç«¯é¢†åŸŸçš„ä¸‰å¤§æ¡†æ¶ã€‚åœ¨è¿™é‡Œå°±ä¸å†æ¯”è¾ƒè¿™ä¸‰ä¸ªæ¡†æ¶çš„ä¼˜åŠ£ï¼Œæˆ‘ä»15å¹´åº•å¼€å§‹ç”¨reactï¼Œä¹Ÿç®—æ˜¯å¾ˆæ—©æœŸçš„ä¸€æ‰¹ç”¨æˆ·äº†ï¼Œæ‰€ä»¥å…ˆä»å®˜æ–¹æ–‡æ¡£å‡ºå‘å¤ä¹ ä¸€ä¸‹Reactçš„çŸ¥è¯†ç‚¹ï¼Œé¡ºä¾¿ä¹Ÿå­¦ä¹ ä¸€ä¸‹æ–°çš„ç‰¹æ€§ã€‚</p><p>å®˜æ–¹æ–‡æ¡£æ¯”è¾ƒå¤šï¼Œæˆ‘å…¨éƒ¨çœ‹äº†ä¸€éã€‚ä¹Ÿå°†å…¶ä¸­çš„è¦ç‚¹æ‘˜å½•æ¥ä¸‹æ¥ï¼Œå¦‚æœæœ‰ç¼˜è¯»åˆ°è¿™ç¯‡æ–‡ç« çš„ä½ æ°å·§æ²¡æœ‰é‚£ä¹ˆå¤šæ—¶é—´å¤ä¹ ï¼Œå¯ä»¥å¤§æ¦‚åœ°çŸä¸€çœ¼æˆ‘çš„æ‘˜å½•ç¬”è®°ã€‚å¤§æ¦‚ä¼šæœ‰ä¸‰ç¯‡ï¼ŒåŸºæœ¬ã€è¿›é˜¶å’ŒContext+Hook</p><h1 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h1><h3 id="1-Reactä¸ç›´æ¥ä¿®æ”¹æ•°æ®çš„åŸå› ï¼š"><a href="#1-Reactä¸ç›´æ¥ä¿®æ”¹æ•°æ®çš„åŸå› ï¼š" class="headerlink" title="1.Reactä¸ç›´æ¥ä¿®æ”¹æ•°æ®çš„åŸå› ï¼š"></a>1.Reactä¸ç›´æ¥ä¿®æ”¹æ•°æ®çš„åŸå› ï¼š</h3><ul><li>ç®€åŒ–å¤æ‚çš„åŠŸèƒ½ï¼Œä¸ç›´æ¥åœ¨æ•°æ®ä¸Šä¿®æ”¹å¯ä»¥è®©æˆ‘ä»¬è¿½æº¯å¹¶å¤ç”¨æ¸¸æˆçš„å†å²è®°å½•ã€‚</li><li>è·Ÿè¸ªæ•°æ®çš„æ”¹å˜ï¼Œç›´æ¥ä¿®æ”¹æ•°æ®ï¼Œå¾ˆéš¾è·Ÿè¸ªåˆ°æ•°æ®çš„æ”¹å˜ï¼Œéœ€è¦å¯å˜å¯¹è±¡å¯ä»¥ä¸æ”¹å˜ä¹‹å‰çš„ç‰ˆæœ¬è¿›è¡Œå¯¹æ¯”ï¼Œè¿™æ ·æ•´ä¸ªå¯¹è±¡æ ‘éƒ½éœ€è¦è¢«éå†ä¸€æ¬¡ã€‚<br>è·Ÿè¸ªä¸å¯å˜æ•°æ®çš„å˜åŒ–ç›¸å¯¹æ¥è¯´å°±å®¹æ˜“å¤šäº†ã€‚å¦‚æœå‘ç°å¯¹è±¡å˜æˆäº†ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è¯´å¯¹è±¡å‘ç”Ÿæ”¹å˜äº†ã€‚</li><li>ç¡®å®šåœ¨reactä¸­ä½•æ—¶é‡æ–°æ¸²æŸ“ï¼Œä¸å¯å˜æ€§æœ€ä¸»è¦çš„ä¼˜åŠ¿åœ¨äºå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ React ä¸­åˆ›å»º pure componentsã€‚æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„ç¡®å®šä¸å¯å˜æ•°æ®æ˜¯å¦å‘ç”Ÿäº†æ”¹å˜ï¼Œä»è€Œç¡®å®šä½•æ—¶å¯¹ç»„ä»¶è¿›è¡Œé‡æ–°æ¸²æŸ“ã€‚</li></ul><h3 id="2-å‡½æ•°ç»„ä»¶"><a href="#2-å‡½æ•°ç»„ä»¶" class="headerlink" title="2.å‡½æ•°ç»„ä»¶"></a>2.å‡½æ•°ç»„ä»¶</h3><p>å¦‚æœä½ æƒ³å†™çš„ç»„ä»¶åªåŒ…å«ä¸€ä¸ª render æ–¹æ³•ï¼Œå¹¶ä¸”ä¸åŒ…å« stateï¼Œé‚£ä¹ˆä½¿ç”¨å‡½æ•°ç»„ä»¶å°±ä¼šæ›´ç®€å•ã€‚<br>PSï¼šå½“æˆ‘ä»¬æŠŠ Square ä¿®æ”¹æˆå‡½æ•°ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬åŒæ—¶ä¹ŸæŠŠ onClick={() =&gt; this.props.onClick()} æ”¹æˆäº†æ›´çŸ­çš„ onClick={props.onClick}ï¼ˆæ³¨æ„ä¸¤ä¾§éƒ½æ²¡æœ‰æ‹¬å·ï¼‰ã€‚</p><pre><code class="hljs plain">function Square(props) &#123;  return (    &lt;button className&#x3D;&quot;square&quot; onClick&#x3D;&#123;props.onClick&#125;&gt;      &#123;props.value&#125;    &lt;&#x2F;button&gt;  );&#125;</code></pre><h3 id="3-key"><a href="#3-key" class="headerlink" title="3.key"></a>3.key</h3><p>æˆ‘ä»¬éœ€è¦ç»™æ¯ä¸€ä¸ªåˆ—è¡¨é¡¹ä¸€ä¸ªç¡®å®šçš„ key å±æ€§ï¼Œå®ƒå¯ä»¥ç”¨æ¥åŒºåˆ†ä¸åŒçš„åˆ—è¡¨é¡¹å’Œä»–ä»¬çš„åŒçº§å…„å¼Ÿåˆ—è¡¨é¡¹ã€‚<br>æ¯å½“ä¸€ä¸ªåˆ—è¡¨é‡æ–°æ¸²æŸ“æ—¶ï¼ŒReact ä¼šæ ¹æ®æ¯ä¸€é¡¹åˆ—è¡¨å…ƒç´ çš„ key æ¥æ£€ç´¢ä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶ä¸æ¯ä¸ª key æ‰€åŒ¹é…çš„åˆ—è¡¨é¡¹ã€‚å¦‚æœ React å‘ç°å½“å‰çš„åˆ—è¡¨æœ‰ä¸€ä¸ªä¹‹å‰ä¸å­˜åœ¨çš„ keyï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„ç»„ä»¶ã€‚å¦‚æœ React å‘ç°å’Œä¹‹å‰å¯¹æ¯”å°‘äº†ä¸€ä¸ª keyï¼Œé‚£ä¹ˆå°±ä¼šé”€æ¯ä¹‹å‰å¯¹åº”çš„ç»„ä»¶ã€‚å¦‚æœä¸€ä¸ªç»„ä»¶çš„ key å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¸ªç»„ä»¶ä¼šè¢«é”€æ¯ï¼Œç„¶åä½¿ç”¨æ–°çš„ state é‡æ–°åˆ›å»ºä¸€ä»½ã€‚</p><p>key æ˜¯ React ä¸­ä¸€ä¸ªç‰¹æ®Šçš„ä¿ç•™å±æ€§ï¼ˆè¿˜æœ‰ä¸€ä¸ªæ˜¯ refï¼Œæ‹¥æœ‰æ›´é«˜çº§çš„ç‰¹æ€§ï¼‰ã€‚å½“ React å…ƒç´ è¢«åˆ›å»ºå‡ºæ¥çš„æ—¶å€™ï¼ŒReact ä¼šæå–å‡º key å±æ€§ï¼Œç„¶åæŠŠ key ç›´æ¥å­˜å‚¨åœ¨è¿”å›çš„å…ƒç´ ä¸Šã€‚è™½ç„¶ key çœ‹èµ·æ¥å¥½åƒæ˜¯ props ä¸­çš„ä¸€ä¸ªï¼Œä½†æ˜¯ä½ ä¸èƒ½é€šè¿‡ this.props.key æ¥è·å– keyã€‚React ä¼šé€šè¿‡ key æ¥è‡ªåŠ¨åˆ¤æ–­å“ªäº›ç»„ä»¶éœ€è¦æ›´æ–°ã€‚ç»„ä»¶æ˜¯ä¸èƒ½è®¿é—®åˆ°å®ƒçš„ key çš„ã€‚</p><p>æˆ‘ä»¬å¼ºçƒˆæ¨èï¼Œæ¯æ¬¡åªè¦ä½ æ„å»ºåŠ¨æ€åˆ—è¡¨çš„æ—¶å€™ï¼Œéƒ½è¦æŒ‡å®šä¸€ä¸ªåˆé€‚çš„ keyã€‚å¦‚æœä½ æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ keyï¼Œé‚£ä¹ˆä½ å°±éœ€è¦è€ƒè™‘é‡æ–°æ•´ç†ä½ çš„æ•°æ®ç»“æ„äº†ï¼Œè¿™æ ·æ‰èƒ½æœ‰åˆé€‚çš„ keyã€‚</p><p>å¦å¤–ï¼Œè®¾ç½®keyçš„å…ƒç´ æ˜¯map() æ–¹æ³•ä¸­çš„å…ƒç´ ï¼Œå‡å¦‚ä½ çš„æ¯ä¸ªliéƒ½æ˜¯åŒ…å«åœ¨ä¸€ä¸ªListItemç»„ä»¶ä¸­è¿”å›çš„ï¼Œä½ å°±åº”è¯¥åœ¨ListItemä¸ŠåŠ keyï¼Œè€Œä¸æ˜¯li</p><h3 id="4-é˜²æ³¨å…¥æ”»å‡»"><a href="#4-é˜²æ³¨å…¥æ”»å‡»" class="headerlink" title="4.é˜²æ³¨å…¥æ”»å‡»"></a>4.é˜²æ³¨å…¥æ”»å‡»</h3><p>React DOM åœ¨æ¸²æŸ“æ‰€æœ‰è¾“å…¥å†…å®¹ä¹‹å‰ï¼Œé»˜è®¤ä¼šè¿›è¡Œè½¬ä¹‰ã€‚å®ƒå¯ä»¥ç¡®ä¿åœ¨ä½ çš„åº”ç”¨ä¸­ï¼Œæ°¸è¿œä¸ä¼šæ³¨å…¥é‚£äº›å¹¶éè‡ªå·±æ˜ç¡®ç¼–å†™çš„å†…å®¹ã€‚æ‰€æœ‰çš„å†…å®¹åœ¨æ¸²æŸ“ä¹‹å‰éƒ½è¢«è½¬æ¢æˆäº†å­—ç¬¦ä¸²ã€‚è¿™æ ·å¯ä»¥æœ‰æ•ˆåœ°é˜²æ­¢ XSSï¼ˆcross-site-scripting, è·¨ç«™è„šæœ¬ï¼‰æ”»å‡»ã€‚</p><h3 id="5-å°†ä¸€ä¸ªå…ƒç´ æ¸²æŸ“ä¸ºdom"><a href="#5-å°†ä¸€ä¸ªå…ƒç´ æ¸²æŸ“ä¸ºdom" class="headerlink" title="5.å°†ä¸€ä¸ªå…ƒç´ æ¸²æŸ“ä¸ºdom"></a>5.å°†ä¸€ä¸ªå…ƒç´ æ¸²æŸ“ä¸ºdom</h3><pre><code class="hljs plain">&lt;div id&#x3D;&quot;root&quot;&gt;&lt;&#x2F;div&gt;</code></pre><p>æˆä¸ºâ€˜æ ¹â€™domèŠ‚ç‚¹ï¼Œä»…ä½¿ç”¨reactåˆ›å»ºçš„åº”ç”¨é€šå¸¸åªæœ‰ä¸€ä¸ªæ ¹domèŠ‚ç‚¹ã€‚<br>æƒ³è¦å°†ä¸€ä¸ª React å…ƒç´ æ¸²æŸ“åˆ°æ ¹ DOM èŠ‚ç‚¹ä¸­ï¼Œåªéœ€æŠŠå®ƒä»¬ä¸€èµ·ä¼ å…¥ ReactDOM.render()</p><pre><code class="hljs plain">const element &#x3D; &lt;h1&gt;Hello, world&lt;&#x2F;h1&gt;;ReactDOM.render(element, document.getElementById(&#39;root&#39;));</code></pre><h3 id="6-æŒ‰éœ€æ›´æ–°"><a href="#6-æŒ‰éœ€æ›´æ–°" class="headerlink" title="6.æŒ‰éœ€æ›´æ–°"></a>6.æŒ‰éœ€æ›´æ–°</h3><p>React DOM ä¼šå°†å…ƒç´ å’Œå®ƒçš„å­å…ƒç´ ä¸å®ƒä»¬ä¹‹å‰çš„çŠ¶æ€è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶åªä¼šè¿›è¡Œå¿…è¦çš„æ›´æ–°æ¥ä½¿ DOM è¾¾åˆ°é¢„æœŸçš„çŠ¶æ€ã€‚<br>å°½ç®¡æ¯ä¸€ç§’æˆ‘ä»¬éƒ½ä¼šæ–°å»ºä¸€ä¸ªæè¿°æ•´ä¸ª UI æ ‘çš„å…ƒç´ ï¼ŒReact DOM åªä¼šæ›´æ–°å®é™…æ”¹å˜äº†çš„å†…å®¹<br>æ ¹æ®æˆ‘ä»¬çš„ç»éªŒï¼Œè€ƒè™‘ UI åœ¨ä»»æ„ç»™å®šæ—¶åˆ»çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯éšæ—¶é—´å˜åŒ–çš„è¿‡ç¨‹ï¼Œèƒ½å¤Ÿæ¶ˆç­ä¸€æ•´ç±»çš„ bugã€‚</p><h3 id="7-ç»„ä»¶åç§°å¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚"><a href="#7-ç»„ä»¶åç§°å¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚" class="headerlink" title="7.ç»„ä»¶åç§°å¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚"></a>7.ç»„ä»¶åç§°å¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´ã€‚</h3><p>React ä¼šå°†ä»¥å°å†™å­—æ¯å¼€å¤´çš„ç»„ä»¶è§†ä¸ºåŸç”Ÿ DOM æ ‡ç­¾ã€‚ä¾‹å¦‚ï¼Œ<code>&lt;div /&gt;</code>ä»£è¡¨ HTML çš„ div æ ‡ç­¾ï¼Œè€Œ <code>&lt;Welcome /&gt;</code> åˆ™ä»£è¡¨ä¸€ä¸ªç»„ä»¶ï¼Œå¹¶ä¸”éœ€åœ¨ä½œç”¨åŸŸå†…ä½¿ç”¨ Welcomeã€‚</p><h3 id="8-ç”Ÿå‘½å‘¨æœŸ"><a href="#8-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="8.ç”Ÿå‘½å‘¨æœŸ"></a>8.ç”Ÿå‘½å‘¨æœŸ</h3><p>å½“ Clock ç»„ä»¶ç¬¬ä¸€æ¬¡è¢«æ¸²æŸ“åˆ° DOM ä¸­çš„æ—¶å€™ï¼Œå°±ä¸ºå…¶è®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨ã€‚è¿™åœ¨ React ä¸­è¢«ç§°ä¸ºâ€œæŒ‚è½½ï¼ˆmountï¼‰â€ã€‚</p><p>åŒæ—¶ï¼Œå½“ DOM ä¸­ Clock ç»„ä»¶è¢«åˆ é™¤çš„æ—¶å€™ï¼Œåº”è¯¥æ¸…é™¤è®¡æ—¶å™¨ã€‚è¿™åœ¨ React ä¸­è¢«ç§°ä¸ºâ€œå¸è½½ï¼ˆunmountï¼‰â€ã€‚</p><p>äºæ˜¯æˆ‘ä»¬æœ‰äº†componentDidMount() å’Œ componentWillUnmount()</p><p>å½“ä½ éœ€è¦åœ¨classä¸­æ·»åŠ ä¸å‚ä¸æ•°æ®æµçš„é¢å¤–å­—æ®µï¼Œè€Œå®ƒåˆéœ€è¦åˆå§‹åŒ–æ—¶ï¼Œå°±åœ¨componentDidMount()æ¥åšã€‚<br>æ¯”å¦‚åœ¨componentDidMount()ä¸­åˆå§‹åŒ–ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œåœ¨componentWillUnmount()ä¸­é”€æ¯å®ƒã€‚</p><p>å…³äºstate:</p><ul><li>ä¸è¦ç›´æ¥ä¿®æ”¹</li><li>stateçš„æ›´æ–°å¯èƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒReact å¯èƒ½ä¼šæŠŠå¤šä¸ª setState() è°ƒç”¨åˆå¹¶æˆä¸€ä¸ªè°ƒç”¨ã€‚<br>å› ä¸º this.props å’Œ this.state å¯èƒ½ä¼šå¼‚æ­¥æ›´æ–°ï¼Œæ‰€ä»¥ä½ ä¸è¦ä¾èµ–ä»–ä»¬çš„å€¼æ¥æ›´æ–°ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚<pre><code class="hljs plain">&#x2F;&#x2F; Wrongthis.setState(&#123;  counter: this.state.counter + this.props.increment,&#125;);</code></pre>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥è®© setState() æ¥æ”¶ä¸€ä¸ªå‡½æ•°è€Œä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå‡½æ•°ç”¨ä¸Šä¸€ä¸ª state ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°†æ­¤æ¬¡æ›´æ–°è¢«åº”ç”¨æ—¶çš„ props åšä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼š<pre><code class="hljs plain">&#x2F;&#x2F; Correctthis.setState((state, props) &#x3D;&gt; (&#123;  counter: state.counter + props.increment&#125;));</code></pre></li></ul><h3 id="9-äº‹ä»¶"><a href="#9-äº‹ä»¶" class="headerlink" title="9.äº‹ä»¶"></a>9.äº‹ä»¶</h3><p>åœ¨ React ä¸­å¦ä¸€ä¸ªä¸åŒç‚¹æ˜¯ä½ ä¸èƒ½é€šè¿‡è¿”å› false çš„æ–¹å¼é˜»æ­¢é»˜è®¤è¡Œä¸ºã€‚ä½ å¿…é¡»æ˜¾å¼çš„ä½¿ç”¨ preventDefault ã€‚</p><pre><code class="hljs plain">function ActionLink() &#123;  function handleClick(e) &#123;    e.preventDefault();    console.log(&#39;The link was clicked.&#39;);  &#125;  return (    &lt;a href&#x3D;&quot;#&quot; onClick&#x3D;&#123;handleClick&#125;&gt;      Click me    &lt;&#x2F;a&gt;  );&#125;</code></pre><p>åœ¨è¿™é‡Œï¼Œe æ˜¯ä¸€ä¸ªåˆæˆäº‹ä»¶ã€‚React æ ¹æ® W3C è§„èŒƒæ¥å®šä¹‰è¿™äº›åˆæˆäº‹ä»¶ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦æ‹…å¿ƒè·¨æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ã€‚å¦‚æœæƒ³äº†è§£æ›´å¤šï¼Œè¯·æŸ¥çœ‹ <a href="https://zh-hans.reactjs.org/docs/events.html" target="_blank" rel="noopener">SyntheticEvent</a> å‚è€ƒæŒ‡å—ã€‚</p><h3 id="10-æ¡ä»¶æ¸²æŸ“"><a href="#10-æ¡ä»¶æ¸²æŸ“" class="headerlink" title="10.æ¡ä»¶æ¸²æŸ“"></a>10.æ¡ä»¶æ¸²æŸ“</h3><p>ä¹‹æ‰€ä»¥å¯ä»¥ç”¨ æ¡ä»¶ &amp;&amp; ç»„ä»¶ çš„æ–¹å¼æ¥æ¸²æŸ“ç»„ä»¶ã€‚æ˜¯å› ä¸ºåœ¨ JavaScript ä¸­ï¼Œtrue &amp;&amp; expression æ€»æ˜¯ä¼šè¿”å› expression, è€Œ false &amp;&amp; expression æ€»æ˜¯ä¼šè¿”å› falseã€‚</p><p>å› æ­¤ï¼Œå¦‚æœæ¡ä»¶æ˜¯ trueï¼Œ&amp;&amp; å³ä¾§çš„å…ƒç´ å°±ä¼šè¢«æ¸²æŸ“ï¼Œå¦‚æœæ˜¯ falseï¼ŒReact ä¼šå¿½ç•¥å¹¶è·³è¿‡å®ƒã€‚</p><p>å…¶æ¬¡ï¼Œåœ¨ç»„ä»¶çš„ render æ–¹æ³•ä¸­è¿”å› null å¹¶ä¸ä¼šå½±å“ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚å³ä½¿è¿”å›nullï¼ŒcomponentDidUpdate ä¾ç„¶ä¼šè¢«è°ƒç”¨ã€‚</p><h3 id="11-è¡¨å•"><a href="#11-è¡¨å•" class="headerlink" title="11.è¡¨å•"></a>11.è¡¨å•</h3><p>Reactä¸­ï¼Œå¯å˜çŠ¶æ€é€šå¸¸ä¿å­˜åœ¨ç»„ä»¶çš„stateå±æ€§ä¸­ï¼Œä¸”åªèƒ½é€šè¿‡setStateæ¥æ›´æ–°ã€‚ä½†HTMLé‡Œç±»ä¼¼input,select,textareaç­‰å…ƒç´ æœ¬èº«è‡ªå·±ç»´æŠ¤ç€stateã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å€¾å‘äºè®©reactçš„stateæˆä¸ºç»„ä»¶çš„å”¯ä¸€æ•°æ®æºï¼Œå³ç”±reactæ¥æ¸²æŸ“inputï¼Œå¹¶æ§åˆ¶ç”¨æˆ·è¾“å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿçš„æ“ä½œï¼Œè¿™æ ·æ”¹é€ äº†çš„è¡¨å•è¾“å…¥å…ƒç´ å«åšâ€œå—æ§â€ç»„ä»¶ã€‚</p><pre><code class="hljs plain">...&lt;form ...&gt;    &lt;input type&#x3D;&quot;text&quot; value&#x3D;&#123;this.state.value&#125; onChange&#x3D;&#123;this.handleChange&#125; &#x2F;&gt;&lt;&#x2F;form&gt;...</code></pre><p>å¦‚ä¸Š,æ˜¾ç¤ºçš„å€¼å°†å§‹ç»ˆä¸º this.state.valueï¼Œè¿™ä½¿å¾— React çš„ state æˆä¸ºå”¯ä¸€æ•°æ®æºã€‚ç”±äº handlechange åœ¨æ¯æ¬¡æŒ‰é”®æ—¶éƒ½ä¼šæ‰§è¡Œå¹¶æ›´æ–° React çš„ stateï¼Œå› æ­¤æ˜¾ç¤ºçš„å€¼å°†éšç€ç”¨æˆ·è¾“å…¥è€Œæ›´æ–°ã€‚</p><p>å¯¹äºå—æ§ç»„ä»¶æ¥è¯´ï¼Œè¾“å…¥çš„å€¼å§‹ç»ˆç”± React çš„ state é©±åŠ¨ã€‚ä½ ä¹Ÿå¯ä»¥å°† value ä¼ é€’ç»™å…¶ä»– UI å…ƒç´ ï¼Œæˆ–è€…é€šè¿‡å…¶ä»–äº‹ä»¶å¤„ç†å‡½æ•°é‡ç½®ï¼Œä½†è¿™æ„å‘³ç€ä½ éœ€è¦ç¼–å†™æ›´å¤šçš„ä»£ç ã€‚</p><p><a href="https://zh-hans.reactjs.org/docs/forms.html" target="_blank" rel="noopener">è¿™é‡Œ</a>äº†è§£è¯¸å¦‚ textarea,selectç­‰å—æ§ç»„ä»¶åœ¨reactä¸­çš„ç”¨æ³•ã€‚</p><p>å½“éœ€è¦å¤„ç†å¤šä¸ª input å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªå…ƒç´ æ·»åŠ  name å±æ€§ï¼Œå¹¶è®©å¤„ç†å‡½æ•°æ ¹æ® event.target.name çš„å€¼é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œã€‚</p><p>å…¶æ¬¡ï¼Œç±»ä¼¼<code>&lt;input type=&quot;file&quot; /&gt;</code>è¿™ç§valueä¸ºåªè¯»çš„å…ƒç´ ï¼Œå®ƒä»¬å«åšéå—æ§ç»„ä»¶ã€‚<br>æœ‰æ—¶ä½¿ç”¨å—æ§ç»„ä»¶ä¼šå¾ˆéº»çƒ¦ï¼Œå› ä¸ºä½ éœ€è¦ä¸ºæ•°æ®å˜åŒ–çš„æ¯ç§æ–¹å¼éƒ½ç¼–å†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå¹¶é€šè¿‡ä¸€ä¸ª React ç»„ä»¶ä¼ é€’æ‰€æœ‰çš„è¾“å…¥ stateã€‚å½“ä½ å°†ä¹‹å‰çš„ä»£ç åº“è½¬æ¢ä¸º React æˆ–å°† React åº”ç”¨ç¨‹åºä¸é React åº“é›†æˆæ—¶ï¼Œè¿™å¯èƒ½ä¼šä»¤äººåŒçƒ¦ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›ä½¿ç”¨éå—æ§ç»„ä»¶, è¿™æ˜¯å®ç°è¾“å…¥è¡¨å•çš„å¦ä¸€ç§æ–¹å¼ã€‚</p><p>å½“ç„¶ï¼Œç›´æ¥æ‰¾ä¸€äº›æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯éå¸¸å¥½çš„è§£å†³æ–¹å¼ï¼Œæ¯”å¦‚<a href="https://jaredpalmer.com/formik" target="_blank" rel="noopener">Formilk</a> å°±æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚ä½†å®ƒä»¬å¤§å¤šä¹Ÿæ˜¯å»ºç«‹åœ¨å—æ§ç»„ä»¶å’Œç®¡ç†stateçš„åŸºç¡€ä¸Šçš„ï¼Œæ‰€ä»¥äº†è§£ä¸€ä¸‹åŸç†å¹¶æ²¡æœ‰é”™ã€‚</p><h3 id="12-çŠ¶æ€æå‡"><a href="#12-çŠ¶æ€æå‡" class="headerlink" title="12.çŠ¶æ€æå‡"></a>12.çŠ¶æ€æå‡</h3><p>å…¶å®å…³äºè¿™ä¸ªï¼Œåªè¦ç”¨è¿‡Reactçš„äººå°±åº”è¯¥éå¸¸ç†Ÿæ‚‰ï¼Œæ²¡ä»€ä¹ˆå€¼å¾—å†è¿›ä¸€æ­¥æ¢è®¨çš„ã€‚è¿™é‡Œå°±æç‚¼ä¸€ä¸‹è¦ç‚¹ï¼š  </p><ul><li>åœ¨ React åº”ç”¨ä¸­ï¼Œä»»ä½•å¯å˜æ•°æ®åº”å½“åªæœ‰ä¸€ä¸ªç›¸å¯¹åº”çš„å”¯ä¸€â€œæ•°æ®æºâ€ï¼Œå¦‚æœå½“å‰ç»„ä»¶çš„stateåœ¨å…¶å®ƒç»„ä»¶ä¸­è¢«éœ€è¦ï¼Œæˆ‘ä»¬å°±åº”è¯¥è€ƒè™‘å°†è¿™ä¸ªå˜é‡æå‡åˆ°å…±åŒçš„çˆ¶ç»„ä»¶ä¸­ã€‚åˆ©ç”¨å¥½è‡ªä¸Šè€Œä¸‹çš„æ•°æ®æµã€‚</li><li>å¦‚æœæŸäº›æ•°æ®å¯ä»¥ç”± props æˆ– state æ¨å¯¼å¾—å‡ºï¼Œé‚£ä¹ˆå®ƒå°±ä¸åº”è¯¥å­˜åœ¨äº state ä¸­ã€‚</li><li>åˆ©ç”¨å¥½<a href="https://github.com/facebook/react/tree/master/packages/react-devtools" target="_blank" rel="noopener">Reactå¼€å‘è€…å·¥å…·</a>æ¥å®šä½UIä¸­çš„bug</li></ul><p>æå‡æ–¹å¼ä¸åŒå‘ç»‘å®šçš„åŒºåˆ«ä¸ä¼˜ç¼ºç‚¹ï¼š reactçš„è¿™ç§æ•°æ®å•å‘ç»‘å®šæ–¹å¼å®é™…æ˜¯å¤§åŠ¿æ‰€è¶‹ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨è¿½è¸ªæ•°æ®å˜åŒ–å’Œè°ƒè¯•ç¨‹åºçš„æ—¶å€™é€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œè€ŒåŒå‘ç»‘å®šè™½ç„¶ä¸€å®šç¨‹åº¦å‡å°‘äº†ä»£ç é‡ï¼Œä½†ä¸€è®©æŸ¥é”™å˜å¾—å›°éš¾ï¼ŒäºŒä¹Ÿä¼šåœ¨å¤§é‡åŒå‘ç»‘å®šå­˜åœ¨çš„æ—¶å€™äº§ç”Ÿæ€§èƒ½é—®é¢˜ã€‚</p><h3 id="13-ä¸éœ€è¦ç»„ä»¶ç»§æ‰¿"><a href="#13-ä¸éœ€è¦ç»„ä»¶ç»§æ‰¿" class="headerlink" title="13.ä¸éœ€è¦ç»„ä»¶ç»§æ‰¿"></a>13.ä¸éœ€è¦ç»„ä»¶ç»§æ‰¿</h3><p>ç»„ä»¶å¯ä»¥æ¥å—ä»»æ„ propsï¼ŒåŒ…æ‹¬åŸºæœ¬æ•°æ®ç±»å‹ï¼ŒReact å…ƒç´ ä»¥åŠå‡½æ•°ã€‚</p><p>å¦‚æœä½ æƒ³è¦åœ¨ç»„ä»¶é—´å¤ç”¨é UI çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å»ºè®®å°†å…¶æå–ä¸ºä¸€ä¸ªå•ç‹¬çš„ JavaScript æ¨¡å—ï¼Œå¦‚å‡½æ•°ã€å¯¹è±¡æˆ–è€…ç±»ã€‚ç»„ä»¶å¯ä»¥ç›´æ¥å¼•å…¥ï¼ˆimportï¼‰è€Œæ— éœ€é€šè¿‡ extend ç»§æ‰¿å®ƒä»¬ã€‚</p><h3 id="14-å®¹å™¨ç»„ä»¶"><a href="#14-å®¹å™¨ç»„ä»¶" class="headerlink" title="14.å®¹å™¨ç»„ä»¶"></a>14.å®¹å™¨ç»„ä»¶</h3><p>æœ‰ä¸€ä¸ªç‰¹æ®Šçš„propï¼šchildrenã€‚ä½¿å¾—åˆ«çš„ç»„ä»¶å¯ä»¥é€šè¿‡ JSX åµŒå¥—ï¼Œå°†ä»»æ„ç»„ä»¶ä½œä¸ºå­ç»„ä»¶ä¼ é€’ç»™å®ƒä»¬ã€‚</p><pre><code class="hljs plain">&lt;SomeComp color&#x3D;&quot;blue&quot;&gt;      &lt;h1 className&#x3D;&quot;Dialog-title&quot;&gt;        Welcome      &lt;&#x2F;h1&gt;      &lt;p className&#x3D;&quot;Dialog-message&quot;&gt;        Thank you for visiting our spacecraft!      &lt;&#x2F;p&gt;&lt;&#x2F;SomeComp&gt;</code></pre><p>å‡ºç°åœ¨æ ‡ç­¾å¼€å§‹ç»“æŸæ ‡è®°ä¹‹é—´çš„è¿™äº›å†…å®¹ï¼Œå°±ä¼šåœ¨SomeCompå†…éƒ¨ä»¥props.childrençš„å½¢å¼å­˜åœ¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>webå‰ç«¯</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åŸºç¡€</tag>
      
      <tag>React</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¾¹å†™ä»£ç è¾¹å­¦ä¹ Mask-rcnn</title>
    <link href="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/"/>
    <url>/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/</url>
    
    <content type="html"><![CDATA[<p>ä½œä¸ºä¸€ä¸ªæ·±åº¦å­¦ä¹ çš„å­¦ä¹ è€…ï¼Œä½ æ˜¯ä¸æ˜¯è‹¦äºè‡ªå·±çœ‹äº†éå¸¸å¤šçš„ç†è®ºå´éš¾ä»¥ä¸‹æ‰‹å®è·µï¼Ÿæ˜¯å¦æ€»è§‰å¾—è‡ªå·±è¿˜æ²¡åˆ°å†™ä»£ç çš„æ—¶å€™ï¼Ÿ<br>å¦‚æœä½ è¿™ä¹ˆæƒ³ï¼Œé‚£ä¹ˆä½ çœ‹å†å¤šçš„ç†è®ºï¼Œä¹Ÿæ— æ³•çœŸæ­£è¸è¿›æ·±åº¦å­¦ä¹ çš„å¤§é—¨ã€‚<br>å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œå¾ˆå¤šæ—¶å€™å³ä½¿è¯»å®Œäº†è®ºæ–‡ä»ç„¶æœ‰ç‚¹æ‡µï¼Œå¾ˆå¤šåœ°æ–¹æ„Ÿè§‰éƒ½ä¸€çŸ¥åŠè§£ï¼Œè¿˜æœ‰äº›åœ°æ–¹å¯èƒ½ç›´æ¥å°±æ˜¯ä¸å¤ªæ˜ç™½ã€‚æ­¤æ—¶ï¼Œå¦‚æœèƒ½æœ‰æºç çœ‹ä¸€çœ‹ï¼Œæ‰èƒ½çœŸæ­£å°†è¿™ç¯‡æ–‡ç« ææ˜ç™½ã€‚<br>so, â€œtalk is cheap, show me the codeâ€ å®ä¹ƒé‡‘ç‰è‰¯è¨€ã€‚</p><p>è¿™ç¯‡æ–‡ç« å°†ä½¿ç”¨pytorch modelzooæä¾›çš„ç°æˆMask R-CNNé¢„è®­ç»ƒæ¨¡å‹æ¥è¿›è¡Œfine-turingï¼Œå®ç°ä¸€ä¸ªç›®æ ‡æ£€æµ‹å’Œè¯­ä¹‰åˆ†å‰²åº”ç”¨ã€‚å¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¥é‡æ–°å¤ä¹ ä¸€ä¸‹Mask R-CNNè¿™ä¸ªç»å…¸ç½‘ç»œçš„ä¸€äº›åŸç†ã€‚  </p><h2 id="Mask-R-CNNç®€ä»‹"><a href="#Mask-R-CNNç®€ä»‹" class="headerlink" title="Mask R-CNNç®€ä»‹"></a>Mask R-CNNç®€ä»‹</h2><p>Mask R-CNNæ¥è‡ªä½•æºæ˜å¤§ç¥2017å¹´çš„è®ºæ–‡ï¼Œæ˜¯ä¸€ä¸ªé€šç”¨çš„ç›®æ ‡æ£€æµ‹å’Œå®ä¾‹åˆ†å‰²çš„æ¨¡å‹ã€‚å®ƒåŸºäºä½œè€…å›¢é˜Ÿåœ¨2015å¹´æå‡ºçš„faster rcnnæ¨¡å‹ï¼Œæœ€ä¸»è¦çš„æ”¹åŠ¨å°±æ˜¯å¢åŠ äº†ä¸€ä¸ªåˆ†æ”¯æ¥ç”¨äºåˆ†å‰²ä»»åŠ¡ã€‚<br>Mask R-CNNæ˜¯anchor-basedçš„æ¨¡å‹ï¼Œä¾ç„¶é‡‡ç”¨Faster RCNNçš„2-stageç»“æ„ï¼Œé¦–å…ˆç”¨RPNæ‰¾å‡ºå€™é€‰regionï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè®¡ç®—ROIå¹¶å®Œæˆåˆ†ç±»ã€æ£€æµ‹å’Œåˆ†å‰²ä»»åŠ¡ã€‚<br>å¹¶æ²¡æœ‰æ·»åŠ å„ç§trickï¼ŒMask RCNNå°±è¶…è¿‡äº†å½“æ—¶æ‰€æœ‰çš„sotaæ¨¡å‹ã€‚</p><h2 id="å®šä¹‰DataSetå¹¶å¤„ç†"><a href="#å®šä¹‰DataSetå¹¶å¤„ç†" class="headerlink" title="å®šä¹‰DataSetå¹¶å¤„ç†"></a>å®šä¹‰DataSetå¹¶å¤„ç†</h2><p>æˆ‘ä»¬å°†ä½¿ç”¨Penn-Fudanæ•°æ®åº“ä¸­çš„è¡Œäººå›¾ç‰‡æ•°æ®æ¥å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚å®ƒåŒ…å«170ä¸ªå›¾åƒå’Œ345ä¸ªè¡Œäººå®ä¾‹ã€‚<a href="https://www.cis.upenn.edu/~jshi/ped_html/PennFudanPed.zip" target="_blank" rel="noopener">æ•°æ®åœ¨æ­¤</a>ã€‚<br>æ•°æ®æ–‡ä»¶ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p><pre><code class="hljs plain">PennFudanPed&#x2F;  PedMasks&#x2F;    FudanPed00001_mask.png    FudanPed00002_mask.png    FudanPed00003_mask.png    FudanPed00004_mask.png    ...  PNGImages&#x2F;    FudanPed00001.png    FudanPed00002.png    FudanPed00003.png    FudanPed00004.png</code></pre><p>PedMasksä¸­æ•°æ®ä¸ºPNGImagesæ–‡ä»¶å¤¹ä¸‹å¯¹åº”å›¾ç‰‡çš„å®ä¾‹åˆ†å‰²æ©è†œï¼Œå¦‚ä¸‹ï¼š</p><img src="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/mask_sample.png" srcset="/img/loading.gif" class="" title="åŸå›¾ç‰‡"><img src="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/mask_sample1.png" srcset="/img/loading.gif" class="" title="maskå›¾ç‰‡"><p>å³æ©è†œä¸­ä¸åŒçš„æ•°å€¼å¯¹åº”ä¸åŒçš„å®ä¾‹çš„åˆ†å‰²ã€‚</p><h3 id="å®šä¹‰Datasetç±»"><a href="#å®šä¹‰Datasetç±»" class="headerlink" title="å®šä¹‰Datasetç±»"></a>å®šä¹‰Datasetç±»</h3><p>ä¸Šä¸€ç¯‡æ–‡ç« è¯´è¿‡ï¼ŒDatasetç±»æ˜¯å¸®åŠ©æˆ‘ä»¬å¤„ç†åŸå§‹æ•°æ®å¹¶äº§å‡ºæ¨¡å‹éœ€è¦çš„è¾“å…¥æ•°æ®çš„ç±»ã€‚<br>è€Œåœ¨æˆ‘ä»¬è¿™æ¬¡çš„Mask R-CNNæ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›Dataseté€šè¿‡<strong>getitem</strong>èƒ½è¿”å›æˆ‘ä»¬å›¾åƒæ•°æ®(H,W)ä»¥åŠå›¾åƒçš„ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>boxes: è¿™å¼ å›¾ç‰‡é‡Œæ‰€æœ‰çš„ç›®æ ‡åŒºåŸŸ,æ ¼å¼ä¸º[x0,x1,y0,y1]ï¼Œxâˆˆ[0,W], yâˆˆ[0,H]</li><li>labels: æ¯ä¸ªè¾¹æ¡†çš„æ ‡ç­¾</li><li>masks: æ¯ä¸ªå›¾åƒçš„æ©è†œ</li><li>image_id: å›¾ç‰‡id</li><li>areaï¼šæ¯ä¸ªbboxçš„é¢ç§¯ï¼Œç”¨äºè®¡ç®—IoU</li><li>iscrowd: æ¯ä¸ªåŒºåŸŸæ˜¯å¦æ˜¯äººç¾¤<br>ä»£ç å¦‚ä¸‹ï¼š<pre><code class="hljs plain">class PennFudanDataset(Dataset):    def __init__(self, root, transforms):        self.root &#x3D; root        self.transforms &#x3D; transforms        # ä¸‹è½½æ‰€æœ‰å›¾åƒæ–‡ä»¶ï¼Œä¸ºå…¶æ’åºã€‚ç¡®ä¿å®ƒä»¬å¯¹é½,è€Œä¸”è¿™æ ·å°±æŠŠå›¾ç‰‡åå­—åˆ—å‡ºæ¥äº†ï¼Œæ–¹ä¾¿äº†åŠ è½½å›¾ç‰‡        self.imgs &#x3D; list(sorted(os.listdir(os.path.join(root, &quot;PNGImages&quot;))))        self.masks &#x3D; list(sorted(os.listdir(os.path.join(root, &quot;PedMasks&quot;))))    def __getitem__(self, idx):        # load images ad masks        img_path &#x3D; os.path.join(self.root, &quot;PNGImages&quot;, self.imgs[idx])        mask_path &#x3D; os.path.join(self.root, &quot;PedMasks&quot;, self.masks[idx])        img &#x3D; Image.open(img_path).convert(&quot;RGB&quot;)        # è¯·æ³¨æ„æˆ‘ä»¬è¿˜æ²¡æœ‰å°†maskè½¬æ¢ä¸ºRGB,        # å› ä¸ºæ¯ç§é¢œè‰²å¯¹åº”ä¸€ä¸ªä¸åŒçš„å®ä¾‹ã€‚0æ˜¯èƒŒæ™¯        mask &#x3D; Image.open(mask_path)        # å°†PILå›¾åƒè½¬æ¢ä¸ºnumpyæ•°ç»„        mask &#x3D; np.array(mask)        # å®ä¾‹è¢«ç¼–ç ä¸ºä¸åŒçš„é¢œè‰²        obj_ids &#x3D; np.unique(mask)        # ç¬¬ä¸€ä¸ªidæ˜¯èƒŒæ™¯(å³0)ï¼Œæ‰€ä»¥åˆ é™¤å®ƒ        obj_ids &#x3D; obj_ids[1:]        # å°†ç›¸åŒé¢œè‰²ç¼–ç çš„maskåˆ†æˆä¸€ç»„        # maskä¸º2ç»´ï¼Œç”¨Noneæ‰©å……obj_idsç»´åº¦ï¼Œmasksä¸º3ç»´ï¼Œå› ä¸ºä¸€å¼ å›¾ç‰‡å¯èƒ½æœ‰å¤šä¸ªå®ä¾‹åˆ†å‰²        # äºŒè¿›åˆ¶æ ¼å¼        masks &#x3D; mask &#x3D;&#x3D; obj_ids[:, None, None]        # è·å–æ¯ä¸ªmaskçš„è¾¹ç•Œæ¡†åæ ‡        num_objs &#x3D; len(obj_ids)        boxes &#x3D; []        for i in range(num_objs):            # masks[i]ä¸º2ç»´ï¼Œæ‰€ä»¥np.whereè¿”å›2ä¸ªtupleï¼Œåˆ†åˆ«ä¸ºæ­¤é¢œè‰²ç¼–ç çš„å…ƒç´ åœ¨å„ä¸ªç»´åº¦çš„ä¸‹æ ‡            # è¿™é‡Œçš„æ•°æ®ä¸­ä¸åŒé¢œè‰²çš„maskæ˜¯è¯­ä¹‰åˆ†å‰²çš„åƒç´ ç‚¹ï¼Œé€‰å‡ºæœ€å¤§æœ€å°çš„xåæ ‡å’Œyåæ ‡å°±å¾—åˆ°äº†ç›®æ ‡åŒºåŸŸ(x0,y0),(x1,y1)            pos &#x3D; np.where(masks[i])            xmin &#x3D; np.min(pos[1])            xmax &#x3D; np.max(pos[1])            ymin &#x3D; np.min(pos[0])            ymax &#x3D; np.max(pos[0])            boxes.append([xmin, ymin, xmax, ymax])        # å°†æ‰€æœ‰è½¬æ¢ä¸ºtorch.Tensor        boxes &#x3D; torch.as_tensor(boxes, dtype&#x3D;torch.float32)        # æˆ‘ä»¬åªæ£€æµ‹è¡Œäººè¿™ä¸€ä¸ªç±»(è¡Œäººï¼Œæ‰€ä»¥ç›´æ¥å…¨éƒ¨ç½®ä¸º1)        labels &#x3D; torch.ones((num_objs,), dtype&#x3D;torch.int64)        masks &#x3D; torch.as_tensor(masks, dtype&#x3D;torch.uint8)        image_id &#x3D; torch.tensor([idx])        area &#x3D; (boxes[:, 3] - boxes[:, 1]) * (boxes[:, 2] - boxes[:, 0])        # å‡è®¾æ‰€æœ‰å®ä¾‹éƒ½ä¸æ˜¯äººç¾¤        iscrowd &#x3D; torch.zeros((num_objs,), dtype&#x3D;torch.int64)        target &#x3D; &#123;&#125;        target[&quot;boxes&quot;] &#x3D; boxes  # è¿™å¼ å›¾ç‰‡é‡Œæ‰€æœ‰çš„ç›®æ ‡åŒºåŸŸ        target[&quot;labels&quot;] &#x3D; labels   # æ¯ä¸ªç›®æ ‡åŒºåŸŸçš„ç±»å‹        target[&quot;masks&quot;] &#x3D; masks    # å›¾åƒæ©è†œ mask        target[&quot;image_id&quot;] &#x3D; image_id  # å›¾ç‰‡id        target[&quot;area&quot;] &#x3D; area          # æ¯ä¸ªåŒºåŸŸçš„é¢ç§¯        target[&quot;iscrowd&quot;] &#x3D; iscrowd    # æ¯ä¸ªåŒºåŸŸæ˜¯å¦æ˜¯äººç¾¤(è¿™é‡Œå‡è®¾çš„éƒ½ä¸æ˜¯)        if self.transforms is not None:            img, target &#x3D; self.transforms(img, target)        return img, target            def __len__(self):        return len(self.imgs)</code></pre></li></ul><h2 id="å®šä¹‰æ¨¡å‹"><a href="#å®šä¹‰æ¨¡å‹" class="headerlink" title="å®šä¹‰æ¨¡å‹"></a>å®šä¹‰æ¨¡å‹</h2><p>Mask-RCNNç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/mask_rcnn_model.jpg" srcset="/img/loading.gif" class="" title="æ¨¡å‹ç»“æ„"><p>torchvision.models.detection.fasterrcnn_resnet50_fpn(pretrained=True) ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªé¢„è®­ç»ƒçš„Mask-RCNNæ¨¡å‹ã€‚<br>ä¿®æ”¹è¿™ç§é¢„è®­ç»ƒæ¨¡å‹ä¸€èˆ¬æœ‰2ç§æ€è·¯ï¼Œç¬¬ä¸€å°±æ˜¯å½“æˆ‘ä»¬æ•°æ®è¾ƒå°‘æ—¶ï¼Œæˆ‘ä»¬å°±åªå°†æœ€åä¸€å±‚æ›¿æ¢æˆæˆ‘ä»¬çš„è¾“å…¥ç›®æ ‡ï¼Œç„¶åè¿›è¡Œå¾®è°ƒã€‚<br>å¦ä¸€ç§æ€è·¯åˆ™æ˜¯å¯ä»¥åœ¨åŸæ¨¡å‹åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚æ›¿æ¢backboneï¼Œä¿®æ”¹RPNçš„anchoræ•°é‡ï¼Œè°ƒæ•´ROIç»´åº¦ç­‰ã€‚  </p><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç¬¬äºŒç§æ–¹å¼ï¼š<br><strong>ä¿®æ”¹backbone</strong>: Mask-RCNN çš„backboneä½¿ç”¨çš„Resnet101ï¼Œæ•´ä½“è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå‡å¦‚ä½ æƒ³ä½¿ç”¨ä¸€äº›è½»é‡çš„backboneï¼Œæ¯”å¦‚mobileNetï¼Œé‚£ä¹ˆä½ å¯ä»¥è¿›è¡Œæ›¿æ¢<br><strong>ä¿®æ”¹rpn</strong>:Mask-RCNN çš„anchoræ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Œæ³¨æ„çœ‹ä¸Šé¢çš„ç»“æ„å›¾ã€‚è¾“å…¥æ•°æ®åœ¨ç»è¿‡backboneä¹‹åï¼Œå¾—åˆ°çš„feature-mapå…¶å®æ˜¯åœ¨åŸè¾“å…¥çš„åŸºç¡€ä¸Šè¿›è¡Œäº†32å€ä¸‹é‡‡æ ·ã€‚åŸºäºè¿™ä¸ªfeature-mapçš„æ¯ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬å†è¿›è¡Œä¸€ä¸ª3Ã—3çš„å·ç§¯æ¥å¢åŠ æ„Ÿå—é‡ï¼Œç„¶åå¯¹æ¯ä¸ªå…ƒç´ ç”Ÿæˆ9ä¸ªanchoræ¥ç”Ÿæˆå€™é€‰åŒºåŸŸã€‚è¿™9ä¸ªåˆå§‹anchoråŒ…å«3ç§é•¿å®½æ¯”(1:1,1:2,2:1),æ¯ç§é•¿å®½æ¯”åŒ…å«3ç§ä¸åŒçš„é¢ç§¯ã€‚ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/rpn_structure.jpg" srcset="/img/loading.gif" class="" title="rpnç»“æ„"><p>æ³¨æ„å›¾ä¸Šçš„å„ç§æ•°å­—ï¼Œ256è¡¨ç¤ºçš„æ˜¯éª¨å¹²ç½‘ç»œè¾“å‡ºçš„é€šé“æ•°ï¼Œkè¡¨ç¤ºç”Ÿæˆçš„anchorçš„æ•°é‡ã€‚å› ä¸ºæ¯ä¸ªanchoræœ‰positiveå’Œnegativeï¼Œæ‰€ä»¥æœ‰2kä¸ªæ‰“åˆ†ã€‚è€Œæ¯ä¸ªanchorä¼šç»è¿‡åç»­çš„å›å½’æ‰¾åˆ°é’ˆå¯¹æ­£ç¡®åŒºåŸŸçš„4ä¸ªåç§»é‡(x,y,w,h)ï¼Œæ‰€ä»¥æ˜¯4kä¸ªcoordinatesã€‚<br>å¯¹äºè¿™äº›å‚æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹ã€‚<br><strong>ä¿®æ”¹RoI pooling</strong>ï¼šRoI poolingå±‚å¤æ‚æ”¶é›†proposalï¼Œç„¶åé€‰å–ç‰¹å¾å¹¶é€å…¥åç»­çš„åˆ†ç±»å’Œæ£€æµ‹FCç½‘ç»œã€‚ è¦çŸ¥é“ä¸ºäº†ä¿ç•™å›¾ç‰‡ä¸­äº‹ç‰©çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¾ˆå°‘å¯¹å›¾ç‰‡é‡‡ç”¨resizeæˆ–è€…è£å‰ªæ“ä½œï¼Œè€ŒMask-RCNNæ¥å—ä¸åŒå¤§å°çš„å›¾ç‰‡è¾“å…¥ï¼Œé‚£ä¹ˆç»è¿‡éª¨å¹²å’ŒRPNç½‘ç»œåï¼Œå„å›¾ç‰‡åˆ°æ­¤æ—¶çš„æ•°æ®ç»´åº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šè¿‡FCç­‰ç½‘ç»œè¿›è¡Œç‰¹å¾ç»„åˆã€‚RoI poolingå±‚å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚å®ƒå°†æ”¶é›†åˆ°çš„proposalåˆ†ä¸ºå›ºå®šä¸ªæ•°çš„åŒºåŸŸ(æ¯”å¦‚7*7)ï¼Œç„¶åå¯¹æ¯è¿™äº›åŒºåŸŸä½¿ç”¨max_poolå¤„ç†ï¼Œè¿™æ ·å°±å¾—åˆ°äº†å›ºå®šç»´åº¦çš„è¾“å‡ºã€‚<br>å…¶æ¬¡ï¼ŒFaster RCNNåœ¨å¤„ç†RoI poolingçš„è¿‡ç¨‹ä¸­æœ‰2æ¬¡å–æ•´æ“ä½œï¼š</p><ul><li>region proposalçš„xywhé€šå¸¸æ˜¯å°æ•°ï¼Œä½†æ˜¯ä¸ºäº†æ–¹ä¾¿æ“ä½œä¼šæŠŠå®ƒæ•´æ•°åŒ–ã€‚</li><li>å°†æ•´æ•°åŒ–åçš„è¾¹ç•ŒåŒºåŸŸå¹³å‡åˆ†å‰²æˆ k x k ä¸ªå•å…ƒï¼Œå¯¹æ¯ä¸€ä¸ªå•å…ƒçš„è¾¹ç•Œè¿›è¡Œæ•´æ•°åŒ–ã€‚<br>è¿™å°†ä¼šå¯¼è‡´RoI poolingåçš„è¾“å‡ºä¸åŸå›¾åƒå¯¹åº”çš„åŒºåŸŸäº§ç”Ÿä¸€äº›åç¦»ï¼Œå¯¼è‡´ä¸èƒ½å®Œå…¨å¯¹åº”ã€‚ç¬¬ä¸€ä¸ªé—®é¢˜å¾ˆå¥½è§£å†³ï¼Œä¸å†å–æ•´å³å¯ã€‚è€Œè§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼Œåˆ™æ˜¯ä½¿ç”¨åŒçº¿æ€§æ’å€¼çš„æ–¹å¼æ¥æ›´åŠ ç²¾ç¡®çš„æ‰¾åˆ°æ¯ä¸ªè¾¹ç•Œçš„ç‰¹å¾ã€‚æˆ‘ä»¬åœ¨ä¸‹é¢ä»£ç ä¸­çœ‹åˆ°çš„sampling_ratio=2å°±æ˜¯è¿™ä¸ªæ–¹æ³•çš„ä½“ç°ã€‚</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="hljs plain">from torchvision.models.detection import FasterRCNNfrom torchvision.models.detection.rpn import AnchorGenerator# åŠ è½½é¢„å…ˆè®­ç»ƒçš„æ¨¡å‹è¿›è¡Œåˆ†ç±»å’Œè¿”å›# åªæœ‰åŠŸèƒ½ # ä¸»å¹²é‡‡ç”¨mobileNet V2backbone &#x3D; torchvision.models.mobilenet_v2(pretrained&#x3D;True).features# FasterRCNNéœ€è¦çŸ¥é“éª¨å¹²ç½‘ä¸­çš„è¾“å‡ºé€šé“æ•°é‡ã€‚å¯¹äºmobilenet_v2ï¼Œå®ƒæ˜¯1280ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œæ·»åŠ å®ƒbackbone.out_channels &#x3D; 1280# æˆ‘ä»¬è®©RPNåœ¨æ¯ä¸ªç©ºé—´ä½ç½®ç”Ÿæˆ5 x 3ä¸ªé”šç‚¹ PSï¼šè¿™é‡ŒåŸæ–‡æ˜¯3*3ï¼Œå³3ç§å¤§å°3ç§å®½é«˜æ¯”# æ”¹æˆ5ç§ä¸åŒçš„å¤§å°å’Œ3ç§ä¸åŒçš„å®½é«˜æ¯”ã€‚ # å› ä¸ºæ¯ä¸ªç‰¹å¾æ˜ å°„å¯èƒ½å…·æœ‰ä¸åŒçš„å¤§å°å’Œå®½é«˜æ¯”ï¼Œsizeä¸ºanchor boxå¤§å°ï¼Œaspect_ratiosåˆ™æ˜¯å®½é«˜æ¯”anchor_generator &#x3D; AnchorGenerator(sizes&#x3D;((32, 64, 128, 256, 512),),                                   aspect_ratios&#x3D;((0.5, 1.0, 2.0),))# å®šä¹‰ä¸€ä¸‹æˆ‘ä»¬å°†ç”¨äºæ‰§è¡Œæ„Ÿå…´è¶£åŒºåŸŸè£å‰ªçš„ç‰¹å¾æ˜ å°„ï¼Œä»¥åŠé‡æ–°ç¼©æ”¾åè£å‰ªçš„å¤§å°ã€‚ # å¦‚æœæ‚¨çš„ä¸»å¹²è¿”å›Tensorï¼Œåˆ™featmap_namesåº”ä¸º[0]ã€‚ # æ›´ä¸€èˆ¬åœ°ï¼Œä¸»å¹²åº”è¯¥è¿”å›OrderedDict [Tensor]# å¹¶ä¸”åœ¨featmap_namesä¸­ï¼Œæ‚¨å¯ä»¥é€‰æ‹©è¦ä½¿ç”¨çš„åŠŸèƒ½æ˜ å°„ã€‚# è¿™é‡Œä¸ºRoIPoolingå±‚ï¼Œå°†feature_mapå¯¹åº”çš„åŸå›¾ä¸­éƒ¨åˆ†å¤„ç†æˆ7*7(output_size&#x3D;7)çš„å¤§å°ç„¶åå†è¿›è¡Œåç»­çš„åˆ†ç±»å’Œå›å½’æ“ä½œ# è€Œsampling_ratio&#x3D;2åˆ™æ˜¯åŸæ–‡ä¸­è¿›è¡Œæ’å€¼æ‰€é€‰å–çš„é‡‡æ ·ç‚¹ï¼Œç®€å•çš„è¯´ï¼šé‡‡æ ·ç‚¹ä¸º2å°±æ˜¯è¯´7*7çš„æ¯ä¸ªåŒºåŸŸå†…ï¼Œéƒ½è¦å†åˆ†æˆ2*2ä¸ªgridï¼Œç„¶åå¯¹æ¯ä¸ªgridä¸­å¿ƒç‚¹è¿›è¡Œé‡‡æ ·ï¼Œå°†è¿™4ä¸ªç‚¹çš„å€¼æ±‚å¹³å‡å°±æ˜¯è¿™ä¸ªåŒºåŸŸæœ€ç»ˆçš„å€¼ã€‚roi_pooler &#x3D; torchvision.ops.MultiScaleRoIAlign(featmap_names&#x3D;[0],                                                output_size&#x3D;7,                                                sampling_ratio&#x3D;2)# å°†è¿™äº›piecesæ”¾åœ¨FasterRCNNæ¨¡å‹ä¸­model &#x3D; FasterRCNN(backbone,                   num_classes&#x3D;2,                   rpn_anchor_generator&#x3D;anchor_generator,                   box_roi_pool&#x3D;roi_pooler)</code></pre><p>è™½ç„¶ç¬¬äºŒç§æ–¹å¼æ˜æ˜¾æ¯”è¾ƒé…·ï¼Œä½†é‰´äºæœ¬ç¤ºä¾‹ä¸­æ ·æœ¬æ•°æ®æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼:</p><pre><code class="hljs plain">def get_model_instance_segmentation(num_classes):    # åŠ è½½åœ¨COCOä¸Šé¢„è®­ç»ƒçš„é¢„è®­ç»ƒçš„å®ä¾‹åˆ†å‰²æ¨¡å‹    model &#x3D; torchvision.models.detection.maskrcnn_resnet50_fpn(pretrained&#x3D;True)    # è·å–åˆ†ç±»å™¨çš„è¾“å…¥ç‰¹å¾æ•°    in_features &#x3D; model.roi_heads.box_predictor.cls_score.in_features    # ç”¨æ–°çš„å¤´éƒ¨æ›¿æ¢é¢„å…ˆè®­ç»ƒå¥½çš„å¤´éƒ¨    model.roi_heads.box_predictor &#x3D; FastRCNNPredictor(in_features, num_classes)    # ç°åœ¨è·å–æ©è†œåˆ†ç±»å™¨çš„è¾“å…¥ç‰¹å¾æ•°    in_features_mask &#x3D; model.roi_heads.mask_predictor.conv5_mask.in_channels    hidden_layer &#x3D; 256    # å¹¶ç”¨æ–°çš„æ©è†œé¢„æµ‹å™¨æ›¿æ¢æ©è†œé¢„æµ‹å™¨    model.roi_heads.mask_predictor &#x3D; MaskRCNNPredictor(in_features_mask,                                                       hidden_layer,                                                       num_classes)</code></pre><h2 id="å®ä¾‹åŒ–æ¨¡å‹"><a href="#å®ä¾‹åŒ–æ¨¡å‹" class="headerlink" title="å®ä¾‹åŒ–æ¨¡å‹"></a>å®ä¾‹åŒ–æ¨¡å‹</h2><p>åœ¨torchvisionçš„å®˜æ–¹åº“ä¸­ï¼Œreferences/detection/é‡Œæœ‰å¾ˆå¤šè¾…åŠ©å‡½æ•°æ¥ç®€åŒ–è®­ç»ƒå’Œè¯„ä¼°æ£€æµ‹æ¨¡å‹ã€‚<br>è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°references/detection/engine.pyï¼Œreferences/detection/utils.pyå’Œreferences/detection/transforms.pyã€‚<br>å»<a href="https://github.com/pytorch/vision" target="_blank" rel="noopener">è¿™é‡Œ</a> downloadä»£ç å¹¶å°†è¿™å‡ ä¸ªæ–‡ä»¶æ‹·è´åˆ°ä½ çš„ç›®å½•ä¸­å³å¯ã€‚</p><p>å…¶æ¬¡ï¼Œæå‰å®‰è£…<a href="https://github.com/cocodataset/cocoapi/tree/master/PythonAPI" target="_blank" rel="noopener">cocoapi</a>,å¦‚æœä½ åœ¨windowsä¸Šï¼Œå¯èƒ½éœ€è¦å®‰è£…visial studioã€‚<br>windowsä¸Šä¹Ÿå¯ä»¥é€šè¿‡å®‰è£…pycocotoolsæ¥è§£å†³ã€‚whlè§ï¼š<a href="https://pypi.org/project/pycocotools-windows/#files" target="_blank" rel="noopener">https://pypi.org/project/pycocotools-windows/#files</a></p><p>è¿™ä¸€æ­¥æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä»£ç é‡Œä¹Ÿæœ‰è¶³å¤Ÿçš„æ³¨é‡Šï¼š</p><pre><code class="hljs plain"># è®­ç»ƒé˜¶æ®µæŒ‰0.5å‡ ç‡æ°´å¹³ç¿»è½¬å›¾åƒdef get_transform(train):    transforms &#x3D; []    transforms.append(T.ToTensor())    if train:        transforms.append(T.RandomHorizontalFlip(0.5))    return T.Compose(transforms)# åœ¨GPUä¸Šè®­ç»ƒï¼Œè‹¥æ— GPUï¼Œå¯é€‰æ‹©åœ¨CPUä¸Šè®­ç»ƒdevice &#x3D; torch.device(&#39;cuda&#39;) if torch.cuda.is_available() else torch.device(&#39;cpu&#39;)# æˆ‘ä»¬çš„æ•°æ®é›†åªæœ‰ä¸¤ä¸ªç±» - èƒŒæ™¯å’Œäººnum_classes &#x3D; 2# ä½¿ç”¨æˆ‘ä»¬çš„æ•°æ®é›†å’Œå®šä¹‰çš„è½¬æ¢dataset &#x3D; PennFudanDataset(&#39;data&#x2F;PennFudanPed&#39;, get_transform(train&#x3D;True))dataset_test &#x3D; PennFudanDataset(&#39;data&#x2F;PennFudanPed&#39;, get_transform(train&#x3D;False))# åœ¨è®­ç»ƒå’Œæµ‹è¯•é›†ä¸­æ‹†åˆ†æ•°æ®é›†indices &#x3D; torch.randperm(len(dataset)).tolist()dataset &#x3D; torch.utils.data.Subset(dataset, indices[:-50])dataset_test &#x3D; torch.utils.data.Subset(dataset_test, indices[-50:])# å®šä¹‰è®­ç»ƒå’ŒéªŒè¯æ•°æ®åŠ è½½å™¨data_loader &#x3D; torch.utils.data.DataLoader(    dataset, batch_size&#x3D;2, shuffle&#x3D;True, num_workers&#x3D;4,    collate_fn&#x3D;utils.collate_fn)data_loader_test &#x3D; torch.utils.data.DataLoader(    dataset_test, batch_size&#x3D;1, shuffle&#x3D;False, num_workers&#x3D;4,    collate_fn&#x3D;utils.collate_fn)# ä½¿ç”¨æˆ‘ä»¬çš„è¾…åŠ©å‡½æ•°è·å–æ¨¡å‹model &#x3D; get_model_instance_segmentation(num_classes)# å°†æˆ‘ä»¬çš„æ¨¡å‹è¿ç§»åˆ°åˆé€‚çš„è®¾å¤‡model.to(device)</code></pre><h2 id="è®­ç»ƒé˜¶æ®µ"><a href="#è®­ç»ƒé˜¶æ®µ" class="headerlink" title="è®­ç»ƒé˜¶æ®µ"></a>è®­ç»ƒé˜¶æ®µ</h2><p>æˆ‘ä»¬ä½¿ç”¨SGDè¿›è¡Œä¼˜åŒ–ï¼Œè®­ç»ƒ10ä¸ªepochã€‚å¹¶ä¸”é€šè¿‡æ¯”è¾ƒåœ¨æµ‹è¯•é›†ä¸Šçš„mAPï¼Œä¿å­˜æ•ˆæœæœ€å¥½çš„å‚æ•°åˆ°best_state_dictä¸­ã€‚</p><pre><code class="hljs plain">def train():    # æ„é€ ä¸€ä¸ªä¼˜åŒ–å™¨    params &#x3D; [p for p in model.parameters() if p.requires_grad]    optimizer &#x3D; torch.optim.SGD(params, lr&#x3D;0.005,                                momentum&#x3D;0.9, weight_decay&#x3D;0.0005)    # å’Œå­¦ä¹ ç‡è°ƒåº¦ç¨‹åº    lr_scheduler &#x3D; torch.optim.lr_scheduler.StepLR(optimizer,                                                   step_size&#x3D;3,                                                   gamma&#x3D;0.1)    # è®­ç»ƒ10ä¸ªepochs    num_epochs &#x3D; 10    best_mAp &#x3D; 0    for epoch in range(num_epochs):        # è®­ç»ƒä¸€ä¸ªepochï¼Œæ¯10æ¬¡è¿­ä»£æ‰“å°ä¸€æ¬¡        train_one_epoch(model, optimizer, data_loader, device, epoch, print_freq&#x3D;10)        # æ›´æ–°å­¦ä¹ é€Ÿç‡        lr_scheduler.step()        # åœ¨æµ‹è¯•é›†ä¸Šè¯„ä»·        eval_res &#x3D; evaluate(model, data_loader_test, device&#x3D;device)        # å°†ç»“æœæœ€å¥½çš„å‚æ•°ä¿å­˜ä¸‹æ¥        mAp_epoch &#x3D; float(eval_res.coco_eval[&#39;bbox&#39;].stats[0])        if mAp_epoch &gt; best_mAp:            torch.save(model.state_dict(),&#39;.&#x2F;best_state_dict&#39;)            best_mAp &#x3D; mAp_epoch    print(&quot;Finish training the model.&quot;)</code></pre><p>è®­ç»ƒè¿‡ç¨‹ä¸­ä½ å¯ä»¥çœ‹åˆ°å„é¡¹æŒ‡æ ‡ï¼Œæˆ‘å¿˜äº†æˆªå›¾ï¼Œæœ€åçš„COCO-style mAPå¤§æ¦‚æ˜¯81å·¦å³ï¼Œmask mAPä¸ºåœ¨78å·¦å³ã€‚</p><h2 id="ä½¿ç”¨æ•ˆæœæœ€å¥½çš„å‚æ•°è¿›è¡Œé¢„æµ‹"><a href="#ä½¿ç”¨æ•ˆæœæœ€å¥½çš„å‚æ•°è¿›è¡Œé¢„æµ‹" class="headerlink" title="ä½¿ç”¨æ•ˆæœæœ€å¥½çš„å‚æ•°è¿›è¡Œé¢„æµ‹"></a>ä½¿ç”¨æ•ˆæœæœ€å¥½çš„å‚æ•°è¿›è¡Œé¢„æµ‹</h2><p>å®Œæˆäº†è®­ç»ƒï¼Œæ¥ä¸‹æ¥è‚¯å®šå°±æ˜¯æˆ‘ä»¬çš„show timeäº†ã€‚</p><pre><code class="hljs plain">model.load_state_dict(torch.load(&#39;.&#x2F;best_state_dict&#39;))    # # åˆ‡æ¢ä¸ºè¯„ä¼°æ¨¡å¼    model.eval()    # è®©æˆ‘ä»¬ç…ä¸€ç…æ•ˆæœ    img, _ &#x3D; dataset_test[0]    with torch.no_grad():        prediction &#x3D; model([img.to(device)])    img_ori &#x3D; Image.fromarray(img.mul(255).permute(1, 2, 0).byte().numpy())    draw &#x3D; ImageDraw.Draw(img_ori)    masks &#x3D; prediction[0][&#39;masks&#39;]    masks_all &#x3D; Image.fromarray(np.sum(np.sum(masks.mul(255).byte().cpu().numpy(),axis&#x3D;0),axis&#x3D;0))            for [x1,y1,x2,y2] in prediction[0][&#39;boxes&#39;]:        draw.rectangle([(x1,y1),(x2,y2)],outline&#x3D;(255,0,0))    imgs &#x3D; [img_ori,masks_all]    for i,im in enumerate(imgs):        ax &#x3D; plt.subplot(1, 2, i + 1)        plt.tight_layout()        ax.axis(&#39;off&#39;)        plt.imshow(im)    plt.show()</code></pre><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/result01.jpg" srcset="/img/loading.gif" class="" title="æ•ˆæœå›¾1"><img src="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/result02.jpg" srcset="/img/loading.gif" class="" title="æ•ˆæœå›¾2"><img src="/2020/05/19/%E8%BE%B9%E5%86%99%E4%BB%A3%E7%A0%81%E8%BE%B9%E5%AD%A6%E4%B9%A0mask-rcnn/result03.jpg" srcset="/img/loading.gif" class="" title="æ•ˆæœå›¾3"><h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><p>æœ¬æ–‡æºç åœ¨<a href="https://github.com/toulondu/mask-rcnn-brief" target="_blank" rel="noopener">è¿™é‡Œ</a></p><h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="https://pytorch.org/tutorials/intermediate/torchvision_tutorial.html" target="_blank" rel="noopener">pytorchå®˜ç½‘æ•™ç¨‹:TORCHVISION OBJECT DETECTION FINETUNING TUTORIAL</a><br><a href="https://arxiv.org/abs/1506.01497" target="_blank" rel="noopener">Faster R-CNN è®ºæ–‡</a><br><a href="https://arxiv.org/abs/1703.06870" target="_blank" rel="noopener">Mask R-CNN è®ºæ–‡</a>ã€<br><a href="https://zhuanlan.zhihu.com/p/37998710" target="_blank" rel="noopener">ä»¤äººæ‹æ¡ˆç§°å¥‡çš„Mask RCNN</a></p>]]></content>
    
    
    <categories>
      
      <category>æ·±åº¦å­¦ä¹ </category>
      
    </categories>
    
    
    <tags>
      
      <tag>coding</tag>
      
      <tag>ç›®æ ‡æ£€æµ‹</tag>
      
      <tag>Mask R-CNN</tag>
      
      <tag>å®è·µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PyTorchä¸­çš„æ•°æ®åŠ è½½å’Œå¤„ç†</title>
    <link href="/2020/05/15/PyTorch%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%A4%84%E7%90%86/"/>
    <url>/2020/05/15/PyTorch%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%A4%84%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æ¥è‡ª<a href="http://pytorch123.com/ThirdSection/DataLoding/" target="_blank" rel="noopener">å®˜ç½‘ä¸­æ–‡æ•™ç¨‹</a>ã€‚<br>æˆ‘ç¨ç¨ä½œäº†æ€»ç»“ï¼Œå¹¶æŠŠä»£ç ä¸­ç¨å¾®ä¸å¥½ç†è§£çš„åœ°æ–¹åšäº†è¯¦ç»†çš„æ³¨é‡Šã€‚</p><p>PyTorchæä¾›äº†è®¸å¤šå·¥å…·æ¥ç®€åŒ–å’Œè¿›è¡Œæ•°æ®åŠ è½½ï¼Œä½¿ä»£ç æ›´å…·å¯è¯»æ€§ã€‚<br>è¿™ä¸€èŠ‚å°±ä¸»è¦ä»‹ç»pytorchä¸­æ˜¯å¦‚ä½•è¿›è¡Œæ•°æ®çš„åŠ è½½å’Œå¤„ç†çš„ã€‚</p><p>å…ˆå®‰è£…2ä¸ªåŒ…ï¼š</p><ul><li>scikit-imageï¼šç”¨äºå›¾åƒçš„IOå’Œå˜æ¢</li><li>pandasï¼šç”¨äºæ›´å®¹æ˜“åœ°è¿›è¡Œcsvè§£æ</li></ul><p>åœ¨pytorchä¸­è¿›è¡Œæ•°æ®åŠ è½½ï¼Œä¸»è¦çš„æ­¥éª¤æ˜¯ï¼š</p><ol><li>å°†ä¸‹å¥½çš„æ•°æ®é›†æ”¾åœ¨æœ¬åœ°æ–‡ä»¶å¤¹ä¸­ï¼Œæœ¬ç¤ºä¾‹ä¸­çš„æ•°æ®é›†æ˜¯imagenetæ•°æ®é›†æ ‡æ³¨ä¸ºfaceçš„å›¾ç‰‡å½“ä¸­åœ¨ dlib é¢éƒ¨æ£€æµ‹ (dlibâ€™s pose estimation) è¡¨ç°è‰¯å¥½çš„å›¾ç‰‡ï¼Œè¿æ¥åœ¨<a href="https://download.pytorch.org/tutorial/faces.zip" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚</li><li>å…ˆåˆ›å»ºä¸€ä¸ªè‡ªå·±çš„æ•°æ®é›†ç±»(ç»§æ‰¿è‡ªdataset),åœ¨<strong>init</strong>ä¸­è¯»å–æ•°æ®å†…å®¹(æ ¹æ®æ•°æ®çš„æ¥æº)ï¼Œåœ¨<strong>getitem</strong>ä¸­æ ¹æ®idxè¯»å–æ–‡ä»¶ã€‚</li><li>åœ¨Datasetç±»ä¸­å¯ä»¥åŠ å…¥ä¸€ä¸ªtransformå‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å¯¹æ ·æœ¬æ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬Rescale,randomCropç­‰(è¾“å…¥å›¾ç‰‡å¤§å°ä¸ç¬¦åˆç½‘ç»œè¾“å…¥è¦æ±‚æ—¶)ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡torchvision.transforms.Composeè¿™ä¸ªå‡½æ•°å¼çš„æ–¹æ³•å°†æ•°æ®è½¬æ¢çš„æ–¹æ³•åˆæˆä¸€ä¸ªæ–¹æ³•ä½œä¸ºæˆ‘ä»¬æœ€åçš„transformã€‚</li><li>è¿­ä»£ä»æˆ‘ä»¬åˆ›å»ºçš„Datasetä¸­è·å–æ•°æ®ï¼Œè¿™ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œé€šè¿‡<strong>torch.utils.data.DataLoader</strong>æä¾›çš„å¤šçº¿ç¨‹å®ç°æˆ‘ä»¬å¯ä»¥æ›´é«˜æ•ˆåœ°è½½å…¥æ•°æ®ã€‚ä½†åœ¨Windowsä¸Šä¼šå­˜åœ¨å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨å¤šçº¿ç¨‹ã€‚</li><li>torchvisionï¼Œè¿™ä¸ªåŒ…æä¾›äº†å¸¸ç”¨çš„datasetså’Œtransformã€‚</li></ol><p>ä»£ç å¦‚ä¸‹,å†…éƒ¨æœ‰è¯¦ç»†æ³¨é‡Š</p><pre><code class="hljs plain">from __future__ import print_function, divisionimport osimport torchimport pandas as pd              #ç”¨äºæ›´å®¹æ˜“åœ°è¿›è¡Œcsvè§£æfrom skimage import io, transform    #ç”¨äºå›¾åƒçš„IOå’Œå˜æ¢import numpy as npimport matplotlib.pyplot as pltfrom torch.utils.data import Dataset, DataLoaderfrom torchvision import transforms, utils# å¿½ç•¥è­¦å‘Šimport warningswarnings.filterwarnings(&quot;ignore&quot;)plt.ion()   # interactive mode# ä¸‹è½½æ•°æ®é›†æ”¾åœ¨&#39;data&#x2F;face&#39;ä¸­ï¼Œ# è¿™ä¸ªæ•°æ®é›†å®é™…ä¸Šæ˜¯imagenetæ•°æ®é›†æ ‡æ³¨ä¸ºfaceçš„å›¾ç‰‡å½“ä¸­åœ¨ dlib é¢éƒ¨æ£€æµ‹ (dlibâ€™s pose estimation) è¡¨ç°è‰¯å¥½çš„å›¾ç‰‡ã€‚# æˆ‘ä»¬è¦å¤„ç†çš„æ˜¯ä¸€ä¸ªé¢éƒ¨å§¿æ€çš„æ•°æ®é›†ã€‚# æ•°æ®é›†æ˜¯æŒ‰å¦‚ä¸‹è§„åˆ™æ‰“åŒ…æˆçš„csvæ–‡ä»¶:# image_name,part_0_x,part_0_y,part_1_x,part_1_y,part_2_x, ... ,part_67_x,part_67_y# å°†csvä¸­çš„æ ‡æ³¨ç‚¹æ•°æ®è¯»å…¥ï¼ˆNï¼Œ2ï¼‰æ•°ç»„ä¸­ï¼Œå…¶ä¸­Næ˜¯ç‰¹å¾ç‚¹çš„æ•°é‡ã€‚è¯»å–æ•°æ®ä»£ç å¦‚ä¸‹ï¼šlandmarks_frame &#x3D; pd.read_csv(&#39;data&#x2F;faces&#x2F;face_landmarks.csv&#39;)n &#x3D; 32img_name &#x3D; landmarks_frame.iloc[n, 0]# valueså°†Seriesä½œä¸ºndarryæˆ–è€…ndarry-likeç±»å‹çš„æ•°æ®è¿”å›ï¼Œå–å†³äºdtypeç±»å‹. è¿™å¥ä»£ç å–å‡ºäº†ç¬¬nå¼ å›¾ç‰‡çš„æ‰€ä»¥æ ‡è®°ç‚¹ä¿¡æ¯landmarks &#x3D; landmarks_frame.iloc[n, 1:].values# ä¸€å¯¹ä¸€å¯¹çš„åæ ‡ï¼Œ2ä¸ªä¸€ç»„landmarks &#x3D; landmarks.astype(&#39;float&#39;).reshape(-1, 2)print(&#39;Image name: &#123;&#125;&#39;.format(img_name))print(&#39;Landmarks shape: &#123;&#125;&#39;.format(landmarks.shape))print(&#39;First 4 Landmarks: &#123;&#125;&#39;.format(landmarks[:4]))# å±•ç¤ºä¸€å¼ å›¾ç‰‡å’Œå®ƒå¯¹åº”çš„æ ‡æ³¨ç‚¹ä½œä¸ºä¾‹å­ã€‚ç”¨åˆ°çš„å‡½æ•°éƒ½å¾ˆå®¹æ˜“çœ‹å‡ºä½œç”¨def show_landmarks(image, landmarks):    &quot;&quot;&quot;æ˜¾ç¤ºå¸¦æœ‰åœ°æ ‡çš„å›¾ç‰‡&quot;&quot;&quot;    plt.imshow(image)    plt.scatter(landmarks[:, 0], landmarks[:, 1], s&#x3D;10, marker&#x3D;&#39;.&#39;, c&#x3D;&#39;r&#39;)    plt.pause(0.001)  # pause a bit so that plots are updatedplt.figure()show_landmarks(io.imread(os.path.join(&#39;data&#x2F;faces&#x2F;&#39;, img_name)),               landmarks)plt.show()# æ•°æ®é›†ç±»# torch.utils.data.Datasetæ˜¯è¡¨ç¤ºæ•°æ®é›†çš„æŠ½è±¡ç±»ï¼Œå› æ­¤è‡ªå®šä¹‰æ•°æ®é›†åº”ç»§æ‰¿Datasetå¹¶è¦†ç›–ä»¥ä¸‹æ–¹æ³• # * __len__ å®ç° len(dataset) è¿”è¿˜æ•°æ®é›†çš„å°ºå¯¸ã€‚# * __getitem__ç”¨æ¥è·å–ä¸€äº›ç´¢å¼•æ•°æ®ï¼Œä¾‹å¦‚ dataset[i] ä¸­çš„(i)ã€‚# ä¸ºé¢éƒ¨æ•°æ®é›†åˆ›å»ºä¸€ä¸ªæ•°æ®é›†ç±»ã€‚# æˆ‘ä»¬å°†åœ¨ __init__ä¸­è¯»å–csvçš„æ–‡ä»¶å†…å®¹ï¼Œåœ¨ __getitem__ä¸­è¯»å–å›¾ç‰‡ã€‚# è¿™ä¹ˆåšæ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ ç©ºé—´ã€‚åªæœ‰åœ¨éœ€è¦ç”¨åˆ°å›¾ç‰‡çš„æ—¶å€™æ‰è¯»å–å®ƒè€Œä¸æ˜¯ä¸€å¼€å§‹å°±æŠŠå›¾ç‰‡å…¨éƒ¨å­˜è¿›å†…å­˜é‡Œã€‚# æˆ‘ä»¬çš„æ•°æ®æ ·æœ¬å°†æŒ‰è¿™æ ·ä¸€ä¸ªå­—å…¸&#123;&#39;image&#39;: image, &#39;landmarks&#39;: landmarks&#125;ç»„ç»‡ã€‚ # æˆ‘ä»¬çš„æ•°æ®é›†ç±»å°†æ·»åŠ ä¸€ä¸ªå¯é€‰å‚æ•°transform ä»¥æ–¹ä¾¿å¯¹æ ·æœ¬è¿›è¡Œé¢„å¤„ç†ã€‚#ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šçœ‹åˆ°ä»€ä¹ˆæ—¶å€™éœ€è¦ç”¨åˆ°transformå‚æ•°ã€‚ __init__æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š# è¿™éƒ¨åˆ†ä»£ç ä¹Ÿæ²¡ä»€ä¹ˆå€¼å¾—è¯´çš„class FaceLandmarksDataset(Dataset):    &quot;&quot;&quot;é¢éƒ¨æ ‡è®°æ•°æ®é›†.&quot;&quot;&quot;    def __init__(self, csv_file, root_dir, transform&#x3D;None):        &quot;&quot;&quot;        csv_fileï¼ˆstringï¼‰ï¼šå¸¦æ³¨é‡Šçš„csvæ–‡ä»¶çš„è·¯å¾„ã€‚        root_dirï¼ˆstringï¼‰ï¼šåŒ…å«æ‰€æœ‰å›¾åƒçš„ç›®å½•ã€‚        transformï¼ˆcallableï¼Œ optionalï¼‰ï¼šä¸€ä¸ªæ ·æœ¬ä¸Šçš„å¯ç”¨çš„å¯é€‰å˜æ¢        &quot;&quot;&quot;        self.landmarks_frame &#x3D; pd.read_csv(csv_file)        self.root_dir &#x3D; root_dir        self.transform &#x3D; transform    def __len__(self):        return len(self.landmarks_frame)    def __getitem__(self, idx):        img_name &#x3D; os.path.join(self.root_dir,                                self.landmarks_frame.iloc[idx, 0])        image &#x3D; io.imread(img_name)        landmarks &#x3D; self.landmarks_frame.iloc[idx, 1:]        landmarks &#x3D; np.array([landmarks])        landmarks &#x3D; landmarks.astype(&#39;float&#39;).reshape(-1, 2)        sample &#x3D; &#123;&#39;image&#39;: image, &#39;landmarks&#39;: landmarks&#125;        if self.transform:            sample &#x3D; self.transform(sample)        return sample        # æ•°æ®å¯è§†åŒ–# å®ä¾‹åŒ–è¿™ä¸ªç±»å¹¶éå†æ•°æ®æ ·æœ¬ã€‚æˆ‘ä»¬å°†ä¼šæ‰“å°å‡ºå‰å››ä¸ªä¾‹å­çš„å°ºå¯¸å¹¶å±•ç¤ºæ ‡æ³¨çš„ç‰¹å¾ç‚¹ã€‚ ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šface_dataset &#x3D; FaceLandmarksDataset(csv_file&#x3D;&#39;data&#x2F;faces&#x2F;face_landmarks.csv&#39;,                                    root_dir&#x3D;&#39;data&#x2F;faces&#x2F;&#39;)fig &#x3D; plt.figure()for i in range(len(face_dataset)):    sample &#x3D; face_dataset[i]    print(i, sample[&#39;image&#39;].shape, sample[&#39;landmarks&#39;].shape)        # åˆ›å»ºå­å›¾ï¼Œ1è¡Œ4åˆ—ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºå½“å‰å›¾ç¼–å· ä½†ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æˆåŠŸï¼Œè¿˜æ˜¯ç”»æˆäº†4è¡Œ1åˆ—    ax &#x3D; plt.subplot(1, 4, i + 1)    plt.tight_layout()    ax.set_title(&#39;Sample #&#123;&#125;&#39;.format(i))    # ä¸ç”»åæ ‡è½´    ax.axis(&#39;off&#39;)    show_landmarks(**sample)    if i &#x3D;&#x3D; 3:        plt.show()        break# æ•°æ®å˜æ¢# é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬ä¼šå‘ç°å›¾ç‰‡å¹¶ä¸æ˜¯åŒæ ·çš„å°ºå¯¸ã€‚ç»å¤§å¤šæ•°ç¥ç»ç½‘ç»œéƒ½å‡å®šå›¾ç‰‡çš„å°ºå¯¸ç›¸åŒã€‚å› æ­¤æˆ‘ä»¬éœ€è¦åšä¸€äº›é¢„å¤„ç†ã€‚# è®©æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªè½¬æ¢: * Rescaleï¼šç¼©æ”¾å›¾ç‰‡ * RandomCropï¼šå¯¹å›¾ç‰‡è¿›è¡Œéšæœºè£å‰ªã€‚è¿™æ˜¯ä¸€ç§æ•°æ®å¢å¼ºæ“ä½œ * ToTensorï¼šæŠŠnumpyæ ¼å¼å›¾ç‰‡è½¬ä¸ºtorchæ ¼å¼å›¾ç‰‡ (æˆ‘ä»¬éœ€è¦äº¤æ¢åæ ‡è½´).# æˆ‘ä»¬ä¼šæŠŠå®ƒä»¬å†™æˆå¯è°ƒç”¨çš„ç±»çš„å½¢å¼è€Œä¸æ˜¯ç®€å•çš„å‡½æ•°ï¼Œè¿™æ ·å°±ä¸éœ€è¦æ¯æ¬¡è°ƒç”¨æ—¶ä¼ é€’ä¸€éå‚æ•°ã€‚æˆ‘ä»¬åªéœ€è¦å®ç°__call__æ–¹æ³•ï¼Œå¿… è¦çš„æ—¶å€™å®ç° __init__æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·è°ƒç”¨è¿™äº›è½¬æ¢:# tsfm &#x3D; Transform(params)# transformed_sample &#x3D; tsfm(sample)class Rescale(object):    &quot;&quot;&quot;å°†æ ·æœ¬ä¸­çš„å›¾åƒé‡æ–°ç¼©æ”¾åˆ°ç»™å®šå¤§å°ã€‚.    Args:        output_sizeï¼ˆtupleæˆ–intï¼‰ï¼šæ‰€éœ€çš„è¾“å‡ºå¤§å°ã€‚ å¦‚æœæ˜¯å…ƒç»„ï¼Œåˆ™è¾“å‡ºä¸º         ä¸output_sizeåŒ¹é…ã€‚ å¦‚æœæ˜¯intï¼Œåˆ™åŒ¹é…è¾ƒå°çš„å›¾åƒè¾¹ç¼˜åˆ°output_sizeä¿æŒçºµæ¨ªæ¯”ç›¸åŒã€‚    &quot;&quot;&quot;    def __init__(self, output_size):        assert isinstance(output_size, (int, tuple))        self.output_size &#x3D; output_size    def __call__(self, sample):        image, landmarks &#x3D; sample[&#39;image&#39;], sample[&#39;landmarks&#39;]        h, w &#x3D; image.shape[:2]        if isinstance(self.output_size, int):            # output_sizeä¸ºintï¼Œå°†é•¿æˆ–å®½ä¸­å°çš„é‚£ä¸€ä¸ªrescaleæˆoutput_sizeï¼Œå¦ä¸€ä¸ªä¿æŒçºµæ¨ªæ¯”ç¼©æ”¾            if h &gt; w:                new_h, new_w &#x3D; self.output_size * h &#x2F; w, self.output_size            else:                new_h, new_w &#x3D; self.output_size, self.output_size * w &#x2F; h        else:            new_h, new_w &#x3D; self.output_size        new_h, new_w &#x3D; int(new_h), int(new_w)                # çœ‹æ¥skimageçš„è¿™ä¸ªåº“å®ç°äº†å¯¹å›¾ç‰‡çš„å„ç§è½¬æ¢æ“ä½œ        img &#x3D; transform.resize(image, (new_h, new_w))        # åˆ«å¿˜äº†å¯¹landmarksä¹Ÿè¦ä½œåŒæ ·æ¯”ä¾‹çš„ç¼©æ”¾ï¼        landmarks &#x3D; landmarks * [new_w &#x2F; w, new_h &#x2F; h]        return &#123;&#39;image&#39;: img, &#39;landmarks&#39;: landmarks&#125;class RandomCrop(object):    &quot;&quot;&quot;éšæœºè£å‰ªæ ·æœ¬ä¸­çš„å›¾åƒ.    Args:       output_sizeï¼ˆtupleæˆ–intï¼‰ï¼šæ‰€éœ€çš„è¾“å‡ºå¤§å°ã€‚ å¦‚æœæ˜¯intï¼Œå°±æŒ‰ç…§intçš„å€¼è¿›è¡Œæ–¹å½¢è£å‰ªã€‚             &quot;&quot;&quot;    def __init__(self, output_size):        assert isinstance(output_size, (int, tuple))        if isinstance(output_size, int):            self.output_size &#x3D; (output_size, output_size)        else:            assert len(output_size) &#x3D;&#x3D; 2            self.output_size &#x3D; output_size    def __call__(self, sample):        image, landmarks &#x3D; sample[&#39;image&#39;], sample[&#39;landmarks&#39;]        h, w &#x3D; image.shape[:2]        new_h, new_w &#x3D; self.output_size                # éšæœºä»å›¾ç‰‡ä¸­è£å‰ªä¸€å—ç›®æ ‡å¤§å°çš„å›¾åƒå‡ºæ¥,landmarkä¹Ÿä½œç›¸åº”å¤„ç† PS:hæ›´å°è‚¿ä¹ˆåŠ        top &#x3D; np.random.randint(0, h - new_h)        left &#x3D; np.random.randint(0, w - new_w)        image &#x3D; image[top: top + new_h,                      left: left + new_w]        landmarks &#x3D; landmarks - [left, top]        return &#123;&#39;image&#39;: image, &#39;landmarks&#39;: landmarks&#125;class ToTensor(object):    &quot;&quot;&quot;å°†æ ·æœ¬ä¸­çš„ndarraysè½¬æ¢ä¸ºTensors.&quot;&quot;&quot;    def __call__(self, sample):        image, landmarks &#x3D; sample[&#39;image&#39;], sample[&#39;landmarks&#39;]        # äº¤æ¢é¢œè‰²è½´å› ä¸º        # numpyåŒ…çš„å›¾ç‰‡æ˜¯: H * W * C        # torchåŒ…çš„å›¾ç‰‡æ˜¯: C * H * W        image &#x3D; image.transpose((2, 0, 1))        return &#123;&#39;image&#39;: torch.from_numpy(image),                &#39;landmarks&#39;: torch.from_numpy(landmarks)&#125;                # 8.ç»„åˆè½¬æ¢# å³æŠŠè¿™äº›è½¬æ¢åº”ç”¨èµ·æ¥ # æˆ‘ä»¬æƒ³è¦æŠŠå›¾åƒçš„çŸ­è¾¹è°ƒæ•´ä¸º256ï¼Œç„¶åéšæœºè£å‰ª(randomcrop)ä¸º224å¤§å°çš„æ­£æ–¹å½¢ã€‚# ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ‰“ç®—ç»„åˆä¸€ä¸ªRescaleå’Œ RandomCropçš„å˜æ¢ã€‚ # æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä¸€ä¸ªç®€å•çš„ç±» torchvision.transforms.Composeæ¥å®ç°è¿™ä¸€æ“ä½œã€‚å…·ä½“å®ç°å¦‚ä¸‹å›¾ï¼šscale &#x3D; Rescale(256)crop &#x3D; RandomCrop(128)composed &#x3D; transforms.Compose([Rescale(256),                               RandomCrop(224)])# åœ¨æ ·æœ¬ä¸Šåº”ç”¨ä¸Šè¿°çš„æ¯ä¸ªå˜æ¢ã€‚fig &#x3D; plt.figure()sample &#x3D; face_dataset[65]for i, tsfrm in enumerate([scale, crop, composed]):    transformed_sample &#x3D; tsfrm(sample)        ax &#x3D; plt.subplot(1, 3, i + 1)    plt.tight_layout()    ax.set_title(type(tsfrm).__name__)    show_landmarks(**transformed_sample)plt.show()# 9.è¿­ä»£æ•°æ®é›†# è®©æˆ‘ä»¬æŠŠè¿™äº›æ•´åˆèµ·æ¥ä»¥åˆ›å»ºä¸€ä¸ªå¸¦ç»„åˆè½¬æ¢çš„æ•°æ®é›†ã€‚# æ€»ç»“ä¸€ä¸‹ï¼Œæ¯æ¬¡è¿™ä¸ªæ•°æ®é›†è¢«é‡‡æ ·æ—¶: # * åŠæ—¶åœ°ä»æ–‡ä»¶ä¸­è¯»å–å›¾ç‰‡ * å¯¹è¯»å–çš„å›¾ç‰‡åº”ç”¨è½¬æ¢ * ç”±äºå…¶ä¸­ä¸€æ­¥æ“ä½œæ˜¯éšæœºçš„ (randomcrop) , æ•°æ®è¢«å¢å¼ºäº†# æˆ‘ä»¬å¯ä»¥åƒä¹‹å‰é‚£æ ·ä½¿ç”¨for i in rangeå¾ªç¯æ¥å¯¹æ‰€æœ‰åˆ›å»ºçš„æ•°æ®é›†æ‰§è¡ŒåŒæ ·çš„æ“ä½œã€‚# è¿˜è®°å¾—FaceLandmarksDataset è¿™ä¸ªç±»å—ï¼Œå¿˜äº†å¯ä»¥ç¿»å›å»çœ‹ä¸€ä¸‹transformed_dataset &#x3D; FaceLandmarksDataset(csv_file&#x3D;&#39;data&#x2F;faces&#x2F;face_landmarks.csv&#39;,                                           root_dir&#x3D;&#39;data&#x2F;faces&#x2F;&#39;,                                           transform&#x3D;transforms.Compose([                                               Rescale(256),                                               RandomCrop(224),                                               ToTensor()                                           ]))for i in range(len(transformed_dataset)):    sample &#x3D; transformed_dataset[i]    print(i, sample[&#39;image&#39;].size(), sample[&#39;landmarks&#39;].size())    if i &#x3D;&#x3D; 3:        break        # ä½†æ˜¯ï¼Œå¯¹æ‰€æœ‰æ•°æ®é›†ç®€å•çš„ä½¿ç”¨forå¾ªç¯ç‰ºç‰²äº†è®¸å¤šåŠŸèƒ½ï¼Œå°¤å…¶æ˜¯: * æ‰¹é‡å¤„ç†æ•°æ® * æ‰“ä¹±æ•°æ® * ä½¿ç”¨å¤šçº¿ç¨‹multiprocessingworker å¹¶è¡ŒåŠ è½½æ•°æ®ã€‚# torch.utils.data.DataLoaderæ˜¯ä¸€ä¸ªæä¾›ä¸Šè¿°æ‰€æœ‰è¿™äº›åŠŸèƒ½çš„è¿­ä»£å™¨ã€‚# ä¸‹é¢ä½¿ç”¨çš„å‚æ•°å¿…é¡»æ˜¯æ¸…æ¥šçš„ã€‚ä¸€ä¸ªå€¼å¾—å…³æ³¨çš„å‚æ•°æ˜¯collate_fn, å¯ä»¥é€šè¿‡å®ƒæ¥å†³å®šå¦‚ä½•å¯¹æ•°æ®è¿›è¡Œæ‰¹å¤„ç†ã€‚ä½†æ˜¯ç»å¤§å¤šæ•°æƒ…å†µä¸‹é»˜è®¤å€¼å°±èƒ½è¿è¡Œè‰¯å¥½ã€‚# PS: è¿™é‡Œwindowsä¸‹è·‘æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºwindowsåœ¨ç”¨è¿™ä¸ªå¤šçº¿ç¨‹æ–¹æ³•æ—¶æœ‰å†…å­˜æ³„æ¼ï¼Œè¯¦æƒ…ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;pytorch&#x2F;pytorch&#x2F;pull&#x2F;5585# æ¦‚æ‹¬ç‚¹æ¥è¯´å°±æ˜¯ï¼Œå› ä¸ºåœ¨Windowsä¸Šä½¿ç”¨FileMappingï¼ˆmmapï¼‰çš„å·®å¼‚å¼•èµ·çš„ã€‚# Windowsä¸Šï¼Œæ‰€æœ‰ç›¸å…³çº¿ç¨‹éƒ½é‡Šæ”¾äº†FileMappingå¯¹è±¡çš„å¼•ç”¨ï¼Œå®ƒæ‰æ‰èƒ½å¤Ÿè¢«é‡Šæ”¾ã€‚æ²¡æœ‰æä¾›å…¶ä»–æ–¹æ³•å¯ä»¥å°†å…¶ç›´æ¥åˆ é™¤ã€‚ï¼ˆä¾‹å¦‚shm_unlinkï¼‰ # å¯ç”¨å¤šçº¿ç¨‹åï¼Œå­çº¿ç¨‹å°†åˆ›å»ºä¸€ä¸ªFileMappingï¼Œç„¶åä¸»è¿›ç¨‹å°†å…¶æ‰“å¼€ã€‚ä¹‹åå­çº¿ç¨‹å°†å°è¯•é‡Šæ”¾å®ƒï¼Œä½†æ˜¯å®ƒçš„å¼•ç”¨è®¡æ•°éé›¶ï¼Œå› æ­¤æ— æ³•åœ¨é‚£æ—¶é‡Šæ”¾å®ƒã€‚# è€Œä¸”å½“å‰ä»£ç æ— æ³•æä¾›åœ¨å¯èƒ½çš„æƒ…å†µä¸‹å†æ¬¡å…³é—­çš„æœºä¼šï¼Œäºæ˜¯å¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚# è§£å†³åŠæ³•æ˜¯æƒå®œä¹‹è®¡ï¼Œå³ä½¿ç”¨num_workerså‚æ•°ï¼Œä»¤num_workers&#x3D;0,åªä½¿ç”¨ä¸€ä¸ªä¸»çº¿ç¨‹åŠ è½½æ•°æ®é›†ã€‚é¿å…åœ¨windowsä¸­ä½¿ç”¨å¤šçº¿ç¨‹ã€‚dataloader &#x3D; DataLoader(transformed_dataset, batch_size&#x3D;4,                        shuffle&#x3D;True, num_workers&#x3D;4)# è¾…åŠ©åŠŸèƒ½ï¼šæ˜¾ç¤ºæ‰¹æ¬¡def show_landmarks_batch(sample_batched):    &quot;&quot;&quot;Show image with landmarks for a batch of samples.&quot;&quot;&quot;    images_batch, landmarks_batch &#x3D; \            sample_batched[&#39;image&#39;], sample_batched[&#39;landmarks&#39;]    batch_size &#x3D; len(images_batch)    im_size &#x3D; images_batch.size(2)    grid_border_size &#x3D; 2    grid &#x3D; utils.make_grid(images_batch)    plt.imshow(grid.numpy().transpose((1, 2, 0)))        for i in range(batch_size):        plt.scatter(landmarks_batch[i, :, 0].numpy() + i * im_size + (i + 1) * grid_border_size,                    landmarks_batch[i, :, 1].numpy() + grid_border_size,                    s&#x3D;10, marker&#x3D;&#39;.&#39;, c&#x3D;&#39;r&#39;)        plt.title(&#39;Batch from dataloader&#39;)        for i_batch, sample_batched in enumerate(dataloader):    print(i_batch, sample_batched[&#39;image&#39;].size(),          sample_batched[&#39;landmarks&#39;].size())    # è§‚å¯Ÿç¬¬4æ‰¹æ¬¡å¹¶åœæ­¢ã€‚    if i_batch &#x3D;&#x3D; 3:        plt.figure()        show_landmarks_batch(sample_batched)        plt.axis(&#39;off&#39;)        plt.ioff()        plt.show()        break</code></pre><p><strong>torchvision</strong><br>torchvisionåŒ…æä¾›äº† å¸¸ç”¨çš„æ•°æ®é›†ç±»(datasets)å’Œè½¬æ¢(transforms)ã€‚<br>æ‰€ä»¥åªè¦æˆ‘ä»¬çš„æ•°æ®ç¬¦åˆè¿™äº›æ•°æ®é›†çš„è¦æ±‚ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦è‡ªå·±æ„é€ è¿™äº›ç±»æ¯”å¦‚ã€‚torchvisionä¸­è¿˜æœ‰ä¸€ä¸ªæ›´å¸¸ç”¨çš„æ•°æ®é›†ç±»ImageFolderã€‚ å®ƒå‡å®šäº†æ•°æ®é›†æ˜¯ä»¥å¦‚ä¸‹æ–¹å¼æ„é€ çš„:<br>root/ants/xxx.png<br>root/ants/xxy.jpeg<br>root/ants/xxz.png<br>.<br>.<br>.<br>root/bees/123.jpg<br>root/bees/nsdf3.png<br>root/bees/asd932_.png</p><p>å…¶ä¸­â€™antsâ€™,beesâ€™ç­‰æ˜¯åˆ†ç±»æ ‡ç­¾ã€‚åœ¨PIL.Imageä¸­ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„è½¬æ¢(transforms)ä¾‹å¦‚RandomHorizontalFlip,Scaleã€‚åˆ© ç”¨è¿™äº›ä½ å¯ä»¥æŒ‰å¦‚ä¸‹çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªæ•°æ®åŠ è½½å™¨(dataloader) :</p><pre><code class="hljs plain">import torchfrom torchvision import transforms, datasetsdata_transform &#x3D; transforms.Compose([        transforms.RandomSizedCrop(224),        transforms.RandomHorizontalFlip(),        transforms.ToTensor(),        transforms.Normalize(mean&#x3D;[0.485, 0.456, 0.406],                             std&#x3D;[0.229, 0.224, 0.225])    ])hymenoptera_dataset &#x3D; datasets.ImageFolder(root&#x3D;&#39;hymenoptera_data&#x2F;train&#39;,                                           transform&#x3D;data_transform)dataset_loader &#x3D; torch.utils.data.DataLoader(hymenoptera_dataset,                                             batch_size&#x3D;4, shuffle&#x3D;True,                                             num_workers&#x3D;4)</code></pre>]]></content>
    
    
    <categories>
      
      <category>ç¼–ç å·¥å…·</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PyTorch</tag>
      
      <tag>åŸºç¡€</tag>
      
      <tag>coding</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¨èç³»ç»ŸæŠ€æœ¯æ¦‚è§ˆ</title>
    <link href="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/"/>
    <url>/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/</url>
    
    <content type="html"><![CDATA[<h2 id="å¼•å­"><a href="#å¼•å­" class="headerlink" title="å¼•å­"></a>å¼•å­</h2><p>æœ€è¿‘åœ¨ä¸€è¾¹å†™ä¸€ä¸ªweb qaçš„é—®ç­”æ¨¡å‹ä¸€è¾¹åˆ·leetcodeï¼Œå‰è€…è¸©å‘å¤ªå¤šè€—è´¹äº†è¶…å‡ºæˆ‘é¢„æœŸçš„æ—¶é—´(è¿˜æ˜¯æ”»åŸèƒ½åŠ›æ¬ ç¼ºå•Š- -)ï¼Œäºæ˜¯æ–‡ç« ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´æ²¡æ›´æ–°äº†ã€‚<br>è¿™æœŸé—´æŠ½ç©ºå›é¡¾å’Œå­¦ä¹ äº†ç›®å‰å·¥ä¸šç•Œæ¨èç³»ç»Ÿå¸¸ç”¨çš„æ¶æ„å’Œç®—æ³•ï¼Œä¹Ÿäº²è‡ªç”¨ä»£ç å®ç°äº†å…¶ä¸­çš„éƒ¨åˆ†ç®—æ³•ï¼Œä½†æ€»ä½“è¿˜æ˜¯åœç•™åœ¨çº¸ä¸Šè°ˆå…µçš„é˜¶æ®µã€‚<br>è™½ç„¶è¿™ç¯‡æ–‡ç« æˆ‘è„¸å¾ˆåšçš„ç”¨äº†<strong><em>â€œæ¦‚è§ˆâ€</em></strong>è¿™ä¸ªè¯ï¼Œä½†æˆ‘ä»¬éƒ½çŸ¥é“çœŸå®çš„å·¥ç¨‹è½åœ°è¿œæ¯”çº¯ç²¹çš„ç®—æ³•æ¥å¾—å¤æ‚ï¼Œé™¤äº†å¯¹åº”å®é™…é—®é¢˜çš„éš¾åº¦ï¼Œè¿˜ä¼šé­é‡å¾ˆå¤šé¢„æƒ³ä¸åˆ°çš„å›°éš¾ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯é¢˜å¤–è¯äº†~</p><p>è¿™ç¯‡æ–‡ç« åŸºæœ¬æ˜¯å¯¹æˆ‘è¿‘æœŸçœ‹çš„è¿™äº›æ¨èç³»ç»Ÿç®—æ³•æ–‡ç« å’Œè§†é¢‘çš„ä¸€ä¸ªä¸ªäººçš„æ–‡å­—æ€»ç»“ï¼Œå¸Œæœ›è‡ªå·±ä¹‹åæœ‰åº”ç”¨çš„æœºä¼šå§~</p><p>ç›¸å…³é“¾æ¥ä¼šæ”¾åœ¨æ–‡æœ«ã€‚</p><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>å·¥ä¸šç•Œæ¨èç³»ç»Ÿçš„æ¶æ„åŸºæœ¬åœ¨å®è§‚ä¸Šæ¯”è¾ƒè¶‹åŒï¼Œå¤§éƒ½å¯ä»¥ç²—åˆ†ä¸º<strong>å¬å›(recall)</strong>å’Œ<strong>æ’åº(rank)</strong>ä¸¤ä¸ªé˜¶æ®µã€‚å¦‚ä¸‹ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/recommandation-system-structure.png" srcset="/img/loading.gif" class="" title="æ¨èç³»ç»Ÿæ¶æ„"><p>ä¸€èˆ¬æ¥è¯´ï¼Œå¹³å°å¾€å¾€åŠ¨è¾„æœ‰ä¸Šç™¾ä¸‡çš„itemï¼Œä¸ç®¡æ˜¯æ–°é—»åº”ç”¨ï¼Œè§†é¢‘åº”ç”¨è¿˜æ˜¯ç”µå•†åº”ç”¨ï¼Œè¦ä»æµ·é‡çš„itemä¸­ç›´æ¥ä¸€æ­¥åˆ°ä½å‡†ç¡®åœ°æ‰¾åˆ°æ¨èç»™æŸä¸ªç”¨æˆ·çš„itemæ˜¯æ¯”è¾ƒéš¾çš„ã€‚ è¿™ä¸¤ä¸ªé˜¶æ®µå¯ä»¥å¤§æ¦‚åœ°çœ‹æˆæ˜¯ç²—ç­›å’Œç²¾é€‰ï¼Œå¯¹æŸä¸ªç”¨æˆ·æ¥è¯´ï¼Œå…ˆé€šè¿‡ä¸€ä¸ªæ¯”è¾ƒå¿«é€Ÿè€Œç®€å•çš„æ–¹æ³•ä»ä¸Šç™¾ä¸‡çš„itemä¸­ç­›é€‰å‡ºå‡ ç™¾æˆ–è€…å‡ åƒä¸ªé«˜è´¨é‡çš„itemï¼Œå†é€šè¿‡ä¸€ä¸ªç²¾ç¡®çš„æ–¹æ³•ä»”ç»†åœ°å°†å…¶ä¸­æœ€å¥½çš„ä¸€äº›itemä¼˜å…ˆçº§ç¡®å®šä¸‹æ¥ï¼Œç„¶åæ¨èç»™ç”¨æˆ·ã€‚å‰è€…å°±å«åšå¬å›é˜¶æ®µï¼Œåè€…åˆ™å«åšæ’åºé˜¶æ®µã€‚</p><p>å½“ç„¶ï¼Œè½åœ°çš„æ—¶å€™å¾€å¾€è¿˜ä¼šæŠŠæ’åºé˜¶æ®µå†åˆ†æˆ ç²—æ’-ä¸»æ’-é‡æ’ï¼Œäºæ˜¯å˜æˆäº†å››ä¸ªé˜¶æ®µï¼Œè¿™ä¸ªåé¢å†è¯´~</p><p>ä¸‹é¢å°±æ¥ä»‹ç»ä¸€ä¸‹å„ä¸ªé˜¶æ®µå¸¸ç”¨çš„ç®—æ³•ã€‚</p><h2 id="å¬å›ç®—æ³•"><a href="#å¬å›ç®—æ³•" class="headerlink" title="å¬å›ç®—æ³•"></a>å¬å›ç®—æ³•</h2><p>å¬å›ç®—æ³•æœ‰å¾ˆå¤šï¼Œä¸»è¦åˆ†ä¸º3ç±»ï¼š</p><ul><li>åŸºäºç”¨æˆ·è¡Œä¸ºï¼Œç®€å•åœ°è¯´å°±æ˜¯â€œä½ çœ‹äº†ä»€ä¹ˆï¼Œæˆ‘å°±ç»™ä½ æ¨èä»€ä¹ˆâ€œ</li><li>åŸºäºç”¨æˆ·æ¡£æ¡ˆï¼Œå³ç»™ç”¨æˆ·å»ºç«‹æ¡£æ¡ˆï¼Œæ ¹æ®ç”¨æˆ·æ¡£æ¡ˆä¸­çš„æ ‡ç­¾æ¨èç›¸åº”çš„item</li><li>åŸºäºéšè¯­ä¹‰ï¼Œå³åŸºäºæœºå™¨å­¦ä¹ æ–¹æ³•ï¼Œä½¿ç”¨ç±»ä¼¼äºembeddingçš„æ–¹å¼<br>ä¸‰è€…å„æœ‰ç‰¹ç‚¹å’Œä¼˜åŠ£ï¼ŒåŸºäºç”¨æˆ·è¡Œä¸ºç›´è§‚ä¸Šæ˜¾å¾—è¿‡äºç®€å•ï¼ŒåŸºäºç”¨æˆ·æ¡£æ¡ˆä¹Ÿä¼šå­˜åœ¨ç”¨æˆ·æ”¹å£å‘³éš¾ä»¥æ³›åŒ–çš„æƒ…å†µï¼Œè€Œæœºå™¨å­¦ä¹ ï¼Œæœ¬èº«å°±åå‘é»‘ç›’ï¼Œå¯¹äºç®—æ³•ä¸­çš„ä¸­é—´å€¼éš¾ä»¥è§£é‡Šï¼Œä»è€Œä¼˜åŒ–å’Œä¿®æ”¹æ˜¾å¾—å›°éš¾ã€‚</li></ul><p>æ‰€ä»¥åœ¨ä½¿ç”¨è¿™äº›ç®—æ³•çš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯ä½¿ç”¨å¤šè·¯å¬å›ï¼Œå³ä½¿ç”¨å¾ˆå¤šä¸åŒçš„å¬å›ç®—æ³•åˆ†åˆ«è¿›è¡Œå¬å›ï¼Œå†æŠŠå„è‡ªå¬å›çš„ç»“æœç»„åˆèµ·æ¥ä½œä¸ºæœ€åçš„å¬å›ç»“æœã€‚</p><p>è¿™é‡Œä¸»è¦ä»‹ç» CF, personal rank, item2vecç­‰ç®—æ³•ã€‚</p><h3 id="CF-ååŒè¿‡æ»¤"><a href="#CF-ååŒè¿‡æ»¤" class="headerlink" title="CF(ååŒè¿‡æ»¤)"></a>CF(ååŒè¿‡æ»¤)</h3><p>ååŒè¿‡æ»¤æ˜¯ä¸€ç§å¾ˆè€çš„ç®—æ³•ï¼Œä½†æ²¿ç”¨è‡³ä»Šï¼Œå®ƒèƒ½å¤Ÿå®ç°å¯¹ç‰¹å¾è¿›è¡Œå­¦ä¹ çš„ç®—æ³•ï¼Œå³èƒ½å¤Ÿè‡ªè¡Œå­¦ä¹ æ‰€éœ€è¦ä½¿ç”¨çš„ç‰¹å¾ã€‚</p><p>ç®—æ³•çš„æ ¸å¿ƒæ˜¯é€šè¿‡å­¦ä¹ å¾—åˆ°2ä¸ªç»´åº¦è¾ƒä½çš„çŸ©é˜µï¼Œä¸€ä¸ªä»£è¡¨ç”¨æˆ·çš„embeddingçŸ©é˜µï¼Œä¸€ä¸ªä»£è¡¨itemçš„embeddingçŸ©é˜µï¼Œè®¡ç®—æŸä¸ªç”¨æˆ·å¯¹äºitemçš„æ¨èå€¼çš„æ—¶å€™ï¼Œåªéœ€è¦å°†äºŒè€…è¿›è¡Œç‚¹ç§¯è®¡ç®—ã€‚å†ç›´ç™½ä¸€ç‚¹ï¼Œæ¯”å¦‚ç”µå½±æ‹¥æœ‰ä¸¤ä¸ªç‰¹å¾ï¼ŒåŠ¨ä½œå±æ€§å’Œçˆ±æƒ…å±æ€§ï¼ŒæŸç”¨æˆ·Açš„embeddingå‘é‡ä¸ºÎ¸=[5ï¼Œ1]ï¼Œå³Aå¯¹ç”µå½±ä¸­åŠ¨ä½œå…ƒç´ çš„åçˆ±ä¸º5ï¼Œç›¸å¯¹åœ°å¯¹çˆ±æƒ…å…ƒç´ çš„åçˆ±åªæœ‰1ã€‚è€ŒæŸä¸€éƒ¨ç”µå½±çš„X=embeddingä¸º[4ï¼Œ1]ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†è¿™2ä¸ªå‘é‡ç›´æ¥è¿›è¡Œç‚¹ç§¯ï¼Œmatmul(Î¸,transpose(X))ï¼Œå¾—åˆ°çš„å€¼å°±æ˜¯è¿™éƒ¨ç”µå½±å¯¹äºè¿™ä¸ªç”¨æˆ·çš„æ¨èå€¼ï¼Œå°†ä¸åŒç”µå½±çš„æ¨èå€¼è¿›è¡Œæ’åºï¼Œå…¶ä¸­æ¨èå€¼æœ€é«˜çš„ä¸å°±æ˜¯åº”è¯¥æ¨èç»™Açš„ç”µå½±äº†å—ã€‚</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/CF01.png" srcset="/img/loading.gif" class="" title="CFå›¾ç¤º"><p>æ€ä¹ˆå¾—åˆ°è¿™ä¸¤ä¸ªembeddingçŸ©é˜µå‘¢ï¼ŸåŸºäºä¸Šé¢ç”µå½±æ¨èçš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬çŸ¥é“æ¯éƒ¨ç”µå½±çš„ç‰¹å¾çŸ©é˜µï¼Œå³Xå·²çŸ¥ æ±‚Î¸ã€‚é‚£è¿™ä¸ªé—®é¢˜å°±å˜æˆäº†ä¸€ä¸ªå¾ˆç®€å•çš„çº¿æ€§å›å½’é—®é¢˜ã€‚ å·²æœ‰çš„æ‰“åˆ†æ•°æ®ä½œä¸ºæ ·æœ¬ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°åªéœ€è¦å°† Î¸Â·XTå‡å»çœŸå®è¯„åˆ† ä½œä¸ºè¯¯å·®ï¼Œå¾ˆç®€å•å°±å¯ä»¥å®šä¹‰å‡ºç›®æ ‡å‡½æ•°ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/CF-formula-1.png" srcset="/img/loading.gif" class="" title="CFå•ä½“å…¬å¼"><p>å…¶ä¸­</p><ul><li>Î¸^(j)ä»£è¡¨ç”¨æˆ·jçš„embeddingå‘é‡ã€‚</li><li>x^(i)åˆ™ä»£è¡¨ç”µå½±içš„embeddingå‘é‡ã€‚</li><li>r(i,j)ä¸º1è¡¨ç¤ºç”¨æˆ·jå·²ç»ä¸ºç”µå½±iæ‰“äº†åˆ†ï¼Œ0åˆ™è¡¨ç¤ºæ²¡æœ‰ã€‚</li><li>y^(i,j)ä¸ºç”¨æˆ·jç»™ç”µå½±içš„è¯„åˆ†<br>å°†è¿™ä¸ªå…¬å¼æ¨å¹¿åˆ°æ‰€æœ‰ç”¨æˆ·ï¼š<img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/CF-formula-1.png" srcset="/img/loading.gif" class="" title="CFå…¬å¼"></li></ul><p>æœ‰äº†ç›®æ ‡å‡½æ•°æˆ‘ä»¬åœ¨å°†å…¶å¯¹Î¸æ±‚å¯¼</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/CF-derivative-theta.png" srcset="/img/loading.gif" class="" title="Lossdå¯¹Î¸å¯¼æ•°"><p>ç„¶åç›´æ¥ç”¨æ¢¯åº¦ä¸‹é™ä¹‹ç±»çš„ä¼˜åŒ–ç®—æ³•è¿›è¡Œæ±‚è§£å³å¯ã€‚</p><p>åŒç†ï¼Œå‡è®¾Î¸å·²çŸ¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼æ±‚å¾—Xã€‚</p><p>ä½ å¯èƒ½ä¼šæƒ³ï¼Œè¿™ä¸å°±æˆäº†é¸¡ç”Ÿè›‹è¿˜æ˜¯è›‹ç”Ÿé¸¡çš„é—®é¢˜äº†å—ï¼Ÿé—®é¢˜æ˜¯ä¸¤è€…æˆ‘ä»¬éƒ½ä¸çŸ¥é“å•Šï¼Ÿ</p><p>æ˜¯çš„ï¼Œä½ å¾ˆæ¸…é†’ï¼Œæ²¡æœ‰è¢«å¸¦åï¼Œå®é™…æƒ…å†µä¸­ï¼Œç”¨æˆ·çš„åå¥½å’Œç”µå½±çš„å±æ€§éƒ½å¾ˆéš¾æ”¶é›†ï¼Œæ›´åˆ«æç‰¹å¾è¿™ä¸ªä¸œè¥¿æœ¬å°±è™šæ— ç¼¥ç¼ˆï¼Œçˆ±æƒ…å±æ€§åŠ¨ä½œå±æ€§ä½ è¿˜èƒ½å¤Ÿç†è§£ï¼ŒçœŸå‡ºæ¥å‡ ç™¾ä¸ªç‰¹å¾ï¼Œä½ èƒ½åˆ†æ¸…ä»€ä¹ˆæ˜¯ä»€ä¹ˆå—?</p><p>è¿™ä¸ªæ—¶å€™ååŒè¿‡æ»¤å°±é’»å‡ºæ¥äº†ï¼Œåœ¨é¢å¯¹è¿™ç§ä¸¤ä¸ªæœªçŸ¥æ•°å¯ä»¥äº’ç›¸æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯åˆå§‹åŒ–å…¶ä¸­ä¸€ä¸ªæœªçŸ¥æ•°ï¼Œç„¶åæ±‚å¾—å¦ä¸€ä¸ªæœªçŸ¥æ•°ï¼Œå†åè¿‡æ¥æ±‚ç¬¬ä¸€ä¸ªæœªçŸ¥æ•°ï¼Œä»¥æ­¤ç±»æ¨ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ2ä¸ªæœªçŸ¥æ•°å°±ä¼šäº§ç”ŸååŒä½œç”¨ï¼Œç»ˆä¼šå®Œæˆæ”¶æ•›ï¼Œè¾¾åˆ°ç”Ÿå‘½çš„å¤§å’Œè°ã€‚æƒ³æƒ³pagerank,æƒ³æƒ³EMï¼Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰~</p><p>é™¤äº†è®©äºŒè€…å½¼æ­¤æ›´æ–°ï¼Œè¿˜å¯ä»¥å°†äºŒè€…åŒæ—¶è®¡ç®—ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/CF-form.png" srcset="/img/loading.gif" class="" title="ååŒè¿‡æ»¤"><p>ç¬¬ä¸€ä¸ªå¼å­æ˜¯å¯¹æ¯ä¸ªç”¨æˆ·ï¼Œé€šè¿‡ä»–ä»¬è¯„ä»·è¿‡çš„ç”µå½±çš„ç±»åˆ«æ¥æ¨æ–­ç”¨æˆ·çš„å–œå¥½ã€‚ç¬¬äºŒä¸ªå¼å­åè¿‡æ¥ï¼Œå¯¹æ¯ä¸ªç”µå½±ï¼Œæ‰¾å‡ºè¯„ä»·è¿‡å®ƒçš„ç”¨æˆ·çš„å–œå¥½æ¥æ¨æ–­ç”µå½±çš„ç±»åˆ«ã€‚</p><p>å…¶å®äºŒè€…å‰åŠéƒ¨åˆ†å°±æ˜¯ç¬¬ä¸‰ä¸ªå¼å­ä¸­çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œåªæ˜¯ç¬¬ä¸‰ä¸ªå¼å­å–å¾—æ˜¯ä¸€ä¸ª(i,j)çš„å¯¹ï¼Œè¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·è¯„åˆ†è¿‡çš„ç”µå½±ã€‚ç„¶åæŠŠäºŒè€…çš„æ­£åˆ™åŒ–éƒ½åŠ ä¸Šã€‚å®é™…ä¸Šå…³äºç¬¬ä¸‰ä¸ªå¼å­ï¼Œå‡å¦‚ä½ å‡è®¾xä¸ºå¸¸æ•°ï¼Œå®ƒå°±ç­‰äºç¬¬ä¸€ä¸ªå¼å­ï¼Œä½ å‡è®¾Î¸ä¸ºå¸¸æ•°ï¼Œå®ƒå°±ç­‰äºç¬¬äºŒä¸ªå¼å­ã€‚</p><p>è¿™å°±æ˜¯ååŒè¿‡æ»¤ï¼Œå®é™…å®ç°è¿‡ç¨‹ä¸­æ˜¯å¯ä»¥ç”¨å‘é‡åŒ–å®ç°ä»è€Œä¸éœ€è¦ä¸€ä¸ªä¸€ä¸ªåœ°è¿›è¡Œè®¡ç®—çš„ã€‚è¿™æ ·çš„å®ç°ä¹Ÿå«åš<strong>ä½ç§©çŸ©é˜µåˆ†è§£(low rank matrix factorization)</strong>ï¼Œè¿˜æœ‰ä¸€äº›åœ°æ–¹å«åš<strong>LFM(latent factor model)</strong>ã€‚ä¸è¿‡çŸ©é˜µåˆ†è§£æ–¹æ³•å¹¶ä¸æ˜¯åªæ­¤ä¸€å®¶ï¼ŒSVDä¹Ÿæ˜¯å…¶ä¸­çš„ä½¼ä½¼è€…ã€‚è¿™äº›æ–¹æ³•æœ€ç»ˆéƒ½æ˜¯å¾—åˆ°user-itemçš„éšå¼çŸ©é˜µåˆ†è§£ï¼Œè·å–äºŒè€…çš„éšç›¸é‡ã€‚</p><h3 id="personal-rank"><a href="#personal-rank" class="headerlink" title="personal rank"></a>personal rank</h3><p>æ¨èç³»ç»Ÿä¸­æœ€åŸºç¡€çš„ä¸¤ä¸ªéƒ¨åˆ†å°±æ˜¯userå’Œitemï¼Œæ•´ä¸ªç³»ç»Ÿä¹Ÿæ˜¯userå’Œitemçš„äº¤äº’ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå›¾ç»“æ„ã€‚é‚£ä¹ˆï¼Œèªæ˜çš„å…ˆè¡Œè€…ä»¬å°±æƒ³ï¼Œèƒ½ä¸èƒ½ä½¿ç”¨å›¾ç®—æ³•æ¥è¿›è¡Œä¸ªæ€§åŒ–æ¨èå‘¢ï¼Ÿ å½“ç„¶å¯ä»¥~</p><p>userå’Œitemæ„æˆçš„å›¾æ˜¯ä¸€ä¸ª<strong>äºŒåˆ†å›¾</strong>ã€‚</p><p>æ‘˜æŠ„ä¸€ä¸‹ç™¾åº¦ç™¾ç§‘äºŒåˆ†å›¾çš„è§£é‡Šï¼š<br>äºŒåˆ†å›¾åˆç§°ä½œäºŒéƒ¨å›¾ï¼Œæ˜¯å›¾è®ºä¸­çš„ä¸€ç§ç‰¹æ®Šæ¨¡å‹ã€‚ è®¾G=(V,E)æ˜¯ä¸€ä¸ªæ— å‘å›¾ï¼Œå¦‚æœé¡¶ç‚¹Vå¯åˆ†å‰²ä¸ºä¸¤ä¸ªäº’ä¸ç›¸äº¤çš„å­é›†(A,B)ï¼Œå¹¶ä¸”å›¾ä¸­çš„æ¯æ¡è¾¹ï¼ˆiï¼Œjï¼‰æ‰€å…³è”çš„ä¸¤ä¸ªé¡¶ç‚¹iå’Œjåˆ†åˆ«å±äºè¿™ä¸¤ä¸ªä¸åŒçš„é¡¶ç‚¹é›†(i in A,j in B)ï¼Œåˆ™ç§°å›¾Gä¸ºä¸€ä¸ªäºŒåˆ†å›¾ã€‚</p><p>è€Œå¯¹äºæ¨èç³»ç»Ÿè€Œè¨€ï¼Œç”¨æˆ·å’Œitemåˆšå¥½æ˜¯ä¸€ä¸ªäºŒåˆ†å›¾ï¼Œé¡¶ç‚¹åˆ†ä¸ºuserå’Œitemä¸¤ç±»ï¼Œä¸”æ‰€æœ‰çš„å˜éƒ½æ˜¯è¿æ¥ä¸€ä¸ªuserå’Œä¸€ä¸ªitemçš„ã€‚</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/personal_rank_example.png" srcset="/img/loading.gif" class="" title="ç¤ºä¾‹"><p>å¦‚ä¸Šuserå’Œitemæ„æˆäº†ä¸€ä¸ªäºŒåˆ†å›¾ï¼Œå¤§å†™ABCDè¡¨ç¤ºuserï¼Œå°å†™è¡¨ç¤ºitemã€‚<br>personal rankæ¯”è¾ƒå„ä¸ªitemå¯¹äºæŸä¸ªuserçš„æ¨èå€¼åŸºäºä»¥ä¸‹è§„åˆ™ï¼Œå…¶é‡è¦æ€§ä¸€æ¬¡é€’å‡ï¼š</p><ol><li>ä¸¤ä¸ªé¡¶ç‚¹é—´æœ‰å¤šå°‘æ¡è·¯å¾„å¯ä»¥è¿é€šï¼Œå¦‚ä¸Šå›¾ï¼Œä»A-cï¼Œæœ‰A-a-B-c, A-d-D-cä¸¤æ¡ï¼Œè€Œä»A-eåªæœ‰A-b-C-eä¸€æ¡ï¼Œåˆ™cæ›´å€¼å¾—æ¨èã€‚</li><li>å¦‚æœç¬¬ä¸€æ¡ç›¸åŒï¼Œåˆ™æ¯”è¾ƒè¿åŒè·¯å¾„çš„æ€»é•¿åº¦ï¼Œé•¿åº¦çŸ­è€…æ›´å€¼å¾—æ¨è</li><li>å¦‚æœ1ï¼Œ2ç›¸åŒï¼Œåˆ™æ¯”è¾ƒè¿åŒè·¯å¾„ç»è¿‡çš„é¡¶ç‚¹çš„å‡ºåº¦å’Œã€‚</li></ol><p>åŸºäºæ­¤è§„åˆ™ï¼Œæˆ‘ä»¬æ¥ä»‹ç»personal rankæ–¹æ³•çš„è¯¦ç»†æ“ä½œï¼š<br>å°†äºŒåˆ†å›¾è§†ä½œæ— å‘å›¾ï¼Œå¯¹äºç”¨æˆ·Aè¿›è¡Œæ¨èæ—¶ï¼Œæˆ‘ä»¬å°±ä»AèŠ‚ç‚¹å‡ºå‘å¼€å§‹åœ¨å›¾ä¸Šè¿›è¡Œéšæœºæ¸¸èµ°ï¼Œä»¥æ¦‚ç‡Î±ä»Aæ‰€æœ‰çš„å‡ºåº¦ä¸­ç­‰æ¦‚ç‡é€‰æ‹©ä¸€æ¡å‰è¿›ï¼Œåˆ°è¾¾å¯¹åº”é¡¶ç‚¹å(æ¯”å¦‚åˆ°äº†b)ï¼Œå†æ¬¡ä»¥Î±çš„æ¦‚ç‡ç»§ç»­ä»açš„å‡ºåº¦ä¸­ ç­‰æ¦‚ç‡åœ°é€‰æ‹©ä¸€æ¡ç»§ç»­å‰è¿›ï¼Œæˆ–è€…(1-Î±)çš„æ¦‚ç‡å›åˆ°èµ·ç‚¹Aï¼Œç»å†å¾ˆå¤šæ­¥ä¹‹åï¼Œç»Ÿè®¡Aåˆ°è¾¾å„ä¸ªitemèŠ‚ç‚¹çš„æ¬¡æ•°æ±‚å¾—æ¦‚ç‡ã€‚å¯ä»¥è¯æ˜ï¼Œåªè¦æ­¥æ•°è¶³å¤Ÿå¤§ï¼Œæ­¤æ¦‚ç‡å¯ä»¥æ”¶æ•›ã€‚</p><p>æŠŠå›ºå®šitemå¯¹å›ºå®šuserçš„æ¨èå¾—åˆ†è®°ä½œPRå€¼</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/personal_rank_formula.png" srcset="/img/loading.gif" class="" title="personal_rankå…¬å¼"><p>å…¶ä¸­out(v~)è¡¨ç¤ºèŠ‚ç‚¹çš„å‡ºåº¦ã€‚</p><p>å¯ä»¥çœ‹å‡ºï¼Œå’Œpagerankç®—æ³•éå¸¸ç›¸ä¼¼ï¼ŒæŸä¸ªç‚¹çš„PRå€¼ç­‰äº å¯ä»¥è¿é€šåˆ°è¯¥ç‚¹çš„å…¶å®ƒç‚¹çš„PRå€¼é™¤ä»¥è‡ªèº«å‡ºåº¦ çš„å’Œï¼Œå³å¦‚aï¼Œæœ‰A,Bå¯ä»¥è¿æ¥åˆ°å®ƒï¼Œè€ŒAå‡ºåº¦ä¸º3ï¼ŒBå‡ºåº¦ä¸º2ï¼Œæ•…PR(a) = PR(A)/3 + PR(B)/2ï¼Œå†ä¹˜ä»¥ä¸€ä¸ªæ¦‚ç‡Î±ã€‚Aè‡ªèº«çš„PRå€¼è¿˜è¦åŠ ä¸Šä¸€ä¸ª(1-alpha)ã€‚</p><p>ç›´æ¥è¿­ä»£è®¡ç®—ï¼Œå¤æ‚åº¦å¤ªé«˜äº†ï¼Œåƒpagerankä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç¥­å‡ºçŸ©é˜µæ¥åšï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/personal_rank_form_vec.png" srcset="/img/loading.gif" class="" title="å‘é‡åŒ–å®ç°"><ul><li>ræ˜¯ä¸€ä¸ªnç»´å‘é‡ï¼Œnæ˜¯å›¾ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹æ•°é‡ï¼ŒåŒ…æ‹¬userèŠ‚ç‚¹å’ŒitemèŠ‚ç‚¹ï¼Œå€¼åˆ™æ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„PRå€¼ã€‚</li><li>r0ä¹Ÿæ˜¯ä¸€ä¸ªnç»´å‘é‡ï¼Œåªæœ‰å¯¹åº”å‡ºå‘èŠ‚ç‚¹çš„å…ƒç´ ä¸º1ï¼Œå…¶ä½™èŠ‚ç‚¹ä¸º0ã€‚</li><li>Mæ˜¯ä¸€ä¸ªné˜¶è½¬ç§»çŸ©é˜µï¼Œå³å›¾ä¸­èŠ‚ç‚¹ä¸èŠ‚ç‚¹ä¹‹é—´è½¬ç§»çš„æ¦‚ç‡ï¼Œå¾ˆå¥½ç†è§£ã€‚<img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/trans_M.png" srcset="/img/loading.gif" class="" title="è½¬ç§»çŸ©é˜µM">è¿™æ ·ä¸æ–­å°†ç»“æœä»£å…¥å…¬å¼ï¼Œræœ€ç»ˆå¯ä»¥æ”¶æ•›ã€‚</li></ul><p>å†å¯¹å…¬å¼è¿›è¡Œç§»é¡¹å¤„ç†ï¼Œå¾—åˆ°ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/personal_rank_final_form.png" srcset="/img/loading.gif" class="" title="ç§»é¡¹å¤„ç†å"><p>å‘é‡åŒ–å®ç°å¾ˆç®€å•ï¼Œä½ æŠŠr0æ¢æˆçŸ©é˜µè¯•è¯•ã€‚</p><p>PSï¼š</p><ul><li>åœ¨è®¡ç®—æ—¶å¾ˆå¤šå–œæ¬¢å»æ‰1-Î±è¿™ä¸ªå€¼ï¼Œæ˜¯å› ä¸ºæ¨èæ—¶æˆ‘ä»¬æ›´å¤šçš„æ˜¯è¦çš„æ¨èæ’åºç»“æœï¼Œè€Œä¸æ˜¯å…·ä½“çš„æ¨èå€¼ï¼Œæ•…å»æ‰ä¸€ä¸ªå¸¸æ•°ä¹˜å­æ²¡æœ‰å½±å“ã€‚</li><li>å¯ä»¥çœ‹åˆ°å…¶ä¸­Mæ˜¯ç¨€ç–çŸ©é˜µï¼Œæ•…E-Î±MTä¹Ÿæ˜¯ç¨€ç–çŸ©é˜µã€‚é’ˆå¯¹å®ƒçš„å­˜å‚¨å’Œè®¡ç®—éƒ½æœ‰å¾ˆå¤šæˆç†Ÿçš„æ–¹æ³•ã€‚</li></ul><h3 id="item2vec"><a href="#item2vec" class="headerlink" title="item2vec"></a>item2vec</h3><p>item2vecæ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œç®—æ³•ï¼Œå®ƒåŸºæœ¬æ˜¯å±äºword2vecçš„è¡ç”Ÿå“ã€‚word2vecç®—æ³•åœ¨è¯ç”Ÿåï¼Œå…¶ç®€æ´çš„æ–¹æ³•å’Œå‡ºè‰²çš„æ•ˆæœæ€èµ·äº†ä¸€è‚¡ä¸‡ç‰©çš†å¯embeddingçš„çƒ­æ½®ï¼Œitem2vecå°±æ˜¯å°†word2vecåº”ç”¨åˆ°æ¨èç³»ç»Ÿä¸Šçš„ç®—æ³•ã€‚</p><p>æ‰€ä»¥è¦è¯´item2vecï¼Œå°±é€ƒä¸äº†word2vecï¼Œword2vecæ˜¯ä¸€ä¸ªç”¨äºNLPçš„ç®—æ³•ï¼Œç”±å¤§ç¥Tomas Mikolovåœ¨2013å¹´çš„è®ºæ–‡ã€ŠEfficient estimation of word representations in vector spaceã€‹ä¸­æå‡ºã€‚word2vecæ˜¯ä¸€ç¯‡è·¨æ—¶ä»£çš„è®ºæ–‡ï¼Œåœ¨word2vecè¯ç”Ÿå‰ï¼Œè¯­è¨€ä¸­çš„è¯éƒ½æ˜¯ä½¿ç”¨one-hotã€tf-infç­‰ç»Ÿè®¡å­¦æ–¹æ³•æˆ–è€…NNLMè¿™ç§è®¡ç®—é‡éå¸¸å¤§çš„n-gramæ–¹å¼è¿›è¡Œè¡¨ç¤ºçš„ï¼Œè¿™æ ·å°±ä¼šä½¿å¾—æ•°æ®ç»´åº¦ç‰¹åˆ«é«˜(è¯­æ–™åº“å¤§å°)å’Œç²¾åº¦ä½ï¼Œè€Œä¸”è¯ä¸è¯çš„å…³ç³»ä¹Ÿè¢«å¿½ç•¥äº†ã€‚word2vecæ˜¯ä¸€ç§å°†å…¶è¿›è¡Œé™ç»´ï¼Œå¹¶ä¸”å¯ä»¥è¡¨ç¤ºå‡ºè¯ä¸è¯å…³ç³»çš„æ–¹æ³•ã€‚è€Œä¸”ä»å®ƒå¼€å§‹çš„embeddingçš„æ¦‚å¿µï¼Œä½¿æˆ‘ä»¬åœ¨NLPç ”ç©¶æ–¹é¢ï¼Œä¹Ÿç»ˆäºå¯ä»¥å¼€å§‹ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šäº†ã€‚</p><p>å®ƒä½¿ç”¨çš„æ–¹å¼å°±æ˜¯embeddingï¼Œå°†è¯ç”¨å‘é‡æ¥è¡¨ç¤ºã€‚å¦‚ä¸‹ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/word2vecSample.png" srcset="/img/loading.gif" class="" title="CFå…¬å¼"><p>æ¯ä¸€åˆ—æ˜¯ä¸€ä¸ªè¯çš„å‘é‡è¡¨ç¤ºï¼Œå‘é‡ä¸­çš„æ¯ä¸ªå€¼å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªç‰¹å¾ï¼Œæ¯”å¦‚kingå’Œqueenåœ¨æ€§åˆ«å’Œçš‡å®¤ä¸Šéƒ½éå¸¸çªå‡ºï¼Œè¿™æ˜¯éå¸¸ç¬¦åˆç›´è§‰çš„ã€‚<br>æ³¨æ„ï¼šä¸Šå›¾åªæ˜¯ä¸ºäº†ä¸¾ä¾‹ï¼ŒçœŸå®çš„embeddingå‘é‡ä¸­çš„å€¼åŸºæœ¬æ˜¯å¾ˆéš¾è§£é‡Šçš„ã€‚</p><p>è¦å¾—åˆ°è¯çš„embedding,æˆ‘ä»¬åªéœ€è¦å°†embeddingçŸ©é˜µä¸è¯¥è¯çš„one-hotç›¸ä¹˜ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/embedding_matrix.png" srcset="/img/loading.gif" class="" title="CFå…¬å¼"><p>è¿™ä¸ªembeddingçŸ©é˜µå¦‚ä½•å¾—åˆ°å‘¢ï¼Ÿ</p><p>word2vecè®ºæ–‡ä¸­ä»‹ç»äº†2ç§æ–¹å¼ï¼ŒCBOWå’Œskip gramã€‚æˆ‘ä»¥skip gramä¸ºä¾‹ä½œä¸€ä¸ªç®€è¦çš„ä»‹ç»ï¼š</p><p>æ¯”å¦‚æˆ‘ä»¬çš„è¯­æ–™åº“å¤§å°ä¸º10000ï¼Œç°åœ¨æœ‰ä¸€ä¸ªè‹±æ–‡å¥å­ï¼š I will try to climb a very high mountain tomorrow.<br>æˆ‘ä»¬éšæœºé€‰æ‹©å…¶ä¸­ä¸€ä¸ªè¯æ¥é¢„æµ‹å®ƒä¸Šä¸‹æ–‡çš„å…¶å®ƒè¯ï¼Œæ¯”å¦‚ climbï¼Œæ¥ç€æˆ‘ä»¬å°±å¯ä»¥åœ¨å®ƒä¸€å®šçš„ä¸Šä¸‹æ–‡èŒƒå›´å†…é€‰å–è¯ä½œä¸ºæ ·æœ¬ï¼Œå¦‚ï¼š(climb,mountain),(climb, high),(climb, I),(climb,to)ã€‚</p><p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨è¿™äº›é€‰å–çš„è¯çš„one-hotæ¥ä¹˜ä»¥ä¸€ä¸ªEmbeddingçŸ©é˜µ Eå¾—åˆ°å…¶è¯å‘é‡ï¼Œå†é€šè¿‡ä¸€å±‚ç¥ç»ç½‘ç»œ+softmaxå¾—åˆ°ä¸€ä¸ª10000ç»´çš„å‘é‡ï¼Œå‘é‡çš„å„ä¸ªå€¼å°±ä»£è¡¨æ¯ä¸ªè¯å‡ºç°åœ¨å…¶ä¸Šä¸‹æ–‡ä¸­çš„æ¦‚ç‡ã€‚<br>å³ï¼š Oc * E = ec -&gt; Î¸T * ec -&gt; softmax -&gt; yhat<br>å…¶ä¸­Eå’ŒÎ¸å°±æ˜¯æˆ‘ä»¬çš„å¾…è®­ç»ƒå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨ä¼˜åŒ–å™¨è¿›è¡Œæ›´æ–°ï¼Œä¾¿å¯ä»¥å¾—åˆ°æˆ‘ä»¬çš„Eã€‚</p><p>è€ŒCBOWåˆ™å·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºCBOWæ˜¯ç”¨å¤šä¸ªè¯æ¥é¢„æµ‹ä¸€ä¸ªè¯ã€‚</p><p>å½“ç„¶ï¼Œword2vecè¿˜æœ‰å¾ˆå¤šçš„ç»†èŠ‚ï¼Œæ¯”å¦‚å¦‚ä½•é€šè¿‡åˆ†å±‚è®¡ç®—æˆ–è€…è´Ÿé‡‡æ ·æ¥å‡å°‘softmaxå±‚çš„è®¡ç®—é‡ä»¥åŠé€‰å–ä¸Šä¸‹æ–‡è¯çš„å¯å‘å¼æ–¹æ³•ç­‰ã€‚ä½ å¯ä»¥åœ¨æ–‡æœ«æ‰¾åˆ°è¯¥è®ºæ–‡è¿›è¡Œç¿»é˜…ã€‚</p><p>è€Œitem2vec å°±æ˜¯æŠŠitemå½“ä½œè¯ï¼Œä¸€èµ·å‡ºç°çš„itemå½“ä½œä¸Šä¸‹æ–‡(æ¯”å¦‚ç”¨æˆ·æµè§ˆçš„itemçš„é›†åˆ)ï¼Œä½¿ç”¨ä¸Šé¢çš„word2vecæ–¹å¼å­¦ä¹ åˆ°itemçš„embeddingçŸ©é˜µï¼Œæœ‰äº†å®ƒï¼Œå†ç”¨ä»»ä½•å‘é‡è¿‘ä¼¼ç®—æ³•è®¡ç®—å‘é‡ç›¸ä¼¼æ€§ä½œä¸ºitemç›¸ä¼¼æ€§è¿˜ä¸æ˜¯ä»»ä½ æ–½ä¸º~ </p><p>æ¯”å¦‚æ ¹æ®ç”¨æˆ·æœ€è¿‘æµè§ˆè¿‡çš„itemæ¨èä¸ä¹‹ç›¸ä¼¼çš„itemã€‚</p><p><strong>å’ŒCFçš„åŒºåˆ«</strong><br>éƒ½æ˜¯è®¡ç®—éšç›¸é‡embeddingï¼Œitem2vecå’Œä¸Šé¢ä»‹ç»çš„MFä¸»è¦çš„åŒºåˆ«å°±æ˜¯MFè®¡ç®—çš„embeddingæ˜¯user-itemçš„ï¼Œè€Œitem2vecè®¡ç®—å‡ºçš„embeedingæ˜¯item-itemçš„ï¼Œä»äºŒè€…æœ€ç»ˆçš„ä½¿ç”¨æ–¹å¼ä¸Šä¾¿å¯çœ‹å‡ºæ¥ã€‚å…¶æ¬¡ï¼ŒäºŒè€…è®¡ç®—çš„æ–¹å¼ä¹Ÿå®Œå…¨ä¸ä¸€æ ·~</p><p>è‡³äºäºŒè€…çš„æ•ˆæœï¼ŒMFæ›´å®¹æ˜“æ¨èæ¯”è¾ƒçƒ­é—¨çš„å†…å®¹ï¼Œè€Œitem2vecåœ¨æ—¶é—´çª—å£çš„åŸºç¡€ä¸Šæ›´èƒ½æ¨èuseræœ€è¿‘æµè§ˆçš„ç›¸ä¼¼itemã€‚</p><h3 id="åŸºäºå†…å®¹"><a href="#åŸºäºå†…å®¹" class="headerlink" title="åŸºäºå†…å®¹"></a>åŸºäºå†…å®¹</h3><p>åŸºäºå†…å®¹çš„æ¨èæ–¹æ³•æœ€å¥½è§£é‡Šï¼Œå®ƒçš„æ€è·¯éå¸¸ç®€å•ï¼Œå°±æ˜¯å»ºç«‹åœ¨â€œç”¨æˆ·ç»å¸¸çœ‹ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±ç»™ä»–æ¨èä»€ä¹ˆâ€çš„æ€è·¯ä¸Šã€‚å®ƒåº”è¯¥æ˜¯è¯ç”Ÿæœ€æ—©çš„æ¨èæ–¹æ³•äº†ã€‚<br>è¿™ç§æ–¹æ³•çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯å®ƒçš„ç‹¬ç«‹æ€§ï¼Œå³ç»™æŸä¸ªç”¨æˆ·è¿›è¡Œæ¨èçš„ç­–ç•¥åªè·Ÿè¿™ä¸ªç”¨æˆ·æœ‰å…³ï¼Œè€Œä¸å…¶å®ƒç”¨ æˆ·çš„è¡Œä¸ºæ— å…³ã€‚</p><p>ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œæ²¡ä»€ä¹ˆæ‰©å±•æ€§ï¼Œä¸”éœ€è¦å·²ç»æœ‰ä¸€äº›ç”¨æˆ·çš„è¡Œä¸ºå†å²ã€‚</p><p>ç®—æ³•çš„ä¸»è¦æµç¨‹ä¸ºï¼š</p><ol><li>ç»™æ‰€æœ‰çš„itemåšåˆ†ç±»ï¼Œæˆ–è€…æ‰“æ ‡ç­¾ï¼Œæ—©æœŸé€šè¿‡æ‰‹åŠ¨æˆ–è€…æå–å…³é”®å­—æ¥åšï¼Œè€Œåå¯ä»¥é€šè¿‡ä¸Šé¢ä»‹ç»çš„embedingæ–¹æ³•æ¥è®¡ç®—ç›¸ä¼¼æ€§æ¥åšï¼Œæˆ–è€…SVDã€‚</li><li>åšç”¨æˆ·ç”»åƒï¼ŒåŸºäºç”¨æˆ·çš„é•¿çŸ­æœŸè¡Œä¸ºå¾—åˆ°ç”¨æˆ·æ„Ÿå…´è¶£çš„åˆ†ç±»æˆ–è€…æ ‡ç­¾ã€‚</li><li>åŸºäº1ï¼Œ2çš„ç»“æœè¿›è¡Œæ¨è</li></ol><p>å¬å›æ–¹æ³•è¿˜æœ‰ä¸å°‘ï¼Œä¸Šé¢ä»‹ç»çš„å‡ ä¸ªåªæ˜¯æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„å‡ ä¸ªç®—æ³•ï¼Œä½¿ç”¨è¿™äº›ç®—æ³•è¿›è¡Œå¤šè·¯å¬å›å¹¶åˆå¹¶ç»“æœï¼Œå¾—åˆ°çš„æ–°çš„é›†åˆï¼Œå°±æ˜¯æˆ‘ä»¬ä¸‹ä¸€æ­¥ï¼Œæ’åºçš„è¾“å…¥äº†ã€‚</p><h2 id="æ’åºç®—æ³•"><a href="#æ’åºç®—æ³•" class="headerlink" title="æ’åºç®—æ³•"></a>æ’åºç®—æ³•</h2><p>å¦‚æœè¯´å¬å›å†³å®šäº†æˆ‘ä»¬æ¨èæ•ˆæœçš„å¤©èŠ±æ¿ï¼Œé‚£ä¹ˆæ’åºå°±å†³å®šäº†æˆ‘ä»¬æœ€ç»ˆé€¼è¿‘å¤©èŠ±æ¿çš„ç¨‹åº¦ã€‚</p><p>åœ¨æ–‡ç« å¼€å¤´è¯´è¿‡ï¼Œæ’åºé˜¶æ®µä¸€èˆ¬åˆ†æˆä¸‰ä¸ªæ­¥éª¤ï¼šç²—æ’-&gt;ä¸»æ’åº-&gt;é‡æ’åºã€‚</p><p>ç²—æ’çš„åŸå› æ—¶å› ä¸ºæ’åºç®—æ³•ä¸€èˆ¬ä½¿ç”¨è¾ƒä¸ºå¤æ‚çš„æ¨¡å‹ï¼Œä½¿ç”¨è¾ƒå¤šçš„å‚æ•°ï¼Œé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼Œå¦‚æœå¬å›é˜¶æ®µäº§å‡ºçš„itemè¿‡å¤šï¼Œä¼šå¯¼è‡´æ’åºæ—¶é—´è¿‡é•¿ã€‚äºæ˜¯å…ˆç”¨ä¸€æ¬¡ç²—æ’çš„è¿‡ç¨‹æ¥ç¼©å°æ ·æœ¬èŒƒå›´ã€‚å› æ­¤ç²—æ’ä¸€èˆ¬ä½¿ç”¨æ¯”è¾ƒç®€å•çš„æ’åºæ–¹æ³•ï¼Œæ¯”å¦‚ä½¿ç”¨åéªŒCTR(ç‚¹å‡»ç‡é¢„ä¼°)å’Œå…¥åº“æ—¶çš„é¢„ä¼°CTRå€¼ç›´æ¥æ’åºã€‚</p><p>ä¸»æ’åºåˆ™æ˜¯æˆ‘ä»¬è¦ä»‹ç»çš„å­¦ä¹ æ’åºã€‚</p><p>é‡æ’åˆ™æ˜¯å¯¹ä¸»æ’çš„ç»“æœè¿›è¡Œä¸€äº›ç­›é€‰ï¼Œæ¯”å¦‚æŠŠç»“æœæ”¾åˆ°ä¸€ä¸ªç±»ä¼¼äºsession modelæˆ–è€…å¼ºåŒ–å­¦ä¹ çš„æ¨¡å‹é‡Œé¢è¿›è¡Œé‡æ–°æ’åºï¼Œä¸»è¦çªå‡ºç”¨æˆ·æœ€è¿‘è¡Œä¸ºçš„ç‰¹ç‚¹ã€‚ä¸€èˆ¬æ¥è¯´ä½¿ç”¨æ›´å°‘çš„æ ·æœ¬èŒƒå›´ï¼Œæ¯”å¦‚åªæŠŠä¸»æ’åºç»“æœçš„top kè¿›è¡Œé‡æ’ã€‚</p><p>æ‰€ä»¥ï¼Œæœ€å½±å“æ’åºç»“æœçš„ï¼Œè¿˜æ˜¯ä¸»æ’åºéƒ¨åˆ†ã€‚æˆ‘ä»¬è¿™é‡Œä»‹ç»çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸»æ’åºçš„æ–¹æ³•ã€‚</p><h3 id="é€»è¾‘å›å½’"><a href="#é€»è¾‘å›å½’" class="headerlink" title="é€»è¾‘å›å½’"></a>é€»è¾‘å›å½’</h3><p>é€»è¾‘å›å½’(logistic regression)è¿™é‡Œå°±ä¸å±•å¼€æ¥è®²äº†ï¼Œç®€å•çš„è¯´å°±æ˜¯ç”¨å‡½æ•°å…³ç³»æ¥æ‹ŸåˆçœŸå®çš„åˆ†å¸ƒï¼Œç„¶åç”¨ä¸€ä¸ªéçº¿æ€§çš„è½¬æ¢å‡½æ•°å°†ç»“æœæ‹Ÿåˆæˆåˆ†ç±»ç»“æœã€‚</p><p>æ¨èç³»ç»Ÿä¸­åŸºäºä¸€é˜¶ç‰¹å¾çš„é€»è¾‘å›å½’å¦‚ä¸‹ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/LR_formula.png" srcset="/img/loading.gif" class="" title="LRå…¬å¼"><p>ä¸Šå¼çš„x1,x2,â€¦,xnä»£è¡¨ä¸åŒçš„ç‰¹å¾ï¼Œsigmoidæ˜¯ä¸€ä¸ªå¯ä»¥å°†å‡½æ•°å€¼æ˜ å°„åˆ°0-1é—´çš„å‡½æ•°ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/sigmoid.png" srcset="/img/loading.gif" class="" title="sigmoidå…¬å¼"><p>æ¥ç€å†ç”¨äº¤å‰ç†µå®šä¹‰æŸå¤±å‡½æ•°å¹¶ç”¨æ¢¯åº¦ä¸‹é™æ›´æ–°æ±‚å¾—wå³å¯ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯æ ·æœ¬æ•°æ®çš„é€‰æ‹©å’Œæ¸…æ´—ï¼Œæ¯”å¦‚æ˜æ˜¾çš„å¼‚å¸¸æ•°æ®ä¾¿åº”è¯¥å»æ‰ã€‚<br>å…¶æ¬¡ï¼Œåœ¨ç‰¹å¾çš„é€‰å–ä¸Šï¼Œé‚£ç§åªæœ‰å°‘é‡æ•°æ®æ‰æ‹¥æœ‰çš„ç‰¹å¾æ„ä¹‰å°±ä¸å¤§ã€‚</p><p>é€»è¾‘å›å½’çš„ç¼ºç‚¹åœ¨äºï¼Œè¦æƒ³å–å¾—å¥½çš„ç»“æœï¼Œäººå·¥ç»„åˆçš„ç‰¹å¾ä¸èƒ½å°‘ï¼Œä½†æ˜¯äººå·¥ç‰¹å¾éœ€è¦ä¸æ–­ç»„åˆã€æµ‹è¯•ã€è°ƒä¼˜ï¼Œéå¸¸è€—è´¹äººåŠ›ï¼Œæˆ‘ä»¬èƒ½å¦åœ¨æ¨¡å‹å±‚é¢è‡ªè¡Œè¿›è¡Œç‰¹å¾ç»„åˆå‘¢ï¼Ÿ</p><h3 id="GBDT"><a href="#GBDT" class="headerlink" title="GBDT"></a>GBDT</h3><p>å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« æ¥è®²GBDTã€‚<br>é“¾æ¥ï¼štodo..</p><h3 id="GBDT-LR"><a href="#GBDT-LR" class="headerlink" title="GBDT + LR"></a>GBDT + LR</h3><p>è¿™ä¸ªæ€è·¯æ¥è‡ªäºã€Špractical lessons from predicting clikcks on ads at facebookã€‹è¿™ç¯‡è®ºæ–‡ã€‚</p><p>ä¸€å¥è¯å°±å¯ä»¥æ¦‚æ‹¬è®ºæ–‡çš„ä¸»è¦æƒ³æ³•ï¼š<br>é€»è¾‘å›å½’è¿›è¡Œèåˆç‰¹å¾æ—¶ï¼Œä¸€éœ€è¦æ‰‹åŠ¨ç»„åˆï¼ŒäºŒè°ƒå‚éº»çƒ¦ï¼Œè€ŒGBDTè¿™ç§æå‡æ ‘æ¨¡å‹ä¸æ–­ç”¨æ–°çš„å†³ç­–æ ‘å­¦ä¹ æ®‹å·®çš„è¿‡ç¨‹ï¼Œå°±ç›¸å½“äºä¸æ–­åœ°æŠŠç‰¹å¾å˜å¹»æˆäº†æ–°çš„ç‰¹å¾ï¼Œå¦‚æœæŠŠè¿™ç§é«˜ç»´ç‰¹å¾å†æ”¾å…¥LRæ¨¡å‹ä¸­å»è®­ç»ƒï¼Œèƒ½ä¸èƒ½å¾—åˆ°æ›´å¥½çš„ç»“æœå‘¢ï¼Ÿ</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/gbdt&lr.png" srcset="/img/loading.gif" class="" title="gbdt&amp;lr-model"><p>åšæ³•ä¹Ÿå¾ˆå¥½å®ç°ï¼Œå…ˆè®­ç»ƒå¥½GBDTæ¨¡å‹ï¼Œå†æŠŠæ¯é¢—å†³ç­–æ ‘çš„ç»“æœä½œä¸ºæ–°çš„åˆ†ç±»ç‰¹å¾ï¼Œç„¶åä½¿ç”¨LRæ¨¡å‹è¿›è¡Œè®­ç»ƒã€‚</p><p>çœ‹èµ·æ¥æœ‰ä¸€äº›trickï¼Œä½†å®é™…æ•ˆæœç¡®å®åœ¨å¾ˆå¤šæƒ…å†µä¸‹ç•¥ä¼˜äºäºŒè€…ã€‚<br>ä½†2ä¸ªæ¨¡å‹å¹¶ä¸æ˜¯è”åˆè®­ç»ƒè€Œæ˜¯å•ç‹¬è¿›è¡Œè®­ç»ƒçš„ï¼ŒäºŒè€…ä¼˜åŒ–ç›®æ ‡ä¸åŒï¼Œä»è€Œè§£é‡Šæ€§ä¹Ÿå°±å¼±äº†ã€‚</p><h3 id="FM-factor-machine"><a href="#FM-factor-machine" class="headerlink" title="FM(factor machine)"></a>FM(factor machine)</h3><p>ç”±ä¸Šé¢çš„LRæ¨¡å‹ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€é˜¶çº¿æ€§æ¨¡å‹ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/state-1-LR.png" srcset="/img/loading.gif" class="" title="lrå…¬å¼"><p>å…¶å®å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œæƒ³è¦èå…¥ç‰¹å¾ç»„åˆçš„æ¦‚å¿µï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ ä¸€é¡¹ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/state-2-feature-combine.png" srcset="/img/loading.gif" class="" title="ç‰¹å¾ç»„åˆ"><p>å°†ç‰¹å¾ä¸¤ä¸¤ç»„åˆæ„æˆæ–°ç‰¹å¾ï¼Œå†æ¬¡æ”¾å…¥çº¿æ€§æ¨¡å‹ï¼Œä¼¼ä¹å°±åœ¨æ¨¡å‹å±‚é¢å®Œæˆäº†ç‰¹å¾ç»„åˆäº†ã€‚</p><p>å…¶å®ä¸ç„¶ï¼Œä¸Šè¯‰æ–¹æ³•åœ¨ç°å®ä¸­æ˜¯å¾ˆéš¾è¿ç”¨çš„ï¼Œå› ä¸ºç°å®ä¸­çš„æ•°æ®ç‰¹å¾å¾€å¾€éå¸¸å¤šï¼Œå¦‚æ·˜å®äº¬ä¸œçš„å•†å“ç‰¹å¾ï¼Œé‡çº§è¶…è¿‡åƒä¸‡ã€‚<br>è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®çŸ©é˜µæ˜¯é«˜åº¦ç¨€ç–çš„ï¼Œxi,xjåŒæ—¶ä¸ä¸º0çš„å¯èƒ½æ€§éå¸¸å°ï¼Œä»è€Œä½¿å¾—wijçš„è®­ç»ƒå‡ ä¹ä¸å¯èƒ½ã€‚</p><p>FMæ¨¡å‹å°±æ˜¯ä¸€ç§æ±‚è§£è¿™ç§é«˜é˜¶ç¨€ç–çŸ©é˜µçš„æ–¹å¼ï¼Œå®ƒå°†wijè½¬åŒ–æˆ2ä¸ªå‘é‡å¤§å°ä¸ºkçš„ä¸€ç»´å‘é‡viå’Œvjçš„å…§ç§¯</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/fm-formula.png" srcset="/img/loading.gif" class="" title="fmå…¬å¼"><p>å®ƒçš„æœ¬è´¨è¿˜æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„embeddingï¼Œä¸ºä»€ä¹ˆå®ƒèƒ½è§£å†³ç¨€ç–çŸ©é˜µçš„è®¡ç®—é—®é¢˜å‘¢ï¼Ÿ<br>å› ä¸ºå®ƒçš„è®¡ç®—å¹¶ä¸ä¾èµ–äºxi,xjè¿™ç§ç‰¹å¾ç»„åˆæ˜¯å¦å‡ºç°ï¼Œviçš„æœ¬è´¨æ˜¯ä¸€ä¸ªembedding, äºæŸä¸ªç‰¹å¾xiè€Œè¨€ï¼Œåªè¦æœ‰è¶³å¤Ÿå¤šxiå’Œå…¶å®ƒä»»ä½•ç‰¹å¾ä¸€èµ·å‡ºç°çš„æ ·æœ¬ï¼Œé‚£ä¹ˆviå°±æ˜¯å¯ä»¥è¢«è®­ç»ƒå‡ºæ¥çš„ã€‚æ­¤æ—¶å’ŒåŒæ ·è¢«è®­ç»ƒå‡ºæ¥çš„vjè®¡ç®—å…§ç§¯ï¼Œä¾¿å¯ä»¥å¾—åˆ°äºŒè€…ç»„åˆç‰¹å¾çš„æƒé‡ã€‚å¦‚ä¸‹ï¼š</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/fm-illustrate.jpg" srcset="/img/loading.gif" class="" title="fmå›¾è§£"><p>è¿™å°±æ˜¯embeddingçš„æ ¸å¿ƒç‰¹ç‚¹ï¼Œå°†one-hotæˆ–è€…1-0çš„ç¡¬åŒ¹é…ï¼Œè½¬æ¢æˆäº†å‘é‡é—´çš„è½¯åŒ¹é…ï¼Œä»è€Œèƒ½å¤Ÿè¿‘ä¼¼çš„å¾—åˆ°2ä¸ªæœ¬æ¥åŒ¹é…ä¸ä¸Šçš„ç‰¹å¾çš„å…³ç³»ã€‚</p><p><strong>å…¬å¼åŒ–ç®€</strong><br>ä¸Šè¯‰FMå…¬å¼ä¸­çš„xixjäº¤å‰é¡¹æ˜¯å¯ä»¥åŒ–ç®€çš„ï¼Œä»è€Œæ›´å¥½çš„è¿›è¡Œmodel servingã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„äº¤å‰é¡¹è‚¯å®šä¸åŒ…æ‹¬è‡ªå·±ä¸è‡ªå·±ç»„åˆï¼Œæ‰€ä»¥xixiè¿™ç§æƒ…å†µä¸è€ƒè™‘ï¼Œå…¶æ¬¡xixj,xjxiè¿™ç§é‡å¤çš„ï¼Œæˆ‘ä»¬ä¹Ÿåªç®—ä¸€æ¬¡ã€‚é‚£ä¹ˆåŸå§‹å¯ä»¥åŒ–ç®€å¦‚ä¸‹:</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/FM-briefy.png" srcset="/img/loading.gif" class="" title="fmåŒ–ç®€"><ol><li>ç¬¬ä¸€æ­¥å¼å­ä¸­çš„1/2å°±æ˜¯åœ¨å»é‡ï¼Œè€Œå‡å»çš„é¡¹åˆ™æ˜¯è‡ªèº«ä¸è‡ªèº«è¿›è¡Œçš„ç‰¹å¾ç»„åˆã€‚</li><li>ç¬¬äºŒæ­¥åˆ™æ˜¯å°†å‘é‡å…§ç§¯å±•å¼€ï¼Œkæ˜¯å‘é‡vçš„ç»´åº¦ã€‚</li><li>ç¬¬ä¸‰æ­¥åˆ™æ˜¯å…ˆå°†kæ±‚å’Œç§»åˆ°æœ€å¤–å±‚ï¼Œç„¶åå†…å±‚æ˜¯åœ¨ç¡®å®šæŸä¸ªç‰¹å¾çš„ç¬¬lä½çš„æƒ…å†µä¸‹ï¼Œä¸å…¶å®ƒç‰¹å¾å¯¹åº”çš„ç¬¬lä½ç›¸ä¹˜å¹¶æ±‚å’Œã€‚</li><li>ç¬¬ä¸‰æ­¥åˆ°ç¬¬å››æ­¥ï¼Œæ³¨æ„2ä¸ªæ±‚å’Œç¬¦å·ï¼Œè™½ç„¶ä¸€ä¸ªæ˜¯iï¼Œä¸€ä¸ªæ˜¯jï¼Œä½†èŒƒå›´ç›¸åŒï¼Œæ±‚å’Œçš„å¯¹è±¡ä¹Ÿç›¸åŒï¼Œæ‰€ä»¥å®é™…æ˜¯ä¸€æ ·çš„ï¼Œç›´æ¥æŠŠä¹˜æ”¹ä¸ºå¹³æ–¹å³å¯ã€‚</li></ol><p>åœ¨å®é™…çš„ç¼–ç ä¸­å°±å¾ˆå¥½è¡¨ç¤ºäº†ï¼ŒÎ£vilxiå°±æ˜¯ æ ·æœ¬ç‰¹å¾çŸ©é˜µ*v, æœ€å¤–å±‚çš„Î£åˆ™æ˜¯æ±‚å’Œæ“ä½œã€‚</p><p>å†æ ¹æ®å®é™…æƒ…å†µæ˜¯åˆ†ç±»è¿˜æ˜¯å›å½’é€‰æ‹©åˆé€‚çš„æŸå¤±å‡½æ•°è¿›è¡Œæ±‚å¯¼å³å¯ï¼Œå› ä¸ºæˆ‘ä»¬çš„å¼å­é‡Œæœ‰å¸¸æ•°é¡¹ã€ä¸€é˜¶é¡¹å’ŒäºŒé˜¶äº¤å‰é¡¹ï¼Œæ‰€ä»¥å¯¼æ•°ä¹Ÿæ˜¯3ä¸ªå“¦~</p><h3 id="ä½¿ç”¨DNN"><a href="#ä½¿ç”¨DNN" class="headerlink" title="ä½¿ç”¨DNN"></a>ä½¿ç”¨DNN</h3><p>æ·±åº¦å­¦ä¹ åœ¨å›¾åƒå’ŒNLPé¢†åŸŸéƒ½æå¾—çƒ­ç«æœå¤©å¦‚ç«å¦‚è¼ï¼Œé‚£æ¨èç³»ç»Ÿå¯ä»¥è¹­ä¸€è¹­å—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œæ¯”èµ·ä¸Šè¯‰çš„LR,GBDT,FMï¼Œç¥ç»ç½‘ç»œæ¨¡å‹æœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯å®ƒå¯ä»¥å®Œå…¨è‡ªåŠ¨åœ°å¯¹ç‰¹å¾è¿›è¡Œéçº¿æ€§çš„ç»„åˆï¼Œä¸”è¦†ç›–äº†äºŒé˜¶ç»„åˆå’Œé«˜é˜¶ç»„åˆã€‚</p><p>å°†DNNå¼•å…¥æ¨èç³»ç»Ÿï¼Œæœ€å¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯wide and deepæ¨¡å‹ï¼Œå®ƒæ¥è‡ªäºgoogleçš„ä¸€ç¯‡è®ºæ–‡ï¼šã€ŠWide &amp; Deep Learning for Recommender Systemsã€‹(æ–‡æœ«é™„é“¾æ¥)ã€‚</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/wideAndDeep.png" srcset="/img/loading.gif" class="" title="wideAndDeepæ¨¡å‹"><p>å·¦è¾¹çš„wideéƒ¨åˆ†æ˜¯ä¸€ä¸ªLRæˆ–è€…FMæ¨¡å‹ï¼Œè€Œå³è¾¹çš„deepåˆ™æ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œæˆ–è€…è¯´MLPæ¨¡å‹ã€‚w&amp;dæ¨¡å‹çš„è¾“å‡ºæ˜¯å°†wideä¾§è¾“å‡ºä¸deepä¾§æœ€åä¸€ä¸ªéšå±‚çš„è¾“å‡ºç›¸åŠ ï¼Œç„¶åå†è¿›è¡Œæ¿€æ´»å¾—åˆ°çš„ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯å¯ä»¥åœ¨ä¸€æ¬¡åå‘ä¼ æ’­ä¸­åŒæ—¶æ›´æ–°ä¸¤è¾¹çš„å‚æ•°ï¼Œè¾¾åˆ°è”åˆè®­ç»ƒçš„ç›®çš„ã€‚</p><img src="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/w&d-formula.png" srcset="/img/loading.gif" class="" title="w&amp;dæ¿€æ´»"><p>x_crossæ˜¯ç»„åˆç‰¹å¾ã€‚<br>Lossç›®æ ‡å‡½æ•°åˆ™æ ¹æ®é¡¹ç›®çš„å®é™…æƒ…å†µè‡ªè¡Œå®šä¹‰ï¼Œå®šä¹‰å¥½åï¼Œå†åˆ©ç”¨ç¥ç»ç½‘ç»œçš„åå‘ä¼ æ’­è¿›è¡Œæ±‚è§£å³å¯ã€‚</p><p>å½“ç„¶ï¼ŒDNNä¹Ÿæœ‰å…¶ç¼ºç‚¹ã€‚è€Œä¸”æˆä¹Ÿè§ä½•è´¥è§ä½•ï¼Œä¸Šé¢æˆ‘ä»¬è¯´è‡ªåŠ¨ç»„åˆç‰¹å¾æ˜¯DNNçš„ä¼˜ç‚¹ï¼Œä½†ä¹Ÿæ˜¯ç¼ºç‚¹ã€‚è¿™ç§æœ€çº¯ç²¹çš„w&amp;dæ¨¡å‹ï¼Œåªä¾é MLPæœ¬èº«æ¥è‡ªåŠ¨å¯¹ç‰¹å¾è¿›è¡Œç»„åˆï¼Œä½†å…¶å†…é‡Œå´å®Œå…¨æ˜¯ä¸€ä¸ªé»‘ç›’å­ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“çœŸæ­£ç»„åˆäº†ä»€ä¹ˆã€‚</p><p>ä¸€èˆ¬æ¥è¯´åœ¨å®é™…è¿›è¡Œä½¿ç”¨çš„æ—¶å€™ï¼Œè¿™äº›æ’åºæ¨¡å‹åœ¨å¤§è§„æ¨¡æ•°æ®ä¸Šå¾—åˆ°çš„æ•ˆæœæ˜¯ w&amp;d&gt;LR+GBDT&gt;GBDT&gt;LRçš„ã€‚<br>å½“ç„¶ï¼Œå®é™…æƒ…å†µå®é™…è®¨è®ºï¼Œåœ¨æ¨¡å‹è½åœ°çš„æ—¶å€™æˆ‘ä»¬éƒ½ä¼šè¿›è¡Œä¸€äº›ç¬¦åˆä¸šåŠ¡é€»è¾‘çš„ä¿®æ”¹ï¼Œæˆ–è€…åŠ å…¥ä¸€äº›å…¶å®ƒçš„æƒ³æ³•ã€‚æ‰€ä»¥ï¼Œé€‰æ‹©åˆé€‚çš„æ‰æ˜¯æœ€é‡è¦çš„ã€‚</p><p>å…¶æ¬¡ï¼Œå¯¹äºå®é™…ä¸Šçº¿çš„æ•ˆæœï¼Œæœ‰å¾ˆå¤šè¯„ä¼°æŒ‡æ ‡ï¼Œé€šç”¨çš„æ¯”å¦‚AUCã€F1ï¼Œæµ‹è¯•é›†è¡¨ç°ç­‰ã€‚ä¸åŒçš„ä¸šåŠ¡è¿˜èƒ½æ ¹æ®å®é™…ä¸šåŠ¡å®šä¹‰ç›¸åº”çš„ä¸šåŠ¡æŒ‡æ ‡ã€‚</p><p>åœ¨ç‰¹å¾çš„é€‰å–ä¸Šï¼Œæ’åºé˜¶æ®µåˆ™æ˜¯å¯ä»¥å°½é‡æŠŠç›¸å…³çš„side infoéƒ½ç‰¹å¾åŒ–ï¼Œæ¯•ç«Ÿè¿™ä¸ªé˜¶æ®µçš„ç›®æ ‡å°±æ˜¯ç²¾ç¡®ï¼Œè€Œæ›´å¤šçš„ä¿¡æ¯å¾€å¾€èƒ½å¤Ÿå¾—åˆ°æ›´å¥½çš„ç»“æœã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å†æ€»ç»“ä¸€ä¸‹æµç¨‹ï¼Œé¦–å…ˆï¼Œä½¿ç”¨å¤šè·¯å¬å›å¹¶åˆå¹¶ï¼Œä»æ‰€æœ‰itemä¸­æ‰¾åˆ°æœ€é€‚åˆæ¨èç»™ç”¨æˆ·çš„è¿‘åƒçš„itemã€‚è¿›å…¥æ’åºé˜¶æ®µåï¼Œå¦‚æœitemè¿‡å¤šå¯¼è‡´æ’åºæ—¶é—´é•¿ï¼Œå¯ä»¥åŠ å…¥ç²—æ’é˜¶æ®µï¼Œç”¨ä¸€äº›ç®€å•çš„æ’åºæ¨¡å‹å¯¹å¬å›è¿”å›çš„itemè¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œè¿›ä¸€æ­¥ç¼©å°itemèŒƒå›´ã€‚æ¥ç€å†ä½¿ç”¨ç²¾ç¡®åº¦è¾ƒé«˜çš„ä¸»æ’åºæ¨¡å‹è¿›è¡Œç²¾å‡†æ’åºã€‚æœ€åï¼Œå†æ ¹æ®ä¸€äº›ä¸šåŠ¡ç­–ç•¥ç­›é€‰ï¼Œæ¯”å¦‚ä½¿å®é™…æ¨èç»“æœå¤šæ ·åŒ–ï¼Œæˆ–è€…å»é™¤å·²è¯»itemç­‰ï¼Œç„¶åå†æ¨èç»™ç”¨æˆ·ã€‚</p><p>è€Œä¸ºäº†éªŒè¯æ¨¡å‹æ•ˆæœå’Œç»§ç»­ä¼˜åŒ–æ¨¡å‹ï¼Œæˆ‘ä»¬è¦ç»§ç»­æ”¶é›†ç”¨æˆ·çš„å„ç§è¡Œä¸ºå’Œåé¦ˆã€‚</p><p>è¿™äº›è¡Œä¸ºå’Œåé¦ˆä¸€éƒ¨åˆ†å¯ä»¥å®æ—¶çš„ç”¨æ¥æ›´æ–°åœ¨çº¿æ¨èæ¨¡å‹ï¼Œè®©ç”¨æˆ·çš„å®æ—¶è¡Œä¸ºåœ¨ä¸‹ä¸€æ¬¡åˆ·æ–°ä¸­å³å¯å¾—åˆ°ä½“ç°ã€‚<br>è€Œæ‰€æœ‰è¿™äº›æ•°æ®éƒ½åº”è¯¥è¢«è®°å½•ä¸‹æ¥è¡¥å……è¿›æˆ‘ä»¬çš„ç¦»çº¿è®­ç»ƒæ•°æ®ï¼Œä»è€Œç”¨æ›´å¤§çš„æ¨¡å‹è¿›è¡Œç¦»çº¿è®­ç»ƒï¼Œä»è€Œå‘¨æœŸæ€§åœ°å¯¹æ¨¡å‹è¿›è¡Œæ›´æ–°ã€‚</p><h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="https://www.coursera.org/learn/machine-learning" target="_blank" rel="noopener">Andrew Ngåœ¨courseraä¸Šçš„æœºå™¨å­¦ä¹ è¯¾ç¨‹</a><br><a href="https://arxiv.org/abs/1301.3781v3" target="_blank" rel="noopener">word2vecè®ºæ–‡:Efficient Estimation of Word Representations in Vector Space</a><br><a href="https://arxiv.org/abs/1603.04259" target="_blank" rel="noopener">item2vecè®ºæ–‡:Item2Vec: Neural Item Embedding for Collaborative Filtering</a><br><a href="https://zhuanlan.zhihu.com/p/58160982" target="_blank" rel="noopener">çŸ¥ä¹å¼ ä¿Šæ—ä¸“æ ï¼šå…¨èƒ½çš„FMæ¨¡å‹</a><br><a href="https://quinonero.net/Publications/predicting-clicks-facebook.pdf" target="_blank" rel="noopener">gbdt&amp;lrè®ºæ–‡ï¼šPractical Lessons from Predicting Clicks on Ads at Facebook</a><br><a href="https://arxiv.org/abs/1606.07792" target="_blank" rel="noopener">wide and deepè®ºæ–‡:Wide &amp; Deep Learning for Recommender Systems</a></p>]]></content>
    
    
    <categories>
      
      <category>åŸºç¡€ç®—æ³•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æœºå™¨å­¦ä¹ </tag>
      
      <tag>æ¨èç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç®€å•çš„è§¦å‘è¯è¯†åˆ«</title>
    <link href="/2020/04/21/%E7%AE%80%E5%8D%95%E7%9A%84%E8%A7%A6%E5%8F%91%E8%AF%8D%E8%AF%86%E5%88%AB/"/>
    <url>/2020/04/21/%E7%AE%80%E5%8D%95%E7%9A%84%E8%A7%A6%E5%8F%91%E8%AF%8D%E8%AF%86%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å‚è€ƒandrew Ng, Sequence Model,  notebook-Trigger word detection.</p><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>å½“ä½ å¯¹è‹¹æœæ‰‹æœºå«å‡ºâ€hey siriâ€ï¼Œæˆ–å¯¹å°ç±³æ‰‹æœºå«å‡ºâ€å°çˆ±åŒå­¦â€æ—¶ï¼Œæ‰‹æœºåŠ©æ‰‹ä¼šç«‹åˆ»å‡ºç°ï¼Œè¿™å°±æ˜¯è§¦å‘è¯è¯†åˆ«ç³»ç»Ÿï¼Œæ˜¯ä¸€ç§è¯†åˆ«éŸ³é¢‘å¹¶ä¸”åœ¨æ¥æ”¶åˆ°æŸä¸ªè§¦å‘è¯çš„æ—¶å€™æ¿€æ´»çš„ç¨‹åºã€‚ä¸åŒäºä¸€èˆ¬çš„è¯­éŸ³è¯†åˆ«éœ€è¦å¤§é‡çš„æ•°æ®(è¶…è¿‡10Wå°æ—¶)æ¥è®­ç»ƒï¼Œè§¦å‘è¯ç³»ç»Ÿçš„è®­ç»ƒç›¸å¯¹ç®€å•å¾ˆå¤šã€‚</p><p>å½“ä½ å®Œæˆè¿™ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œä½ å¯ä»¥å°†å®ƒæ‰©å±•å¹¶å¸ƒç½®åˆ°è‡ªå·±çš„ç”µè„‘ä¸Šï¼Œæ¯å½“ä½ è¯´å‡ºæŸä¸ªæ¿€æ´»è¯çš„æ—¶å€™ï¼Œä½ çš„ç”µè„‘å¯ä»¥éšå³è‡ªåŠ¨æ‰“å¼€æŸä¸ªappï¼Œæˆ–è€…æ˜¯æ’­æ”¾æŸä¸€é¦–éŸ³ä¹ï¼Œå¬èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆæ£’(å§ï¼Ÿ)ã€‚</p><p>å› ä¸ºå£°éŸ³æ•°æ®æ˜¯åºåˆ—æ•°æ®ï¼Œæˆ‘ä»¬ç”¨RNN&amp;GRUæ¥åšè¿™ä¸ªç”¨è¯†åˆ«è§¦å‘è¯çš„ç¨‹åºï¼Œå½“ç¨‹åºå¬è§è¯­éŸ³â€æ¿€æ´»â€çš„æ—¶å€™å°±ç»™å‡ºä¸€ä¸ªæŸç§ååº”ã€‚</p><h2 id="åˆ›å»ºè¯­éŸ³æ•°æ®é›†"><a href="#åˆ›å»ºè¯­éŸ³æ•°æ®é›†" class="headerlink" title="åˆ›å»ºè¯­éŸ³æ•°æ®é›†"></a>åˆ›å»ºè¯­éŸ³æ•°æ®é›†</h2><p>è¯­éŸ³æ•°æ®æ˜¯å¾ˆéš¾è·å–çš„ä¸€ç±»æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦çš„æ ·æœ¬æ˜¯10ç§’é’Ÿçš„æ•°æ®ï¼Œå…¶ä¸­ä¼šéšæ—¶å‡ºç°æˆ‘ä»¬çš„æ¿€æ´»è¯ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±å½•åˆ¶è¿™äº›æ ·æœ¬ï¼Œå› ä¸ºæ•°é‡æ¯”è¾ƒå¤§ï¼Œè¿™å°†ä¼šç›¸å½“å›°éš¾ï¼Œäºæ˜¯æˆ‘ä»¬è€ƒè™‘ä½¿ç”¨éŸ³é¢‘åˆæˆæ¥åˆ¶ä½œæˆ‘ä»¬çš„æ•°æ®é›†ã€‚<br>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ç”¨äºåˆæˆçš„å…ƒæ•°æ®ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å»åˆ°å„ç§ç¯å¢ƒä¸­ç”¨ä¸åŒäººï¼Œä¸åŒå£éŸ³å½•åˆ¶â€æ¿€æ´»â€ä»¥åŠä»»ä½•å…¶å®ƒè¯­éŸ³ã€‚<br>å°†å®ƒä»¬åˆ†ä¸º positive\negative\backgroundä¸‰ç±»ï¼Œpositiveä¸ºä¸åŒäººä¸åŒå£éŸ³å¿µæˆ‘ä»¬çš„æ¿€æ´»è¯ï¼Œ negative åˆ™æ˜¯éšæœºçš„å…¶å®ƒè¯ï¼Œbackgroundåˆ™æ˜¯å„ç§èƒŒæ™¯éŸ³ï¼ŒæŒç»­10ç§’ã€‚<br>PSï¼šå› ä¸ºå£éŸ³å’Œè¯è¯­é•¿çŸ­ä¸åŒï¼Œpositiveå’Œnegativeçš„è¯­éŸ³æ–‡ä»¶é•¿åº¦ä¸å®šã€‚</p><p>æ”¶é›†å®Œè¯­éŸ³åï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚<br>ä¸€èˆ¬æ¥è¯´ï¼Œå½•åˆ¶çš„å£°éŸ³æ–‡ä»¶æ ¹æ®è®¾å¤‡çš„ä¸åŒï¼Œæ‹¥æœ‰ä¸åŒçš„HZæ•°ã€‚è¿™é‡Œå‡è®¾æˆ‘ä»¬é‡‡é›†çš„æ ·æœ¬ä¸º44100HZï¼Œå³å½•åˆ¶çš„éŸ³é¢‘æ–‡ä»¶æ¯ç§’æœ‰44100ä¸ªæ•°å­—ã€‚</p><p>è¦ç›´æ¥å¤„ç†è¿™ç§æ–‡ä»¶ç›¸å¯¹æ¥è¯´æ˜¯è¾ƒä¸ºå›°éš¾çš„ï¼Œæ‰€ä»¥æ›´æµè¡Œçš„åšæ³•æ˜¯å°†æ•°æ®ç”¨å‚…é‡Œå¶å˜æ¢è½¬åŒ–ä¸ºé¢‘è°±(spectrogram)ï¼Œè¿™æ˜¯ä¿¡å·å¤„ç†ç›¸å…³çš„çŸ¥è¯†ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥ç”¨è½¯ä»¶åŒ…å®ç°ã€‚</p><pre><code class="hljs plain">x &#x3D; graph_spectrogram(&quot;audios&#x2F;train_example.wav&quot;)</code></pre>{% asset_img spectrogram-img.png é¢‘è°±ç‰‡ %}<p>é¢‘è°±å›¾ç›´è§‚ä¸Šä½“ç°çš„æ˜¯é¢‘ç‡(yè½´)å’Œæ—¶é—´(xè½´)çš„å›¾åƒå…³ç³»ï¼Œåç»¿çš„é¢œè‰²è¡¨ç¤ºé¢‘ç‡è¾ƒé«˜ï¼Œè€Œè“è‰²åˆ™ç›¸åã€‚</p><p>é¢‘è°±è¾“å‡ºçš„æ•°æ®ç»´åº¦æ˜¯ç”±ç¨‹åºçš„è¶…å‚æ•°å’Œè¾“å…¥æ•°æ®çš„é•¿åº¦å†³å®šçš„ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„è½¬æ¢ç¨‹åºï¼Œ10ç§’çš„æ•°æ®å°†æ‹¥æœ‰5511ä¸ªtimestepï¼Œå³Tx=5511.</p><pre><code class="hljs plain">print(&quot;spectrogram shape:&quot;, x.shape)</code></pre><p>è¾“å‡ºä¸º(101,5511)ã€‚<br>å› æ­¤æˆ‘ä»¬å¯ä»¥å®šä¹‰ï¼š</p><pre><code class="hljs plain">Tx &#x3D; 5511 n_freq &#x3D; 101 # æ¯ä¸ªtimestepä¸­è¾“å…¥åˆ°æ¨¡å‹ä¸­çš„é¢‘ç‡æ•°Ty &#x3D; 1375 # æˆ‘ä»¬ç¨‹åºçš„è¾“å‡ºå°†ä¼šæŠŠ10ç§’åˆ‡åˆ†ä¸º1375ä»½</code></pre><h3 id="åˆæˆè¯­éŸ³"><a href="#åˆæˆè¯­éŸ³" class="headerlink" title="åˆæˆè¯­éŸ³"></a>åˆæˆè¯­éŸ³</h3><p>ä¸‰ä¸ªæ­¥éª¤</p><ol><li>é¦–å…ˆæˆ‘ä»¬éšæœºé€‰å–ä¸€ä¸ªbackgroundéŸ³é¢‘</li><li>éšæœºå°†0-4ä¸ªæ­£æ ·æœ¬éŸ³é¢‘ç‰‡æ®µæ’å…¥</li><li>éšæœºå°†0-2ä¸ªè´Ÿæ ·æœ¬éŸ³é¢‘ç‰‡æ®µæ’å…¥<br>å› ä¸ºæ˜¯æˆ‘ä»¬æ§åˆ¶çš„æ’å…¥ï¼Œæˆ‘ä»¬åŒæ—¶å¯ä»¥å¾—åˆ°Ylabelæ•°æ®ï¼Œå³ç¬¬å‡ ä¸ªtimestepä¸ºæ¿€æ´»è¯åˆšåˆšè¯´å®Œçš„æ—¶åˆ»ï¼Œè®°ä¸ºy&lt;t&gt;=1,ä½†ä¸€èˆ¬æ¥è¯´ä¸ºäº†é¿å…labelæ•°æ®è¿‡äºç¨€ç–ï¼Œæˆ‘ä»¬ä¼šæŠŠæ¿€æ´»è¯ç»“æŸåçš„ä¸€æ®µtimestepçš„yéƒ½ç½®ä¸º1ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©çš„ä¸€æ®µä¸º50ä¸ªtimestepã€‚</li></ol><p>ä½¿ç”¨pydubåŒ…æ¥å¤„ç†éŸ³é¢‘ï¼Œè¿™ä¸ªåŒ…å°†ä¼šç”¨msä½œä¸ºæ—¶é—´è½´æœ€å°å•ä½ï¼Œ10ç§’çš„æ•°æ®å°†ä¼šæœ‰10000ä¸ªtimestep.</p><p>æ³¨æ„ï¼Œåˆæˆåçš„éŸ³é¢‘åº”è¯¥ä¾ç„¶ä¸º10ç§’ï¼Œå³æ­£è´Ÿæ ·æœ¬éƒ½åº”è¯¥è¢«backgroundå®Œå…¨å®¹çº³ï¼Œä¸”äºŒè€…äº’ç›¸ä¸èƒ½é‡å ã€‚</p><pre><code class="hljs plain">activates, negatives, backgrounds &#x3D; load_raw_audio()</code></pre><p>å…ˆæ¥å®ç°å‡ ä¸ªå·¥å…·æ–¹æ³•ï¼š</p><pre><code class="hljs plain"># è·å–æ’å…¥ä½ç½®def get_random_time_segment(segment_ms):    &quot;&quot;&quot;    ä»10000ä¸ªtimestepä¸­éšæœºå–ä¸€ä¸ªtimestepï¼Œä½œä¸ºä¹‹åçš„æ’å…¥ä½ç½®        Arguments:    segment_ms -- è¦æ’å…¥éŸ³é¢‘çš„msé•¿åº¦        Returns:    segment_time -- a tuple(segment_start, segment_end) in msï¼Œæ’å…¥çš„å¼€å§‹å’Œç»“æŸtimestemp    &quot;&quot;&quot;        segment_start &#x3D; np.random.randint(low&#x3D;0, high&#x3D;10000-segment_ms)   # ç¡®ä¿æ’å…¥çš„éŸ³é¢‘ä¸ä¼šè¶…å‡ºbackgroundçš„ç»“å°¾    segment_end &#x3D; segment_start + segment_ms - 1        return (segment_start, segment_end)# æ£€æŸ¥æ˜¯å¦å‘ç”Ÿé‡å def is_overlapping(segment_time, previous_segments):    &quot;&quot;&quot;    Arguments:    segment_time -- a tuple(segment_start, segment_end) æ–°æ’å…¥ç‰‡æ®µçš„èµ·æ­¢æ—¶é—´    previous_segments -- a list of tuples(segment_start, segment_end) å·²ç»æ’å…¥çš„ç‰‡æ®µçš„èµ·æ­¢æ—¶é—´åˆ—è¡¨        Returns:    True or False ä»£è¡¨æ˜¯å¦å‘ç”Ÿé‡å     &quot;&quot;&quot;        segment_start, segment_end &#x3D; segment_time    overlap &#x3D; False        for previous_start, previous_end in previous_segments:        # ä½œä¸šæç¤ºå¯ä»¥ç”¨ if ... &lt;&#x3D; ... and ... &gt;&#x3D; ... è¿™ç§å½¢å¼å®ç°ï¼Œæˆ‘æ²¡æƒ³å‡ºæ¥å‘¢        if (previous_start &gt; segment_end or segment_start &gt; previous_end) &#x3D;&#x3D; False :            overlap &#x3D; True    return overlap# å‘backgroundä¸­éšæœºä½ç½®æ’å…¥éŸ³é¢‘ç‰‡æ®µï¼Œç¡®ä¿ä¸ä¼šå‘ç”Ÿé‡å å’Œè¶…å‡ºdef insert_audio_clip(background, audio_clip, previous_segments):    &quot;&quot;&quot;     Arguments:    background -- 10ç§’é’Ÿçš„èƒŒæ™¯éŸ³é¢‘.      audio_clip -- è¦æ’å…¥çš„éŸ³é¢‘.     previous_segments -- å·²ç»æ’å…¥åœ¨backgroundä¸­çš„éŸ³é¢‘çš„èµ·æ­¢æ—¶é—´        Returns:    new_background -- æ’å…¥éŸ³é¢‘åçš„æ–°çš„background    &quot;&quot;&quot;        # Get the duration of the audio clip in ms    segment_ms &#x3D; len(audio_clip)        segment_time &#x3D; get_random_time_segment(segment_ms)        while is_overlapping(segment_time, previous_segments):        segment_time &#x3D; get_random_time_segment(segment_ms)    previous_segments.append(segment_time)        # å°†éŸ³é¢‘åœ¨backgroundçš„å¯¹åº”ä½ç½®å åŠ è¿›å»    new_background &#x3D; background.overlay(audio_clip, position &#x3D; segment_time[0])        return new_background, segment_time</code></pre><p>æ’å…¥äº†æ¿€æ´»è¯è¯­éŸ³åï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹Ylabelåšå‡ºæ›´æ–°ï¼Œå¦‚æˆ‘ä»¬ä¸Šé¢æ‰€è¯´ï¼Œå°†ç»“æŸä½ç½®çš„åé¢50ä¸ªyéƒ½æ›´æ–°ä¸º1ã€‚<br>å› ä¸ºæˆ‘ä»¬çš„yçš„ç»´åº¦ä¸º1375è€ŒéŸ³é¢‘æ•°æ®ç»´åº¦ä¸º10000ï¼Œæ‰€ä»¥è¦è®°å¾—åšä¸€ä¸‹ç¼©æ”¾ã€‚è¿˜è¦ç¡®ä¿å¦‚æœéŸ³é¢‘æ’å…¥åœ¨backgroundçš„å°¾éƒ¨ï¼Œå¯¼è‡´åé¢æ²¡å‰©ä¸‹50ä¸ªå€¼ï¼Œæ³¨æ„ä¸è¦è¶Šç•Œã€‚</p><pre><code class="hljs plain">def insert_ones(y, segment_end_ms):    &quot;&quot;&quot;    Arguments:    y -- numpy array of shape (1, Ty),è®­ç»ƒæ ·æœ¬çš„æ ‡ç­¾å€¼    segment_end_ms -- æ’å…¥çš„æ¿€æ´»éŸ³é¢‘çš„ç»“æŸæ—¶é—´        Returns:    y -- æ›´æ–°åçš„ labels    &quot;&quot;&quot;        # ç¼©æ”¾    segment_end_y &#x3D; int(segment_end_ms * Ty &#x2F; 10000.0)        for i in range(segment_end_y, segment_end_y + 50):        if i &lt; Ty:            y[0, i] &#x3D; 1        return y</code></pre><p>æ¥ä¸‹æ¥å°±å¯ä»¥åˆ›å»ºæˆ‘ä»¬çš„è®­ç»ƒæ ·æœ¬äº†ï¼š</p><pre><code class="hljs plain">def create_training_example(background, activates, negatives):    &quot;&quot;&quot;    Creates a training example with a given background, activates, and negatives.        Arguments:    background -- a 10 second background audio recording    activates -- a list of audio segments of the word &quot;activate&quot;    negatives -- a list of audio segments of random words that are not &quot;activate&quot;        Returns:    x -- the spectrogram of the training example    y -- the label at each time step of the spectrogram    &quot;&quot;&quot;        # å‡å°å™ªéŸ³    background &#x3D; background - 20    y &#x3D; np.zeros((1,Ty))    previous_segments &#x3D; []        # éšæœºæ’å…¥0-4æ®µæ¿€æ´»éŸ³é¢‘    number_of_activates &#x3D; np.random.randint(0, 5)    random_indices &#x3D; np.random.randint(len(activates), size&#x3D;number_of_activates)    random_activates &#x3D; [activates[i] for i in random_indices]        for random_activate in random_activates:        background, segment_time &#x3D; insert_audio_clip(background, random_activate, previous_segments)        segment_start, segment_end &#x3D; segment_time        y &#x3D; insert_ones(y, segment_end)    # éšæœºæ’å…¥0-2æ®µnegativeè¯­éŸ³    number_of_negatives &#x3D; np.random.randint(0, 3)    random_indices &#x3D; np.random.randint(len(negatives), size&#x3D;number_of_negatives)    random_negatives &#x3D; [negatives[i] for i in random_indices]    for random_negative in random_negatives:        background, _ &#x3D; insert_audio_clip(background, random_negative, previous_segments)        # æ ‡å‡†åŒ–ä¸€æ³¢     background &#x3D; match_target_amplitude(background, -20.0)    # å¯¼å‡ºè®­ç»ƒæ ·æœ¬    file_handle &#x3D; background.export(&quot;train&quot; + &quot;.wav&quot;, format&#x3D;&quot;wav&quot;)    print(&quot;File (train.wav) was saved in your directory.&quot;)        # ç»˜åˆ¶é¢‘è°±å›¾    x &#x3D; graph_spectrogram(&quot;train.wav&quot;)        return x, y</code></pre><p>ç„¶åæˆ‘ä»¬å°±ç”¨è¿™ä¸ªæ–¹æ³•å»åˆ›å»ºä¸€å¤§å †çš„è®­ç»ƒæ ·æœ¬ã€‚<br>ç„¶åå°†åˆ›å»ºå¥½çš„è®­ç»ƒæ ·æœ¬èµ‹å€¼ç»™ <strong><em>X</em></strong> å’Œ <strong><em>Y</em></strong></p><h2 id="æ¨¡å‹"><a href="#æ¨¡å‹" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h2><p>æˆ‘ä»¬ç”¨keresæ¥å®ç°è¿™ä¸ªæ¨¡å‹ã€‚<br>æ¨¡å‹å…±å››å±‚</p><ul><li>ç¬¬ä¸€å±‚æ˜¯ä¸€ä¸ªå·ç§¯å±‚ï¼Œå› ä¸ºæˆ‘ä»¬çš„é¢‘è°±æ•°æ®ä¸º1ç»´ï¼Œæ‰€ä»¥æ˜¯ä¸€ç»´å·ç§¯(196ä¸ªæ»¤æ³¢å™¨ï¼Œæ»¤æ³¢å™¨é•¿åº¦15ï¼Œæ­¥å¹…ä¸º4)ï¼Œå·ç§¯åå†åšä¸€æ¬¡BNï¼Œå¹¶ç”¨ReLuæ¿€æ´»ï¼Œå†ç”¨Dropoutè¿›è¡Œä¸€æ¬¡æ­£åˆ™åŒ–ã€‚</li><li>ç¬¬äºŒå±‚æ˜¯ä¸€ä¸ªGRUå±‚ï¼Œä¿è¯ç½‘ç»œçš„è®°å¿†èƒ½åŠ›ï¼Œå¹¶ä¸”ä¹Ÿå¯¹è¾“å‡ºçš„æ•°æ®åšDropoutå’ŒBNå¤„ç†ã€‚</li><li>ç¬¬ä¸‰å±‚ç»§ç»­ç”¨ä¸€ä¸ªGRUå±‚ã€‚</li><li>æœ€åä¸€å±‚ä¸ºå…¨è¿æ¥ï¼Œä¸”æ¥sofxmaxä½œä¸ºè¾“å‡ºã€‚</li></ul><p>å¦‚ä¸‹ï¼š</p><img src="/2020/04/21/%E7%AE%80%E5%8D%95%E7%9A%84%E8%A7%A6%E5%8F%91%E8%AF%8D%E8%AF%86%E5%88%AB/model.png" srcset="/img/loading.gif" class="" title="æ¨¡å‹å›¾ç‰‡"><p>ä»£ç ï¼š</p><pre><code class="hljs plain">def model(input_shape):    &quot;&quot;&quot;    ç”¨kerasæ„é€ è®­ç»ƒæ¨¡å‹        Argument:    input_shape -- æ¨¡å‹è¾“å…¥æ•°æ®çš„å½¢çŠ¶    Returns:    model -- keras model å®ä¾‹    &quot;&quot;&quot;        X_input &#x3D; Input(shape &#x3D; input_shape)        # Layer 1: CONV layer     X &#x3D; Conv1D(filters&#x3D;196,kernel_size&#x3D;15,strides&#x3D;4)(X_input)   # CONV1D    X &#x3D; BatchNormalization()(X)                                 # Batch normalization    X &#x3D; Activation(&quot;relu&quot;)(X)                                   # ReLu activation    X &#x3D; Dropout(rate&#x3D;0.8)(X)                                    # dropout (use 0.8)    # Layer 2: First GRU Layer    X &#x3D; GRU(units&#x3D;128, return_sequences &#x3D; True)(X)           # GRU (use 128 units and return the sequences)    X &#x3D; Dropout(rate&#x3D;0.8)(X)                                 # dropout (use 0.8)    X &#x3D; BatchNormalization()(X)                              # Batch normalization        # Layer 3: Second GRU Layer    X &#x3D; GRU(units&#x3D;128, return_sequences &#x3D; True)(X)           # GRU (use 128 units and return the sequences)    X &#x3D; Dropout(rate&#x3D;0.8)(X)                                 # dropout (use 0.8)    X &#x3D; BatchNormalization()(X)                              # Batch normalization    X &#x3D; Dropout(rate&#x3D;0.8)(X)                                 # dropout (use 0.8)        # Layer 4: Time-distributed dense layer    X &#x3D; TimeDistributed(Dense(1, activation &#x3D; &quot;sigmoid&quot;))(X) # time distributed  (sigmoid)    model &#x3D; Model(inputs &#x3D; X_input, outputs &#x3D; X)        return model</code></pre><p>æ³¨æ„ä¸Šé¢æœ€åä¸€å±‚çš„ TimeDistributed å±‚ï¼Œ<a href="https://machinelearningmastery.com/timedistributed-layer-for-long-short-term-memory-networks-in-python/" target="_blank" rel="noopener">è¿™é‡Œ</a>æœ‰å…³äºå®ƒçš„ä½¿ç”¨çš„å®Œå…¨è§£é‡Šã€‚<br>ç®€å•çš„è¯´ï¼Œå®ƒæ˜¯ä½¿ç”¨timestepæ¥è¿›è¡Œæ“ä½œï¼Œä¸”å¯¹æ¯ä¸ªtimestepçš„æ•°æ®éƒ½å…±äº«æƒé‡ã€‚<br>æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬ç”¨å®ƒåŒ…è£…äº†Denseï¼Œå³æ˜¯è¯´å¯¹æ¯ä¸ªtimestepçš„ç»“æœï¼Œéƒ½ä½¿ç”¨åŒæ ·çš„å‚æ•°è®¡ç®—Denseè¾“å‡ºç»“æœã€‚</p><p>æ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œè®­ç»ƒäº†ï¼š</p><pre><code class="hljs plain">opt &#x3D; Adam(lr&#x3D;0.0001, beta_1&#x3D;0.9, beta_2&#x3D;0.999, decay&#x3D;0.01)model.compile(loss&#x3D;&#39;binary_crossentropy&#39;, optimizer&#x3D;opt, metrics&#x3D;[&quot;accuracy&quot;])model.fit(X, Y, batch_size &#x3D; 5, epochs&#x3D;100)</code></pre><p>å¾—åˆ°ï¼š<br>Epoch 100/100<br>26/26 [==============================] - 34s - loss: 0.0610 - acc: 0.9796 </p><p>æ¥ä¸‹æ¥å¦‚æœæœ‰å¼€å‘é›†ï¼Œå¯ä»¥å¯¹æ¨¡å‹è¿›è¡Œæµ‹è¯•ï¼Œå¼€å‘é›†æ ·æœ¬æœ€å¥½æ¥è‡ªçœŸå®åˆ†å¸ƒï¼Œå³å»çœŸå®çš„ç¯å¢ƒè¯´è¯è¿›è¡Œå½•éŸ³ã€‚</p><h2 id="é¢„æµ‹å’Œæ›´å¤šæ“ä½œ"><a href="#é¢„æµ‹å’Œæ›´å¤šæ“ä½œ" class="headerlink" title="é¢„æµ‹å’Œæ›´å¤šæ“ä½œ"></a>é¢„æµ‹å’Œæ›´å¤šæ“ä½œ</h2><p>æ¥ä¸‹æ¥å°±å¯ä»¥ç”¨è¿™ä¸ªè®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹äº†ï¼š</p><pre><code class="hljs plain">x &#x3D; graph_spectrogram(filename)x  &#x3D; x.swapaxes(0,1)x &#x3D; np.expand_dims(x, axis&#x3D;0)predictions &#x3D; model.predict(x)</code></pre><p>è¿˜å¯ä»¥åœ¨è§¦å‘çš„æ—¶å€™åšæ›´å¤šçš„æ“ä½œï¼š</p><pre><code class="hljs plain">consecutive_timesteps &#x3D; 0for i in range(Ty):        consecutive_timesteps +&#x3D; 1        if predictions[0,i,0] &gt; threshold:            # ä»»ä½•æ“ä½œ            whatever_you_wanna_do()</code></pre>]]></content>
    
    
    <categories>
      
      <category>æ·±åº¦å­¦ä¹ </category>
      
    </categories>
    
    
    <tags>
      
      <tag>coding</tag>
      
      <tag>RNN</tag>
      
      <tag>Trigger word</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æœºå™¨å­¦ä¹ ä¸­çš„å„ç§ä¼˜åŒ–å™¨ç®—æ³•</title>
    <link href="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/"/>
    <url>/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p>æ·±åº¦å­¦ä¹ ä¸­çš„ä¼˜åŒ–å™¨æœ‰å¾ˆå¤šç§ï¼Œé™¤äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„æ¢¯åº¦ä¸‹é™å¤–ï¼Œè¿˜æœ‰ä¸€äº›è¯¸å¦‚ RMSPropï¼Œadam ç­‰ä¼˜ç§€çš„ä¼˜åŒ–å™¨ã€‚æ¥äº†è§£ä¸€æ³¢~</p><h2 id="æ¢¯åº¦ä¸‹é™-GD-BGD-MBGD"><a href="#æ¢¯åº¦ä¸‹é™-GD-BGD-MBGD" class="headerlink" title="æ¢¯åº¦ä¸‹é™ GD,BGD,MBGD"></a>æ¢¯åº¦ä¸‹é™ GD,BGD,MBGD</h2><p>æ¢¯åº¦ä¸‹é™ï¼ˆGDï¼šgradient descentï¼‰å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œè¿™é‡Œä¹Ÿä¸åšè¯¦ç»†ä»‹ç»ã€‚æ•´ä½“å°±æ˜¯å…ˆåˆå§‹åŒ–æ±‚è§£å‚æ•°ï¼Œç„¶åé€šè¿‡æ±‚è§£æŸå¤±å‡½æ•°å¯¹æ±‚è§£å‚æ•°çš„å¯¼æ•°æ¥å¯¹æˆ‘ä»¬çš„æ±‚è§£å‚æ•°è¿›è¡Œæ›´æ–°ï¼Œç›´åˆ°æ”¶æ•›ã€‚ </p><p>æ¢¯åº¦ä¸‹é™åˆ†ä¸ºBGDï¼ˆbatchï¼šæ‰¹é‡æ¢¯åº¦ä¸‹é™ï¼‰ï¼ŒSGDï¼ˆstochasticï¼šéšæœºæ¢¯åº¦ä¸‹é™ï¼‰å’Œ MBGD(Mini-Batchï¼šå°æ‰¹é‡æ¢¯åº¦ä¸‹é™)ï¼ŒåŒºåˆ«åœ¨äºæ¯æ¬¡æ›´æ–°æ¢¯åº¦æ—¶ä½¿ç”¨çš„æ ·æœ¬çš„æ•°é‡ï¼Œåˆ†åˆ«ä¸ºå…¨éƒ¨æ ·æœ¬ï¼Œå•ä¸ªæ ·æœ¬å’Œä¸€éƒ¨åˆ†æ ·æœ¬ã€‚</p><p>æ¢¯åº¦ä¸‹é™æ‰¾åˆ°çš„æœ€ä¼˜è§£ä¸€èˆ¬ä¸ºå‡½æ•°çš„ä¸€ä¸ªéç‚¹ï¼Œå³å±€éƒ¨æœ€ä¼˜è§£ã€‚<br>MBGDå’ŒSGDå› ä¸ºæ ·æœ¬è¾ƒå°‘ï¼Œéšæœºæ€§å¤ªå¼ºï¼Œæ¢¯åº¦å¾€å¾€éœ‡è¡å¾ˆå¤§ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/GDvsMBGD.png" srcset="/img/loading.gif" class="" title="GDvsMBGD"><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨MBGDè¿›è¡Œä¼˜åŒ–æ—¶æˆ‘ä»¬å¯ä»¥å¯¹å­¦ä¹ ç‡è¿›è¡Œè¡°å‡æ¥ä½¿ä¹‹æ”¶æ•›ã€‚</p><p>PS:å› ä¸ºè®¡ç®—æœºæœ¬èº«çš„ä¸€äº›æ€§è´¨ï¼Œå°†æ‰¹æ¬¡é‡è®¾ç½®ä¸º2çš„å¹‚æ•°è®¡ç®—ä¼šæ›´å¿«ã€‚</p><p>å½“ç„¶ï¼Œè¿˜æœ‰æ¯”å°æ‰¹æ¬¡ä¸‹é™æ›´å¿«çš„ç®—æ³•ã€‚ä½†åœ¨å­¦ä¹ å®ƒä»¬ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£æŒ‡æ•°åŠ æƒå¹³å‡ã€‚</p><h2 id="æŒ‡æ•°åŠ æƒå¹³å‡"><a href="#æŒ‡æ•°åŠ æƒå¹³å‡" class="headerlink" title="æŒ‡æ•°åŠ æƒå¹³å‡"></a>æŒ‡æ•°åŠ æƒå¹³å‡</h2><p>ä»€ä¹ˆæ˜¯æŒ‡æ•°åŠ æƒå¹³å‡ï¼Ÿ</p><p>å‚è€ƒå´æ©è¾¾è€å¸ˆå¯¹æ­¤çš„è®²è§£ï¼Œç”¨ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œè¯´æ˜ï¼š</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/LondonTempreture.png" srcset="/img/loading.gif" class="" title="LondonTempreture"><p>ä¸Šå›¾æ˜¯ä¼¦æ•¦ä¸€å¹´ä¹‹ä¸­æ¯å¤©çš„æ¸©åº¦æƒ…å†µï¼Œæˆ‘ä»¬æ¥å¯¹å®ƒåšä¸€äº›å¤„ç†ï¼ŒæŠŠæ¯å¤©çš„æ¸©åº¦å€¼è®°ä½œVnã€‚åˆ™ï¼š<br>V0=0ï¼Œ V1 = 0.9*V0 + 0.1*Î¸1ï¼Œ V2=0.9V1 + 0.1*Î¸2ï¼Œâ€¦<br>Î¸ä¸ºä¸Šå›¾ä¸­å½“å¤©çœŸå®çš„æ¸©åº¦å€¼ï¼Œè¿™ä¸ª0.9æˆ‘ä»¬è®°ä½œÎ²ï¼Œé‚£ä¹ˆå…¬å¼è®°ä¸ºï¼š</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/formulaVt.png" srcset="/img/loading.gif" class="" title="formulaVt"><p>ç¨å¾®è¿›è¡Œä¸€ä¸‹è”æƒ³ï¼Œè¿™ä¸ªVå¯ä»¥è¿‘ä¼¼çœ‹åšæ˜¯ä¹‹å‰1/(1-Î²)å¤©çš„å¹³å‡å€¼ï¼Œå½“æˆ‘ä»¬åˆ†åˆ«å–Î²=0.9(çº¢è‰²æ›²çº¿)å’Œ0.98(ç»¿è‰²æ›²çº¿)æ—¶ï¼Œå›¾åƒä¸ºï¼š</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/TempretureHandled.png" srcset="/img/loading.gif" class="" title="TempretureHandled"><p>Î²å–0.9ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªå¼å­å±•å¼€ï¼š</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/UnfoldFormulaV.png" srcset="/img/loading.gif" class="" title="UnfoldFormulaV"><p>Î¸éšç€æ—¶é—´æ¨åæ˜¯Î²çš„æŒ‡æ•°çº§è¡°å‡ï¼Œä¸”ä¸€èˆ¬æ¥è¯´ï¼ŒæŒ‡æ•°åŠ æƒçš„è¡°å‡å¤§çº¦ä¼šåœ¨1/(1-Î²)åè¡°å‡åˆ°å¤§çº¦ä¸‰åˆ†ä¹‹ä¸€çš„ç¨‹åº¦ï¼Œæ¯”å¦‚0.9çš„1/(1-0.9)æ¬¡æ–¹çº¦ç­‰äº0.35ï¼Œæ‰€ä»¥æˆ‘ä»¬è¯´å®ƒå¤§çº¦æ˜¯æœ€è¿‘10å¤©çš„å¹³å‡å€¼ã€‚è¿™å°±æ˜¯æŒ‡æ•°åŠ æƒå¹³å‡åç§°çš„ç”±æ¥ã€‚</p><p>æŒ‡æ•°åŠ æƒå¹³å‡å‡å°‘äº†å­˜å‚¨ç©ºé—´çš„ä½¿ç”¨ï¼Œå½“æˆ‘ä»¬éœ€è¦æŸä¸ªVçš„å€¼æ—¶ï¼Œåªéœ€è¦é€šè¿‡è®¡ç®—å³å¯è·å¾—ï¼Œå› æ­¤å®ƒåœ¨æœºå™¨å­¦ä¹ ä¸­å¾—åˆ°äº†å¤§é‡çš„åº”ç”¨ã€‚</p><p>ç»†å¿ƒçš„ä½ å¯èƒ½æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬çš„V0å–å€¼ä¸º0ï¼Œè¿™ä¼šåœ¨è®¡ç®—åˆæœŸçš„æ—¶å€™äº§ç”Ÿè¾ƒå¤§çš„è¯¯å·®å€¼ã€‚<br>å› æ­¤åœ¨å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå¯¹Vçš„å€¼è¿›è¡Œ<strong><em>åå·®ä¿®æ­£</em></strong>ã€‚<br>ä½¿ Vt = Vt/(1-Î²^t)  ï¼Œä»è€Œå¯¹Vtè¿›è¡Œæ”¾å¤§ï¼Œè€Œéšç€tçš„å¢å¤§ï¼Œæ”¾å¤§ç‡ä¼šé€æ¸è¶‹äº1ã€‚</p><p>æœ‰äº†è¿™ä¸ªåŸºç¡€ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»‹ç»ä¸€äº›å…¶å®ƒçš„ä¼˜åŒ–å™¨æ–¹æ³•ã€‚</p><h2 id="åŠ¨é‡æ¢¯åº¦ç®—æ³•ï¼ˆmomentumï¼‰"><a href="#åŠ¨é‡æ¢¯åº¦ç®—æ³•ï¼ˆmomentumï¼‰" class="headerlink" title="åŠ¨é‡æ¢¯åº¦ç®—æ³•ï¼ˆmomentumï¼‰"></a>åŠ¨é‡æ¢¯åº¦ç®—æ³•ï¼ˆmomentumï¼‰</h2><p>ç®—æ³•çš„ä¸»è¦æ€æƒ³å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠæˆ‘ä»¬åˆšæ‰å­¦ä¹ çš„æŒ‡æ•°åŠ æƒå¹³å‡ç”¨æ¥è®¡ç®—æ¢¯åº¦ï¼Œç„¶åç”¨è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦æ¥è¿›è¡Œå‚æ•°æ›´æ–°ã€‚<br>åœ¨ä¸Šé¢çš„æ¢¯åº¦ä¸‹é™ç®—æ³•ä¸­ï¼Œè€ƒè™‘å¤šç»´åº¦çš„æƒ…å†µï¼Œå¦‚ä¸‹ï¼š</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/momentumExample.png" srcset="/img/loading.gif" class="" title="momentumExample"><p>äºæ”¶æ•›æ¥è¯´ï¼Œç«–ç›´æ–¹å‘çš„éœ‡è¡æ˜¾ç„¶æ˜¯æ— ç›Šçš„ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå‡å°ç«–ç›´æ–¹å‘çš„éœ‡è¡ã€‚</p><p>åŠ¨é‡æ¢¯åº¦ä¸‹é™çš„æ­¥éª¤å¦‚ä¸‹<br>ç¬¬tæ¬¡è¿­ä»£ï¼š</p><ol><li>ç”¨å½“å‰å°æ‰¹é‡æ ·æœ¬ è®¡ç®— å‚æ•°Wå’Œ åå·®bçš„å¯¼æ•°</li><li>Vdw = Î²Vdw + (1-Î²)dwï¼Œ Vdb = Î²Vdb + (1-Î²)db</li><li>W := W - Î±Vdw,   b := b-Î±Vdb </li></ol><p>end<br>æˆ‘ä»¬è¿˜æ˜¯å¯¹æ‰¹æ¬¡æ•°é‡è¿›è¡Œè¿­ä»£ï¼Œæ•´ä¸ªç®—æ³•ä¸­ä¸­æœ‰2ä¸ªè¶…å‚æ•°ï¼ŒÎ±å’ŒÎ²ï¼ŒÎ±ä¸ºå­¦ä¹ ç‡ï¼ŒÎ²æ˜¯æˆ‘ä»¬ä¸Šé¢å­¦ä¹ åˆ°çš„æŒ‡æ•°åŠ æƒã€‚</p><p>ä¸ºä»€ä¹ˆå’‹è¿™ä¹ˆåšå¯ä»¥æœ‰æ•ˆå‘¢ï¼Ÿå› ä¸ºæŒ‡æ•°åŠ æƒå¹³å‡çš„å¹³å‡ï¼Œå®ƒå°±è®©å‚ç›´æ–¹å‘ä¸Šç›¸åçš„éœ‡è¡è¢«å¹³å‡ä»è€Œå˜å°ï¼Œè€Œæ°´å¹³æ–¹å‘çš„éœ‡è¡æ–¹å‘æ˜¯ç›¸åŒçš„ï¼Œå¹³å‡å€¼ä¾ç„¶å¾ˆå¤§ï¼Œæ•…æ•´ä½“æ”¶æ•›é€Ÿåº¦å°±åŠ å¿«äº†ã€‚</p><p>PS:åŠ¨é‡æ¢¯åº¦ä¸‹é™æ—¶åŸºæœ¬ä¸ç”¨åå·®ä¿®æ­£ï¼ŒÎ²åŸºæœ¬éƒ½æ˜¯é€‰æ‹©0.9ã€‚</p><h2 id="RMSprop"><a href="#RMSprop" class="headerlink" title="RMSprop"></a>RMSprop</h2><p>RMSpropå…¨ç§°ä¸ºå‡æ–¹æ ¹ä¼ é€’(Root Mean Square prop), å®ƒä¹Ÿå¯ä»¥åŠ é€Ÿæ¢¯åº¦ä¸‹é™ã€‚<br>è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/RMSPropStep.png" srcset="/img/loading.gif" class="" title="RMSPropStep"><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/RMSPropImg.png" srcset="/img/loading.gif" class="" title="RMSPropImg"><p>RMSpropä¸»è¦çš„æ€æƒ³æ˜¯ç¼©å°å¤§çš„éœ‡è¡ï¼ŒåŠ å¿«å°çš„éœ‡è¡ã€‚å¦‚ä¸Šå›¾ï¼Œå‚ç›´æ–¹å‘çš„éœ‡è¡å¾ˆå¤§ï¼Œè€Œæ°´å¹³æ–¹å‘å¾ˆå°ï¼ŒRMSpropå°±ä¼šç¼©å°å‚ç›´æ–¹å‘çš„éœ‡è¡ï¼ŒåŠ å¿«æ°´å¹³æ–¹å‘çš„é€Ÿåº¦ã€‚<br>åŸç†å¾ˆç®€å•ï¼Œå¦‚æœå‚ç›´æ–¹å‘çš„éœ‡è¡è¾ƒå¤§ï¼Œé‚£ä¹ˆSdbå°±ä¼šå¾ˆå¤§ï¼Œé‚£ä¹ˆä½œä¸ºé™¤æ•°ï¼Œæ›´æ–°é€Ÿåº¦å°±å‡æ…¢äº†ï¼Œç›¸åï¼Œæ°´å¹³æ–¹å‘è¾ƒæ…¢ï¼ŒSdwå°±è¾ƒå°ï¼ŒWçš„æ›´æ–°é€Ÿåº¦å°±åŠ å¿«äº†ã€‚<br>å½“ç„¶ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œå¹¶æ²¡æœ‰å‚ç›´æ°´å¹³è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬åŠ å¿«çš„æ˜¯æ…¢çš„ç»´åº¦ï¼Œå‡æ…¢çš„æ˜¯å¿«çš„ç»´åº¦ã€‚<br>è€Œä¸”ä¸ºäº†é˜²æ­¢é™¤0å‘ç”Ÿï¼Œé€šå¸¸åœ¨åˆ†æ¯ä¸Šæˆ‘ä»¬ä¼šåŠ ä¸€ä¸ªå¾ˆå°çš„EPSONï¼Œå¤§æ¦‚10e-8</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠRMSpropå’ŒåŠ¨é‡ç»“åˆèµ·æ¥ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ›´å¥½çš„ä¼˜åŒ–ç®—æ³•ã€‚<br>ä¸ºäº†é˜²æ­¢å†²çªï¼ŒRMSpropä¸­çš„Î²ï¼Œæˆ‘ä»¬ç”¨Î²_2è¡¨ç¤º</p><h2 id="Adam"><a href="#Adam" class="headerlink" title="Adam"></a>Adam</h2><p>adaptive moment estimation è‡ªé€‚åº”çŸ©ä¼°è®¡<br>adamä¼˜åŒ–ç®—æ³•å®é™…ä¸Šå°±æ˜¯å°†RMSpropå’ŒåŠ¨é‡æ¢¯åº¦ä¸‹é™ç»“åˆèµ·æ¥çš„ç®—æ³•ã€‚<br>åœ¨æœºå™¨å­¦ä¹ é¢†åŸŸå’Œæ·±åº¦å­¦ä¹ é¢†åŸŸä¸­ï¼Œæ›¾ç»æå‡ºäº†éå¸¸å¤šçš„ä¼˜åŒ–ç®—æ³•ï¼Œä½†å¤§å¤šæ•°ç®—æ³•éƒ½ä¸èƒ½å¾ˆå¥½çš„é€‚åº”äºä¸åŒçš„ç½‘ç»œç»“æ„ï¼Œadamç®—æ³•æ˜¯å°‘æœ‰çš„åœ¨éå¸¸å¤šç½‘ç»œç»“æ„ä¸­éƒ½èƒ½å¤Ÿäº§ç”Ÿéå¸¸å¥½æ•ˆæœçš„ç®—æ³•ã€‚</p><p>åœ¨æœºå™¨å­¦ä¹ é¢†åŸŸå’Œæ·±åº¦å­¦ä¹ é¢†åŸŸä¸­ï¼Œæ›¾ç»æå‡ºäº†éå¸¸å¤šçš„ä¼˜åŒ–ç®—æ³•ï¼Œæ¯”å¦‚Adagrad,Adadeltaç­‰ï¼Œä½†å¤§å¤šæ•°ç®—æ³•éƒ½ä¸èƒ½å¾ˆå¥½çš„é€‚åº”äºä¸åŒçš„ç½‘ç»œç»“æ„ï¼Œadamç®—æ³•æ˜¯å°‘æœ‰çš„åœ¨éå¸¸å¤šç½‘ç»œç»“æ„ä¸­éƒ½èƒ½å¤Ÿäº§ç”Ÿéå¸¸å¥½æ•ˆæœçš„ç®—æ³•ã€‚</p><p>åˆå§‹åŒ–Vdwï¼ŒSdw,  Vdb, Sdbä¸º0</p><img src="/2020/04/16/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%AD%E7%9A%84%E5%90%84%E7%A7%8D%E4%BC%98%E5%8C%96%E5%99%A8%E7%AE%97%E6%B3%95/AdamStep.png" srcset="/img/loading.gif" class="" title="AdamStep"><p>lä¸ºç½‘ç»œå±‚æ•°ï¼Œä¸¤ä¸ªÎ²åˆ†åˆ«æ˜¯åŠ¨é‡æ¢¯åº¦å’ŒRMSpropä¸­çš„åŠ æƒï¼ŒÎ±ä¸ºå­¦ä¹ ç‡ï¼ŒåŒæ ·ï¼Œä¸ºäº†é˜²æ­¢é™¤0å‘ç”Ÿï¼Œé€šå¸¸åœ¨åˆ†æ¯ä¸Šæˆ‘ä»¬ä¼šåŠ ä¸€ä¸ªå¾ˆå°çš„EPSONï¼Œå¤§æ¦‚10e-8ï¼ˆä¸Šå›¾æ²¡åŠ ï¼‰ã€‚</p><p>å‡ ä¸ªè¶…å‚æ•°ï¼Œä¸€èˆ¬Î²1é€‰æ‹©0.9ï¼ŒÎ²2é€‰æ‹©0.999ï¼ŒEPSONé€‰æ‹©10e-8ã€‚<br>è€ŒÎ±ï¼Œä¸€ä¸ªå¥½çš„æ–¹æ³•å°±æ˜¯é€æ¸å‡å°å­¦ä¹ é€Ÿç‡ï¼Œä½¿ç”¨ä¸€ä¸ªè¡°å‡ç‡æ¥å¯¹å­¦ä¹ ç‡è¿›è¡Œè¡°å‡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ·±åº¦å­¦ä¹ </category>
      
      <category>åŸºç¡€ç®—æ³•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åŸºç¡€</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BERTç¬”è®°-ç®€ä»‹</title>
    <link href="/2020/04/03/BERT%E7%AC%94%E8%AE%B0-%E7%AE%80%E4%BB%8B/"/>
    <url>/2020/04/03/BERT%E7%AC%94%E8%AE%B0-%E7%AE%80%E4%BB%8B/</url>
    
    <content type="html"><![CDATA[<p>BERTï¼Œå…¨å Bidirectional Encoder Representation from Transformersã€‚æ˜¯Google AIå›¢é˜Ÿåœ¨2018å¹´æ¨å‡ºçš„ä¸€ä¸ªNLPæ¨¡å‹ï¼Œåœ¨æœºå™¨é˜…è¯»ç†è§£é¡¶çº§æ°´å¹³æµ‹è¯•SQuAD1.1ä¸Šå…¨é¢è¶…è¶Šäººç±»è¡¨ç°ï¼Œå¹¶åœ¨11é¡¹NLPæµ‹è¯•ä¸­æ‹¿åˆ°æœ€ä½³æˆç»©ã€‚è¿™ä¹Ÿå¯¼è‡´BERTçš„å¤§ç«ã€‚</p><p>BERTçš„å‡ºç°å½»åº•æ”¹å˜äº†pre-trainäº§ç”Ÿè¯å‘é‡å’Œä¸‹æ¸¸NLPè®­ç»ƒä»»åŠ¡é—´çš„å…³ç³»ã€‚</p><p>//todo ç•™å‘</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Transformeræ¨¡å‹ç®€ä»‹(ç¬”è®°)</title>
    <link href="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/"/>
    <url>/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>Transformeræ¥è‡ªGoogle 2017å¹´çš„ä¸€ç¯‡æ–‡ç« ï¼Œåœ¨åŸæ¥çš„Attention&amp;RNNæ¨¡å‹ä¸ŠæŠ›å¼ƒäº†RNNï¼Œç”¨å…¨attentionçš„ç»“æ„å–å¾—äº†æ›´å¥½çš„æ•ˆæœã€‚<br>è¿™é‡Œåšä¸€åšè‡ªå·±å­¦ä¹ çš„ç¬”è®°ï¼Œä¹Ÿç®—ä¸€ä¸ªç®€å•çš„ä»‹ç»ã€‚<br>å†…å®¹å›¾ç‰‡å¾ˆå¤šæ¥è‡ªäºåŸè®ºæ–‡<a href="https://arxiv.org/pdf/1706.03762.pdf" target="_blank" rel="noopener">Attention Is All You Need</a>å’Œ<a href="https://jalammar.github.io/illustrated-transformer/" target="_blank" rel="noopener">The Illustrated Transformer</a>è¿™ç¯‡æ–‡ç« ã€‚</p><h2 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h2><p>åŸè®ºæ–‡ç»™å‡ºçš„ç»“æ„å¦‚ä¸‹ï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/structureOfTransformer.png" srcset="/img/loading.gif" class="" title="transformerç»“æ„"><p>å¯ä»¥çœ‹åˆ°ç”±å·¦å³ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå·¦è¾¹çš„Encoderså’Œå³è¾¹çš„Decodersç»„æˆã€‚ä¸¤è¾¹éƒ½æœ‰ä¸€ä¸ªâ€NÃ—â€,è¡¨ç¤ºå„è‡ªç”±Nä¸ªåŒæ ·çš„ç»“æ„é‡å¤Næ¬¡ç»„æˆï¼ŒåŸæ–‡ä¸­æ˜¯6ã€‚å°±æ˜¯ä¸‹é¢å›¾ä¸­çš„æ ·å­ã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/encodersAndDecoders.png" srcset="/img/loading.gif" class="" title="å±•å¼€"><h2 id="encoder"><a href="#encoder" class="headerlink" title="encoder"></a>encoder</h2><p>æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹Encoderéƒ¨åˆ†ã€‚</p><p>å› ä¸ºæ˜¯NLPçš„æ¡ˆä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦æŠŠæˆ‘ä»¬çš„è¾“å…¥æ•°æ®ï¼Œå³è¯å˜æˆè¯å‘é‡ï¼Œè¿™é€šè¿‡embeddingå®ç°ï¼Œembeddingåçš„æ•°æ®ä½œä¸ºEncoderçš„è¾“å…¥ã€‚<br>è™½ç„¶æœ‰å¾ˆå¤šencoderï¼Œä½†embeddingåªç”¨åœ¨æœ€ä¸‹é¢ä¸€å±‚çš„encoderä¸Šï¼Œå…¶å®ƒçš„encoderéƒ½æ˜¯ç”¨ä¸Šä¸€å±‚encoderçš„è¾“å‡ºä½œä¸ºè¾“å…¥ã€‚</p><p>æ¯ä¸ªencoderéƒ½æ˜¯ä¸€æ ·çš„ç»“æ„ï¼Œéƒ½ç”±ä¸¤ä¸ªå­ç»“æ„ç»„æˆï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/EachEncoder.png" srcset="/img/loading.gif" class="" title="encoderç»„æˆ"><p>self-attentionçš„ä½œç”¨æ˜¯ï¼Œå½“ä½ åœ¨å¤„ç†æŸä¸ªå…·ä½“çš„è¯æ—¶ï¼Œself-attentionå…è®¸ä½ ä»å¥å­ä¸­çš„å…¶å®ƒä½ç½®å¤„å¯»æ‰¾çº¿ç´¢ï¼Œä»è€Œå¯¹å½“å‰è¯çš„ç†è§£å’Œé¢„æµ‹èµ·åˆ°å¸®åŠ©ã€‚</p><h3 id="self-attention-ç»†èŠ‚"><a href="#self-attention-ç»†èŠ‚" class="headerlink" title="self-attention ç»†èŠ‚"></a>self-attention ç»†èŠ‚</h3><p>è®¡ç®—self-attentionä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤</p><p><strong>ç¬¬ä¸€æ­¥</strong><br>è®¡ç®—self-attentionçš„ç¬¬ä¸€æ­¥æ˜¯ä»æ¯ä¸ªè¾“å…¥å‘é‡ä¸­åˆ›å»ºå‡º3ä¸ªå‘é‡(Querry,Key,Value)ã€‚ä»–ä»¬é€šè¿‡æŠŠembeddingåˆ†åˆ«ä¸ä¸‰ä¸ªçŸ©é˜µç›¸ä¹˜å¾—åˆ°ï¼Œä¸‰ä¸ªçŸ©é˜µé€šè¿‡è®­ç»ƒè¿‡ç¨‹å¾—åˆ°ã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/transformerSelfAttentionVectors.png" srcset="/img/loading.gif" class="" title="QSV"><p>Q,S,Vè¾ƒä¹‹embeddingçš„ç»´åº¦è¦å°ï¼Œåœ¨æ–‡ä¸­çš„ç»´åº¦æ˜¯64ï¼Œè€Œembeddingçš„ç»´åº¦æ˜¯512ã€‚ä¸å¿…å®Œå…¨ä¸€æ ·ï¼Œä½†è¿™æ˜¯ä¸€ç§ä½¿å¾—è®¡ç®—æ¯”è¾ƒç¨³å®šçš„ç»“æ„é€‰æ‹©ã€‚</p><ul><li>Q = WQ * x</li><li>K = WK * x</li><li>V = WV * x</li></ul><p><strong>ç¬¬äºŒæ­¥</strong><br>è®¡ç®—self-attentionçš„ç¬¬äºŒæ­¥æ˜¯è®¡ç®—ä¸€ä¸ªscoreã€‚ å‡è®¾æˆ‘ä»¬æ­£åœ¨è®¡ç®—çš„å¥å­çš„ç¬¬ä¸€ä¸ªå•è¯ä¸ºâ€Thinkingâ€ã€‚æˆ‘ä»¬éœ€è¦æŠŠè¾“å…¥çš„å¥å­ä¸­çš„æ¯ä¸€ä¸ªè¯ä¸è¿™ä¸ªè¯è¿ç®—æ¥å¾—åˆ°ä¸€ä¸ªscoreï¼Œè¿™ä¸ªscoreå†³å®šäº†æˆ‘ä»¬åœ¨encodeå½“å‰è¯çš„æ—¶å€™å¥å­å…¶å®ƒä½ç½®æ‰€æ–½åŠ çš„å½±å“ã€‚</p><p>è®¡ç®—æ–¹æ³•æ˜¯æŠŠå½“å‰æ¬¡çš„Qä¸è¦è®¡ç®—çš„è¯çš„Kå€¼è¿›è¡Œç‚¹ä¹˜ã€‚å³å¦‚æœæˆ‘ä»¬è¦è®¡ç®—#1ä½ç½®å¤„çš„self-attentionï¼Œç¬¬ä¸€ä¸ªæˆ‘ä»¬è¦è®¡ç®—çš„scoreå°†æ˜¯æŠŠq1å’Œk1ç‚¹ä¹˜ï¼Œç¬¬äºŒä¸ªsocreåˆ™æ˜¯æŠŠq1å’Œk2è¿›è¡Œç‚¹ä¹˜ã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/SelfAttentionScore.png" srcset="/img/loading.gif" class="" title="è®¡ç®—score"><p><strong>ç¬¬ä¸‰æ­¥å’Œç¬¬å››æ­¥</strong><br>ç¬¬ä¸‰æ­¥å’Œç¬¬å››æ­¥æ˜¯å°†å¾—åˆ°çš„scoreé™¤ä»¥8ï¼Œè¿™ä¸ª8æ˜¯QKVå‘é‡çš„ç»´åº¦64çš„å¹³æ–¹æ ¹ã€‚è¿™å¯ä»¥è®©æ¢¯åº¦æ›´åŠ ç¨³å®š(ç›´æ¥å½’ä¸€å€¼å·®è·è¾ƒå¤§)ã€‚å½“ç„¶å¯ä»¥ä¸æ˜¯8ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªé»˜è®¤å€¼ã€‚æ¥ç€å°†ç»“æœä¼ é€’ç»™ä¸€ä¸ªsoftmaxæ“ä½œï¼Œè¿™å°†æŠŠsocreçš„å€¼æ ‡å‡†åŒ–ï¼Œä½¿å®ƒä»¬éƒ½ä¸ºæ­£ï¼Œä¸”å’Œä¸º1ã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/selfAttentionSoftmax.png" srcset="/img/loading.gif" class="" title="è®¡ç®—æƒé‡"><p><strong>ç¬¬äº”æ­¥</strong><br>ç¬¬äº”æ­¥æ˜¯å°†æ¯ä¸ªVä¸ç¬¬å››æ­¥çš„ç»“æœç›¸ä¹˜ã€‚è¿™ä¸€æ­¥ä»ç›´è§‰ä¸Šè®²æ˜¯ä¿ç•™å½“å‰è¯æƒ³è¦å…³æ³¨çš„å…¶å®ƒè¯è¯­çš„å®Œæ•´æ€§ï¼ŒåŒæ—¶ä¸¢æ‰ä¸ç›¸å…³çš„è¯è¯­(é€šè¿‡ä¹˜ä»¥äº†éå¸¸å°çš„æ•°)ã€‚</p><p><strong>ç¬¬å…­æ­¥</strong><br>å°†å¾—åˆ°çš„å¸¦æƒé‡çš„æ•°æ®å‘é‡ç›¸åŠ ã€‚è¿™å°†å¾—åˆ°self-attentionå±‚åœ¨è¿™ä¸ªä½ç½®(æˆ‘ä»¬è¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ªè¯)çš„è¾“å‡ºã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/selfAttentionOutput.png" srcset="/img/loading.gif" class="" title="encoderè¾“å‡º"><p>è¿™å°±æ˜¯self-attentiondeçš„è®¡ç®—è¿‡ç¨‹ï¼Œç»“æœå‘é‡æˆ‘ä»¬å°†ä¼ é€’ç»™æ¥ä¸‹æ¥çš„ feed-forward nertal networkå¤„ç†ã€‚<br>å½“ç„¶ï¼Œåœ¨å®é™…å®ç°ä¸­ï¼Œè¿™äº›è®¡ç®—éƒ½å¯ä»¥é€šè¿‡çŸ©é˜µå½¢å¼çš„è®¡ç®—ä»è€Œæ›´åŠ å¿«é€Ÿã€‚</p><p><strong>self-attentionçš„çŸ©é˜µè®¡ç®—</strong><br>ä½¿ç”¨çŸ©é˜µï¼Œç¬¬äºŒæ­¥åˆ°ç¬¬å…­æ­¥å®é™…ä¸Šå¯ä»¥åœ¨ä¸€ä¸ªå…¬å¼å†…è¿›è¡Œè®¡ç®—ï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/selfAttentionMatrixCalculation.png" srcset="/img/loading.gif" class="" title="çŸ©é˜µè®¡ç®—å…¬å¼"><h3 id="multi-headed"><a href="#multi-headed" class="headerlink" title="multi-headed"></a>multi-headed</h3><p>æ–‡ç« è¿›ä¸€æ­¥ç”¨ä¸€ä¸ªå«åšâ€multi-headedâ€ attentionçš„ç»“æ„å¢å¼ºäº†self-attentionã€‚å®ƒä»2ä¸ªæ–¹é¢æå‡äº†attentionå±‚çš„è¡¨ç°ï¼š<br><strong>æ‰©å¼ äº†æ¨¡å‹å…³æ³¨å…¶ä»–ä½ç½®çš„èƒ½åŠ›</strong><br>åœ¨æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯¹thinkingçš„ç¼–ç å°±åŒ…å«äº†å¥ä¸­å…¶å®ƒä½ç½®è¯çš„å½±å“(å½“ç„¶ï¼Œæœ€å¤§çš„å½±å“ä¾ç„¶æ˜¯å®ƒè‡ªå·±)ã€‚åœ¨è§£æä¸€äº›æœ‰æ˜æ˜¾æŒ‡å‘æ€§çš„ä»£è¯æ—¶å°±æ˜¾å¾—éå¸¸æœ‰ç”¨ã€‚æ¯”å¦‚â€œThe animal didnâ€™t cross the street because it was too tiredâ€ä¸­çš„â€itâ€æŒ‡ä»£çš„è°ã€‚<br><strong>ç»™äº†attentionå±‚å¤šé‡â€è¡¨è¿°å­ç©ºé—´â€</strong><br>è¿™ä¸»è¦é€šè¿‡å¤šç»„[WQ,WK,QV]æ¥å®ç°ï¼Œæ–‡ä¸­ä½¿ç”¨äº†8ç»„WQ,WK,QVï¼Œè¿™äº›çŸ©é˜µéƒ½é€šè¿‡éšæœºåˆå§‹åŒ–èµ‹å€¼ã€‚å³æ˜¯è¯´æˆ‘ä»¬ä¼šå¾—åˆ°8ç»„QKVï¼Œä»è€Œå¾—åˆ°8ä¸ªè¾“å‡ºçŸ©é˜µã€‚æ¯ä¸€ä¸ªéƒ½æ˜¯è¾“å…¥æ•°æ®çš„ä¸€ä¸ªè¡¨è¿°å­ç©ºé—´ã€‚</p><p>åœ¨ä¼ é€’ç»™feed-forward networkå‰ï¼Œæˆ‘ä»¬éœ€è¦å°†ä»–ä»¬å¤„ç†æˆä¸€ä¸ªçŸ©é˜µã€‚é€šè¿‡å°†è¿™8ä¸ªçŸ©é˜µå †å èµ·æ¥ï¼Œå†ä¸ä¸€ä¸ªæƒé‡çŸ©é˜µWOç›¸ä¹˜å¾—åˆ°ã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/transformer_attention_heads_weight_matrix_o.png" srcset="/img/loading.gif" class="" title="concatç»“æœ"><p>ä»¥ä¸Šå¤§æ¦‚å°±æ˜¯ multi-headed self-attention çš„å†…å®¹ã€‚åŸæ–‡å°†ä»–ä»¬æ”¾åˆ°ä¸€å¼ å›¾ä¸Šï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/encoderTotalLook.png" srcset="/img/loading.gif" class="" title="æ•´ä½“é€ å‹"><h3 id="position-encoding"><a href="#position-encoding" class="headerlink" title="position encoding"></a>position encoding</h3><p>å› ä¸ºæ”¾å¼ƒäº†ä½¿ç”¨RNNï¼Œé‚£ä¹ˆå¥å­ä¸­è¯ä¸è¯çš„ä½ç½®å…³ç³»å°±è¢«å¿½ç•¥äº†ï¼Œæ–‡ä¸­ä½¿ç”¨äº†ä¸€ç§position encodingçš„æ–¹å¼å°†ä½ç½®ä¿¡æ¯è¡¥å…¥æ¨¡å‹ä¸­ã€‚<br>è¿™é€šè¿‡ç»™æ¯ä¸€ä¸ªinput embeddingåŠ ä¸Šä¸€ä¸ªvectoræ¥å®ç°ã€‚è¿™äº›vectoréµå¾ªä¸€ç§<strong><em>ç‰¹æ®Šçš„æ¨¡å¼</em></strong>ï¼Œå®ƒå­˜å‚¨äº†æ¯ä¸ªè¯çš„ä½ç½®ä¿¡æ¯ï¼Œé€šè¿‡æŠŠå®ƒä¸embeddingç›¸åŠ ï¼Œä»è€ŒæŠŠè¿™ç§ä¿¡æ¯ä»£å…¥åˆ°åé¢çš„QKVå’Œç‚¹ä¹˜çš„è®¡ç®—è¿‡ç¨‹ä¸­ã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/transformer_positional_encoding_vectors.png" srcset="/img/loading.gif" class="" title="ä½ç½®ç¼–ç "><p>å¦‚æœæˆ‘ä»¬çš„embeddingæ˜¯512ç»´çš„å‘é‡ï¼Œé‚£ä¹ˆè¦åŠ çš„positional encoding å‘é‡ä¹Ÿæ˜¯512ç»´ã€‚</p><p>å…³äºä½ç½®ç¼–ç ï¼Œæ–‡ä¸­ä½¿ç”¨çš„æ˜¯ä¸‰è§’å‡½æ•°çš„å½¢å¼ã€‚</p><p>å¤§æ¦‚è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯ä½ç½®ç¼–ç å’Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä¸‰è§’å‡½æ•°ã€‚<br>è¦å¯¹ä½ç½®è¿›è¡Œç¼–ç ï¼Œæœ€ç®€å•çš„æ–¹å¼è«è¿‡äºç›´æ¥ä½¿ç”¨å•è¯åœ¨æ–‡æœ¬ä¸­çš„ä½ç½®ï¼Œå³1ï¼Œ2ï¼Œ3ï¼Œâ€¦ï¼ŒNã€‚ä½†ç¼ºç‚¹è¿‡äºæ˜æ˜¾ï¼Œå¦‚æœæ–‡æœ¬è¾ƒé•¿ï¼Œé‚£ä¹ˆä½ç½®ç¼–ç çš„å¤§å°è·¨åº¦å°±å¤ªå¤§äº†ï¼Œå°†è¿™æ ·çš„æ•°æ®åŠ å…¥åˆ°æ¨¡å‹è®­ç»ƒä¸­ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ä¼šå–§å®¾å¤ºä¸»çš„æŠ¢å embeddingçš„é‡è¦æ€§ã€‚<br>åŒæ ·ï¼Œå°†åˆšæ‰çš„é¡ºåºé™¤ä»¥æ–‡æœ¬é•¿åº¦ä¹Ÿæ˜¯ä¸è¡Œçš„ï¼Œå¦‚1/N,2/N,3/N,â€¦1ã€‚<br>æˆ‘ä»¬éœ€è¦ä½ç½®ä¿¡æ¯ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„ä¿¡æ¯å°±æ˜¯ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼Œè€Œè¿™ç§å¤„ç†æ–¹å¼ï¼Œä¼šå¯¼è‡´ç›¸éš”åŒæ ·è·ç¦»çš„ä¸¤ä¸ªè¯ï¼Œåœ¨é•¿åº¦ä¸åŒçš„æ–‡æœ¬ä¸­å¾—åˆ°çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ä¸ä¸€è‡´ï¼Œç”šè‡³å·®è·è¾ƒå¤§ã€‚<br>æ€»ç»“ä¹‹åï¼Œé‚£ä¹ˆçœŸæ­£é€‚åˆç”¨æ¥åšä½ç½®ç¼–ç çš„å‡½æ•°ä¼¼ä¹å°±æ˜¯ è¿ç»­ä¸”æœ‰ç•Œçš„å‘¨æœŸæ€§å‡½æ•°ã€‚æœ‰ç•Œä¿è¯å€¼åŸŸä¸ä¼šå¤ªå¤§ï¼Œå‘¨æœŸæ€§ä¿è¯ä¸€å®šç¨‹åº¦ä¸Šç¼–ç çš„å·®å¼‚ä¼šæ‘†è„±æ–‡æœ¬é•¿åº¦çš„å½±å“ï¼Œè€Œè¿ç»­åˆ™ä¿è¯äº†ä¸¤ä¸ªæ¯”è¾ƒé è¿‘çš„è¯ä¸ä¼šå‡ºç°å·®è·å¾ˆå¤§çš„æƒ…å†µã€‚</p><p>äºæ˜¯æ–‡ä¸­ä½¿ç”¨äº†sinå’Œcoså‡½æ•°ï¼Œè¿ç»­è€Œä¸”å‘¨æœŸç¨³å®šï¼Œå€¼åŸŸ[-1,1]ã€‚</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/PosEncodingformula.png" srcset="/img/loading.gif" class="" title="ä½ç½®ç¼–ç å…¬å¼"><p>åŠ å…¥äº†dmodelå’Œiä¸¤ä¸ªå‚æ•°ï¼Œdmodelæ˜¯embeddingçš„ç»´åº¦ï¼Œåœ¨æ–‡ä¸­å°±æ˜¯512ï¼Œç”¨äºå¢å¤§ä½ç½®ç¼–ç çš„ç©ºé—´è¡¨ç°èŒƒå›´ã€‚iä¸ºå‘é‡çš„æŸä¸€ç»´åº¦ï¼Œdmodel=512ï¼Œé‚£ä¹ˆiå°±æ˜¯[0,255],è¿™æ ·åœ¨å¥‡å¶ç»´åº¦åˆ†åˆ«ä½¿ç”¨sinå’Œcosã€‚è¿™æ ·å°±ä»å–å€¼èŒƒå›´å’Œå–å€¼æ–¹æ³•ä¸¤ä¸ªæ–¹å‘ä¸Šå¢åŠ äº†å–å€¼çš„å¤šæ ·æ€§ã€‚è®©ä½ç½®ç¼–ç æ›´åŠ ç§‘å­¦ã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸ªå‡½æ•°ä½œè€…åº”è¯¥ä¹Ÿæ˜¯é€šè¿‡è‡ªèº«çš„ç»éªŒä¸ä¸æ–­çš„å®éªŒå¾—åˆ°çš„ã€‚</p><p>PSï¼šGOOGLE BERTä¸­ç”¨äº†æ–°çš„å–ä½ç½®ä¿¡æ¯çš„æ–¹æ³•ï¼Œposition embeddingï¼Œè¿™æ˜¯åè¯ã€‚</p><h3 id="æ®‹å·®ç½‘ç»œ-Residual-network-çš„ä½¿ç”¨"><a href="#æ®‹å·®ç½‘ç»œ-Residual-network-çš„ä½¿ç”¨" class="headerlink" title="æ®‹å·®ç½‘ç»œ(Residual network)çš„ä½¿ç”¨"></a>æ®‹å·®ç½‘ç»œ(Residual network)çš„ä½¿ç”¨</h3><p>å¦ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯å“ªé‡Œè·‘ä¸æ‰çš„resNetçš„ä½¿ç”¨ï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/resInEncoder.png" srcset="/img/loading.gif" class="" title="resNetçš„ä½¿ç”¨"><p>åŒæ ·ï¼Œåœ¨decoderä¸­ä¹Ÿä½¿ç”¨åˆ°äº†resNetï¼Œå¦‚æœæ˜¯ä¸€ä¸ª2ä¸ªencoderå’Œdecoderçš„transformerï¼Œå®ƒé•¿è¿™æ ·ï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/resInTransformer.png" srcset="/img/loading.gif" class="" title="resNetçš„ä½¿ç”¨2"><h2 id="Decoder"><a href="#Decoder" class="headerlink" title="Decoder"></a>Decoder</h2><p>ä»‹ç»å®ŒEncoderï¼Œå¤§å¤šæ•°Decoderé‡Œçš„ç»„ä»¶çš„ä½œç”¨ä¹Ÿæ˜æœ—äº†ã€‚æ¥ä¸‹æ¥çœ‹çœ‹ä»–å“¥ä¿©å¦‚ä½•ä¸€èµ·å·¥ä½œã€‚</p><p>å†è´´ä¸€ä¸‹æ¨¡å‹ç»“æ„å›¾ï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/structureOfTransformer.png" srcset="/img/loading.gif" class="" title="transformerç»“æ„"><p>å¯ä»¥çœ‹åˆ°Decoderä¸­æœ‰ä¸€ä¸ª Encoder-Decoder Attention å±‚ï¼Œå®ƒæ¥å—Encoderéƒ¨åˆ†æœ€åçš„è¾“å‡ºä½œä¸ºè®¡ç®—attentionçš„Keyå’ŒValueï¼Œæ¥å—å®ƒä¸‹é¢çš„self-attentionå±‚çš„è¾“å‡ºä½œä¸ºQueryã€‚</p><p>å…¶æ¬¡ï¼ŒDecoderéƒ¨åˆ†çš„self-attentionå±‚ä¹Ÿä¸Encoderä¸­çš„ä¸åŒï¼Œä¸åŒäºEncoderä¸­è®¡ç®—å•è¯ä¸¤ä¸¤é—´çš„attentionï¼ŒDecoderä¸­è®¡ç®—çš„æ˜¯å½“å‰å•è¯å’Œå®ƒå‰é¢çš„å•è¯çš„attentionï¼ŒåŒæ ·ï¼Œä¹Ÿè¦åŠ å…¥ä½ç½®ä¿¡æ¯ã€‚</p><p>æ–‡ç« ä¸­æœ‰å¼ éå¸¸å½¢è±¡çš„åŠ¨å›¾ï¼š</p><img src="/2020/04/02/Transformer%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B-%E7%AC%94%E8%AE%B0/transformerDecodingGif.gif" srcset="/img/loading.gif" class="" title="transformerç»“æ„"><p>æ³¨æ„åœ¨decoderä¸­åšself-attentionçš„æ—¶å€™ï¼Œå½“å‰è¾“å…¥åªåº”è¯¥çœ‹åˆ°å½“å‰æ—¶åˆ»ä»¥å‰çš„è¾“å‡ºï¼Œæ¯”å¦‚åœ¨è¾“å‡ºç¬¬äºŒä¸ªè¯çš„æ—¶å€™ï¼Œè¾“å…¥ä¸­æ˜¯ä¸åº”è¯¥å‡ºç°ç¬¬ä¸‰ä¸ªè¯çš„ä¿¡æ¯çš„ã€‚æ–‡ä¸­å¤„ç†è¿™ç§æƒ…å†µçš„æ–¹æ³•æ˜¯ç”¨äº†ä¸€ä¸ªå€’ä¸‰è§’çŸ©é˜µ(ç¬¬iè¡Œjåˆ—çš„å…ƒç´ è¡¨ç¤ºç¬¬iä¸ªè¾“å…¥å’Œç¬¬jä¸ªè¾“å…¥çš„attention)ï¼Œå°†å¯¹è§’çº¿å³ä¾§å…ƒç´ å…¨éƒ¨è®¾ç½®ä¸ºè´Ÿæ— ç©·ï¼Œè¿™æ ·å°±é˜²æ­¢äº†æ¨¡å‹çœ‹åˆ°æœªæ¥çš„ä¿¡æ¯ã€‚</p><h2 id="æœ€åä¸€å±‚"><a href="#æœ€åä¸€å±‚" class="headerlink" title="æœ€åä¸€å±‚"></a>æœ€åä¸€å±‚</h2><p>decoderå°†è¾“å‡ºä¸€å †floatsç»„æˆçš„å‘é‡ï¼Œå°†å®ƒè½¬æ¢æˆè¯è¯­ï¼Œå°±æ˜¯æœ€åä¸€å±‚çš„å·¥ä½œ(é€šå¸¸æ˜¯ä¸€ä¸ªLinear+Softmax)ã€‚</p><p>Linear layeræ˜¯ä¸€ä¸ªç®€å•çš„å…¨è¿æ¥å±‚ï¼Œå°†decoderçš„è¾“å‡ºæŠ•å°„ä¸ºä¸€ä¸ªæ¯”åŸæ¥å¤§å¾ˆå¤šçš„å‘é‡ï¼Œå«åšlogits vectorã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„è¯ç©ºé—´æœ‰10000ä¸ªå•è¯ï¼Œé‚£ä¹ˆ10000å°±æ˜¯è¿™ä¸ªlogits vectorçš„ç»´åº¦ï¼Œå‘é‡ä¸­æ¯ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªå…·ä½“çš„è¯ã€‚æ¥ä¸‹æ¥ä½ å°±æ¸…æ¥šäº†ï¼Œsoftmaxçš„ä½œç”¨æ˜¯å°†è¿™ä¸ªlogits vectorçš„ç»“æœå˜æˆæ¦‚ç‡ï¼Œæ¦‚ç‡æœ€é«˜çš„å…ƒç´ å¯¹åº”çš„è¯å°±æ˜¯æˆ‘ä»¬çš„è¾“å‡ºã€‚</p><h2 id="å…³äºè®­ç»ƒ"><a href="#å…³äºè®­ç»ƒ" class="headerlink" title="å…³äºè®­ç»ƒ"></a>å…³äºè®­ç»ƒ</h2><p>todoâ€¦</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>todoâ€¦</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://jalammar.github.io/illustrated-transformer/" target="_blank" rel="noopener">The Illustrated Transformer</a><br><a href="https://arxiv.org/pdf/1706.03762.pdf" target="_blank" rel="noopener">Attention Is All You Need</a><br><a href="http://nlp.seas.harvard.edu/2018/04/03/attention.html" target="_blank" rel="noopener">å“ˆä½›å¤§å­¦çš„pytorchç‰ˆæœ¬æºç </a></p>]]></content>
    
    
    <categories>
      
      <category>æ·±åº¦å­¦ä¹ </category>
      
      <category>NLP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Model</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®ç°ä¸€ä¸ªç®€å•çš„äººè„¸è¯†åˆ«ç³»ç»Ÿ</title>
    <link href="/2020/03/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/"/>
    <url>/2020/03/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/</url>
    
    <content type="html"><![CDATA[<p>ä¸‹è¿°çš„å¤§å¤šæ•°æ–¹æ³•æ¥è‡ª <strong><em><a href="https://arxiv.org/pdf/1503.03832.pdf" target="_blank" rel="noopener">FaceNet</a></em></strong>,ä¹Ÿå«åš<strong><em>DeepFace</em></strong>.</p><h2 id="è„¸éƒ¨è¯†åˆ«"><a href="#è„¸éƒ¨è¯†åˆ«" class="headerlink" title="è„¸éƒ¨è¯†åˆ«"></a>è„¸éƒ¨è¯†åˆ«</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œè„¸éƒ¨è¯†åˆ«é—®é¢˜å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>è„¸éƒ¨éªŒè¯(Face Verification)ï¼šâ€è¿™æ˜¯æŸä¸ªäººå—ï¼Ÿâ€ é€šè¿‡æä¾›çš„è¾“å…¥çš„æ•°æ®æ¥è¯†åˆ«æ˜¯å¦æ˜¯æŸä¸ªç¡®å®šçš„äººã€‚æ¯”å¦‚æœºåœºç³»ç»Ÿæ‰«æä½ çš„æŠ¤ç…§æ¥ç¡®è®¤ä½ æ˜¯å¦æ˜¯æ­£ç¡®çš„æŒæœ‰äººï¼Œæ¯”å¦‚ç§»åŠ¨æ‰‹æœºé€šè¿‡è¯†åˆ«ä½ çš„è„¸éƒ¨ç¡®è®¤ä½ æ˜¯æ‹¥æœ‰è€…ä»è€Œè§£é”ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª1å¯¹1åŒ¹é…çš„é—®é¢˜ã€‚</li><li>è„¸éƒ¨è¯†åˆ«(Face Recognition)ï¼šâ€è¿™æ˜¯è°ï¼Ÿâ€ é€šè¿‡æä¾›çš„è¾“å…¥è¯†åˆ«æ¥è¯†åˆ«å¯¹åº”çš„äººæ˜¯è°ã€‚æ¯”å¦‚å…¬å¸çš„è„¸éƒ¨è¯†åˆ«æ‰“å¡ï¼Œé€šè¿‡è¯†åˆ«è„¸éƒ¨ç›´æ¥å®Œæˆå¯¹åº”äººå‘˜çš„æ‰“å¡ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ª1å¯¹Kçš„åŒ¹é…é—®é¢˜ã€‚</li></ul><p>FaceNet é€šè¿‡ä¸€ä¸ªç¥ç»ç½‘ç»œå…ˆå°†è¾“å…¥çš„è„¸éƒ¨ç…§ç‰‡è§£ç ä¸ºä¸€ä¸ª128ç»´å‘é‡ï¼Œé€šè¿‡æ¯”è¾ƒ2ä¸ªè¿™æ ·çš„å‘é‡ï¼Œä»è€Œåˆ¤æ–­è¿™ä¸¤å¼ å›¾ç‰‡æ˜¯å¦æ˜¯ä¸€ä¸ªäººã€‚å°†è¾“å…¥æ•°æ®ä¸æ•°æ®åº“ä¸­æ‰€æœ‰äººå‘˜çš„ç…§ç‰‡è¿›è¡Œå¯¹æ¯”ï¼Œä»è€Œæ‰¾åˆ°â€è¿™æ˜¯è°â€ã€‚</p><p>æˆ‘ä»¬å°†ç”¨TensorFlowæ¥å®ç°è¿™ä¸ªç¨‹åºï¼š(tensorflow 1.X)</p><ul><li>1.å®ç°ä¸‰å…ƒæŸå¤±å‡½æ•°</li><li>2.ç”¨ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹æ¥å°†è„¸éƒ¨å›¾ç‰‡è§£ç ä¸º128ç»´çš„å‘é‡</li><li>3.ä½¿ç”¨è¿™äº›ä»£ç æ¥è¿›è¡Œè„¸éƒ¨éªŒè¯å’Œè„¸éƒ¨è¯†åˆ«</li></ul><p>å¦å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨é€šé“ä¼˜å…ˆ(channels-first)ã€‚ ä¹Ÿå°±æ˜¯è¯´å¯¹äºè¾“å…¥æ•°æ®çš„ç»´åº¦è¡¨ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨(m,nC,nH,nW), è€Œä¸æ˜¯(m,nH,nW,nC)ã€‚å½“ç„¶ï¼Œchannels-first å’Œ channels-lastéƒ½æœ‰å„è‡ªçš„ç†ç”±ï¼Œè‡³ä»Šç¤¾åŒºä¹Ÿæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†ã€‚</p><h3 id="å¯¼å…¥åŒ…"><a href="#å¯¼å…¥åŒ…" class="headerlink" title="å¯¼å…¥åŒ…"></a>å¯¼å…¥åŒ…</h3><p>å…ˆå¯¼å…¥åŒ…</p><pre><code class="hljs plain">from keras.models import Sequentialfrom keras.layers import Conv2D, ZeroPadding2D, Activation, Input, concatenatefrom keras.models import Modelfrom keras.layers.normalization import BatchNormalizationfrom keras.layers.pooling import MaxPooling2D, AveragePooling2Dfrom keras.layers.merge import Concatenatefrom keras.layers.core import Lambda, Flatten, Densefrom keras.initializers import glorot_uniformfrom keras.engine.topology import Layerfrom keras import backend as KK.set_image_data_format(&#39;channels_first&#39;)import cv2import osimport numpy as npfrom numpy import genfromtxtimport pandas as pdimport tensorflow as tffrom fr_utils import *from inception_blocks_v2 import *np.set_printoptions(threshold&#x3D;np.nan)</code></pre><hr><h2 id="0-ç®€é™‹çš„è„¸éƒ¨è¯†åˆ«"><a href="#0-ç®€é™‹çš„è„¸éƒ¨è¯†åˆ«" class="headerlink" title="0.ç®€é™‹çš„è„¸éƒ¨è¯†åˆ«"></a>0.ç®€é™‹çš„è„¸éƒ¨è¯†åˆ«</h2><p>åœ¨è„¸éƒ¨éªŒè¯ä¸­ï¼Œä½ éœ€è¦ç¡®å®šç»™åˆ°çš„ä¸¤å¼ å›¾ç‰‡æ˜¯å¦æ˜¯ä¸€ä¸ªäººã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç›´æ¥å°†ä¸¤å¼ å›¾ç‰‡ä¸€ä¸ªåƒç´ ä¸€ä¸ªåƒç´ çš„è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸¤å¼ å›¾ç‰‡é—´çš„é—´è·å°äºæŸä¸ªé˜ˆå€¼ï¼Œä»–ä»¬å¯èƒ½å°±æ˜¯ä¸€ä¸ªäººã€‚</p><img src="/2020/03/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/LisaFaceReco.png" srcset="/img/loading.gif" class="" title="é€åƒç´ æ¯”è¾ƒ"><p>ä¸éš¾æƒ³åˆ°è¿™ä¸ªç®—æ³•çš„è¡¨ç°ä¼šå¾ˆå·®ã€‚å› ä¸ºå…‰çº¿çš„å˜åŒ–ã€äººç‰©è„¸éƒ¨æ–¹å‘ã€ç”šè‡³æ˜¯å¤´éƒ¨ä½ç½®çš„å¾®å°å˜åŒ–ï¼Œéƒ½ä¼šå¯¼è‡´åƒç´ å€¼çš„æ”¹å˜ã€‚</p><p>ä¸å…¶ä½¿ç”¨åŸå›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¼–ç åçš„å›¾ç‰‡æ•°æ®ã€‚å³f(img)ã€‚</p><p>å°†å›¾ç‰‡ç¼–ç åçš„æ•°æ®è¿›è¡Œå…ƒç´ çº§çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ›´åŠ å‡†ç¡®çš„å…³äºè„¸éƒ¨éªŒè¯çš„ç»“æœã€‚</p><hr><h2 id="1-å°†è„¸éƒ¨å›¾ç‰‡ç¼–ç ä¸º128ç»´çš„å‘é‡"><a href="#1-å°†è„¸éƒ¨å›¾ç‰‡ç¼–ç ä¸º128ç»´çš„å‘é‡" class="headerlink" title="1.å°†è„¸éƒ¨å›¾ç‰‡ç¼–ç ä¸º128ç»´çš„å‘é‡"></a>1.å°†è„¸éƒ¨å›¾ç‰‡ç¼–ç ä¸º128ç»´çš„å‘é‡</h2><h3 id="1-1-ä½¿ç”¨å·ç§¯ç½‘ç»œæ¥è¿›è¡Œç¼–ç "><a href="#1-1-ä½¿ç”¨å·ç§¯ç½‘ç»œæ¥è¿›è¡Œç¼–ç " class="headerlink" title="1.1 ä½¿ç”¨å·ç§¯ç½‘ç»œæ¥è¿›è¡Œç¼–ç "></a>1.1 ä½¿ç”¨å·ç§¯ç½‘ç»œæ¥è¿›è¡Œç¼–ç </h3><p>FaceNetæ¨¡å‹éœ€è¦ä½¿ç”¨éå¸¸å¤šçš„æ•°æ®å’Œå¾ˆé•¿çš„æ—¶é—´æ¥è¿›è¡Œè®­ç»ƒã€‚è¿™é‡Œæˆ‘ä»¬è·³è¿‡è¿™ä¸ªæ­¥éª¤ï¼Œç›´æ¥è½½å…¥åˆ«äººå·²ç»è®­ç»ƒå¥½çš„æƒé‡ã€‚ ç½‘ç»œç»“æ„é‡‡ç”¨äº† <a href="https://arxiv.org/abs/1409.4842" target="_blank" rel="noopener">Szegedyç­‰äºº</a>æ–‡ä¸­çš„inceptionæ¨¡å‹ã€‚ æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå·²ç»å®ç°å¥½çš„inception networkçš„å®ç°(åœ¨inception_blocks_v2.pyä¸­ï¼Œç•¥)ã€‚</p><p>å‡ ä¸ªéœ€è¦çŸ¥é“çš„çŸ¥è¯†ç‚¹ï¼š</p><ul><li>è¿™ä¸ªç½‘ç»œé‡‡ç”¨96Ã—96ç»´åº¦çš„RGBå›¾åƒä½œä¸ºè¾“å…¥ã€‚ç‰¹åˆ«åœ°ï¼Œè¾“å…¥ä¸€ä¸ªè„¸éƒ¨ç…§ç‰‡(æˆ–è€…å¤šæ‰¹æ¬¡çš„mç…§ç‰‡ç»„)ä½œä¸ºå¼ é‡ï¼Œå½¢çŠ¶ä¸ºï¼š(m,nC,nH,nW) = (m,3,96,96)</li><li>å®ƒå°†è¾“å‡ºä¸€ä¸ª(m,128)çš„çŸ©é˜µï¼Œå³å°†æ¯ä¸€å¼ å›¾ç‰‡éƒ½ç¼–ç ä¸º128ç»´çš„å‘é‡ã€‚</li></ul><pre><code class="hljs plain">FRmodel &#x3D; faceRecoModel(input_shape&#x3D;(3, 96, 96))print(&quot;Total Params:&quot;, FRmodel.count_params())</code></pre><p>è¾“å‡ºï¼šTotal Params: 3743280</p><p>é€šè¿‡ä½¿ç”¨ä¸€ä¸ª128å…ƒçš„å…¨è¿æ¥å±‚ä½œä¸ºå®ƒçš„æœ€åä¸€å±‚ï¼Œè¿™å°±ä¿è¯äº†æ¨¡å‹å°†è¾“å‡º128ç»´çš„å‘é‡ã€‚æ¥ç€ï¼Œä½¿ç”¨è¿™ä¸¤ä¸ªå‘é‡è¿›è¡Œä¸¤å¼ å›¾ç‰‡çš„æ¯”è¾ƒï¼š</p><p>å¦‚æœç¼–ç ç¬¦åˆä»¥ä¸‹åˆ¤åˆ«æ ‡å‡†ï¼Œåˆ™æ˜¯ä¸€ä¸ªå¥½çš„ç¼–ç :</p><ul><li>å¯¹åŒä¸€ä¸ªäººçš„ä¸åŒå›¾ç‰‡çš„ç¼–ç è¾ƒä¸ºç›¸ä¼¼</li><li>å¯¹ä¸åŒäººçš„å›¾ç‰‡çš„ç¼–ç å·®å¼‚è¾ƒå¤§</li></ul><p>ä¸‰å…ƒæŸå¤±å‡½æ•°å°†ä»¥ä¸Šæ ‡å‡†å…¬å¼åŒ–äº†ï¼Œå¹¶ä¸”è¯•å›¾å°†ç›¸åŒäººçš„å›¾ç‰‡çš„ç¼–ç ç¼©å°ï¼Œå°†ä¸åŒäººå›¾ç‰‡çš„ç¼–ç æ‹‰å¤§ã€‚</p><h3 id="1-2-ä¸‰å…ƒæŸå¤±å‡½æ•°å¯¹äºä¸€å¼ å›¾ç‰‡xï¼Œæˆ‘ä»¬å£°æ˜å®ƒçš„ç¼–ç ä¸ºf-x-fæ˜¯ç”±ç¥ç»ç½‘ç»œè®¡ç®—çš„æ–¹æ³•ã€‚"><a href="#1-2-ä¸‰å…ƒæŸå¤±å‡½æ•°å¯¹äºä¸€å¼ å›¾ç‰‡xï¼Œæˆ‘ä»¬å£°æ˜å®ƒçš„ç¼–ç ä¸ºf-x-fæ˜¯ç”±ç¥ç»ç½‘ç»œè®¡ç®—çš„æ–¹æ³•ã€‚" class="headerlink" title="1.2 ä¸‰å…ƒæŸå¤±å‡½æ•°å¯¹äºä¸€å¼ å›¾ç‰‡xï¼Œæˆ‘ä»¬å£°æ˜å®ƒçš„ç¼–ç ä¸ºf(x), fæ˜¯ç”±ç¥ç»ç½‘ç»œè®¡ç®—çš„æ–¹æ³•ã€‚"></a>1.2 ä¸‰å…ƒæŸå¤±å‡½æ•°å¯¹äºä¸€å¼ å›¾ç‰‡xï¼Œæˆ‘ä»¬å£°æ˜å®ƒçš„ç¼–ç ä¸ºf(x), fæ˜¯ç”±ç¥ç»ç½‘ç»œè®¡ç®—çš„æ–¹æ³•ã€‚</h3><img src="/2020/03/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/FaceNetFx.png" srcset="/img/loading.gif" class="" title="f(x)æ–¹æ³•"><p>ä¸‰å…ƒæŸå¤±å‡½æ•°çš„è®­ç»ƒéœ€è¦ç”¨åˆ°ä¸‰å…ƒç»„æ•°æ®ï¼Œæ¯ä¸ªä¸‰å…ƒç»„åŒ…å«ä¸‰å¼ å›¾ç‰‡(A,P,N)</p><ul><li>A æ˜¯ä¸€å¼ é”šå›¾ç‰‡ - æŸäººçš„å¤´éƒ¨å›¾åƒ</li><li>P æ˜¯ä¸€å¼ â€æ­£â€å›¾ç‰‡ - ä¸Aå›¾ç‰‡ä¸­æ˜¯åŒä¸€ä¸ªäººç‰©</li><li>N æ˜¯ä¸€å¼ â€è´Ÿâ€å›¾ç‰‡ - ä¸Aå›¾ç‰‡ä¸­ä¸æ˜¯åŒä¸€ä¸ªäººç‰©</li></ul><p>æˆ‘ä»¬ç”¨(A(i),P(i),N(i))(éƒ½æ˜¯ä¸Šæ ‡)æ¥å£°æ˜ç¬¬iä¸ªè®­ç»ƒæ ·æœ¬ã€‚<br>æˆ‘ä»¬å¸Œæœ›å›¾A(i)ä¸P(i)çš„è·ç¦»è‡³å°‘æ¯”A(i)å’ŒN(i)çš„è·ç¦»è¿‘è‡³å°‘ä¸€ä¸ªÎ±çš„å€¼ï¼š</p><img src="/2020/03/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/lossFormulaSingle.png" srcset="/img/loading.gif" class="" title="å•ä¸ªæ ·æœ¬çš„ä¸‰å…ƒæŸå¤±å…¬å¼"><p>é‚£ä¹ˆæ€»çš„æŸå¤±å‡½æ•°å°±æ˜¯ï¼š</p><img src="/2020/03/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/lossFormulaTotal.png" srcset="/img/loading.gif" class="" title="ä¸‰å…ƒæŸå¤±å…¬å¼"><p>[z]+è¡¨ç¤º max(z,0)ã€‚è¡¨ç¤ºä¸€æ—¦Aä¸Pè·ç¦»å’ŒAä¸Nè·ç¦»è¾¾åˆ°æˆ‘ä»¬çš„è¦æ±‚ï¼ŒæŸå¤±å°±ä¸º0ï¼Œå¦åˆ™å®ƒçš„å€¼å°±æ˜¯æŸå¤±å€¼ã€‚</p><p><strong><em>Notes:</em></strong></p><ul><li>å…¬å¼ä¸­çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯é”šå›¾ç‰‡Aå’Œæ­£å›¾ç‰‡Pçš„è·ç¦»ï¼Œä½ å¸Œæœ›å®ƒå°½å¯èƒ½çš„å°</li><li>å…¬å¼çš„ç¬¬äºŒä¸ªéƒ¨åˆ†åˆ™æ˜¯é”šå›¾ç‰‡Aå’Œè´Ÿå›¾ç‰‡Nçš„è·ç¦»ï¼Œä½ å¸Œæœ›å®ƒç›¸å¯¹è¾ƒå¤§</li><li>Î±å«åšè¾¹è·(margin)ï¼Œè¿™æ˜¯ä¸€ä¸ªäººä¸ºé€‰æ‹©çš„è¶…å‚æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨ Î± = 0.2</li></ul><p>å¤§å¤šæ•°çš„å®ç°é‡Œä¼šå°†ç¼–ç åçš„å‘é‡è¿›è¡Œä¸€æ¬¡L2å½’ä¸€åŒ–ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ç”¨æ‹…å¿ƒ~</p><p>å®ç°ä¸Šé¢å…¬å¼ä¸­çš„ä¸‰å…ƒæŸå¤±å‡½æ•°ï¼Œéœ€è¦4ä¸ªæ­¥éª¤ï¼š</p><ol><li>è®¡ç®—é”šå›¾ç‰‡Aå’Œæ­£å›¾ç‰‡Pé—´çš„è·ç¦»</li><li>è®¡ç®—é”šå›¾ç‰‡Aå’Œè´Ÿå›¾ç‰‡Né—´çš„è·ç¦»</li><li>å¯¹æ¯ä¸ªä¸‰å…ƒç»„æ ·æœ¬è¿›è¡Œå…¬å¼è®¡ç®—</li><li>å°†æ¯ç»„æ ·æœ¬ç»æ­¥éª¤3å¾—åˆ°çš„å€¼ä¸0å–maxå¹¶å–å’Œ</li></ol><p>PSï¼š</p><img src="/2020/03/25/%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/L2formula.png" srcset="/img/loading.gif" class="" title="L2 Normè®¡ç®—æ–¹æ³•"><pre><code class="hljs plain">def triplet_loss(y_true, y_pred, alpha &#x3D; 0.2):    &quot;&quot;&quot;    ä¸‰å…ƒæŸå¤±å‡½æ•°çš„å®ç°        Arguments:    y_true -- true æ ‡ç­¾, å½“ä½ åœ¨kerasä¸­å®šä¹‰lossæ—¶éœ€è¦, åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä½ ä¸éœ€è¦å®ƒ.    y_pred -- python list åŒ…å«ä¸‰ä¸ªå¯¹è±¡:            anchor -- é”šå›¾ç‰‡ç¼–ç åçš„ç»“æœ, å½¢çŠ¶ä¸º (None, 128)            positive -- æ­£å›¾ç‰‡ç¼–ç åçš„ç»“æœ, å½¢çŠ¶ä¸º(None, 128)            negative -- è´Ÿå›¾ç‰‡ç¼–ç åçš„ç»“æœ, å½¢çŠ¶ä¸º (None, 128)        Returns:    loss -- æ•°å­—, æŸå¤±å€¼    &quot;&quot;&quot;        anchor, positive, negative &#x3D; y_pred[0], y_pred[1], y_pred[2]        # Step 1    pos_dist &#x3D; tf.reduce_sum(tf.square(tf.subtract(anchor,positive)),-1)    # Step 2    neg_dist &#x3D; tf.reduce_sum(tf.square(tf.subtract(anchor,negative)),-1)    # Step 3    basic_loss &#x3D; tf.maximum(tf.add(tf.subtract(pos_dist,neg_dist),alpha),0)    # Step 4    loss &#x3D; tf.reduce_sum(basic_loss)        return loss</code></pre><hr><h2 id="2-è½½å…¥é¢„è®­ç»ƒæ¨¡å‹"><a href="#2-è½½å…¥é¢„è®­ç»ƒæ¨¡å‹" class="headerlink" title="2.è½½å…¥é¢„è®­ç»ƒæ¨¡å‹"></a>2.è½½å…¥é¢„è®­ç»ƒæ¨¡å‹</h2><p>FaceNeté€šè¿‡æœ€å°åŒ–ä¸‰å…ƒæŸå¤±å‡½æ•°æ¥è¿›è¡Œè®­ç»ƒã€‚ä½†è®­ç»ƒéœ€è¦å¤§é‡çš„æ•°æ®å’Œè®¡ç®—æ—¶é—´ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸ä»å¤´è®­ç»ƒäº†ã€‚æˆ‘ä»¬ç›´æ¥è¯»å–ä¸€ä¸ªé¢„è®­ç»ƒçš„æ¨¡å‹ã€‚ç”¨ä¸‹é¢çš„ä»£ç è¯»å–æ¥è¯»å–ä¸€ä¸ªæ¨¡å‹ï¼š</p><pre><code class="hljs plain">FRmodel.compile(optimizer &#x3D; &#39;adam&#39;, loss &#x3D; triplet_loss, metrics &#x3D; [&#39;accuracy&#39;])load_weights_from_FaceNet(FRmodel)</code></pre><hr><h2 id="3-åº”ç”¨æ¨¡å‹"><a href="#3-åº”ç”¨æ¨¡å‹" class="headerlink" title="3.åº”ç”¨æ¨¡å‹"></a>3.åº”ç”¨æ¨¡å‹</h2><p>å‡å®šæˆ‘ä»¬æ„å»ºçš„è¿™ä¸ªç³»ç»Ÿæ˜¯ä¸€ä¸ªé—¨ç¦ç³»ç»Ÿï¼Œç”¨äºç»™æŸå…¬å¸åˆ©ç”¨è„¸éƒ¨è¯†åˆ«æ¥ç¡®å®šæ˜¯å¦å…è®¸æŸäººè¿›å…¥å…¬å¸å»ºç­‘ã€‚</p><p>è¦é€šè¿‡é—¨ç¦ï¼Œæ¯ä¸ªäººè¦å…ˆåœ¨å…¥å£å¤„åˆ·é—¨ç¦å¡ï¼Œè„¸éƒ¨è¯†åˆ«ç³»ç»Ÿä¼šè¯†åˆ«ä»–ä»¬æ˜¯å¦æ˜¯ä»–ä»¬æ‰€å£°æ˜çš„äººã€‚</p><h3 id="3-1-è„¸éƒ¨è¯†åˆ«"><a href="#3-1-è„¸éƒ¨è¯†åˆ«" class="headerlink" title="3.1 è„¸éƒ¨è¯†åˆ«"></a>3.1 è„¸éƒ¨è¯†åˆ«</h3><p>æˆ‘ä»¬å…ˆå»ºç«‹ä¸€ä¸ªæ•°æ®åº“ï¼Œå®ƒå­˜æ”¾äº†æ‰€æœ‰è¢«å…è®¸è¿›å…¥å»ºç­‘äººå‘˜çš„ç¼–ç åå‘é‡æ•°æ®ã€‚å®ƒå°†ç”¨åˆ°img_to_encoding(image_path,model)æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨è¾“å…¥å›¾ç‰‡æ•°æ®ä¸Šé€šè¿‡æ¨¡å‹çš„å‰å‘ä¼ æ’­æ¥è·å¾—ç»“æœã€‚</p><p>å› ä¸ºæ˜¯æ•™ç¨‹ï¼Œç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ä¸€ä¸ªdictæ¥å……å½“æ•°æ®åº“ï¼š</p><pre><code class="hljs plain">database &#x3D; &#123;&#125;database[&quot;danielle&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;danielle.png&quot;, FRmodel)database[&quot;younes&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;younes.jpg&quot;, FRmodel)database[&quot;tian&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;tian.jpg&quot;, FRmodel)database[&quot;andrew&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;andrew.jpg&quot;, FRmodel)database[&quot;kian&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;kian.jpg&quot;, FRmodel)database[&quot;dan&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;dan.jpg&quot;, FRmodel)database[&quot;sebastiano&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;sebastiano.jpg&quot;, FRmodel)database[&quot;bertrand&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;bertrand.jpg&quot;, FRmodel)database[&quot;kevin&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;kevin.jpg&quot;, FRmodel)database[&quot;felix&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;felix.jpg&quot;, FRmodel)database[&quot;benoit&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;benoit.jpg&quot;, FRmodel)database[&quot;arnaud&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;arnaud.jpg&quot;, FRmodel)</code></pre><p>æ¥ä¸‹æ¥ï¼Œå½“ä¸€ä¸ªäººèµ°åˆ°å‰é—¨å¤„å¹¶åˆ·å¡ï¼Œä½ å°±å¯ä»¥ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾ä»–çš„ç¼–ç ï¼Œç„¶åå†è¿›è¡Œè„¸éƒ¨åŒ¹é…ï¼Œä¸»è¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>å°†å‰é—¨æ‘„åƒæœºæ•æ‰çš„å›¾ç‰‡è¿›è¡Œç¼–ç </li><li>è®¡ç®—ä¸Šä¸€æ­¥çš„ç¼–ç ä¸æ•°æ®åº“ä¸­æ‰¾åˆ°çš„å¯¹åº”idäººå‘˜çš„ç¼–ç é—´çš„é—´è·</li><li>å¦‚æœé—´è·å°äº0.7ï¼Œå¼€é—¨</li></ol><pre><code class="hljs plain">def verify(image_path, identity, database, model):    &quot;&quot;&quot;    éªŒè¯å­˜æ”¾åœ¨image_pathä¸­çš„äººæ˜¯å¦å’Œæ•°æ®åº“identityå¯¹åº”çš„äººæ˜¯åŒä¸€ä¸ª        å‚æ•°:    image_path -- å›¾ç‰‡åœ°å€    identity -- string, è¦è¯†åˆ«è€…çš„åå­—(æ¥è‡ªäºåˆ·å¡id). å¿…é¡»æ˜¯å»ºç­‘è¿›å…¥å…è®¸çš„äººå‘˜.    database -- python dictionary æ•°æ®å­—å…¸ äººå:å¤´åƒç¼–ç  (å‘é‡).    model -- kerasçš„ inception æ¨¡å‹        Returns:    dist -- image_pathå­˜å‚¨çš„å›¾åƒå’Œidentityå¯¹åº”çš„å›¾åƒçš„é—´è·    door_open -- Trueä»£è¡¨å¼€é—¨ï¼ŒFalseä»£è¡¨ä¸å¼€é—¨    &quot;&quot;&quot;        # Step 1:    encoding &#x3D; img_to_encoding(image_path,model)        # Step 2:     dist &#x3D; np.linalg.norm(encoding - database[identity])    # Step 3:     if dist &lt; 0.7:        print(&quot;It&#39;s &quot; + str(identity) + &quot;, welcome in!&quot;)        door_open &#x3D; True    else:        print(&quot;It&#39;s not &quot; + str(identity) + &quot;, please go away&quot;)        door_open &#x3D; False            return dist, door_open</code></pre><p>ç”¨äº† <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.linalg.norm.html" target="_blank" rel="noopener">np.linalg.norm</a>æ¥è®¡ç®—é—´è·ï¼Œä¸ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°å³è®¡ç®—F-èŒƒæ•°ã€‚</p><p>æˆ‘ä»¬ä¼ å…¥ä¸€å¼ æ­£ç¡®çš„å›¾ç‰‡è¯•ä¸€è¯•ï¼š</p><pre><code class="hljs plain">verify(&quot;images&#x2F;camera_0.jpg&quot;, &quot;younes&quot;, database, FRmodel)</code></pre><p>è¾“å‡ºï¼šItâ€™s younes, welcome in!</p><p>å†æ¥ä¸€å¼ é”™è¯¯çš„å‘¢ï¼š</p><pre><code class="hljs plain">verify(&quot;images&#x2F;camera_2.jpg&quot;, &quot;kian&quot;, database, FRmodel)</code></pre><p>è¾“å‡ºï¼šItâ€™s not kian, please go away</p><h3 id="3-2-è„¸éƒ¨è¯†åˆ«"><a href="#3-2-è„¸éƒ¨è¯†åˆ«" class="headerlink" title="3.2 è„¸éƒ¨è¯†åˆ«"></a>3.2 è„¸éƒ¨è¯†åˆ«</h3><p>è„¸éƒ¨è®¤è¯ç³»ç»ŸåŸºæœ¬å®Œæˆäº†ï¼Œä½†æ˜¯å¦‚æœç³»ç»Ÿå†…æŸäººä¸¢å¤±äº†IDå¡ï¼Œä»–å†æ¬¡å›åˆ°åŠå…¬å®¤å°±ä¸èƒ½å†è¿›å»äº†ï¼(éœ€è¦åˆ·å¡)</p><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å°±éœ€è¦å°†ç³»ç»Ÿæ”¹é€ æˆä¸€ä¸ªè„¸éƒ¨è¯†åˆ«ç³»ç»Ÿã€‚è¿™æ ·å¤§å®¶å°±éƒ½ä¸éœ€è¦å¸¦idå¡äº†ã€‚ä¸€ä¸ªè¢«æˆæƒçš„äººåªè¦èµ°åˆ°å‰é—¨ï¼Œé—¨å°±ä¼šè‡ªåŠ¨æ‰“å¼€ï¼</p><p>å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ªéå†ï¼Œç›´æ¥ä¸Šä»£ç å³å¯ï¼š</p><pre><code class="hljs plain">def who_is_it(image_path, database, model):    &quot;&quot;&quot;    å®ç°è„¸éƒ¨è¯†åˆ«ç³»ç»Ÿï¼Œè¯†åˆ«image_pathå›¾ç‰‡äººçš„èº«ä»½        Arguments:    ç•¥        Returns:    min_dist -- image_pathå›¾ç‰‡ä¸æ•°æ®åº“ä¸­å›¾ç‰‡çš„æœ€å°é—´è·    identity -- æœ€å°é—´è·å¯¹åº”çš„äºº    &quot;&quot;&quot;        encoding &#x3D; img_to_encoding(image_path,model)            # åˆå§‹åŒ–æœ€å°å€¼ï¼Œæ•´å¤§ç‚¹    min_dist &#x3D; 100        for (name, db_enc) in database.items():                dist &#x3D; np.linalg.norm(encoding - db_enc)        if dist &lt; min_dist:            min_dist &#x3D; dist            identity &#x3D; name    if min_dist &gt; 0.7:        print(&quot;Not in the database.&quot;)    else:        print (&quot;it&#39;s &quot; + str(identity) + &quot;, the distance is &quot; + str(min_dist))            return min_dist, identity</code></pre><p>è¯•ä¸€ä¸‹ï¼š</p><pre><code class="hljs plain">who_is_it(&quot;images&#x2F;camera_0.jpg&quot;, database, FRmodel)</code></pre><p>è¾“å‡ºï¼šitâ€™s younes, the distance is 0.659393</p><p>æ¿€åŠ¨äººå¿ƒçš„æ—¶å€™æ¥äº†ï¼Œæˆ‘ä»¬æŠŠLisaçš„å›¾ç‰‡è£å‰ªæˆ96Ã—96å†æ”¾å…¥ï¼š</p>{% asset_img Lisa.png Lisa %} {% asset_img camera_Lisa.png LisaInCamera %}<pre><code class="hljs plain">database[&quot;lisa&quot;] &#x3D; img_to_encoding(&quot;images&#x2F;Lisa.png&quot;, FRmodel)who_is_it(&quot;images&#x2F;camera_Lisa.png&quot;, database, FRmodel)</code></pre><p>è¾“å‡ºï¼š itâ€™s lisa, the distance is 0.597898<br>æˆåŠŸï¼ï¼ï¼</p><p>è¿™æ ·ï¼Œä¸€ä¸ªç®€é™‹ç‰ˆæœ¬çš„è„¸éƒ¨è¯†åˆ«ç³»ç»Ÿå°±å®Œæˆå•¦ï¼</p><h3 id="ä¸€äº›æå‡çš„æ–¹æ³•"><a href="#ä¸€äº›æå‡çš„æ–¹æ³•" class="headerlink" title="ä¸€äº›æå‡çš„æ–¹æ³•"></a>ä¸€äº›æå‡çš„æ–¹æ³•</h3><p>è¿™é‡Œå°±ä¸ä¸€ä¸€å®ç°äº†ï¼Œè¿˜æœ‰ä¸€äº›å¯ä»¥æå‡ç®—æ³•æ•ˆæœçš„æ–¹æ³•ï¼š</p><ul><li>å¯¹äºæ¯ä¸ªäººï¼Œå¤šåœ¨æ•°æ®åº“ä¸­æ”¾å‡ å¼ ç…§ç‰‡ï¼Œæ¯”å¦‚ä¸åŒè§’åº¦çš„ï¼Œä¸åŒå…‰çº¿çš„ï¼Œä¸åŒæ—¶é—´çš„ã€‚åœ¨åˆ·è„¸æ—¶ï¼Œå°†ä¹‹ä¸æ•°æ®åº“ä¸­æ¯ä¸ªäººçš„å¤šå¼ å›¾ç‰‡è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ ·å¯ä»¥æé«˜æ¨¡å‹å‡†ç¡®åº¦ã€‚</li><li>è¿ç”¨ä¸€ä¸ªè£å‰ªç®—æ³•ï¼Œå°†å›¾ç‰‡å°½é‡å‰ªåˆ°åªå‰©ä¸‹è„¸éƒ¨ã€‚è¿™æ ·å¯ä»¥å°½é‡æ’é™¤ä¸ç›¸å…³å› ç´ çš„å¹²æ‰°ï¼Œä¹Ÿèƒ½æé«˜å‡†ç¡®åº¦ã€‚</li></ul><hr><h2 id="å¼•ç”¨ï¼š"><a href="#å¼•ç”¨ï¼š" class="headerlink" title="å¼•ç”¨ï¼š"></a>å¼•ç”¨ï¼š</h2><ul><li>Florian Schroff, Dmitry Kalenichenko, James Philbin (2015). <a href="https://arxiv.org/pdf/1503.03832.pdf" target="_blank" rel="noopener">FaceNet: A Unified Embedding for Face Recognition and Clustering</a></li><li>Yaniv Taigman, Ming Yang, Marcâ€™Aurelio Ranzato, Lior Wolf (2014). <a href="https://research.fb.com/wp-content/uploads/2016/11/deepface-closing-the-gap-to-human-level-performance-in-face-verification.pdf" target="_blank" rel="noopener">DeepFace: Closing the gap to human-level performance in face verification</a></li><li>The pretrained model we use is inspired by Victor Sy Wangâ€™s implementation and was loaded using his code: <a href="https://github.com/iwantooxxoox/Keras-OpenFace" target="_blank" rel="noopener">https://github.com/iwantooxxoox/Keras-OpenFace</a>.</li><li>Our implementation also took a lot of inspiration from the official FaceNet github repository: <a href="https://github.com/davidsandberg/facenet" target="_blank" rel="noopener">https://github.com/davidsandberg/facenet</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>æ·±åº¦å­¦ä¹ </category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å·ç§¯ç¥ç»ç½‘ç»œä»‹ç»</title>
    <link href="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/"/>
    <url>/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ä¼ ç»Ÿçš„ç¥ç»ç½‘ç»œçš„å…¨è¿æ¥å±‚(full connected)åœ¨é­é‡è¾ƒå¤§çš„è¾“å…¥æ•°æ®æ—¶ï¼Œéœ€è¦è®­ç»ƒçš„å‚æ•°å°†ä¼šéå¸¸å¤šã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸€å¼ 1000Ã—1000çš„å›¾ç‰‡ï¼Œä½œflattenå¤„ç†åå°±æœ‰äº†1000Ã—1000Ã—3çš„è¾“å…¥ç»´åº¦ï¼Œå¦‚æœç¬¬äºŒå±‚çš„éšè—å•å…ƒæ•°æ˜¯1000ï¼Œå‚æ•°Wçš„ç»´åº¦å°±æ˜¯3000000Ã—1000ã€‚<br>å‚æ•°è¿‡å¤šï¼Œå°±æ„å‘³ç€è®­ç»ƒéš¾åº¦å˜é«˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå·ç§¯ç¥ç»ç½‘ç»œå°±è¯ç”Ÿäº†ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯å·ç§¯"><a href="#ä»€ä¹ˆæ˜¯å·ç§¯" class="headerlink" title="ä»€ä¹ˆæ˜¯å·ç§¯"></a>ä»€ä¹ˆæ˜¯å·ç§¯</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æœ€åŸºç¡€çš„ä¸€ç‚¹ï¼šä»€ä¹ˆæ˜¯å·ç§¯ï¼Ÿ</p><p>ç”¨ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œè¯´æ˜ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰ä¸€å¼ 6Ã—6çš„å›¾ç‰‡ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬æš‚æ—¶å‡å®šå®ƒç¬¬ä¸‰ä¸ªç»´åº¦ä¸º1ï¼Œå³é€šé“æ•°ä¸º1ã€‚é‚£ä¹ˆä¸€æ¬¡å·ç§¯æ“ä½œå¦‚ä¸‹ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/conv01.png" srcset="/img/loading.gif" class="" title="å·ç§¯1"><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå·¦ä¸€çš„6Ã—6çŸ©é˜µä»£è¡¨æˆ‘ä»¬çš„è¾“å…¥çŸ©é˜µï¼Œä¸­é—´çš„3Ã—3çŸ©é˜µå«åšè¿‡æ»¤å™¨(filter)ï¼Œä¹Ÿå«åšå·ç§¯æ ¸ï¼Œè€ŒäºŒè€…ä¸­é—´çš„â€*â€œå°±è¡¨ç¤º<strong><em>å·ç§¯</em></strong>ï¼Œå®ƒå’Œè®¡ç®—æœºä¸­çš„ä¹˜æ³•ç¬¦å·ä¸€è‡´ã€‚</p><p>å·ç§¯çš„è¿ç®—æ–¹æ³•å°±æ˜¯ ä»è¾“å…¥çŸ©é˜µçš„å·¦ä¸Šè§’å¼€å§‹ï¼Œä»å·¦åˆ°å³æ¯ä¸€æ¬¡å–å‡ºä¸€ä¸ªä¸å·ç§¯æ ¸ç»´åº¦ä¸€æ ·å¤§å°çš„çŸ©é˜µï¼Œè¿™é‡Œæ˜¯3Ã—3ã€‚ å°†å–å‡ºçš„çŸ©é˜µçš„æ¯ä¸€ä½ä¸å·ç§¯æ ¸å¯¹åº”ä¸ºç›¸ä¹˜å¹¶ç›¸åŠ ï¼Œå¾—åˆ°çš„æ•°æ®å¡«åœ¨å³ä¾§ç»“æœçŸ©é˜µçš„å¯¹åº”ä½ç½®ã€‚</p><p>ç¬¬äºŒæ­¥å¦‚ä¸‹ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/conv02.png" srcset="/img/loading.gif" class="" title="å·ç§¯2"><p>ä»¥æ­¤ç±»æ¨ï¼Œå¾€å³ä¸èƒ½å†èµ°æ—¶ï¼Œå°±å‘ä¸‹ç§»åŠ¨ä¸€è¡Œï¼Œå†æ¬¡ä»æœ€å·¦è¾¹å¼€å§‹å–ã€‚<br>è¿™æ ·ï¼Œæœ€ç»ˆæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ª4Ã—4çš„ç»“æœçŸ©é˜µ(ä¸€å¼ å˜å°çš„å›¾ç‰‡)ã€‚</p><h3 id="å·ç§¯åœ¨åšä»€ä¹ˆ"><a href="#å·ç§¯åœ¨åšä»€ä¹ˆ" class="headerlink" title="å·ç§¯åœ¨åšä»€ä¹ˆ"></a>å·ç§¯åœ¨åšä»€ä¹ˆ</h3><p>ä½ å¯èƒ½ä¼šæ„Ÿåˆ°å›°æƒ‘ï¼Œè¿™æ ·çš„ä¸€æ­¥æ‰€è°“çš„æ“ä½œåˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚<br>å°±æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œè¿™æ ·ä¸€ä¸ªå·ç§¯æ ¸çš„æ•ˆæœå¯ä»¥ç”¨å…­ä¸ªå­—æ¥æ¦‚æ‹¬ï¼šâ€œå‚ç›´è¾¹ç¼˜æ£€æµ‹â€ã€‚<br>å¦‚ä¸‹ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/conv03.png" srcset="/img/loading.gif" class="" title="å·ç§¯3"><p>å¯ä»¥çœ‹åˆ°ï¼Œç»“æœå›¾ç‰‡çš„ä¸­éƒ¨æœ‰ä¸€é“æ˜æ˜¾çš„ç™½è‰²ï¼Œè¿™å°±æ˜¯æ£€æµ‹å‡ºæ¥çš„å‚ç›´è¾¹ç¼˜ã€‚æ˜¯çš„ï¼Œå®ƒçœ‹èµ·æ¥ä¸å·¦è¾¹çš„è¾“å…¥å›¾ç‰‡æœ‰äº›ä¸ç¬¦åˆï¼Œæ˜¾å¾—æ¯”è¾ƒåšï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬é€‰æ‹©çš„å›¾ç‰‡è¾ƒå°(æ‰6Ã—6)ï¼Œå½“æŠŠå›¾ç‰‡å˜å¤§æ—¶ï¼Œç»“æœå°±å˜å¾—è¾ƒä¸ºå¯è§‚äº†ã€‚</p><p>æ—¢ç„¶æœ‰å‚ç›´è¾¹ç¼˜æ£€æµ‹çš„å·ç§¯æ ¸ï¼Œè‡ªç„¶å°±æœ‰å…¶å®ƒåŠŸèƒ½çš„å·ç§¯æ ¸ï¼Œæ¯”å¦‚æ°´å¹³è¾¹ç¼˜æ£€æµ‹å·ç§¯æ ¸ï¼Œæ¯”å¦‚ç€é‡çªå‡ºæŸäº›è¾¹ç¼˜ç‰¹å¾çš„å·ç§¯æ ¸ç­‰ã€‚</p><p>è€Œå·ç§¯æ ¸çš„å€¼æ˜¯å¯ä»¥é€šè¿‡è®­ç»ƒå¾—åˆ°çš„ï¼Œè¿™ç‚¹æˆ‘ä»¬å°†åœ¨åé¢ä»‹ç»ã€‚</p><h2 id="å¡«å……-padding"><a href="#å¡«å……-padding" class="headerlink" title="å¡«å……-padding"></a>å¡«å……-padding</h2><p>é™¤äº†å·ç§¯ï¼Œconvç½‘ç»œçš„ç¬¬äºŒä¸ªé‡è¦çš„ç§¯æœ¨å°±æ˜¯<strong><em>å¡«å……</em></strong>ã€‚</p><p>åœ¨ä¸Šä¸€èŠ‚ä»‹ç»å·ç§¯æ—¶ï¼Œä¸€ä¸ª6Ã—6çš„å›¾ç‰‡ç»è¿‡ä¸€æ¬¡å·ç§¯æ“ä½œå˜æˆäº†4Ã—4ï¼Œå¯è§å·ç§¯æ“ä½œæ˜¯ä¼šè®©è¾“å…¥æ•°æ®çš„ç»´åº¦é™ä½çš„ã€‚è¿™æ ·çš„æ“ä½œå¤šæ¥å‡ æ¬¡ï¼Œå†å¤§çš„å›¾ç‰‡ä¹Ÿé­ä¸ä½ã€‚å› æ­¤ï¼Œä¸ºäº†æ„å»ºæ·±å±‚ç½‘ç»œï¼Œå¡«å……å°±å¿…ä¸å¯å°‘ã€‚</p><p>é¦–å…ˆï¼Œå…³äºå·ç§¯æ“ä½œå‡å°ç»´åº¦ï¼Œæ˜¯æœ‰ä¸€ä¸ªé€šç”¨çš„è®¡ç®—å…¬å¼çš„ï¼š<br><strong><em>ç»“æœçŸ©é˜µçš„ç»´åº¦ = (n-f+1) Ã— (n-f+1)</em></strong><br>å…¶ä¸­fä¸ºå·ç§¯æ ¸çš„ç»´åº¦ï¼Œnä¸ºè¾“å…¥çŸ©é˜µçš„ç»´åº¦ã€‚</p><p>é™¤äº†ä¼šå‡å°å›¾ç‰‡çš„ç»´åº¦å¤–ï¼Œå·ç§¯è¿˜ä¼šå¯¼è‡´å›¾ç‰‡è§’è½çš„åƒç´ åªèƒ½è¢«ä½¿ç”¨åˆ°ä¸€æ¬¡ï¼Œè€Œä¸­é—´çš„æ•°æ®åˆ™ä¼šè¢«ä½¿ç”¨å¤šæ¬¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´å›¾ç‰‡è¾¹ç¼˜çš„æ•°æ®ä¸èƒ½å¾—åˆ°è¶³å¤Ÿçš„åˆ©ç”¨ï¼Œç”šè‡³è¢«ä¸¢å¤±äº†ã€‚</p><p>æ‰€ä»¥æ‰€è°“å¡«å……ï¼Œå°±æ˜¯å¡«å……æ•°æ®çš„è¾¹ç¼˜ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/padding01.png" srcset="/img/loading.gif" class="" title="å¡«å……1"><p>é€šè¿‡åœ¨åŸå›¾ç‰‡è¾¹ç¼˜å¡«å……ä¸€å±‚ä½¿ä¹‹å˜æˆ8Ã—8çš„å›¾åƒï¼Œä»è€Œç»è¿‡å·ç§¯æ“ä½œåï¼Œä½ ä¾ç„¶å¯ä»¥å¾—åˆ°ä¸€ä¸ª6Ã—6çš„å›¾åƒã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨å·ç§¯ç½‘ç»œä¸­å¤§å¤šæ•°æ—¶å€™ä½¿ç”¨è¿™æ ·çš„å¡«å……ï¼Œå³ä½¿æ•°æ®åœ¨å¡«å……åè¿›è¡Œå·ç§¯å¾—åˆ°ä¸åŸæ•°æ®åŒæ ·ç»´åº¦çš„æ•°æ®ã€‚è¿™æ ·çš„å·ç§¯æ“ä½œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong><em>sameå·ç§¯</em></strong>ã€‚</p><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰fullå·ç§¯å’Œvalidå·ç§¯ï¼Œå‰è€…è®©å›¾åƒæœ€è§’è½çš„å…ƒç´ ä¹Ÿå¯ä»¥è¢«å……åˆ†åˆ©ç”¨ï¼Œè€Œåè€…åˆ™æ˜¯ä¸åšå¡«å……ã€‚</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/padding02.png" srcset="/img/loading.gif" class="" title="fullå·ç§¯"><p>ä¸Šå›¾ä¸ºfullå·ç§¯</p><h2 id="æ­¥å¹…-stride-å·ç§¯"><a href="#æ­¥å¹…-stride-å·ç§¯" class="headerlink" title="æ­¥å¹…(stride)å·ç§¯"></a>æ­¥å¹…(stride)å·ç§¯</h2><p>åœ¨ä¹‹å‰çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬æ¯æ¬¡è®¡ç®—å·ç§¯åï¼Œéƒ½æ˜¯åœ¨åŸå›¾ç‰‡ä¸Šå‘å³æˆ–è€…å‘ä¸‹ç§»åŠ¨ä¸€æ­¥ã€‚è€Œæ­¥å¹…å·ç§¯ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†è¿™ä¸ªä¸€æ­¥æ‰©å±•å¼€æ¥ï¼Œæ¯æ¬¡ç§»åŠ¨sæ­¥ï¼Œæˆ‘ä»¬ä»¥2ä¸ºä¾‹ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/stride01.png" srcset="/img/loading.gif" class="" title="æ­¥å¹…å·ç§¯1"><p>å¦‚ä¸Šä¸ºç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥ï¼Œæ­¤å¤–ï¼Œå½“éœ€è¦å‘ä¸‹ç§»åŠ¨æ—¶ï¼Œä¹Ÿæ˜¯ç§»åŠ¨sæ­¥</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/stride03.png" srcset="/img/loading.gif" class="" title="æ­¥å¹…å·ç§¯3"><p>å®¹æ˜“è®¡ç®—ï¼Œç»è¿‡æ­¥å¹…ä¸ºsçš„å·ç§¯åï¼Œç»“æœçŸ©é˜µç»´åº¦çš„è®¡ç®—æ–¹å¼ä¸ºï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/strideFormula.png" srcset="/img/loading.gif" class="" title="æ­¥å¹…å·ç§¯ç»“æœçŸ©é˜µç»´åº¦å…¬å¼"><p>å‡å¦‚å½“å‘å³ç§»åŠ¨sæ­¥å·²ç»è¶…å‡ºäº†åŸçŸ©é˜µèŒƒå›´ï¼Œå³å½“ä¸èƒ½è¢«æ•´é™¤çš„æ—¶å€™ï¼Œå°±ç›´æ¥èˆå¼ƒå‰©ä½™éƒ¨åˆ†ç›´æ¥å‘ä¸‹èµ°äº†ã€‚å³å‘ä¸‹å–æ•´ã€‚</p><h2 id="ä¸‰ç»´æ•°æ®çš„å·ç§¯"><a href="#ä¸‰ç»´æ•°æ®çš„å·ç§¯" class="headerlink" title="ä¸‰ç»´æ•°æ®çš„å·ç§¯"></a>ä¸‰ç»´æ•°æ®çš„å·ç§¯</h2><p>å¯¹äºç°å®æƒ…å†µä¸­çš„å›¾ç‰‡æ¥è¯´ï¼Œå› ä¸ºRGBæ ¼å¼çš„å­˜åœ¨ï¼Œæˆ‘ä»¬çš„è¾“å…¥æ•°æ®å¤§å¤šéƒ½æ˜¯3ç»´çš„ï¼Œé‚£ä¹ˆï¼Œå¦‚ä½•å°†å·ç§¯æ‰©å±•åˆ°ä¸‰ç»´æ•°æ®ä¸Šå»å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œå·ç§¯æ ¸ï¼ˆè¿‡æ»¤å™¨ï¼‰ä¹Ÿè¦å˜æˆä¸‰ç»´ï¼Œä¸”ç¬¬ä¸‰ä¸ªç»´åº¦è¦å’ŒåŸçŸ©é˜µç›¸åŒ(ç¬¬ä¸‰ä¸ªç»´åº¦åœ¨å·ç§¯ä¸­æˆ‘ä»¬ä¸€èˆ¬å«åš<strong><em>é€šé“</em></strong>)ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/convIn3D01.png" srcset="/img/loading.gif" class="" title="ä¸‰ç»´æ•°æ®å·ç§¯01"><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ä¸€ä¸ª4*4çš„çŸ©é˜µï¼Œæ²¡æœ‰äº†ç¬¬ä¸‰ä¸ªç»´åº¦ï¼Œè®¡ç®—æ–¹æ³•å…¶å®å¾ˆç®€å•ï¼ŒåŸºæœ¬å°±æ˜¯äºŒç»´è®¡ç®—æ–¹å¼çš„ä¸‰ç»´æ‰©å±•ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/convIn3D02.png" srcset="/img/loading.gif" class="" title="ä¸‰ç»´æ•°æ®å·ç§¯02"><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/convIn3D03.png" srcset="/img/loading.gif" class="" title="ä¸‰ç»´æ•°æ®å·ç§¯03"><p>å³æŠŠæ¯ä¸ª3Ã—3Ã—3 = 27ä¸ªæ ¼å­çš„æ•°å­—å¯¹åº”ç›¸ä¹˜å¹¶ç›¸åŠ ï¼Œç„¶åå³ç§»å’Œä¸‹ç§»å³å¯ï¼Œå› ä¸ºæ·±åº¦ä¸€è‡´ï¼Œå¹¶ä¸éœ€è¦å…³å¿ƒç¬¬ä¸‰ä¸ªç»´åº¦ã€‚</p><p>å·ç§¯æ ¸çš„è®¾è®¡å¾ˆçµæ´»ï¼Œå‡å¦‚ä½ æŠŠå·ç§¯æ ¸çš„ç¬¬äºŒå±‚å’Œç¬¬ä¸‰å±‚éƒ½è®¾ç½®ä¸º0ï¼Œç›¸å½“äºåœ¨ç»“æœçŸ©é˜µä¸­å°±åªæœ‰ä½ å¯¹ç¬¬ä¸€å±‚çš„å·ç§¯ï¼Œåœ¨RGBå›¾ç‰‡ä¸­ï¼Œä½ å°±åªæ£€æµ‹äº†çº¢è‰²é€šé“çš„è¾¹ç¼˜ã€‚</p><p>æ›´å¸¸ç”¨çš„æ˜¯ï¼Œä½ å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªå·ç§¯æ ¸ï¼Œç„¶åæŠŠå¾—åˆ°çš„ç»“æœå †å ï¼Œå¾—åˆ°é€šé“æ•°å¤§äº1çš„ç»“æœï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/convIn3D04.png" srcset="/img/loading.gif" class="" title="ä¸‰ç»´æ•°æ®å·ç§¯04"><p><strong>æ‰€ä»¥å·ç§¯ç»“æœçŸ©é˜µçš„é€šé“æ•°ï¼Œå–å†³äºå·ç§¯æ ¸çš„æ•°é‡ï¼Œè®°ä½è¿™ä¸€ç‚¹ã€‚</strong></p><h2 id="å·ç§¯ç¥ç»ç½‘ç»œ"><a href="#å·ç§¯ç¥ç»ç½‘ç»œ" class="headerlink" title="å·ç§¯ç¥ç»ç½‘ç»œ"></a>å·ç§¯ç¥ç»ç½‘ç»œ</h2><p>ä»‹ç»äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ‹‰é€šæ¥çœ‹ä¸€ä¸‹ï¼ŒæŠŠä¸Šè¿°çŸ¥è¯†ç‚¹ç»“åˆèµ·æ¥ï¼Œå°±æ˜¯å·ç§¯ç¥ç»ç½‘ç»œçš„ä¸€å±‚ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/aLayerInConvNet.png" srcset="/img/loading.gif" class="" title="å·åŠç½‘ç»œä¸­çš„ä¸€å±‚"><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œæ¯ä¸€ä¸ªè¿‡æ»¤å™¨(å·ç§¯æ ¸)éƒ½ç›¸å½“äºæ˜¯è¿‡æ»¤å‡ºåŸæ•°æ®çš„ä¸€ä¸ªç‰¹æ€§ã€‚ä¸Šå›¾ä¸­ï¼Œç”¨äº†2ä¸ªè¿‡æ»¤å™¨ï¼Œå°†æ¯ä¸ªè¿‡æ»¤å™¨å¾—åˆ°çš„ç»“æœå†è¿›è¡Œä¸€æ¬¡æ¿€æ´»ã€‚æ¿€æ´»å‡½æ•°å¯ä»¥è¯´æ˜¯ç¥ç»ç½‘ç»œä¸­çš„ä¸€ç§é‡è¦å·¥å…·ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªéçº¿æ€§å‡½æ•°ï¼Œå¯ä»¥ç®€å•åœ°ç†è§£ä¸ºå°†æ•°æ®ä¸­çš„ç‰¹ç‚¹æ”¾å¤§å¹¶ä¸”ä¿è¯äº†å¤šå±‚ç½‘ç»œçš„å®ç”¨æ€§ã€‚æ¿€æ´»ä¹‹åå†é‡å åœ¨ä¸€èµ·ï¼Œå°±å¾—åˆ°äº†æˆ‘ä»¬æœ€å4Ã—4Ã—2çš„ç»“æœã€‚</p><p>å¦‚æœä½ çŸ¥é“æ™®é€šç¥ç»ç½‘ç»œçš„ç»“æ„ï¼Œå®ƒæ¯ä¸€å±‚çš„è¿ç®—å°±æ˜¯å…ˆè¿›è¡Œ z[l] = W*a[l-1] + b[l]ï¼Œå†è¿›è¡Œ a[l] = g(z[l])ã€‚å¯ä»¥çœ‹åˆ°å¯¹äºæˆ‘ä»¬çš„å·ç§¯ç¥ç»ç½‘ç»œï¼Œè¿™ä¸€å±‚çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥å¯¹åº”æˆè¿™ä¸ªå…¬å¼ï¼Œè¿‡æ»¤å™¨å°±æ˜¯æˆ‘ä»¬çš„Wã€‚</p><p>æ—¢ç„¶è¿‡æ»¤å™¨æ˜¯æˆ‘ä»¬Wï¼Œä¸Šé¢æˆ‘ä»¬ä¹Ÿè¯´è¿‡è¿‡æ»¤å™¨çš„å€¼å¯ä»¥è®­ç»ƒï¼Œé‚£ä¹ˆè¿™ä¹ˆä¸€å±‚å·ç§¯ç½‘ç»œï¼Œæˆ‘ä»¬éœ€è¦è®­ç»ƒå¤šå°‘å‚æ•°å‘¢ï¼Ÿ<br>å‡è®¾æˆ‘ä»¬æœ‰10ä¸ª3Ã—3Ã—3çš„è¿‡æ»¤å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ 3Ã—3Ã—3Ã—10 + 10(bå‚æ•°ï¼Œåå·®å€¼) ä¸ªï¼Œå³280ä¸ªå‚æ•°ã€‚</p><h3 id="ConvNetä¸­çš„ç¬¦å·"><a href="#ConvNetä¸­çš„ç¬¦å·" class="headerlink" title="ConvNetä¸­çš„ç¬¦å·"></a>ConvNetä¸­çš„ç¬¦å·</h3><p>åœ¨å·ç§¯ç½‘ç»œä¸­ï¼Œä½ ä¼šçœ‹åˆ°å¾ˆå¤šå„ç§ç¬¦å·ä»¥åŠå‚æ•°ã€ä¸­é—´å€¼ï¼Œç»“æœçš„ç»´åº¦ï¼Œæˆ‘ä»¬ç¨ä½œæ€»ç»“ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/notaionInConvNet.png" srcset="/img/loading.gif" class="" title="å·ç§¯ç½‘ç»œä¸­çš„ç¬¦å·"><p>ä»¥ä¸Šå°±æ˜¯å·ç§¯ç½‘ç»œä¸­çš„ä¸€å±‚äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ‰©å±•å®ƒæ¥æ„å»ºä¸€ä¸ªå·ç§¯ç½‘ç»œå‘¢ï¼Ÿ</p><p>PS: ConvNetæ˜¯å·ç§¯ç¥ç»ç½‘ç»œçš„ç®€å†™</p><h3 id="ä¸€ä¸ªç®€å•çš„ä¾‹å­"><a href="#ä¸€ä¸ªç®€å•çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªç®€å•çš„ä¾‹å­"></a>ä¸€ä¸ªç®€å•çš„ä¾‹å­</h3><p>ç°åœ¨å‡å¦‚ä½ æœ‰ä¸€äº›ç…§ç‰‡ï¼Œä½ æƒ³é€šè¿‡å·ç§¯ç½‘ç»œæ¥å®ç°å›¾ç‰‡çš„åˆ†ç±»ï¼Œå‡å¦‚è¾“å…¥å›¾ç‰‡çš„å¤§å°ä¸º39Ã—39Ã—3ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/aBriefConvNet.png" srcset="/img/loading.gif" class="" title="ä¸€ä¸ªç®€å•çš„å·ç§¯ç½‘ç»œç»“æ„"><p>æ¥ç€ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæœ€åè¿™ä¸ª7Ã—7Ã—40çš„çŸ©é˜µå±•å¼€æˆ1960çš„å‘é‡ï¼Œæ¥ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šç¥ç»ç½‘ç»œçš„æ‰‹æ®µï¼Œä½¿ç”¨é€»è¾‘å›å½’æˆ–è€…ä¸€ä¸ªsoftmaxå±‚æ¥è¿›è¡Œæœ€åç»“æœçš„è®¡ç®—ã€‚</p><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºä¸€ä¸ªå¤§å¤šæ•°å·ç§¯ç¥ç»ç½‘ç»œçš„è¶‹åŠ¿ï¼Œå³éšç€å±‚æ•°çš„å¢åŠ ï¼ŒçŸ©é˜µçš„å®½é«˜ä¼šé€æ¸å‡å°ï¼Œè€Œé€šé“æ•°é‡ä¼šé€æ¸å¢åŠ ã€‚</p><h3 id="å…¶å®ƒçš„å±‚ç±»å‹"><a href="#å…¶å®ƒçš„å±‚ç±»å‹" class="headerlink" title="å…¶å®ƒçš„å±‚ç±»å‹"></a>å…¶å®ƒçš„å±‚ç±»å‹</h3><p>ä¸Šé¢çš„ç½‘ç»œä¸­ï¼Œè¿™äº›ä½¿ç”¨å·ç§¯æ ¸çš„å±‚éƒ½å¯ä»¥å«åšå·ç§¯å±‚ï¼Œä½†ç¥ç»ç½‘ç»œå±‚ä¸­è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å±‚ç±»å‹ï¼Œæ¯”å¦‚æ± åŒ–(pooling)å±‚ï¼Œå…¨è¿æ¥(full connect/FC)å±‚ç­‰ã€‚<br>å°†å·ç§¯å±‚ä¸è¿™äºŒè€…ç»“åˆï¼Œæˆ‘ä»¬å¯ä»¥æ­å»ºå‡ºæ›´å¥½çš„å·ç§¯ç¥ç»ç½‘ç»œã€‚</p><h2 id="æ± åŒ–å±‚"><a href="#æ± åŒ–å±‚" class="headerlink" title="æ± åŒ–å±‚"></a>æ± åŒ–å±‚</h2><p>åœ¨ConvNetä¸­ï¼Œç»å¸¸ä¼šä½¿ç”¨ä¸€ç§å«åšæ± åŒ–å±‚(pooling layer)çš„ç»“æ„æ¥å‡å°è¡¨ç¤ºå±‚çš„å¤§å°ï¼Œä»è€ŒåŠ å¿«æ¨¡å‹è®­ç»ƒï¼Œç”šè‡³æ›´å¥½çš„å‘ç°ä¸€äº›ç‰¹æ€§ã€‚</p><p>ä¸‹é¢ä»‹ç»ä¸¤ç§æ± åŒ–å±‚</p><h3 id="æœ€å¤§å€¼-Max-æ± åŒ–"><a href="#æœ€å¤§å€¼-Max-æ± åŒ–" class="headerlink" title="æœ€å¤§å€¼(Max)æ± åŒ–"></a>æœ€å¤§å€¼(Max)æ± åŒ–</h3><p>éå¸¸ç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/maxPooling.png" srcset="/img/loading.gif" class="" title="æœ€å¤§å€¼æ± åŒ–"><p>è™½ç„¶å¾ˆç®€å•ï¼Œä½†maxæ± åŒ–åœ¨å¾ˆå¤šçš„å®é™…åº”ç”¨ä¸­éƒ½æœ‰å¾ˆå¥½çš„æ•ˆæœã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<br>ç›´ç™½çš„ç†è§£ä¸€ä¸‹ï¼ŒåŠ å…¥ä½ æŠŠè¿™ä¸ª4Ã—4çš„åŒºåŸŸçœ‹ä½œæŸä¸ªç‰¹å¾çš„é›†åˆï¼Œå³ç¥ç»ç½‘ç»œæŸä¸ªå±‚ä¸­çš„æ¿€æ´»çŠ¶æ€ï¼Œé‚£ä¹ˆä¸€ä¸ªå¤§çš„æ•°å­—æ„å‘³ç€ç®—æ³•å¯èƒ½æ£€æµ‹åˆ°äº†ä¸€ä¸ªç‰¹å®šçš„ç‰¹å¾ï¼Œå¦‚ä¸Šå›¾å·¦ä¸Šçš„2*2åŒºåŸŸå°±æœ‰è¿™æ ·çš„ç‰¹å¾ï¼Œ8è¢«æŒ‘é€‰å¹¶ä¿ç•™ä¸‹æ¥ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªå‚ç›´è¾¹ç¼˜ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªä»»ä½•éš¾ä»¥æè¿°çš„ç‰¹å¾ï¼Œè€Œå³ä¸ŠåŒºåŸŸæ²¡æœ‰è¿™æ ·çš„ç‰¹å¾ï¼Œå®ƒçš„æœ€å¤§å€¼ä¾ç„¶å¾ˆå°ã€‚<br>æ‰€ä»¥ï¼Œmax poolingä½œæ‰€åšçš„å…¶å®æ˜¯ ï¼Œå¦‚æœåœ¨è¿‡æ»¤å™¨ä¸­ä»»ä½•åœ°æ–¹æ£€æµ‹åˆ°äº†ä»»ä½•ç‰¹å¾ï¼Œå°±ä¿ç•™æœ€å¤§çš„æ•°å€¼ã€‚<br>åä¹‹ï¼Œå¦‚æœæ²¡æœ‰æ˜æ˜¾çš„ç‰¹å¾è¢«æ£€æµ‹åˆ°ï¼Œæ¯”å¦‚å³ä¸Šæ–¹çš„å››åˆ†ä¹‹ä¸€åŒºåŸŸå°±æ²¡æœ‰è¿™ä¸ªç‰¹å¾ï¼Œåœ¨ç»“æœä¸­é‚£äº›æ•°å€¼çš„æœ€å¤§å€¼ä»ç„¶ç›¸å½“å°ã€‚</p><h3 id="å¹³å‡å€¼æ± åŒ–"><a href="#å¹³å‡å€¼æ± åŒ–" class="headerlink" title="å¹³å‡å€¼æ± åŒ–"></a>å¹³å‡å€¼æ± åŒ–</h3><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/avgPooling.png" srcset="/img/loading.gif" class="" title="å¹³å‡å€¼æ± åŒ–"><p>å°±ä¸ä»‹ç»äº†â€¦</p><h3 id="æ± åŒ–å±‚ç‰¹ç‚¹"><a href="#æ± åŒ–å±‚ç‰¹ç‚¹" class="headerlink" title="æ± åŒ–å±‚ç‰¹ç‚¹"></a>æ± åŒ–å±‚ç‰¹ç‚¹</h3><p>æœ€å¤§å€¼æ± åŒ–çš„ä½¿ç”¨é€šå¸¸æ¯”å‡å€¼æ± åŒ–å¤šå¾—å¤šã€‚<br>ä¹Ÿè®¸ä½ æ³¨æ„åˆ°äº†ï¼Œå¤§å¤šæ•°æ± åŒ–å±‚éƒ½ä¸éœ€è¦å­¦ä¹ è¶…å‚æ•°ï¼Œåªè¦ç¡®å®šäº†få’Œsï¼Œè®¡ç®—å°±ç¡®å®šäº†ã€‚<br>è€Œä¸”å¦‚æœè¾“å…¥æ•°æ®æ˜¯3ç»´çš„ï¼Œåˆ™ç»“æœä¸­é€šé“æ•°é‡ä¾ç„¶ä¿æŒï¼Œå³æ¯ä¸€å±‚éƒ½åƒç¬¬ä¸€å±‚ä¸€æ ·è¿›è¡Œè¿‡æ»¤ã€‚</p><h2 id="å·ç§¯ç½‘ç»œæ ·ä¾‹"><a href="#å·ç§¯ç½‘ç»œæ ·ä¾‹" class="headerlink" title="å·ç§¯ç½‘ç»œæ ·ä¾‹"></a>å·ç§¯ç½‘ç»œæ ·ä¾‹</h2><p>todoâ€¦</p><h2 id="å·ç§¯ä¸ºä»€ä¹ˆæœ‰ç”¨"><a href="#å·ç§¯ä¸ºä»€ä¹ˆæœ‰ç”¨" class="headerlink" title="å·ç§¯ä¸ºä»€ä¹ˆæœ‰ç”¨"></a>å·ç§¯ä¸ºä»€ä¹ˆæœ‰ç”¨</h2><p>æ¯”èµ·ä¸€èˆ¬çš„å…¨è¿æ¥ç¥ç»ç½‘ç»œï¼Œå·ç§¯ç¥ç»ç½‘ç»œä¸»è¦æœ‰2ä¸ªä¼˜åŠ¿ï¼Œå‚æ•°å…±äº«å’Œè¿æ¥ç¨€ç–æ€§ã€‚</p><img src="/2020/03/24/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BB%8B%E7%BB%8D/whyCcnvWork.png" srcset="/img/loading.gif" class="" title="ä¾‹å›¾"> <p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚ä¸Šå›¾ï¼Œç¬¬ä¸€å±‚å…±32Ã—32Ã—3 = 3072ä¸ªè¾“å…¥ï¼Œç¬¬äºŒå±‚å…±4704ä¸ªè¾“å‡ºã€‚ä½¿ç”¨å¦‚ä¸Šæ‰€ç¤ºçš„å·ç§¯ï¼Œæˆ‘ä»¬åªéœ€è¦(5Ã—5Ã—3+1)Ã—6ä¸€å…±456ä¸ªå‚æ•°ã€‚è€Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å…¨è¿æ¥å±‚ï¼Œæˆ‘ä»¬éœ€è¦å¤šå°‘å‚æ•°å‘¢ï¼Ÿä¸€å…±3072Ã—4704ä¸ªå‚æ•°ï¼Œå¤šå¤ªå¤šäº†ã€‚</p><p>å·ç§¯ç½‘ç»œçš„å‚æ•°å°‘ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªåŸå› ã€‚</p><h3 id="å‚æ•°å…±äº«"><a href="#å‚æ•°å…±äº«" class="headerlink" title="å‚æ•°å…±äº«"></a>å‚æ•°å…±äº«</h3><p>æ¯ä¸€æ¬¡å·ç§¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„å·ç§¯æ ¸ä¸€ç›´è¢«è½®æµåœ°ä½¿ç”¨ï¼Œè¾“å…¥æ•°æ®çš„æ¯ä¸€ä¸ªéƒ¨åˆ†éƒ½ä¸è¿‡æ»¤å™¨è¿›è¡Œäº†è®¡ç®—ã€‚<br>æ‰€è°“å…±äº«å³å·ç§¯æ ¸çš„å…±äº«ã€‚</p><h3 id="è¿æ¥çš„ç¨€ç–æ€§"><a href="#è¿æ¥çš„ç¨€ç–æ€§" class="headerlink" title="è¿æ¥çš„ç¨€ç–æ€§"></a>è¿æ¥çš„ç¨€ç–æ€§</h3><p>ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ¯”å¦‚çœ‹ä¸Šå›¾ï¼Œå·ç§¯åç»“æœçŸ©é˜µçš„æ¯ä¸€ä¸ªå€¼ï¼Œéƒ½åªæ˜¯åŸè¾“å…¥æ•°æ®çš„ä¸€ä¸ª3*3çš„æ•°æ®ä¸è¿‡æ»¤å™¨å‘ç”Ÿè®¡ç®—å¾—åˆ°çš„ï¼Œä¸åƒå…¨è¿æ¥è¦å…³è”æ‰€æœ‰è¾“å…¥å€¼ã€‚</p><p>æ›´å¤šï¼Œä¹Ÿæœ‰äººè¯´å·ç§¯å¯ä»¥æ•æ‰å¹³ç§»ä¸å˜ï¼Œå³æ˜¯è¯´ä¸€å¼ å›¾ç‰‡çš„åƒç´ å³ç§»æˆ–å·¦ç§»äº†ä¸€äº›åƒç´ ï¼Œå®ƒä»¬ä¾ç„¶åº”è¯¥æœ‰ç›¸åŒçš„ç‰¹å¾ã€‚å·ç§¯å¯ä»¥ç»™ä»–ä»¬æ‰“ä¸Šç›¸åŒçš„æ ‡ç­¾ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™å°±æ˜¯å·ç§¯ç¥ç»ç½‘ç»œçš„åŸºæœ¬æ¦‚å¿µï¼Œé€šè¿‡tensorflowç­‰è½¯ä»¶åŒ…ä½ ä¹Ÿå¯ä»¥å¾ˆè½»æ¾çš„å®ç°å„ç§è‡ªå®šä¹‰çš„ç½‘ç»œç±»å‹ã€‚ä½†ä¸€èˆ¬çš„å®é™…åº”ç”¨ä¸­ï¼Œå¹¶ä¸æ¨èè‡ªç”±æ„å»ºç½‘ç»œç»“æ„ï¼Œå› ä¸ºå·ç§¯ç½‘ç»œçš„è®­ç»ƒæ—¶é—´æ™®éè¾ƒé•¿ï¼Œæ‰€ä»¥å½“ä½ è¦å»ºç«‹ä¸€ä¸ªå·ç§¯ç½‘ç»œæ¥è§£å†³ä¸€ä¸ªæ–°çš„é—®é¢˜æ—¶ï¼Œå»å°è¯•æƒ³å½“ç„¶çš„ç½‘ç»œç»“æ„å¾€å¾€å¾—ä¸å¿å¤±ã€‚ä¸€ä¸ªå¥½çš„æ–¹æ³•å°±æ˜¯å¤šä»å„å¤§è®ºæ–‡æˆ–è€…æˆåŠŸæ¨¡å‹çš„åˆ†äº«ä¸­è·å¾—çµæ„Ÿï¼Œåœ¨åˆ«äººæ¨èçš„æ¨¡å‹å’Œè¶…å‚æ•°çš„åŸºç¡€ä¸Šæ„å»ºä½ çš„ç½‘ç»œï¼Œæ‰èƒ½äº‹åŠåŠŸå€ã€‚</p><p>ä¹‹åä¼šä»‹ç»ä¸€äº›ç»å…¸çš„å·ç§¯ç½‘ç»œæ¨¡å‹ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ·±åº¦å­¦ä¹ </category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
