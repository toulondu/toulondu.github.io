<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"toulondu.github.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="这篇文章来自官网中文教程。我稍稍作了总结，并把代码中稍微不好理解的地方做了详细的注释。 PyTorch提供了许多工具来简化和进行数据加载，使代码更具可读性。这一节就主要介绍pytorch中是如何进行数据的加载和处理的。 先安装2个包：  scikit-image：用于图像的IO和变换 pandas：用于更容易地进行csv解析  在pytorch中进行数据加载，主要的步骤是：  将下好的数据集放在本">
<meta property="og:type" content="article">
<meta property="og:title" content="PyTorch中的数据加载和处理">
<meta property="og:url" content="https://toulondu.github.io/2020/05/15/PyTorch%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%A4%84%E7%90%86/index.html">
<meta property="og:site_name" content="Toulon&#39;s BLOG">
<meta property="og:description" content="这篇文章来自官网中文教程。我稍稍作了总结，并把代码中稍微不好理解的地方做了详细的注释。 PyTorch提供了许多工具来简化和进行数据加载，使代码更具可读性。这一节就主要介绍pytorch中是如何进行数据的加载和处理的。 先安装2个包：  scikit-image：用于图像的IO和变换 pandas：用于更容易地进行csv解析  在pytorch中进行数据加载，主要的步骤是：  将下好的数据集放在本">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-15T06:21:23.000Z">
<meta property="article:modified_time" content="2020-05-15T06:24:04.087Z">
<meta property="article:author" content="Toulon Du">
<meta property="article:tag" content="PyTorch">
<meta property="article:tag" content="基础">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://toulondu.github.io/2020/05/15/PyTorch%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%A4%84%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>PyTorch中的数据加载和处理 | Toulon's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Toulon's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Algorithm</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://toulondu.github.io/2020/05/15/PyTorch%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toulon Du">
      <meta itemprop="description" content="Sharing Knowledge And Learn More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Toulon's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PyTorch中的数据加载和处理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-15 14:21:23 / 修改时间：14:24:04" itemprop="dateCreated datePublished" datetime="2020-05-15T14:21:23+08:00">2020-05-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A0%81%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">编码工具</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>这篇文章来自<a href="http://pytorch123.com/ThirdSection/DataLoding/" target="_blank" rel="noopener">官网中文教程</a>。<br>我稍稍作了总结，并把代码中稍微不好理解的地方做了详细的注释。</p>
<p>PyTorch提供了许多工具来简化和进行数据加载，使代码更具可读性。<br>这一节就主要介绍pytorch中是如何进行数据的加载和处理的。</p>
<p>先安装2个包：</p>
<ul>
<li>scikit-image：用于图像的IO和变换</li>
<li>pandas：用于更容易地进行csv解析</li>
</ul>
<p>在pytorch中进行数据加载，主要的步骤是：</p>
<ol>
<li>将下好的数据集放在本地文件夹中，本示例中的数据集是imagenet数据集标注为face的图片当中在 dlib 面部检测 (dlib’s pose estimation) 表现良好的图片，连接在<a href="https://download.pytorch.org/tutorial/faces.zip" target="_blank" rel="noopener">这里</a>。</li>
<li>先创建一个自己的数据集类(继承自dataset),在<strong>init</strong>中读取数据内容(根据数据的来源)，在<strong>getitem</strong>中根据idx读取文件。</li>
<li>在Dataset类中可以加入一个transform参数，它是一个函数，可以对样本数据进行预处理，包括Rescale,randomCrop等(输入图片大小不符合网络输入要求时)。我们可以通过torchvision.transforms.Compose这个函数式的方法将数据转换的方法合成一个方法作为我们最后的transform。</li>
<li>迭代从我们创建的Dataset中获取数据，这不需要我们自己实现，通过<strong>torch.utils.data.DataLoader</strong>提供的多线程实现我们可以更高效地载入数据。但在Windows上会存在内存泄漏的问题，所以无法使用多线程。</li>
<li>torchvision，这个包提供了常用的datasets和transform。</li>
</ol>
<p>代码如下,内部有详细注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line">from __future__ import print_function, division</span><br><span class="line">import os</span><br><span class="line">import torch</span><br><span class="line">import pandas as pd              #用于更容易地进行csv解析</span><br><span class="line">from skimage import io, transform    #用于图像的IO和变换</span><br><span class="line">import numpy as np</span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">from torch.utils.data import Dataset, DataLoader</span><br><span class="line">from torchvision import transforms, utils</span><br><span class="line"></span><br><span class="line"># 忽略警告</span><br><span class="line">import warnings</span><br><span class="line">warnings.filterwarnings(&quot;ignore&quot;)</span><br><span class="line"></span><br><span class="line">plt.ion()   # interactive mode</span><br><span class="line"></span><br><span class="line"># 下载数据集放在&#39;data&#x2F;face&#39;中，</span><br><span class="line"># 这个数据集实际上是imagenet数据集标注为face的图片当中在 dlib 面部检测 (dlib’s pose estimation) 表现良好的图片。</span><br><span class="line"># 我们要处理的是一个面部姿态的数据集。</span><br><span class="line"># 数据集是按如下规则打包成的csv文件:</span><br><span class="line"># image_name,part_0_x,part_0_y,part_1_x,part_1_y,part_2_x, ... ,part_67_x,part_67_y</span><br><span class="line"></span><br><span class="line"># 将csv中的标注点数据读入（N，2）数组中，其中N是特征点的数量。读取数据代码如下：</span><br><span class="line">landmarks_frame &#x3D; pd.read_csv(&#39;data&#x2F;faces&#x2F;face_landmarks.csv&#39;)</span><br><span class="line"></span><br><span class="line">n &#x3D; 32</span><br><span class="line">img_name &#x3D; landmarks_frame.iloc[n, 0]</span><br><span class="line"># values将Series作为ndarry或者ndarry-like类型的数据返回，取决于dtype类型. 这句代码取出了第n张图片的所以标记点信息</span><br><span class="line">landmarks &#x3D; landmarks_frame.iloc[n, 1:].values</span><br><span class="line"># 一对一对的坐标，2个一组</span><br><span class="line">landmarks &#x3D; landmarks.astype(&#39;float&#39;).reshape(-1, 2)</span><br><span class="line"></span><br><span class="line">print(&#39;Image name: &#123;&#125;&#39;.format(img_name))</span><br><span class="line">print(&#39;Landmarks shape: &#123;&#125;&#39;.format(landmarks.shape))</span><br><span class="line">print(&#39;First 4 Landmarks: &#123;&#125;&#39;.format(landmarks[:4]))</span><br><span class="line"></span><br><span class="line"># 展示一张图片和它对应的标注点作为例子。用到的函数都很容易看出作用</span><br><span class="line">def show_landmarks(image, landmarks):</span><br><span class="line">    &quot;&quot;&quot;显示带有地标的图片&quot;&quot;&quot;</span><br><span class="line">    plt.imshow(image)</span><br><span class="line">    plt.scatter(landmarks[:, 0], landmarks[:, 1], s&#x3D;10, marker&#x3D;&#39;.&#39;, c&#x3D;&#39;r&#39;)</span><br><span class="line">    plt.pause(0.001)  # pause a bit so that plots are updated</span><br><span class="line"></span><br><span class="line">plt.figure()</span><br><span class="line">show_landmarks(io.imread(os.path.join(&#39;data&#x2F;faces&#x2F;&#39;, img_name)),</span><br><span class="line">               landmarks)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 数据集类</span><br><span class="line"># torch.utils.data.Dataset是表示数据集的抽象类，因此自定义数据集应继承Dataset并覆盖以下方法 </span><br><span class="line"># * __len__ 实现 len(dataset) 返还数据集的尺寸。</span><br><span class="line"># * __getitem__用来获取一些索引数据，例如 dataset[i] 中的(i)。</span><br><span class="line"></span><br><span class="line"># 为面部数据集创建一个数据集类。</span><br><span class="line"># 我们将在 __init__中读取csv的文件内容，在 __getitem__中读取图片。</span><br><span class="line"># 这么做是为了节省内存 空间。只有在需要用到图片的时候才读取它而不是一开始就把图片全部存进内存里。</span><br><span class="line"></span><br><span class="line"># 我们的数据样本将按这样一个字典&#123;&#39;image&#39;: image, &#39;landmarks&#39;: landmarks&#125;组织。 </span><br><span class="line"># 我们的数据集类将添加一个可选参数transform 以方便对样本进行预处理。</span><br><span class="line">#下一节我们会看到什么时候需要用到transform参数。 __init__方法如下图所示：</span><br><span class="line"># 这部分代码也没什么值得说的</span><br><span class="line">class FaceLandmarksDataset(Dataset):</span><br><span class="line">    &quot;&quot;&quot;面部标记数据集.&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def __init__(self, csv_file, root_dir, transform&#x3D;None):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        csv_file（string）：带注释的csv文件的路径。</span><br><span class="line">        root_dir（string）：包含所有图像的目录。</span><br><span class="line">        transform（callable， optional）：一个样本上的可用的可选变换</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self.landmarks_frame &#x3D; pd.read_csv(csv_file)</span><br><span class="line">        self.root_dir &#x3D; root_dir</span><br><span class="line">        self.transform &#x3D; transform</span><br><span class="line"></span><br><span class="line">    def __len__(self):</span><br><span class="line">        return len(self.landmarks_frame)</span><br><span class="line"></span><br><span class="line">    def __getitem__(self, idx):</span><br><span class="line">        img_name &#x3D; os.path.join(self.root_dir,</span><br><span class="line">                                self.landmarks_frame.iloc[idx, 0])</span><br><span class="line">        image &#x3D; io.imread(img_name)</span><br><span class="line">        landmarks &#x3D; self.landmarks_frame.iloc[idx, 1:]</span><br><span class="line">        landmarks &#x3D; np.array([landmarks])</span><br><span class="line">        landmarks &#x3D; landmarks.astype(&#39;float&#39;).reshape(-1, 2)</span><br><span class="line">        sample &#x3D; &#123;&#39;image&#39;: image, &#39;landmarks&#39;: landmarks&#125;</span><br><span class="line"></span><br><span class="line">        if self.transform:</span><br><span class="line">            sample &#x3D; self.transform(sample)</span><br><span class="line"></span><br><span class="line">        return sample</span><br><span class="line">        </span><br><span class="line"># 数据可视化</span><br><span class="line"># 实例化这个类并遍历数据样本。我们将会打印出前四个例子的尺寸并展示标注的特征点。 代码如下图所示：</span><br><span class="line">face_dataset &#x3D; FaceLandmarksDataset(csv_file&#x3D;&#39;data&#x2F;faces&#x2F;face_landmarks.csv&#39;,</span><br><span class="line">                                    root_dir&#x3D;&#39;data&#x2F;faces&#x2F;&#39;)</span><br><span class="line"></span><br><span class="line">fig &#x3D; plt.figure()</span><br><span class="line"></span><br><span class="line">for i in range(len(face_dataset)):</span><br><span class="line">    sample &#x3D; face_dataset[i]</span><br><span class="line"></span><br><span class="line">    print(i, sample[&#39;image&#39;].shape, sample[&#39;landmarks&#39;].shape)</span><br><span class="line">    </span><br><span class="line">    # 创建子图，1行4列，最后一个参数为当前图编号 但也不知道为什么没成功，还是画成了4行1列</span><br><span class="line">    ax &#x3D; plt.subplot(1, 4, i + 1)</span><br><span class="line">    plt.tight_layout()</span><br><span class="line">    ax.set_title(&#39;Sample #&#123;&#125;&#39;.format(i))</span><br><span class="line">    # 不画坐标轴</span><br><span class="line">    ax.axis(&#39;off&#39;)</span><br><span class="line">    show_landmarks(**sample)</span><br><span class="line"></span><br><span class="line">    if i &#x3D;&#x3D; 3:</span><br><span class="line">        plt.show()</span><br><span class="line">        break</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 数据变换</span><br><span class="line"># 通过上面的例子我们会发现图片并不是同样的尺寸。绝大多数神经网络都假定图片的尺寸相同。因此我们需要做一些预处理。</span><br><span class="line"># 让我们创建三个转换: * Rescale：缩放图片 * RandomCrop：对图片进行随机裁剪。这是一种数据增强操作 * ToTensor：把numpy格式图片转为torch格式图片 (我们需要交换坐标轴).</span><br><span class="line"># 我们会把它们写成可调用的类的形式而不是简单的函数，这样就不需要每次调用时传递一遍参数。我们只需要实现__call__方法，必 要的时候实现 __init__方法。我们可以这样调用这些转换:</span><br><span class="line"># tsfm &#x3D; Transform(params)</span><br><span class="line"># transformed_sample &#x3D; tsfm(sample)</span><br><span class="line"></span><br><span class="line">class Rescale(object):</span><br><span class="line">    &quot;&quot;&quot;将样本中的图像重新缩放到给定大小。.</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">        output_size（tuple或int）：所需的输出大小。 如果是元组，则输出为</span><br><span class="line">         与output_size匹配。 如果是int，则匹配较小的图像边缘到output_size保持纵横比相同。</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def __init__(self, output_size):</span><br><span class="line">        assert isinstance(output_size, (int, tuple))</span><br><span class="line">        self.output_size &#x3D; output_size</span><br><span class="line"></span><br><span class="line">    def __call__(self, sample):</span><br><span class="line">        image, landmarks &#x3D; sample[&#39;image&#39;], sample[&#39;landmarks&#39;]</span><br><span class="line"></span><br><span class="line">        h, w &#x3D; image.shape[:2]</span><br><span class="line">        if isinstance(self.output_size, int):</span><br><span class="line">            # output_size为int，将长或宽中小的那一个rescale成output_size，另一个保持纵横比缩放</span><br><span class="line">            if h &gt; w:</span><br><span class="line">                new_h, new_w &#x3D; self.output_size * h &#x2F; w, self.output_size</span><br><span class="line">            else:</span><br><span class="line">                new_h, new_w &#x3D; self.output_size, self.output_size * w &#x2F; h</span><br><span class="line">        else:</span><br><span class="line">            new_h, new_w &#x3D; self.output_size</span><br><span class="line"></span><br><span class="line">        new_h, new_w &#x3D; int(new_h), int(new_w)</span><br><span class="line">        </span><br><span class="line">        # 看来skimage的这个库实现了对图片的各种转换操作</span><br><span class="line">        img &#x3D; transform.resize(image, (new_h, new_w))</span><br><span class="line"></span><br><span class="line">        # 别忘了对landmarks也要作同样比例的缩放！</span><br><span class="line">        landmarks &#x3D; landmarks * [new_w &#x2F; w, new_h &#x2F; h]</span><br><span class="line"></span><br><span class="line">        return &#123;&#39;image&#39;: img, &#39;landmarks&#39;: landmarks&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class RandomCrop(object):</span><br><span class="line">    &quot;&quot;&quot;随机裁剪样本中的图像.</span><br><span class="line"></span><br><span class="line">    Args:</span><br><span class="line">       output_size（tuple或int）：所需的输出大小。 如果是int，就按照int的值进行方形裁剪。         </span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def __init__(self, output_size):</span><br><span class="line">        assert isinstance(output_size, (int, tuple))</span><br><span class="line">        if isinstance(output_size, int):</span><br><span class="line">            self.output_size &#x3D; (output_size, output_size)</span><br><span class="line">        else:</span><br><span class="line">            assert len(output_size) &#x3D;&#x3D; 2</span><br><span class="line">            self.output_size &#x3D; output_size</span><br><span class="line"></span><br><span class="line">    def __call__(self, sample):</span><br><span class="line">        image, landmarks &#x3D; sample[&#39;image&#39;], sample[&#39;landmarks&#39;]</span><br><span class="line"></span><br><span class="line">        h, w &#x3D; image.shape[:2]</span><br><span class="line">        new_h, new_w &#x3D; self.output_size</span><br><span class="line">        </span><br><span class="line">        # 随机从图片中裁剪一块目标大小的图像出来,landmark也作相应处理 PS:h更小肿么办</span><br><span class="line">        top &#x3D; np.random.randint(0, h - new_h)</span><br><span class="line">        left &#x3D; np.random.randint(0, w - new_w)</span><br><span class="line"></span><br><span class="line">        image &#x3D; image[top: top + new_h,</span><br><span class="line">                      left: left + new_w]</span><br><span class="line"></span><br><span class="line">        landmarks &#x3D; landmarks - [left, top]</span><br><span class="line"></span><br><span class="line">        return &#123;&#39;image&#39;: image, &#39;landmarks&#39;: landmarks&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ToTensor(object):</span><br><span class="line">    &quot;&quot;&quot;将样本中的ndarrays转换为Tensors.&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def __call__(self, sample):</span><br><span class="line">        image, landmarks &#x3D; sample[&#39;image&#39;], sample[&#39;landmarks&#39;]</span><br><span class="line"></span><br><span class="line">        # 交换颜色轴因为</span><br><span class="line">        # numpy包的图片是: H * W * C</span><br><span class="line">        # torch包的图片是: C * H * W</span><br><span class="line">        image &#x3D; image.transpose((2, 0, 1))</span><br><span class="line">        return &#123;&#39;image&#39;: torch.from_numpy(image),</span><br><span class="line">                &#39;landmarks&#39;: torch.from_numpy(landmarks)&#125;</span><br><span class="line">                </span><br><span class="line"># 8.组合转换</span><br><span class="line"># 即把这些转换应用起来 </span><br><span class="line"># 我们想要把图像的短边调整为256，然后随机裁剪(randomcrop)为224大小的正方形。</span><br><span class="line"># 也就是说，我们打算组合一个Rescale和 RandomCrop的变换。 </span><br><span class="line"># 我们可以调用一个简单的类 torchvision.transforms.Compose来实现这一操作。具体实现如下图：</span><br><span class="line"></span><br><span class="line">scale &#x3D; Rescale(256)</span><br><span class="line">crop &#x3D; RandomCrop(128)</span><br><span class="line">composed &#x3D; transforms.Compose([Rescale(256),</span><br><span class="line">                               RandomCrop(224)])</span><br><span class="line"></span><br><span class="line"># 在样本上应用上述的每个变换。</span><br><span class="line">fig &#x3D; plt.figure()</span><br><span class="line">sample &#x3D; face_dataset[65]</span><br><span class="line"></span><br><span class="line">for i, tsfrm in enumerate([scale, crop, composed]):</span><br><span class="line">    transformed_sample &#x3D; tsfrm(sample)</span><br><span class="line">    </span><br><span class="line">    ax &#x3D; plt.subplot(1, 3, i + 1)</span><br><span class="line">    plt.tight_layout()</span><br><span class="line">    ax.set_title(type(tsfrm).__name__)</span><br><span class="line">    show_landmarks(**transformed_sample)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"># 9.迭代数据集</span><br><span class="line"># 让我们把这些整合起来以创建一个带组合转换的数据集。</span><br><span class="line"># 总结一下，每次这个数据集被采样时: </span><br><span class="line"># * 及时地从文件中读取图片 * 对读取的图片应用转换 * 由于其中一步操作是随机的 (randomcrop) , 数据被增强了</span><br><span class="line"></span><br><span class="line"># 我们可以像之前那样使用for i in range循环来对所有创建的数据集执行同样的操作。</span><br><span class="line"></span><br><span class="line"># 还记得FaceLandmarksDataset 这个类吗，忘了可以翻回去看一下</span><br><span class="line">transformed_dataset &#x3D; FaceLandmarksDataset(csv_file&#x3D;&#39;data&#x2F;faces&#x2F;face_landmarks.csv&#39;,</span><br><span class="line">                                           root_dir&#x3D;&#39;data&#x2F;faces&#x2F;&#39;,</span><br><span class="line">                                           transform&#x3D;transforms.Compose([</span><br><span class="line">                                               Rescale(256),</span><br><span class="line">                                               RandomCrop(224),</span><br><span class="line">                                               ToTensor()</span><br><span class="line">                                           ]))</span><br><span class="line"></span><br><span class="line">for i in range(len(transformed_dataset)):</span><br><span class="line">    sample &#x3D; transformed_dataset[i]</span><br><span class="line"></span><br><span class="line">    print(i, sample[&#39;image&#39;].size(), sample[&#39;landmarks&#39;].size())</span><br><span class="line"></span><br><span class="line">    if i &#x3D;&#x3D; 3:</span><br><span class="line">        break</span><br><span class="line">        </span><br><span class="line"># 但是，对所有数据集简单的使用for循环牺牲了许多功能，尤其是: * 批量处理数据 * 打乱数据 * 使用多线程multiprocessingworker 并行加载数据。</span><br><span class="line"># torch.utils.data.DataLoader是一个提供上述所有这些功能的迭代器。</span><br><span class="line"># 下面使用的参数必须是清楚的。一个值得关注的参数是collate_fn, 可以通过它来决定如何对数据进行批处理。但是绝大多数情况下默认值就能运行良好。</span><br><span class="line"># PS: 这里windows下跑是有问题的，因为windows在用这个多线程方法时有内存泄漏，详情：https:&#x2F;&#x2F;github.com&#x2F;pytorch&#x2F;pytorch&#x2F;pull&#x2F;5585</span><br><span class="line"># 概括点来说就是，因为在Windows上使用FileMapping（mmap）的差异引起的。</span><br><span class="line"># Windows上，所有相关线程都释放了FileMapping对象的引用，它才才能够被释放。没有提供其他方法可以将其直接删除。（例如shm_unlink） </span><br><span class="line"># 启用多线程后，子线程将创建一个FileMapping，然后主进程将其打开。之后子线程将尝试释放它，但是它的引用计数非零，因此无法在那时释放它。</span><br><span class="line"># 而且当前代码无法提供在可能的情况下再次关闭的机会，于是导致了内存泄漏。</span><br><span class="line"></span><br><span class="line"># 解决办法是权宜之计，即使用num_workers参数，令num_workers&#x3D;0,只使用一个主线程加载数据集。避免在windows中使用多线程。</span><br><span class="line"></span><br><span class="line">dataloader &#x3D; DataLoader(transformed_dataset, batch_size&#x3D;4,</span><br><span class="line">                        shuffle&#x3D;True, num_workers&#x3D;4)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 辅助功能：显示批次</span><br><span class="line">def show_landmarks_batch(sample_batched):</span><br><span class="line">    &quot;&quot;&quot;Show image with landmarks for a batch of samples.&quot;&quot;&quot;</span><br><span class="line">    images_batch, landmarks_batch &#x3D; \</span><br><span class="line">            sample_batched[&#39;image&#39;], sample_batched[&#39;landmarks&#39;]</span><br><span class="line">    batch_size &#x3D; len(images_batch)</span><br><span class="line">    im_size &#x3D; images_batch.size(2)</span><br><span class="line">    grid_border_size &#x3D; 2</span><br><span class="line"></span><br><span class="line">    grid &#x3D; utils.make_grid(images_batch)</span><br><span class="line">    plt.imshow(grid.numpy().transpose((1, 2, 0)))</span><br><span class="line">    </span><br><span class="line">    for i in range(batch_size):</span><br><span class="line">        plt.scatter(landmarks_batch[i, :, 0].numpy() + i * im_size + (i + 1) * grid_border_size,</span><br><span class="line">                    landmarks_batch[i, :, 1].numpy() + grid_border_size,</span><br><span class="line">                    s&#x3D;10, marker&#x3D;&#39;.&#39;, c&#x3D;&#39;r&#39;)</span><br><span class="line"></span><br><span class="line">        plt.title(&#39;Batch from dataloader&#39;)</span><br><span class="line">        </span><br><span class="line">for i_batch, sample_batched in enumerate(dataloader):</span><br><span class="line">    print(i_batch, sample_batched[&#39;image&#39;].size(),</span><br><span class="line">          sample_batched[&#39;landmarks&#39;].size())</span><br><span class="line"></span><br><span class="line">    # 观察第4批次并停止。</span><br><span class="line">    if i_batch &#x3D;&#x3D; 3:</span><br><span class="line">        plt.figure()</span><br><span class="line">        show_landmarks_batch(sample_batched)</span><br><span class="line">        plt.axis(&#39;off&#39;)</span><br><span class="line">        plt.ioff()</span><br><span class="line">        plt.show()</span><br><span class="line">        break</span><br></pre></td></tr></table></figure>

<p><strong>torchvision</strong><br>torchvision包提供了 常用的数据集类(datasets)和转换(transforms)。<br>所以只要我们的数据符合这些数据集的要求，我们就不需要自己构造这些类比如。torchvision中还有一个更常用的数据集类ImageFolder。 它假定了数据集是以如下方式构造的:<br>root/ants/xxx.png<br>root/ants/xxy.jpeg<br>root/ants/xxz.png<br>.<br>.<br>.<br>root/bees/123.jpg<br>root/bees/nsdf3.png<br>root/bees/asd932_.png</p>
<p>其中’ants’,bees’等是分类标签。在PIL.Image中你也可以使用类似的转换(transforms)例如RandomHorizontalFlip,Scale。利 用这些你可以按如下的方式创建一个数据加载器(dataloader) :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import torch</span><br><span class="line">from torchvision import transforms, datasets</span><br><span class="line"></span><br><span class="line">data_transform &#x3D; transforms.Compose([</span><br><span class="line">        transforms.RandomSizedCrop(224),</span><br><span class="line">        transforms.RandomHorizontalFlip(),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize(mean&#x3D;[0.485, 0.456, 0.406],</span><br><span class="line">                             std&#x3D;[0.229, 0.224, 0.225])</span><br><span class="line">    ])</span><br><span class="line">hymenoptera_dataset &#x3D; datasets.ImageFolder(root&#x3D;&#39;hymenoptera_data&#x2F;train&#39;,</span><br><span class="line">                                           transform&#x3D;data_transform)</span><br><span class="line">dataset_loader &#x3D; torch.utils.data.DataLoader(hymenoptera_dataset,</span><br><span class="line">                                             batch_size&#x3D;4, shuffle&#x3D;True,</span><br><span class="line">                                             num_workers&#x3D;4)</span><br></pre></td></tr></table></figure>




















    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/PyTorch/" rel="tag"># PyTorch</a>
              <a href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag"># 基础</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/01/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E6%A6%82%E8%A7%88/" rel="prev" title="推荐系统技术概览">
      <i class="fa fa-chevron-left"></i> 推荐系统技术概览
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Toulon Du</p>
  <div class="site-description" itemprop="description">Sharing Knowledge And Learn More</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Toulon Du</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
